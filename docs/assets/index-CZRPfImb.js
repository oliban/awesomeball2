var Ft=Object.defineProperty;var Dt=(P,t,i)=>t in P?Ft(P,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):P[t]=i;var o=(P,t,i)=>Dt(P,typeof t!="symbol"?t+"":t,i);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const l of document.querySelectorAll('link[rel="modulepreload"]'))r(l);new MutationObserver(l=>{for(const e of l)if(e.type==="childList")for(const s of e.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&r(s)}).observe(document,{childList:!0,subtree:!0});function i(l){const e={};return l.integrity&&(e.integrity=l.integrity),l.referrerPolicy&&(e.referrerPolicy=l.referrerPolicy),l.crossOrigin==="use-credentials"?e.credentials="include":l.crossOrigin==="anonymous"?e.credentials="omit":e.credentials="same-origin",e}function r(l){if(l.ep)return;l.ep=!0;const e=i(l);fetch(l.href,e)}})();const b=800,G=600,Ht=60,H="#FFFFFF",B="#000000",Gt="#FFFFFF",yt="#FFFF00",it=980,ut=240,ft=-450,et=600,dt=-450,Nt=.98,mt=.9,M=G-50,$t=1.5,Yt=10,Wt=1.4,Ut=10,Xt=1.5,Jt=12,zt=5,Pt=30,At=1.4,jt=15,N=80,J=150,D=10,tt=M-J,rt=0,lt=b-N,Tt=rt,St=lt+N;var O=(P=>(P.WELCOME="WELCOME",P.PLAYING="PLAYING",P.GOAL_SCORED="GOAL_SCORED",P.MATCH_OVER="MATCH_OVER",P.GAME_OVER="GAME_OVER",P.TROPHY="TROPHY",P))(O||{});const q={JUMP:"w",KICK:"s",LEFT:"a",RIGHT:"d"},Z={JUMP:"ArrowUp",KICK:"ArrowDown",LEFT:"ArrowLeft",RIGHT:"ArrowRight"},Vt={SOUNDS:{KICK_1:"sounds/kick_ball1.mp3",KICK_2:"sounds/kick_ball2.mp3",KICK_3:"sounds/kick_ball3.mp3",JUMP_1:"sounds/jump1.mp3",LAND_1:"sounds/land1.mp3",LAND_2:"sounds/land2.mp3",WALL_HIT_1:"sounds/wall_hit1.mp3",PLAYER_BUMP_1:"sounds/player_bump1.mp3",HEADBUTT_1:"sounds/headbutt1.mp3",BODY_HIT_1:"sounds/body_hit1.mp3",SWORD_HIT:"sounds/sword_hit.mp3",SWORD_HIT_BALL:"sounds/sword_hit.mp3",CROSSBAR_HIT:"sounds/crossbar_hit.mp3",BALL_BOUNCE_1:"sounds/ball_bounce1.mp3",COMBO_SPARKLE_1:"sounds/combo_sparkle1.mp3",COMBO_SPARKLE_2:"sounds/combo_sparkle2.mp3",COMBO_SPARKLE_3:"sounds/combo_sparkle3.mp3",COMBO_SPARKLE_4:"sounds/combo_sparkle4.mp3",SUPER_JACKPOT:"sounds/super_jackpot.mp3",NILS_AHEAD:"sounds/nils_ahead.mp3",HARRY_AHEAD:"sounds/harry_ahead.mp3",NILS_WINS:"sounds/nils_wins.mp3",HARRY_WINS:"sounds/harry_wins.mp3",PLAYER1_GOAL_1:"sounds/player1_goal1.mp3",PLAYER1_GOAL_2:"sounds/player1_goal2.mp3",PLAYER1_GOAL_3:"sounds/player1_goal3.mp3",PLAYER2_GOAL_1:"sounds/player2_goal1.mp3",PLAYER2_GOAL_2:"sounds/player2_goal2.mp3",PLAYER2_GOAL_3:"sounds/player2_goal3.mp3",NUM_0:"sounds/0.mp3",NUM_1:"sounds/1.mp3",NUM_2:"sounds/2.mp3",NUM_3:"sounds/3.mp3",NUM_4:"sounds/4.mp3",NUM_5:"sounds/5.mp3"}},st=Math.PI/2,qt=600,kt=.2,Zt=400,Q=80,Qt=800,ti=100,ii=1.5,ei=-400,wt=600,Mt=400,si=.3,oi=Math.PI/3,hi=600,ni=800,ai=6*Math.PI;class ri{constructor(){o(this,"keys",new Set);o(this,"justPressedKeys",new Set);o(this,"previouslyPressedKeys",new Set);o(this,"justReleasedKeys",new Set);o(this,"previouslyReleasedKeys",new Set);window.addEventListener("keydown",t=>{const i=t.key.toLowerCase();this.keys.has(i)||this.justPressedKeys.add(i),this.keys.add(i)}),window.addEventListener("keyup",t=>{const i=t.key.toLowerCase();this.keys.delete(i),this.justReleasedKeys.add(i)})}update(){this.previouslyPressedKeys=new Set(this.justPressedKeys),this.justPressedKeys.clear(),this.previouslyReleasedKeys=new Set(this.justReleasedKeys),this.justReleasedKeys.clear()}isKeyPressed(t){return this.keys.has(t.toLowerCase())}wasKeyJustPressed(t){return this.previouslyPressedKeys.has(t.toLowerCase())}wasKeyJustReleased(t){return this.previouslyReleasedKeys.has(t.toLowerCase())}}class li{constructor(){o(this,"audioContext");o(this,"soundBuffers",{});o(this,"soundsLoaded",!1);o(this,"loadingPromise",null);o(this,"activeLoops",new Map);o(this,"lastPlayedTimes",new Map);o(this,"debounceInterval",1e3);try{this.audioContext=new(window.AudioContext||window.webkitAudioContext)}catch(t){console.error("Web Audio API is not supported in this browser.",t),this.audioContext=null}}async loadSounds(){if(!this.audioContext)return console.warn("AudioContext not available, skipping sound loading."),this.soundsLoaded=!0,Promise.resolve();if(this.loadingPromise)return this.loadingPromise;if(this.soundsLoaded)return Promise.resolve();const t=Vt.SOUNDS,i=[];return this.loadingPromise=new Promise(async(r,l)=>{console.log("Starting sound loading..."),Object.keys(t).length;for(const e in t)if(Object.prototype.hasOwnProperty.call(t,e)){const s=t[e];i.push(this.loadSound(e,s).then(()=>{}))}try{await Promise.all(i),console.log("All sounds loaded successfully!"),this.soundsLoaded=!0,this.loadingPromise=null,r()}catch(e){console.error("Error loading one or more sounds:",e),this.loadingPromise=null,l(e)}}),this.loadingPromise}async loadSound(t,i){if(!this.audioContext)return Promise.resolve();try{const r=await fetch(i);if(!r.ok)throw new Error(`HTTP error! status: ${r.status} for ${i}`);const l=await r.arrayBuffer(),e=await this.audioContext.decodeAudioData(l);this.soundBuffers[t]=e}catch(r){console.error(`Failed to load sound: ${t} from ${i}`,r),this.soundBuffers[t]=null}}playSound(t,i=1,r=!1){var n;const l=performance.now(),e=this.lastPlayedTimes.get(t);if(e&&l-e<this.debounceInterval||!this.audioContext||!this.soundsLoaded)return;const s=this.soundBuffers[t];if(!s){console.warn(`Sound buffer not found for key: ${t}`);return}try{const h=this.audioContext.createBufferSource();h.buffer=s;const a=this.audioContext.createGain();if(a.gain.setValueAtTime(i,this.audioContext.currentTime),h.connect(a),a.connect(this.audioContext.destination),h.loop=r,h.start(0),this.lastPlayedTimes.set(t,l),r){if(this.activeLoops.has(t))try{(n=this.activeLoops.get(t))==null||n.stop()}catch{}this.activeLoops.set(t,h),h.onended=()=>{this.activeLoops.get(t)===h&&this.activeLoops.delete(t)}}}catch(h){console.error(`Error playing sound ${t}:`,h)}}areSoundsLoaded(){return this.soundsLoaded}stopSound(t){if(this.activeLoops.has(t)){const i=this.activeLoops.get(t);try{i==null||i.stop(),console.log(`Stopped looped sound: ${t}`)}catch{}this.activeLoops.delete(t)}}}const R=new li;class ci{constructor(t,i,r,l,e,s){o(this,"x");o(this,"y");o(this,"vx");o(this,"vy");o(this,"owner");o(this,"isActive",!0);o(this,"width",20);o(this,"height",8);o(this,"angle",0);o(this,"lastPos");o(this,"particleSystem");o(this,"smokeEmitTimer",0);o(this,"smokeEmitInterval",.03);this.x=t,this.y=i,this.vx=r,this.vy=l,this.owner=e,this.angle=Math.atan2(l,r),this.lastPos={x:t,y:i},this.particleSystem=s,console.log(`Rocket created by Player ${e.teamColor==="#DCDCDC"?1:2} at (${t.toFixed(0)}, ${i.toFixed(0)}) with velocity (${r.toFixed(0)}, ${l.toFixed(0)})`)}update(t){if(!this.isActive)return!1;if(this.lastPos={x:this.x,y:this.y},this.x+=this.vx*t,this.y+=this.vy*t,this.angle=Math.atan2(this.vy,this.vx),this.smokeEmitTimer+=t,this.smokeEmitTimer>=this.smokeEmitInterval){this.smokeEmitTimer-=this.smokeEmitInterval;const l=Math.sqrt(this.vx*this.vx+this.vy*this.vy),e=this.x-Math.cos(this.angle)*(this.width/2+2),s=this.y-Math.sin(this.angle)*(this.width/2+2);this.particleSystem.emit("rocket_smoke",e,s,1,{vx:this.vx,vy:this.vy,baseSpeed:l})}let i=!1,r=null;return this.y>M-this.height/2&&(this.y=M-this.height/2,i=!0,r="ground"),!i&&(this.x<-this.width||this.x>b+this.width||this.y<-this.height)?(this.isActive=!1,!1):i?(this.isActive=!1,console.log(`Explosion triggered by ${r} at (${this.lastPos.x.toFixed(0)}, ${this.lastPos.y.toFixed(0)})`),!0):!1}getRect(){const t=this.x-this.width/2,i=this.y-this.height/2;return{x:t,y:i,width:this.width,height:this.height}}draw(t){this.isActive&&(t.save(),t.translate(this.x,this.y),t.rotate(this.angle),t.fillStyle="#ff4500",t.fillRect(-this.width/2,-this.height/2,this.width,this.height),t.strokeStyle=B,t.lineWidth=1,t.strokeRect(-this.width/2,-this.height/2,this.width,this.height),t.fillStyle="yellow",t.beginPath(),t.moveTo(-this.width/2-5,0),t.lineTo(-this.width/2,-this.height/3),t.lineTo(-this.width/2,this.height/3),t.closePath(),t.fill(),t.restore())}}function C(P,t,i){return{x:P.x+t*Math.cos(i),y:P.y-t*Math.sin(i)}}const di=.0625*60,gt=Math.PI/7,bt=Math.PI/6,f=-Math.PI/2,ot=Math.PI/2.5,Lt=Math.PI/1.5,ht=Math.PI*.6,nt=-Math.PI*.15,vt=.45,gi=.15,yi=.7,Rt=14,pi=8,Et=9,It=25,ui=800,fi=8,mi=150,pt=50,Pi=550,Ai=Pi-mi,Ti=0,Si=ui-pt;function _(P,t,i){return P*(1-i)+t*i}function ki(P){return P*P}class ct{constructor(t,i,r,l,e,s,n,h,a){o(this,"x");o(this,"y");o(this,"vx");o(this,"vy");o(this,"baseY");o(this,"isJumping");o(this,"hasJumpedThisPress",!1);o(this,"isKicking");o(this,"isBicycleKicking",!1);o(this,"bicycleKickTimer",0);o(this,"kickTimer");o(this,"kickDuration",vt);o(this,"walkCycleTimer");o(this,"facingDirection",1);o(this,"onOtherPlayerHead",!1);o(this,"onLeftCrossbar");o(this,"onRightCrossbar");o(this,"justLanded",!1);o(this,"lastLandingVy",0);o(this,"isStunned");o(this,"stunTimer");o(this,"isTumbling");o(this,"tumbleTimer");o(this,"rotationAngle");o(this,"rotationVelocity");o(this,"minKickDistSq",1/0);o(this,"kickImpactForceX",0);o(this,"kickImpactForceY",0);o(this,"isBeingPushedBack",!1);o(this,"pushbackTimer",0);o(this,"teamColor");o(this,"teamAccent");o(this,"eyeColor");o(this,"baseHeadRadius",8);o(this,"baseTorsoLength",36);o(this,"baseLimbWidth",10);o(this,"baseArmLength",24);o(this,"baseLegLength",32);o(this,"headRadius");o(this,"torsoLength");o(this,"limbWidth");o(this,"armLength");o(this,"legLength");o(this,"leftThighAngle",f);o(this,"rightThighAngle",f);o(this,"leftShinAngle",0);o(this,"rightShinAngle",0);o(this,"leftArmAngle",f);o(this,"rightArmAngle",f);o(this,"activePowerups",new Map);o(this,"isFlying",!1);o(this,"isBig",!1);o(this,"isShrunk",!1);o(this,"isEnormousHead",!1);o(this,"isControlsReversed",!1);o(this,"isSword",!1);o(this,"swordAngle",0);o(this,"isSwingingSword",!1);o(this,"swordSwingTimer",0);o(this,"isItching",!1);o(this,"itchingTimer",0);o(this,"itchDuration",10);o(this,"isAiming",!1);o(this,"aimAngle",0);o(this,"drawPower",0);o(this,"hasBow",!1);o(this,"arrowAmmo",0);o(this,"jumpPower");o(this,"playerSpeed");o(this,"gravity");o(this,"speedMultiplier",1);o(this,"jumpMultiplier",1);o(this,"sizeMultiplier",1);o(this,"speedBoostTimer",0);o(this,"superJumpTimer",0);o(this,"bigPlayerTimer",0);o(this,"hasRocketLauncher",!1);o(this,"rocketAmmo",0);o(this,"swordSwingDuration",.6);o(this,"swordSwingAngleMax",Math.PI*1.5);o(this,"swordLengthMultiplier",3);this.x=t,this.y=i,this.baseY=i,this.vx=0,this.vy=0,this.isJumping=!1,this.isKicking=!1,this.isBicycleKicking=!1,this.bicycleKickTimer=0,this.kickTimer=0,this.walkCycleTimer=0,this.facingDirection=r,this.hasJumpedThisPress=!1,this.justLanded=!1,this.lastLandingVy=0,this.onLeftCrossbar=!1,this.onRightCrossbar=!1,this.isStunned=!1,this.stunTimer=0,this.isTumbling=!1,this.tumbleTimer=0,this.rotationAngle=0,this.rotationVelocity=0,this.isAiming=!1,this.aimAngle=0,this.drawPower=0,this.hasBow=!1,this.teamColor=l,this.teamAccent=e,this.eyeColor=s,this.headRadius=this.baseHeadRadius,this.torsoLength=this.baseTorsoLength,this.limbWidth=this.baseLimbWidth,this.armLength=this.baseArmLength,this.legLength=this.baseLegLength,this.gravity=n,this.jumpPower=h,this.playerSpeed=a,this.kickDuration=vt,this.updateSizeAttributes()}_getRelativeLimbPositions(){let t=this.leftThighAngle,i=this.rightThighAngle,r=this.leftShinAngle,l=this.rightShinAngle,e=this.leftArmAngle,s=this.rightArmAngle;isNaN(t)&&(t=f),isNaN(i)&&(i=f),isNaN(r)&&(r=0),isNaN(l)&&(l=0),isNaN(e)&&(e=f),isNaN(s)&&(s=f);let n=this.isItching,h="normal",a="normal";if(n){const U=Date.now()/1e3*4,Y=(Math.sin(U*Math.PI)+1)/2,F=Y<.5?4*Y*Y*Y:1-Math.pow(-2*Y+2,3)/2,W={leftThigh:Math.PI*.3,leftShin:Math.PI*.4,leftArm:Math.PI*.6,rightThigh:-Math.PI*.2,rightShin:-Math.PI*.1,rightArm:-Math.PI*.3},X={leftThigh:-Math.PI*.1,leftShin:-Math.PI*.2,leftArm:-Math.PI*.4,rightThigh:Math.PI*.4,rightShin:Math.PI*.5,rightArm:Math.PI*.7};t=st+_(W.leftThigh,X.leftThigh,F),r=_(W.leftShin,X.leftShin,F),e=st+_(W.leftArm,X.leftArm,F),i=st+_(W.rightThigh,X.rightThigh,F),l=_(W.rightShin,X.rightShin,F),s=st+_(W.rightArm,X.rightArm,F),h="frantic",a="jagged"}const c={x:0,y:-this.legLength},d={x:0,y:c.y-this.torsoLength},g={x:0,y:d.y-this.headRadius},y=this.headRadius*.2,p=this.limbWidth*.5,u={x:d.x-p,y:d.y+y},m={x:d.x+p,y:d.y+y},A=this.armLength*.5,k=this.armLength*.5,w=C(u,A,e),S=C(w,k,e),T=C(m,A,s),L=C(T,k,s),v=this.legLength*.5,I=this.legLength*.5,E=C(c,v,t),K=C(E,I,t+r),$=C(c,v,i),j=C($,I,i+l);return{drawLThighAngle:t,drawRThighAngle:i,drawLShinAngle:r,drawRShinAngle:l,drawLArmAngle:e,drawRArmAngle:s,relHipPos:c,relNeckPos:d,relHeadCenter:g,relLeftShoulderPos:u,relRightShoulderPos:m,relLeftElbowPos:w,relLeftHandPos:S,relRightElbowPos:T,relRightHandPos:L,relLeftKneePos:E,relLeftFootPos:K,relRightKneePos:$,relRightFootPos:j,isDrawingItching:n,eyeStyle:h,mouthStyle:a}}draw(t){t.save(),t.translate(this.x,this.y);const i=this._getRelativeLimbPositions();if(this.isTumbling){const h=-(this.legLength+this.torsoLength/2);t.translate(0,h),t.rotate(this.rotationAngle),t.translate(0,-h)}else if(this.isBicycleKicking){const h=-(this.legLength+this.torsoLength/2);t.translate(0,h),t.rotate(this.rotationAngle),t.translate(0,-h)}t.lineWidth=this.limbWidth,t.lineCap="round",t.strokeStyle=this.teamColor,t.beginPath(),t.moveTo(i.relHipPos.x,i.relHipPos.y),t.lineTo(i.relNeckPos.x,i.relNeckPos.y),t.stroke(),t.fillStyle=this.teamColor,t.beginPath(),t.arc(i.relHeadCenter.x,i.relHeadCenter.y,this.headRadius,0,Math.PI*2),t.fill(),t.stroke();const r=this.headRadius*.18,l=this.headRadius*.4,e=i.relHeadCenter.x,s=i.relHeadCenter.y;if(i.isDrawingItching?(t.fillStyle=this.eyeColor,t.beginPath(),t.arc(e-l*.9,s+(Math.random()-.5)*3,r*1.2,0,Math.PI*2),t.fill(),t.beginPath(),t.arc(e+l*1.1,s+(Math.random()-.5)*3,r*.8,0,Math.PI*2),t.fill()):(t.fillStyle=this.eyeColor,t.beginPath(),t.arc(e-l,s,r,0,Math.PI*2),t.fill(),t.beginPath(),t.arc(e+l,s,r,0,Math.PI*2),t.fill()),i.mouthStyle==="jagged"){t.strokeStyle=B,t.lineWidth=1,t.beginPath();const h=s+l*.8;t.moveTo(e-l*.8,h);for(let a=0;a<4;a++)t.lineTo(e-l*.8+l*1.6*(a+Math.random())/4,h+(Math.random()-.5)*8);t.lineTo(e+l*.8,h),t.stroke(),t.lineWidth=this.limbWidth}t.strokeStyle=this.teamAccent,t.beginPath(),t.moveTo(i.relLeftShoulderPos.x,i.relLeftShoulderPos.y),t.lineTo(i.relLeftElbowPos.x,i.relLeftElbowPos.y),t.lineTo(i.relLeftHandPos.x,i.relLeftHandPos.y),t.stroke(),t.beginPath(),t.moveTo(i.relRightShoulderPos.x,i.relRightShoulderPos.y),t.lineTo(i.relRightElbowPos.x,i.relRightElbowPos.y),t.lineTo(i.relRightHandPos.x,i.relRightHandPos.y),t.stroke(),t.strokeStyle=this.teamColor,t.beginPath(),t.moveTo(i.relHipPos.x,i.relHipPos.y),t.lineTo(i.relLeftKneePos.x,i.relLeftKneePos.y),t.lineTo(i.relLeftFootPos.x,i.relLeftFootPos.y),t.stroke(),t.beginPath(),t.moveTo(i.relHipPos.x,i.relHipPos.y),t.lineTo(i.relRightKneePos.x,i.relRightKneePos.y),t.lineTo(i.relRightFootPos.x,i.relRightFootPos.y),t.stroke(),t.fillStyle=this.teamAccent;const n=(h,a)=>{const c=a===1?0:Math.PI;t.save(),t.translate(h.x,h.y),t.rotate(c),t.fillRect(0,-8/2,Rt,pi),t.restore()};if(n(i.relLeftFootPos,this.facingDirection),n(i.relRightFootPos,this.facingDirection),this.hasRocketLauncher){t.save();const h=this.armLength*1.1,a=this.limbWidth*.8,c=-(this.legLength+this.torsoLength*.3),d=this.facingDirection*(this.limbWidth*.5);t.translate(d,c);const g=this.facingDirection===1?0:-h;t.fillStyle="#808080",t.fillRect(g,-a/2,h,a),t.strokeStyle=B,t.lineWidth=1,t.strokeRect(g,-a/2,h,a);const y=this.facingDirection===1?h:-5;t.fillStyle="#505050",t.fillRect(g+y,-a/3,5,a*.66),t.restore()}if(this.hasBow){t.save();const h=this.facingDirection*(this.armLength*.6),a=-(this.legLength+this.torsoLength*.5);t.translate(h,a);const c=this.facingDirection===1?this.aimAngle:Math.PI-this.aimAngle;t.rotate(c);const d=this.armLength*2.2,g=this.limbWidth*.6,y=d*.2,p=-g*.8,u=d/2,m=p,A=-u,k=m,w=u,S=m+y,T=0;t.strokeStyle="#E0E0E0",t.lineWidth=1.5,t.lineCap="butt",t.beginPath(),t.moveTo(m,A),t.lineTo(k,w),t.stroke(),t.strokeStyle="#8B4513",t.lineWidth=g,t.lineCap="round",t.beginPath(),t.moveTo(m,A),t.quadraticCurveTo(S,T,k,w),t.stroke(),t.strokeStyle="red",t.lineWidth=1,t.beginPath(),t.moveTo(0,0),t.lineTo(50,0),t.stroke(),t.restore()}if(this.isSword){t.save(),t.translate(i.relRightHandPos.x,i.relRightHandPos.y);const a=(this.facingDirection===1?Math.PI*2/3:Math.PI/3)+this.swordAngle;t.rotate(a);const c=this.armLength*this.swordLengthMultiplier,d=c*.15,g=c-d,y=this.limbWidth*.8;t.fillStyle="#8B4513",t.fillRect(0,-y/2,d,y),t.fillStyle="#C0C0C0",t.fillRect(d,-y/2*.7,g,y*.7),t.strokeStyle=B,t.lineWidth=1,t.strokeRect(0,-y/2,d,y),t.strokeRect(d,-y/2*.7,g,y*.7),t.restore()}t.restore()}update(t,i,r){this.onOtherPlayerHead=!1,this.onLeftCrossbar=!1,this.onRightCrossbar=!1,this.y<i&&!this.onLeftCrossbar&&!this.onRightCrossbar&&(this.vy+=this.gravity*t);const l=this.isJumping,e=this.vy;this.y+=this.vy*t,this.x+=this.vx*t;let s=!1;const n=Ai-fi;if(this.vy>=0){const h={x:Ti,y:n,width:pt};if(this.x>=h.x&&this.x<=h.x+h.width&&this.y>=h.y&&this.y<=h.y+10&&(this.y=h.y,this.vy=0,this.isJumping=!1,this.onLeftCrossbar=!0,s=!0,l&&e>100&&R.playSound("LAND_1")),!s){const a={x:Si,y:n,width:pt};this.x>=a.x&&this.x<=a.x+a.width&&this.y>=a.y&&this.y<=a.y+10&&(this.y=a.y,this.vy=0,this.isJumping=!1,this.onRightCrossbar=!0,s=!0,l&&e>100&&R.playSound("LAND_1"))}}if(this.isSwingingSword){this.swordSwingTimer+=t;const h=Math.min(this.swordSwingTimer/this.swordSwingDuration,1),a=0,c=-this.swordSwingAngleMax*(this.facingDirection===1?1:-1);this.swordAngle=_(a,c,h),this.swordSwingTimer>=this.swordSwingDuration&&(this.isSwingingSword=!1,this.swordSwingTimer=0)}else this.swordAngle=_(this.swordAngle,0,.15),Math.abs(this.swordAngle)<.01&&(this.swordAngle=0);if(!this.isSwingingSword&&this.isKicking){this.kickTimer,this.kickTimer+=t;const c=this.kickTimer/this.kickDuration;if(c<.2){const d=ki(c/.2);this.facingDirection===1?(this.rightThighAngle=f+d*-ot,this.rightShinAngle=-ht):(this.leftThighAngle=f+d*ot,this.leftShinAngle=ht)}else if(c<1){const d=(c-.2)/.8;if(this.facingDirection===1)if(this.rightThighAngle=f+_(-ot,Lt,d),d<.5){const g=d/.5;this.rightShinAngle=_(-ht,-nt,g)}else this.rightShinAngle=-nt;else if(this.leftThighAngle=f+_(ot,-Lt,d),d<.5){const g=d/.5;this.leftShinAngle=_(ht,nt,g)}else this.leftShinAngle=nt}this.kickTimer>=this.kickDuration&&(this.kickTimer=0,this.isKicking=!1)}else if(this.isBicycleKicking){const a=[{time:0,angles:{nkThigh:f-.2*Math.PI,nkShin:.3*Math.PI,kThigh:f-.1*Math.PI,kShin:.2*Math.PI,lArm:f+.2*Math.PI,rArm:f-.2*Math.PI,rotationMag:0}},{time:.2,angles:{nkThigh:f-.7*Math.PI,nkShin:.8*Math.PI,kThigh:f+.3*Math.PI,kShin:.6*Math.PI,lArm:f+.6*Math.PI,rArm:f-.7*Math.PI,rotationMag:.4*Math.PI}},{time:.5,angles:{nkThigh:f-.9*Math.PI,nkShin:.8*Math.PI,kThigh:f-1.5*Math.PI,kShin:0*Math.PI,lArm:f-.8*Math.PI,rArm:f-.8*Math.PI,rotationMag:1*Math.PI}},{time:.75,angles:{nkThigh:f-.8*Math.PI,nkShin:.9*Math.PI,kThigh:f-.6*Math.PI,kShin:.7*Math.PI,lArm:f-.5*Math.PI,rArm:f+.5*Math.PI,rotationMag:1.6*Math.PI}},{time:1,angles:{nkThigh:f-.4*Math.PI,nkShin:.5*Math.PI,kThigh:f-.4*Math.PI,kShin:.5*Math.PI,lArm:f,rArm:f,rotationMag:2*Math.PI}}];this.bicycleKickTimer+=t;const c=Math.min(this.bicycleKickTimer/1,1);let d=a[0],g=a[1];for(let E=0;E<a.length-1;E++)if(c>=a[E].time&&c<a[E+1].time){d=a[E],g=a[E+1];break}const y=d.angles,p=g.angles,u=g.time-d.time,m=u>0?(c-d.time)/u:1,A=_(y.nkThigh,p.nkThigh,m),k=_(y.kThigh,p.kThigh,m),w=_(y.nkShin,p.nkShin,m),S=_(y.kShin,p.kShin,m),T=_(y.lArm,p.lArm,m),L=_(y.rArm,p.rArm,m),v=_(y.rotationMag,p.rotationMag,m),I=this.facingDirection!==1;I?(this.rightThighAngle=k,this.rightShinAngle=S,this.leftThighAngle=A,this.leftShinAngle=w):(this.leftThighAngle=k,this.leftShinAngle=S,this.rightThighAngle=A,this.rightShinAngle=w),this.leftArmAngle=T,this.rightArmAngle=L,this.rotationAngle=I?v:-v,c>=1&&(this.isBicycleKicking=!1,this.bicycleKickTimer=0,this.rotationAngle=0)}else if(!this.isSwingingSword){const h=this.y>=i||this.onLeftCrossbar||this.onRightCrossbar;if(this.isJumping&&!h){const a=f+Math.PI*.2,c=f-Math.PI*.2,d=-Math.PI*.2,g=It*t;this.leftThighAngle+=(a-this.leftThighAngle)*g,this.rightThighAngle+=(c-this.rightThighAngle)*g,this.leftShinAngle+=(d-this.leftShinAngle)*g,this.rightShinAngle+=(d-this.rightShinAngle)*g}else if(h&&this.vx!==0){this.walkCycleTimer+=t*di;const a=Math.sin(this.walkCycleTimer*Math.PI*2)*gt;this.leftThighAngle=f+a,this.rightThighAngle=f-a,this.leftShinAngle=a*-.5,this.rightShinAngle=-a*-.5,this.leftArmAngle=f-a*(bt/gt),this.rightArmAngle=f+a*(bt/gt)}else{const a=It*t;this.leftThighAngle+=(f-this.leftThighAngle)*a,this.rightThighAngle+=(f-this.rightThighAngle)*a,this.leftShinAngle+=(0-this.leftShinAngle)*a,this.rightShinAngle+=(0-this.rightShinAngle)*a,this.leftArmAngle+=(f-this.leftArmAngle)*a,this.rightArmAngle+=(f-this.rightArmAngle)*a}}if(this.x<0&&(this.x=0),this.x>r&&(this.x=r),!s)if(this.y>=i){const a=this.vy;this.y=i,this.vy=0,l&&(this.lastLandingVy=a,this.isJumping=!1,this.hasJumpedThisPress=!1,this.justLanded=!0,a>200&&R.playSound("LAND_2"))}else this.justLanded=!1;this.isTumbling&&(this.tumbleTimer-=t,this.rotationAngle+=this.rotationVelocity*t,this.tumbleTimer<=0&&(this.isTumbling=!1,this.tumbleTimer=0,this.rotationAngle=0,this.rotationVelocity=0,this.leftThighAngle=f,this.rightThighAngle=f,this.leftShinAngle=0,this.rightShinAngle=0,this.leftArmAngle=f,this.rightArmAngle=f)),this.isBeingPushedBack&&(this.pushbackTimer-=t,this.pushbackTimer<=0&&(this.isBeingPushedBack=!1,this.pushbackTimer=0)),this.speedBoostTimer>0&&(this.speedBoostTimer-=t,this.speedBoostTimer<=0&&this.deactivateSpeedBoost()),this.superJumpTimer>0&&(this.superJumpTimer-=t,this.superJumpTimer<=0&&this.deactivateSuperJump()),this.bigPlayerTimer>0&&(this.bigPlayerTimer-=t,this.bigPlayerTimer<=0&&this.deactivateBigPlayer()),this.isItching&&(this.itchingTimer-=t,this.itchingTimer<=0&&(this.isItching=!1,console.log(`Player ${this.teamColor} stopped itching`)))}startKick(){!this.isKicking&&!this.isStunned&&!this.isTumbling&&!this.isItching&&(this.isKicking=!0,this.kickTimer=0,this.minKickDistSq=1/0,this.kickImpactForceX=0,this.kickImpactForceY=0)}startBicycleKick(){const t=!this.isKicking&&!this.isStunned&&!this.isTumbling&&!this.isItching&&!this.isBicycleKicking;if(t||console.warn(`[Player.startBicycleKick] BLOCKED! States: isKicking=${this.isKicking}, isStunned=${this.isStunned}, isTumbling=${this.isTumbling}, isItching=${this.isItching}, isBicycleKicking=${this.isBicycleKicking}`),t){console.log(`[Player.startBicycleKick] Starting bicycle kick for player ${this.teamColor}`),this.isBicycleKicking=!0,this.bicycleKickTimer=0,this.rotationAngle=0;const i={nkThigh:f-.2*Math.PI,nkShin:.3*Math.PI,kThigh:f-.1*Math.PI,kShin:.2*Math.PI,lArm:f+.2*Math.PI,rArm:f-.2*Math.PI};this.facingDirection!==1?(this.rightThighAngle=i.kThigh,this.rightShinAngle=i.kShin,this.leftThighAngle=i.nkThigh,this.leftShinAngle=i.nkShin,this.rightArmAngle=i.rArm,this.leftArmAngle=i.lArm):(this.leftThighAngle=i.kThigh,this.leftShinAngle=i.kShin,this.rightThighAngle=i.nkThigh,this.rightShinAngle=i.nkShin,this.leftArmAngle=i.lArm,this.rightArmAngle=i.rArm),this.minKickDistSq=1/0,this.kickImpactForceX=0,this.kickImpactForceY=0,R.playSound("KICK_1")}}jump(){let t=!this.isJumping&&!this.isKicking&&!this.isStunned&&!this.isTumbling;if((this.onOtherPlayerHead||this.onLeftCrossbar||this.onRightCrossbar)&&(t=!this.isKicking&&!this.isStunned&&!this.isTumbling),t){const i=this.jumpPower*this.jumpMultiplier;this.vy=i,this.isJumping=!0,this.hasJumpedThisPress=!0,this.onOtherPlayerHead=!1,this.onLeftCrossbar=!1,this.onRightCrossbar=!1,R.playSound("JUMP_1")}}startSwordSwing(){this.isSword&&!this.isSwingingSword&&!this.isKicking&&!this.isStunned&&!this.isTumbling&&!this.isItching&&(this.isSwingingSword=!0,this.swordSwingTimer=0,this.swordAngle=0,console.log("Player started sword swing!"))}getHeadCircle(){const t={x:this.x,y:this.y-this.legLength-this.torsoLength},i={x:t.x,y:t.y-this.headRadius};return{x:i.x,y:i.y,radius:this.headRadius}}getBodyRect(){const t=this.y-this.legLength,i=this.legLength+this.torsoLength,r=this.limbWidth*2;return{x:this.x-r/2,y:t-this.torsoLength,width:r,height:i}}startTumble(){!this.isTumbling&&!this.isStunned&&(this.isTumbling=!0,this.tumbleTimer=ii,this.rotationVelocity=(Math.random()-.5)*ai,this.rotationAngle=0,this.isJumping=!1,this.onOtherPlayerHead=!1,this.onLeftCrossbar=!1,this.onRightCrossbar=!1,this.isKicking=!1,this.kickTimer=0)}getFootPosition(t){const i=t?this.rightThighAngle:this.leftThighAngle,r=t?this.rightShinAngle:this.leftShinAngle,l=this.legLength*.5,e=this.legLength*.5,s={x:this.x,y:this.y-this.legLength},n=C(s,l,i);return C(n,e,i+r)}getKickImpactPoint(){if(!this.isKicking)return null;const t=this.kickTimer/this.kickDuration;if(t<gi||t>yi)return null;const i=this.facingDirection===1,r={x:this.x,y:this.y-this.legLength},l=i?this.rightThighAngle:this.leftThighAngle,e=i?this.rightShinAngle:this.leftShinAngle,s=this.legLength*.5,n=this.legLength*.5,h=C(r,s,l);return C(h,n,l+e)}getBicycleKickImpactPoint(){if(!this.isBicycleKicking)return null;const t=1,i=[{time:0,angles:{nkThigh:f-.2*Math.PI,nkShin:.3*Math.PI,kThigh:f-.1*Math.PI,kShin:.2*Math.PI,lArm:f+.2*Math.PI,rArm:f-.2*Math.PI,rotationMag:0}},{time:.2,angles:{nkThigh:f-.7*Math.PI,nkShin:.8*Math.PI,kThigh:f+.3*Math.PI,kShin:.6*Math.PI,lArm:f+.6*Math.PI,rArm:f-.7*Math.PI,rotationMag:.4*Math.PI}},{time:.5,angles:{nkThigh:f-.9*Math.PI,nkShin:.8*Math.PI,kThigh:f-1.5*Math.PI,kShin:0*Math.PI,lArm:f-.8*Math.PI,rArm:f-.8*Math.PI,rotationMag:1*Math.PI}},{time:.75,angles:{nkThigh:f-.8*Math.PI,nkShin:.9*Math.PI,kThigh:f-.6*Math.PI,kShin:.7*Math.PI,lArm:f-.5*Math.PI,rArm:f+.5*Math.PI,rotationMag:1.6*Math.PI}},{time:1,angles:{nkThigh:f-.4*Math.PI,nkShin:.5*Math.PI,kThigh:f-.4*Math.PI,kShin:.5*Math.PI,lArm:f,rArm:f,rotationMag:2*Math.PI}}],r=Math.min(this.bicycleKickTimer/t,1);let l=i[0],e=i[1];for(let F=0;F<i.length-1;F++)if(r>=i[F].time&&r<i[F+1].time){l=i[F],e=i[F+1];break}const s=l.angles,n=e.angles,h=e.time-l.time,a=h>0?(r-l.time)/h:1,c=_(s.kThigh,n.kThigh,a),d=_(s.kShin,n.kShin,a);_(s.nkThigh,n.nkThigh,a),_(s.nkShin,n.nkShin,a);const g=this.facingDirection!==1,y=c,p=d,u=this.legLength*.5,m=this.legLength*.5,A={x:0,y:-this.legLength},k=C(A,u,y),w=C(k,m,y+p),S=0,T=-(this.legLength+this.torsoLength/2),L=w.x-S,v=w.y-T,I=Math.cos(this.rotationAngle),E=Math.sin(this.rotationAngle),K=L*I-v*E,$=L*E+v*I,j=K+S,z=$+T,U=this.x+j,Y=this.y+z;return console.log(`[BicycleKickImpact] Timer: ${this.bicycleKickTimer.toFixed(2)} Prog: ${r.toFixed(2)} Rot: ${(this.rotationAngle*180/Math.PI).toFixed(1)}Â° RelFoot: (${w.x.toFixed(1)}, ${w.y.toFixed(1)}) AbsFoot: (${U.toFixed(1)}, ${Y.toFixed(1)})`),{x:U,y:Y}}getFootHitboxes(){const t=[],i={x:this.x,y:this.y-this.legLength},r=this.legLength*.5,l=this.legLength*.5,e=Rt*.5,s=C(i,r,this.leftThighAngle),n=C(s,l,this.leftThighAngle+this.leftShinAngle),h=this.leftThighAngle+this.leftShinAngle,a=C(n,e,h);t.push({x:a.x,y:a.y,radius:Et});const c=C(i,r,this.rightThighAngle),d=C(c,l,this.rightThighAngle+this.rightShinAngle),g=this.rightThighAngle+this.rightShinAngle,y=C(d,e,g);return t.push({x:y.x,y:y.y,radius:Et}),t}getBowCenterPosition(){const t=this.facingDirection*(this.armLength*.6),i=-this.legLength-this.torsoLength*.5,r=this.x+t,l=this.y+i;return{x:r,y:l}}getSwordCollisionShape(){if(!this.isSword||!this.isSwingingSword)return null;const t=this._getRelativeLimbPositions(),i={x:this.x+t.relRightHandPos.x,y:this.y+t.relRightHandPos.y},r=this.armLength*this.swordLengthMultiplier,l=r*.15,s=(this.facingDirection===1?Math.PI*2/3:Math.PI/3)+this.swordAngle,n=l*.5,h=C(i,n,s),a=C(i,r,s);return{p1:h,p2:a}}activateSpeedBoost(){this.speedMultiplier=$t,this.speedBoostTimer=Yt,console.log("Speed Boost Activated!")}deactivateSpeedBoost(){this.speedMultiplier=1,console.log("Speed Boost Deactivated.")}activateSuperJump(){this.jumpMultiplier=Wt,this.superJumpTimer=Ut,console.log("Super Jump Activated!")}deactivateSuperJump(){this.jumpMultiplier=1,console.log("Super Jump Deactivated.")}activateBigPlayer(){this.sizeMultiplier=Xt,this.bigPlayerTimer=Jt,this.updateSizeAttributes(),console.log("Big Player Activated!")}deactivateBigPlayer(){this.sizeMultiplier=1,this.updateSizeAttributes(),console.log("Big Player Deactivated.")}fireRocket(t){if(!this.hasRocketLauncher||this.rocketAmmo<=0||this.isStunned||this.isTumbling)return null;this.rocketAmmo--,console.log(`Player ${this.facingDirection===1?1:2} fired rocket! Ammo left: ${this.rocketAmmo}`);const i=this.armLength*1.1;this.limbWidth*.8;const r=-this.legLength-this.torsoLength*.3,l=this.facingDirection*(this.limbWidth*.5),e=this.facingDirection===1?i+5:-5,s=this.x+l,n=this.y+r,h=s+this.facingDirection*e+this.facingDirection*5,a=n,c=this.facingDirection*Zt,d=0,g=new ci(h,a,c,d,this,t);return R.playSound("ROCKET_FIRE_1"),this.rocketAmmo<=0&&(this.hasRocketLauncher=!1,console.log(`Player ${this.facingDirection===1?1:2} ran out of rockets.`)),g}updateSizeAttributes(){this.headRadius=this.baseHeadRadius*this.sizeMultiplier,this.torsoLength=this.baseTorsoLength*this.sizeMultiplier,this.armLength=this.baseArmLength*this.sizeMultiplier,this.legLength=this.baseLegLength*this.sizeMultiplier}startItching(){this.isItching||(console.log(`Player ${this.teamColor} started itching!`),this.isItching=!0,this.itchingTimer=this.itchDuration,this.isKicking=!1,this.isTumbling=!1,this.isBeingPushedBack=!1)}updateAim(t,i){const r=t-this.x,l=i-this.y;this.aimAngle=Math.atan2(-l,r)}}class wi{constructor(t,i){o(this,"x");o(this,"y");o(this,"vx");o(this,"vy");o(this,"radius");o(this,"color");o(this,"rotation",0);o(this,"rotationSpeed",0);o(this,"isFrozen",!1);o(this,"freezeTimer",0);this.x=t,this.y=i,this.vx=0,this.vy=0,this.radius=jt,this.color=H}update(t){if(this.isFrozen&&this.freezeTimer&&this.freezeTimer>0){this.freezeTimer-=t,this.freezeTimer<=0&&(this.isFrozen=!1,console.log("Ball Unfrozen!"));return}const i=this.vy,r=this.vx;let l=!1;this.vy+=it*t;const e=Nt;this.vx*=e,this.vy*=e,this.x+=this.vx*t,this.y+=this.vy*t,this.rotation+=this.vx/this.radius*t,this.rotation+=this.rotationSpeed*t,this.y+this.radius>M&&(this.y=M-this.radius,i>50?(this.vy*=-.85,this.vx*=.9,l||(R.playSound("BALL_BOUNCE_1"),l=!0)):this.vy=0,this.vx*=mt),this.x-this.radius<0&&(this.y<=tt||this.y>=M)?(this.x=this.radius,r<-50?(this.vx*=-.85,l||(R.playSound("WALL_HIT_1"),l=!0)):this.vx=0):this.x+this.radius>b&&(this.y<=tt||this.y>=M)&&(this.x=b-this.radius,r>50?(this.vx*=-.85,l||(R.playSound("WALL_HIT_1"),l=!0)):this.vx=0);const s=[{x:rt,y:tt-D,width:N,height:D},{x:lt,y:tt-D,width:N,height:D}];for(const n of s)if(this.checkCircleRectCollision(this,n)){console.log("Crossbar Collision!");const h=.8,a=Math.max(n.x,Math.min(this.x,n.x+n.width)),c=Math.max(n.y,Math.min(this.y,n.y+n.height)),d=this.x-a,g=this.y-c,y=Math.sqrt(d*d+g*g)||1,p=this.radius-y;if(p>0){const u=d/y*(p+.1),m=g/y*(p+.1);this.x+=u,this.y+=m}Math.abs(d)>Math.abs(g)?(this.vx=-this.vx*h,this.vy*=.95):(g<0?(this.vy=-Math.abs(this.vy*h),this.vy>-80&&(this.vy-=80)):(this.vy=-Math.abs(this.vy*h),this.vy>-80&&(this.vy-=80),this.x+=Math.sign(this.x-(n.x+n.width/2))*1),this.vx*=.95),l||(R.playSound("CROSSBAR_HIT"),l=!0);break}}checkCircleRectCollision(t,i){const r=Math.max(i.x,Math.min(t.x,i.x+i.width)),l=Math.max(i.y,Math.min(t.y,i.y+i.height)),e=t.x-r,s=t.y-l;return e*e+s*s<t.radius*t.radius}draw(t){t.save(),t.translate(this.x,this.y),t.rotate(this.rotation),t.beginPath(),t.arc(0,0,this.radius,0,Math.PI*2),t.fillStyle=H,t.fill(),t.strokeStyle=B,t.lineWidth=1,t.stroke(),t.closePath(),t.fillStyle=B;const i=6,r=Math.PI*2/i,l=this.radius*.4,e=this.radius*.6;for(let s=0;s<i;s++){const n=s*r,h=Math.cos(n)*e,a=Math.sin(n)*e;t.beginPath();for(let c=0;c<5;c++){const d=n+c*(Math.PI*2)/5+Math.PI/5,g=h+Math.cos(d)*l,y=a+Math.sin(d)*l;c===0?t.moveTo(g,y):t.lineTo(g,y)}t.closePath(),t.fill()}this.isFrozen&&(t.beginPath(),t.arc(0,0,this.radius,0,Math.PI*2),t.fillStyle="rgba(173, 216, 230, 0.6)",t.fill(),t.closePath()),t.restore()}applyForce(t,i){this.vx+=t,this.vy+=i}applyKick(t,i){this.vx=t,this.vy=i}freeze(t){this.isFrozen=!0,this.freezeTimer=t,this.vx=0,this.vy=0,console.log(`Ball Frozen for ${t}s!`)}applyGroundFriction(){this.vx*=mt}}class Mi{constructor(t){o(this,"ctx");this.ctx=t}draw(t){switch(t.currentState){case O.WELCOME:this.drawWelcomeScreen();break;case O.PLAYING:this.drawScoreboard(t.player1Score,t.player2Score),this.drawPlayerStatusText(t);break;case O.GOAL_SCORED:this.drawScoreboard(t.player1Score,t.player2Score),this.drawGoalMessage();break;case O.MATCH_OVER:this.drawScoreboard(t.player1Score,t.player2Score),this.drawMatchOverMessage(t.player1Score,t.player2Score);break;default:this.drawScoreboard(t.player1Score,t.player2Score);break}this.drawGlobalStatusText(t)}drawWelcomeScreen(){this.ctx.fillStyle=H,this.ctx.font="40px Arial",this.ctx.textAlign="center",this.ctx.fillText("Awesome Ball 2!",b/2,G/2-50),this.ctx.font="24px Arial",this.ctx.fillText("Press Kick or Jump to Start",b/2,G/2)}drawScoreboard(t,i){const r=`${t} - ${i}`,l=32;this.ctx.font=`bold ${l}px Arial, sans-serif`,this.ctx.textAlign="center",this.ctx.textBaseline="top",this.ctx.strokeStyle=B,this.ctx.lineWidth=3,this.ctx.strokeText(r,b/2,10),this.ctx.fillStyle=H,this.ctx.fillText(r,b/2,10)}drawPlayerStatusText(t){this.ctx.font="bold 14px Arial",this.ctx.fillStyle=H,this.ctx.textAlign="center";const r=b*.25;let l=50;t.p1SpeedBoostTimer&&t.p1SpeedBoostTimer>0&&(this.ctx.fillText(`SPEED UP! ${t.p1SpeedBoostTimer.toFixed(1)}s`,r,l),l+=16),t.p1SuperJumpTimer&&t.p1SuperJumpTimer>0&&(this.ctx.fillText(`HIGH JUMP! ${t.p1SuperJumpTimer.toFixed(1)}s`,r,l),l+=16),t.p1BigPlayerTimer&&t.p1BigPlayerTimer>0&&(this.ctx.fillText(`BIG! ${t.p1BigPlayerTimer.toFixed(1)}s`,r,l),l+=16),t.player1GoalEnlargeTimer&&t.player1GoalEnlargeTimer>0&&(this.ctx.fillStyle="#FFA500",this.ctx.fillText(`GOAL ENLARGED: ${t.player1GoalEnlargeTimer.toFixed(1)}s`,r,l),this.ctx.fillStyle=H,l+=16),t.p1HasRocketLauncher&&t.p1RocketAmmo!==void 0&&t.p1RocketAmmo>0&&(this.ctx.fillStyle="#FF4500",this.ctx.fillText(`ROCKETS: ${t.p1RocketAmmo}`,r,l),this.ctx.fillStyle=H,l+=16),t.p1HasBow&&t.p1ArrowAmmo!==void 0&&t.p1ArrowAmmo>0&&(this.ctx.fillStyle="#90EE90",this.ctx.fillText(`ARROWS: ${t.p1ArrowAmmo}`,r,l),this.ctx.fillStyle=H,l+=16);const e=b*.75;let s=50;t.p2SpeedBoostTimer&&t.p2SpeedBoostTimer>0&&(this.ctx.fillText(`SPEED UP! ${t.p2SpeedBoostTimer.toFixed(1)}s`,e,s),s+=16),t.p2SuperJumpTimer&&t.p2SuperJumpTimer>0&&(this.ctx.fillText(`HIGH JUMP! ${t.p2SuperJumpTimer.toFixed(1)}s`,e,s),s+=16),t.p2BigPlayerTimer&&t.p2BigPlayerTimer>0&&(this.ctx.fillText(`BIG! ${t.p2BigPlayerTimer.toFixed(1)}s`,e,s),s+=16),t.player2GoalEnlargeTimer&&t.player2GoalEnlargeTimer>0&&(this.ctx.fillStyle="#FFA500",this.ctx.fillText(`GOAL ENLARGED: ${t.player2GoalEnlargeTimer.toFixed(1)}s`,e,s),this.ctx.fillStyle=H,s+=16),t.p2HasRocketLauncher&&t.p2RocketAmmo!==void 0&&t.p2RocketAmmo>0&&(this.ctx.fillStyle="#FF4500",this.ctx.fillText(`ROCKETS: ${t.p2RocketAmmo}`,e,s),this.ctx.fillStyle=H,s+=16),t.p2HasBow&&t.p2ArrowAmmo!==void 0&&t.p2ArrowAmmo>0&&(this.ctx.fillStyle="#90EE90",this.ctx.fillText(`ARROWS: ${t.p2ArrowAmmo}`,e,s),this.ctx.fillStyle=H,s+=16)}drawGlobalStatusText(t){if(t.ballIsFrozen&&t.ballFreezeTimer&&t.ballFreezeTimer>0){const i=`BALL FROZEN: ${t.ballFreezeTimer.toFixed(1)}s`;this.ctx.font="bold 18px Arial",this.ctx.fillStyle="rgba(173, 216, 230, 0.9)",this.ctx.textAlign="center",this.ctx.fillText(i,b/2,G-30)}}drawGoalMessage(){this.ctx.fillStyle=yt,this.ctx.font="60px Impact",this.ctx.textAlign="center",this.ctx.fillText("GOAL!",b/2,G/3)}drawMatchOverMessage(t,i){}}var x=(P=>(P.SPEED_BOOST="SPEED_BOOST",P.BIG_PLAYER="BIG_PLAYER",P.SUPER_JUMP="SUPER_JUMP",P.BALL_FREEZE="BALL_FREEZE",P.ROCKET_LAUNCHER="ROCKET_LAUNCHER",P.BOW="BOW",P.SWORD="SWORD",P.GOAL_ENLARGE="GOAL_ENLARGE",P))(x||{});class Bt{constructor(t,i,r){o(this,"x");o(this,"y");o(this,"vx");o(this,"vy");o(this,"type");o(this,"width",30);o(this,"height",30);o(this,"isActive",!0);o(this,"hasParachute",!0);o(this,"driftSpeed",30);o(this,"descendSpeed",80);o(this,"swayTimer",0);o(this,"swayMagnitude",8);o(this,"swayFrequency",2);o(this,"currentSwayOffset",0);this.x=t,this.y=i,this.type=r,this.vy=this.descendSpeed,this.vx=(Math.random()<.5?-1:1)*this.driftSpeed}update(t){this.isActive&&(this.y<M-this.height?(this.x+=this.vx*t,this.y+=this.vy*t,(this.x<0||this.x+this.width>b)&&(this.vx*=-1,this.x=Math.max(0,Math.min(this.x,b-this.width))),this.hasParachute?(this.swayTimer+=t,this.currentSwayOffset=Math.sin(this.swayTimer*this.swayFrequency*2*Math.PI)*this.swayMagnitude):this.currentSwayOffset=0,this.hasParachute&&this.y>M-this.height*3&&(this.hasParachute=!1,this.vy=150,this.currentSwayOffset=0)):(this.y=M-this.height,this.vx=0,this.vy=0,this.hasParachute=!1),this.y>G&&(this.isActive=!1))}draw(t){if(!this.isActive)return;const r=this.x+this.currentSwayOffset,l=this.y,e=this.width,s=this.height;if(this.hasParachute){const n=e*2,h=s*1.5,a=r+e/2-n/2,c=l-h-s*.2;t.fillStyle=H,t.strokeStyle=B,t.lineWidth=1,t.beginPath(),t.arc(a+n/2,c+h,n/2,Math.PI,0),t.closePath(),t.fill(),t.stroke(),t.beginPath(),t.moveTo(a,c+h),t.lineTo(r,l),t.moveTo(a+n,c+h),t.lineTo(r+e,l),t.stroke()}switch(t.save(),t.translate(r+e/2,l+s/2),t.fillStyle=H,t.strokeStyle=B,t.lineWidth=1,t.fillRect(-e/2,-s/2,e,s),t.strokeRect(-e/2,-s/2,e,s),t.lineWidth=2,t.strokeStyle=B,this.type){case"SPEED_BOOST":t.fillStyle="#FFFF00",t.beginPath(),t.moveTo(-e*.1,-s*.4),t.lineTo(e*.3,0),t.lineTo(e*.1,s*.4),t.lineTo(-e*.3,0),t.closePath(),t.fill(),t.stroke();break;case"BIG_PLAYER":t.fillStyle="#FF0000",t.beginPath(),t.moveTo(0,-s*.3),t.lineTo(e*.3,0),t.lineTo(e*.1,0),t.lineTo(e*.1,s*.3),t.lineTo(-e*.1,s*.3),t.lineTo(-e*.1,0),t.lineTo(-e*.3,0),t.closePath(),t.fill(),t.stroke();break;case"SUPER_JUMP":t.fillStyle="#00FF00",t.beginPath(),t.moveTo(-e*.3,s*.3),t.quadraticCurveTo(0,-s*.1,e*.3,s*.3),t.moveTo(-e*.3,s*.1),t.quadraticCurveTo(0,-s*.3,e*.3,s*.1),t.stroke();break;case"BALL_FREEZE":t.fillStyle="#00FFFF",t.beginPath();for(let n=0;n<6;n++){const h=Math.PI/3*n;t.moveTo(0,0),t.lineTo(Math.cos(h)*e*.4,Math.sin(h)*s*.4)}t.stroke(),t.beginPath(),t.arc(0,0,e*.15,0,Math.PI*2),t.fill();break;case"ROCKET_LAUNCHER":t.fillStyle="#808080",t.fillRect(-e*.1,-s*.4,e*.2,s*.8),t.beginPath(),t.moveTo(-e*.1,-s*.4),t.lineTo(e*.1,-s*.4),t.lineTo(0,-s*.6),t.closePath(),t.fill(),t.stroke(),t.fillRect(-e*.2,s*.2,e*.4,s*.1);break;case"BOW":t.fillStyle="#8B4513",t.strokeStyle=B,t.lineWidth=2,t.beginPath(),t.arc(0,0,e*.35,Math.PI*.6,Math.PI*1.4),t.stroke(),t.beginPath(),t.moveTo(0,-s*.35),t.lineTo(0,s*.35),t.stroke();break;case"SWORD":t.fillStyle="#A9A9A9",t.strokeStyle=B,t.lineWidth=2,t.fillRect(-e*.08,s*.1,e*.16,s*.3),t.fillRect(-e*.25,s*.05,e*.5,s*.1),t.beginPath(),t.moveTo(-e*.08,s*.05),t.lineTo(e*.08,s*.05),t.lineTo(e*.08,-s*.4),t.lineTo(0,-s*.5),t.lineTo(-e*.08,-s*.4),t.closePath(),t.fill(),t.stroke();break;case"GOAL_ENLARGE":t.fillStyle="#FFA500",t.strokeStyle=B,t.lineWidth=2,t.beginPath(),t.moveTo(0,-s*.1),t.lineTo(0,-s*.4),t.moveTo(-e*.15,-s*.3),t.lineTo(0,-s*.4),t.lineTo(e*.15,-s*.3),t.stroke(),t.beginPath(),t.moveTo(0,s*.1),t.lineTo(0,s*.4),t.moveTo(-e*.15,s*.3),t.lineTo(0,s*.4),t.lineTo(e*.15,s*.3),t.stroke(),t.beginPath(),t.moveTo(-e*.1,0),t.lineTo(-e*.4,0),t.moveTo(-e*.3,-s*.15),t.lineTo(-e*.4,0),t.lineTo(-e*.3,s*.15),t.stroke(),t.beginPath(),t.moveTo(e*.1,0),t.lineTo(e*.4,0),t.moveTo(e*.3,-s*.15),t.lineTo(e*.4,0),t.lineTo(e*.3,s*.15),t.stroke();break;default:t.fillStyle="purple",t.fillRect(-e/2,-s/2,e,s),t.strokeStyle=H,t.strokeRect(-e/2,-s/2,e,s)}t.restore()}getRect(){return{x:this.x,y:this.y,width:this.width,height:this.height}}}class bi{constructor(){o(this,"activePowerups",[]);o(this,"spawnTimer",0);o(this,"minSpawnTime",15);o(this,"maxSpawnTime",45);o(this,"nextSpawnTime",0);this.resetSpawnTimer()}resetSpawnTimer(){this.nextSpawnTime=Math.random()*(this.maxSpawnTime-this.minSpawnTime)+this.minSpawnTime,this.spawnTimer=0}spawnPowerup(){const t=[x.SPEED_BOOST,x.BIG_PLAYER,x.SUPER_JUMP,x.BALL_FREEZE,x.ROCKET_LAUNCHER,x.BOW,x.SWORD,x.GOAL_ENLARGE],i=Math.floor(Math.random()*t.length),r=t[i],l=Math.random()*(b-40)+20,e=-50,s=new Bt(l,e,r);this.activePowerups.push(s),this.resetSpawnTimer()}update(t){this.spawnTimer+=t,this.spawnTimer>=this.nextSpawnTime&&this.spawnPowerup();for(let i=this.activePowerups.length-1;i>=0;i--){const r=this.activePowerups[i];r.update(t),r.isActive||this.activePowerups.splice(i,1)}}draw(t){for(const i of this.activePowerups)i.draw(t)}checkCollisions(t){const i=t.getBodyRect();for(let r=this.activePowerups.length-1;r>=0;r--){const l=this.activePowerups[r];if(!l.isActive)continue;const e=l.getRect();if(i.x<e.x+e.width&&i.x+i.width>e.x&&i.y<e.y+e.height&&i.y+i.height>e.y){const s=l.type;return l.isActive=!1,this.activePowerups.splice(r,1),s}}return null}addPowerup(t){this.activePowerups.push(t)}}const _t=.97;class V{constructor(t,i,r,l,e,s,n=3,h=.5,a="circle"){o(this,"x");o(this,"y");o(this,"vx");o(this,"vy");o(this,"lifespan");o(this,"initialLifespan");o(this,"color");o(this,"radius");o(this,"initialRadius");o(this,"alpha",1);o(this,"gravityEffect");o(this,"isActive",!0);o(this,"particleType","circle");this.x=t,this.y=i,this.vx=r,this.vy=l,this.lifespan=e,this.initialLifespan=e,this.color=s,this.radius=n,this.initialRadius=n,this.gravityEffect=h,this.particleType=a}update(t){if(this.isActive)if(this.vy+=it*this.gravityEffect*t,this.x+=this.vx*t,this.y+=this.vy*t,this.vx*=_t,this.vy*=_t,this.lifespan-=t,this.lifespan<=0)this.alpha=0,this.isActive=!1;else{const i=Math.max(0,this.lifespan/this.initialLifespan);this.particleType==="smoke"?(this.alpha=i,this.radius=this.initialRadius*(.8+.2*i)):this.particleType==="spark"?(this.alpha=i*i,this.radius=this.initialRadius*this.alpha):(this.alpha=i,this.radius=this.initialRadius*i)}}draw(t){!this.isActive||this.alpha<=0||this.radius<=.1||(t.globalAlpha=this.alpha,t.fillStyle=this.color,t.shadowBlur,t.shadowColor,t.beginPath(),t.arc(this.x,this.y,Math.max(.5,this.radius),0,Math.PI*2),t.fill(),t.globalAlpha=1)}}class Li{constructor(){o(this,"particles",[])}addParticle(t){this.particles.push(t)}emit(t,i,r,l=10,e={}){const s=e.scale||1;switch(t){case"dust":const n=e.count!==void 0?e.count:8;for(let u=0;u<n;u++){const m=Math.random()*Math.PI*2,A=Math.random()*35+10,k=Math.cos(m)*A,w=Math.sin(m)*A*.6-3,S=Math.random()*.7+.4;let T=Math.random()*1.6+1.2;T*=s;const L=e.color||"rgba(139, 69, 19, 0.65)",v=.02;this.addParticle(new V(i,r,k,w,S,L,T,v,"smoke"))}break;case"landingDust":const h=e.count!==void 0?e.count:12;for(let u=0;u<h;u++){const m=Math.random()*Math.PI*2,A=Math.random()*40+15,k=Math.cos(m)*A,w=Math.sin(m)*A*.5-5,S=Math.random()*.8+.5;let T=Math.random()*3.4+2.4;const L=1+Math.min(2,Math.abs(e.landingVelocity||0)/500);T*=s*L;const v="rgba(255, 255, 255, 0.6)",I=.03;this.addParticle(new V(i,r,k,w,S,v,T,I,"smoke"))}break;case"goal":const a=e.count!==void 0?e.count:50;for(let u=0;u<a;u++){const m=Math.random()*Math.PI*2,A=Math.random()*90+30,k=Math.cos(m)*A,w=Math.sin(m)*A,S=Math.random()*.5+.3;let T=Math.random()*1.8+1.2;T*=s;const L=["#FFD700","#FFA500","#FF4500"],v=L[Math.floor(Math.random()*L.length)],I=.1;this.addParticle(new V(i,r,k,w,S,v,T,I,"spark"))}break;case"jump":const c=e.count!==void 0?e.count:10;for(let u=0;u<c;u++){const m=Math.random()*Math.PI*.8+Math.PI*1.1,A=Math.random()*30+8,k=Math.cos(m)*A,w=Math.sin(m)*A*.7,S=Math.random()*.6+.3;let T=Math.random()*1.7+1.2;T*=s;const L="rgba(255, 255, 255, 0.7)",v=.01;this.addParticle(new V(i,r,k,w,S,L,T,v,"smoke"))}break;case"kick":for(let u=0;u<l;u++){const m=Math.random()*Math.PI*2,A=Math.random()*60+20,k=Math.cos(m)*A*(e.kickDirection||1),w=Math.sin(m)*A-15,S=Math.random()*.35+.25;let T=Math.random()*1.4+1.1;T*=s;const L="#FFFF00",v=.1;this.addParticle(new V(i,r,k,w,S,L,T,v,"spark"))}break;case"explosion":const d=e.count!==void 0?e.count:50,g=e.radius||50;for(let u=0;u<d;u++){const m=Math.random()*Math.PI*2,A=Math.random()*(g*2.5)+g*.5,k=Math.cos(m)*A,w=Math.sin(m)*A,S=Math.random()*.6+.3;let T=Math.random()*3+2;T*=s;const L=["#FFA500","#FF4500","#FFD700","#FFFFFF","#808080"],v=L[Math.floor(Math.random()*L.length)],I=.05,E=Math.random()<.7?"spark":"smoke";this.addParticle(new V(i,r,k,w,S,v,T,I,E))}break;case"rocket_smoke":const y=e.count!==void 0?e.count:1,p=e.baseSpeed||50;for(let u=0;u<y;u++){const m=(e.vx||0)*-.02,A=(e.vy||0)*-.02,k=Math.PI/4,S=Math.atan2(e.vy||0,e.vx||0)+Math.PI+(Math.random()*k-k/2),T=p*(Math.random()*.2+.1),L=Math.cos(S)*T,v=Math.sin(S)*T,I=Math.random()*.5+.3;let E=Math.random()*1.5+1;E*=s;const K=`rgba(150, 150, 150, ${Math.random()*.3+.4})`,$=.01;this.addParticle(new V(i+m,r+A,L,v,I,K,E,$,"smoke"))}break}}update(t){for(let i=this.particles.length-1;i>=0;i--)this.particles[i].update(t),this.particles[i].isActive||this.particles.splice(i,1)}draw(t){for(const i of this.particles)i.draw(t)}clear(){this.particles=[]}}var Kt=(P=>(P.FLYING="FLYING",P.STUCK="STUCK",P))(Kt||{});function Ct(P,t,i){return{x:P.x+t*Math.cos(i),y:P.y-t*Math.sin(i)}}class Ot{constructor(t,i,r,l,e,s){o(this,"x");o(this,"y");o(this,"vx");o(this,"vy");o(this,"owner");o(this,"isActive",!0);o(this,"state","FLYING");o(this,"width",30);o(this,"thickness",2);o(this,"angle",0);o(this,"stuckToObject",null);o(this,"stuckOffsetX",0);o(this,"stuckOffsetY",0);o(this,"lastPos");o(this,"particleSystem");o(this,"length",30);o(this,"headSize",6);this.x=t,this.y=i,this.vx=r,this.vy=l,this.owner=e,this.angle=Math.atan2(l,r),this.lastPos={x:t,y:i},this.particleSystem=s}update(t){return this.isActive&&(this.lastPos={x:this.x,y:this.y},this.state==="FLYING"?(this.vy+=it*t,this.x+=this.vx*t,this.y+=this.vy*t,this.angle=Math.atan2(this.vy,this.vx),(this.x<-this.width*2||this.x>b+this.width*2||this.y>G+100||this.y<-this.width*2)&&(console.log("Arrow went way out of bounds, deactivating."),this.isActive=!1)):this.state==="STUCK"&&this.stuckToObject&&typeof this.stuckToObject=="object"&&"x"in this.stuckToObject&&"y"in this.stuckToObject&&(this.x=this.stuckToObject.x+this.stuckOffsetX,this.y=this.stuckToObject.y+this.stuckOffsetY,this.stuckToObject instanceof ct)),!1}stick(t,i,r){var l;if(this.state==="FLYING")if(this.state="STUCK",this.stuckToObject=t,this.x=i,this.y=r,this.angle=Math.atan2(this.vy,this.vx),this.vx=0,this.vy=0,t&&typeof t=="object"&&"x"in t&&"y"in t){this.stuckOffsetX=i-t.x,this.stuckOffsetY=r-t.y;let e=((l=t.constructor)==null?void 0:l.name)||"object";t instanceof ct&&(e="Player"),console.log(`Arrow Stuck to ${e} at relative offset (${this.stuckOffsetX.toFixed(1)}, ${this.stuckOffsetY.toFixed(1)})`)}else console.log(`Arrow Stuck to ${t} at (${i.toFixed(1)}, ${r.toFixed(1)})`)}getTipPosition(){return Ct({x:this.x,y:this.y},this.width*.5,this.angle)}getBasePosition(){return Ct({x:this.x,y:this.y},-this.width*.5,this.angle)}draw(t){this.isActive&&(t.save(),t.translate(this.x,this.y),t.rotate(this.angle),t.strokeStyle=this.owner.teamColor,t.lineWidth=this.thickness,t.beginPath(),t.moveTo(-this.width/2,0),t.lineTo(this.width/2,0),t.stroke(),t.fillStyle=B,t.beginPath(),t.moveTo(this.width/2,0),t.lineTo(this.width/2-6,-3),t.lineTo(this.width/2-6,3),t.closePath(),t.fill(),t.lineWidth=1,t.strokeStyle="#A0522D",t.beginPath(),t.moveTo(-this.width/2,0),t.lineTo(-this.width/2-5,-4),t.moveTo(-this.width/2,0),t.lineTo(-this.width/2-5,4),t.moveTo(-this.width/2-2,0),t.lineTo(-this.width/2-7,-4),t.moveTo(-this.width/2-2,0),t.lineTo(-this.width/2-7,4),t.stroke(),t.restore())}getCollisionShape(){const t=this.length/2,i=this.x-Math.cos(this.angle)*t,r=this.y-Math.sin(this.angle)*t,l=this.x+Math.cos(this.angle)*t,e=this.y+Math.sin(this.angle)*t;return{p1:{x:i,y:r},p2:{x:l,y:e},radius:this.thickness/2}}getLastPosition(){return this.lastPos}}const at=5,vi=1.5,xt=400;class Ri{constructor(t){o(this,"ctx");o(this,"inputHandler");o(this,"uiManager");o(this,"particleSystem");o(this,"lastTime",0);o(this,"accumulatedTime",0);o(this,"timeStep",1/Ht);o(this,"player1");o(this,"player2");o(this,"ball");o(this,"player1Score",0);o(this,"player2Score",0);o(this,"currentState",O.WELCOME);o(this,"goalMessageTimer",0);o(this,"matchOverTimer",0);o(this,"powerupManager");o(this,"activeRockets",[]);o(this,"activeArrows",[]);o(this,"isPlayer1GoalEnlarged",!1);o(this,"player1GoalEnlargeTimer",0);o(this,"isPlayer2GoalEnlarged",!1);o(this,"player2GoalEnlargeTimer",0);o(this,"player1LastKickTime",0);o(this,"player2LastKickTime",0);o(this,"isMatchOverListenerActive",!1);o(this,"handleMatchOverKeyPress",t=>{const i=t.key.toLowerCase();(i==="enter"||i==="s"||i==="arrowdown")&&(console.log(`Restart key pressed (${t.key}) after Match Over. Restarting game...`),this.startNewMatch(),this.removeMatchOverRestartListener())});this.ctx=t,this.inputHandler=new ri,this.uiManager=new Mi(t),this.powerupManager=new bi,this.particleSystem=new Li,this.player1=new ct(b*.25,M,1,"#DCDCDC","#1E1E1E",B,it,ft,ut),this.player2=new ct(b*.75,M,-1,"#009246","#CE2B37",B,it,ft,ut),this.ball=new wi(b/2,M-100)}spawnSpecificPowerup(t,i,r){const l=new Bt(i,r,t);this.powerupManager.addPowerup(l)}resetPositions(){this.ball.x=b/2,this.ball.y=M-100,this.ball.vx=0,this.ball.vy=0,this.player1.x=b*.25,this.player1.y=M,this.player1.vx=0,this.player1.vy=0,this.player1.facingDirection=1,this.player1.isKicking=!1,this.player1.isJumping=!1,this.player1.isTumbling=!1,this.player1.isStunned=!1,this.player1.stunTimer=0,this.player1.isBeingPushedBack=!1,this.player1.pushbackTimer=0,this.player1.isItching=!1,this.player1.speedMultiplier=1,this.player1.jumpMultiplier=1,this.player1.sizeMultiplier=1,this.player1.hasRocketLauncher=!1,this.player1.rocketAmmo=0,this.player1.hasBow=!1,this.player1.arrowAmmo=0,this.player1.isSword=!1,this.player2.x=b*.75,this.player2.y=M,this.player2.vx=0,this.player2.vy=0,this.player2.facingDirection=-1,this.player2.isKicking=!1,this.player2.isJumping=!1,this.player2.isTumbling=!1,this.player2.isStunned=!1,this.player2.stunTimer=0,this.player2.isBeingPushedBack=!1,this.player2.pushbackTimer=0,this.player2.isItching=!1,this.player2.speedMultiplier=1,this.player2.jumpMultiplier=1,this.player2.sizeMultiplier=1,this.player2.hasRocketLauncher=!1,this.player2.rocketAmmo=0,this.player2.hasBow=!1,this.player2.arrowAmmo=0,this.player2.isSword=!1,this.particleSystem.clear()}startNewMatch(){console.log("Executing startNewMatch..."),this.player1Score=0,this.player2Score=0,this.resetPositions(),this.activeRockets=[],this.activeArrows=[],this.powerupManager&&Array.isArray(this.powerupManager.activePowerups)?this.powerupManager.activePowerups=[]:console.warn("Could not clear powerups in PowerupManager"),this.currentState=O.PLAYING,this.particleSystem.clear(),console.log("startNewMatch finished. State set to PLAYING.")}checkGoal(){if(this.currentState!==O.PLAYING)return;const t=At;this.isPlayer1GoalEnlarged&&N*t;const i=this.isPlayer1GoalEnlarged?J*t:J,r=rt,l=M-i,e=r,s=this.isPlayer2GoalEnlarged?N*t:N,n=this.isPlayer2GoalEnlarged?J*t:J,h=lt-(s-N),a=M-n,c=h+s,d=this.ball.y>l&&this.ball.y<M,g=this.ball.y>a&&this.ball.y<M;let y=!1,p=null;d&&this.ball.x-this.ball.radius<e?(console.log("GOAL P2! (Goal Size Adjusted)"),this.player2Score++,y=!0,p=2):g&&this.ball.x+this.ball.radius>c&&(console.log("GOAL P1! (Goal Size Adjusted)"),this.player1Score++,y=!0,p=1),y&&(p===1?R.playSound("PLAYER1_GOAL_1"):p===2&&R.playSound("PLAYER2_GOAL_1"),this.particleSystem.emit("goal",this.ball.x,this.ball.y,50),this.player1Score>=at||this.player2Score>=at?(this.currentState=O.MATCH_OVER,this.matchOverTimer=3,this.player1Score>=at?R.playSound("NILS_WINS"):R.playSound("HARRY_WINS")):(this.currentState=O.GOAL_SCORED,this.goalMessageTimer=vi,this.announceScore()))}handleCollisions(){if(this.currentState!==O.PLAYING)return;const t=[this.player1,this.player2];let i=!1;const r=n=>{if(typeof n.getKickImpactPoint=="function")return n.getKickImpactPoint();if(!n.isKicking)return null;const h=n.legLength||30,a=h*.8,c=n.y-h*.5;return{x:n.x+n.facingDirection*a,y:c}};for(const n of t){const h=this.powerupManager.checkCollisions(n);h&&this.applyPowerup(n,h)}const l=this.player1.getBodyRect(),e=this.player2.getBodyRect();if(this.checkRectCollision(l,e)){const n=l.x+l.width/2-(e.x+e.width/2),h=l.width/2+e.width/2-Math.abs(n);if(h>0){const a=h/2,c=Math.sign(n)||1;this.player1.x+=a*c,this.player2.x-=a*c;const d=.3,g=this.player1.vx,y=this.player2.vx;this.player1.vx=-g*d+y*d*.5,this.player2.vx=-y*d+g*d*.5,console.log("Player-Player Body Collision"),R.playSound("PLAYER_BUMP_1")}}if(this.checkFeetOnHeadCollision(this.player1,this.player2)){const n=this.player2.getHeadCircle();this.player1.y=n.y-n.radius,this.player1.vy=0,this.player1.isJumping=!1,this.player1.onOtherPlayerHead=!0}else this.player1.onOtherPlayerHead=!1;if(this.checkFeetOnHeadCollision(this.player2,this.player1)){const n=this.player1.getHeadCircle();this.player2.y=n.y-n.radius,this.player2.vy=0,this.player2.isJumping=!1,this.player2.onOtherPlayerHead=!0}else this.player2.onOtherPlayerHead=!1;for(const n of t){if(n.isBicycleKicking&&!i){const p=n.getBicycleKickImpactPoint();if(p){const u=this.ball.x-p.x,m=this.ball.y-p.y,A=u*u+m*m,k=this.ball.radius+60,w=k*k;if(console.log(`[Bicycle Kick] Check: dist=${Math.sqrt(A).toFixed(1)}, radius=${Math.sqrt(w).toFixed(1)}`),A<w){console.log(`BICYCLE KICK CONNECT! Player: ${n===this.player1?1:2}, KickPoint: (${p.x.toFixed(1)}, ${p.y.toFixed(1)}), Ball: (${this.ball.x.toFixed(1)}, ${this.ball.y.toFixed(1)})`),R.playSound("KICK_1"),console.log("Applying Bicycle Kick force (Direction-Based)!");const T=et*2.5*1.5,L=-(n.legLength+n.torsoLength/2),v=n.x,I=n.y+L;let E=p.x-v,K=p.y-I;const $=Math.sqrt(E*E+K*K);$>0?(E/=$,K/=$):(E=n.facingDirection,K=-.5);const j=E*T,z=K*T;this.ball.applyKick(j,z),this.particleSystem.emit("kick",p.x,p.y,15,{kickDirection:n.facingDirection,isBicycle:!0}),i=!0;continue}}}if(n.isKicking&&!i){const p=n.getKickImpactPoint();if(p){const u=this.ball.x-p.x,m=this.ball.y-p.y,A=u*u+m*m,k=this.ball.radius+30,w=k*k;if(A<w){console.log(`Kick Connect! Player: ${n===this.player1?1:2}, KickPoint: (${p.x.toFixed(1)}, ${p.y.toFixed(1)}), Ball: (${this.ball.x.toFixed(1)}, ${this.ball.y.toFixed(1)}), DistSq: ${A.toFixed(1)}, RadiusSq: ${w.toFixed(1)}`),R.playSound("KICK_1");let S=0,T=0;if(n.isBicycleKicking){console.log("Applying Bicycle Kick force!");const z=2,U=1.5;S=n.facingDirection*et*z*.7,T=dt*z*U}else{const U=n.vx*.4,Y=n.vy*.4,F=n.facingDirection*et*1.5;let W=dt*1.5;const X=M-this.ball.radius*2;this.ball.y<X&&(W*=.2,console.log(`Volley kick! Ball Y: ${this.ball.y.toFixed(0)}, Threshold: ${X.toFixed(0)}. Reduced base VY to ${W.toFixed(0)}`)),S=F+U,T=W+Y,console.log(`Standard Kick Details: Base=(${F.toFixed(0)}, ${W.toFixed(0)}), Momentum=(${U.toFixed(0)}, ${Y.toFixed(0)}), Final=(${S.toFixed(0)}, ${T.toFixed(0)})`)}const L=Math.atan2(T,S),v=Math.sqrt(S*S+T*T),I=Math.PI/18,E=(Math.random()*2-1)*I,K=L+E,$=Math.cos(K)*v,j=Math.sin(K)*v;console.log(`Kick Randomness: OrigAngle=${L.toFixed(2)}, Offset=${E.toFixed(2)}, FinalAngle=${K.toFixed(2)}`),this.ball.applyKick($,j),this.particleSystem.emit("kick",p.x,p.y,n.isBicycleKicking?15:8,{kickDirection:n.facingDirection,isBicycle:n.isBicycleKicking}),i=!0;continue}}}const h=n.getHeadCircle(),a=this.ball.x-h.x,c=this.ball.y-h.y,d=a*a+c*c,g=h.radius+this.ball.radius+5,y=g*g;if(d<y&&!n.isKicking){console.log("Headbutt Connect!");const p=et*n.facingDirection*.6,u=dt*1.5,m=n.vx*.3,A=n.vy*.3;this.ball.vx=p+m,this.ball.vy=u+A,i=!0,R.playSound("HEADBUTT_1")}if(!i){const p=n.getBodyRect();if(this.checkCircleRectCollision(this.ball,p)){const u=Math.max(p.x,Math.min(this.ball.x,p.x+p.width)),m=Math.max(p.y,Math.min(this.ball.y,p.y+p.height)),A=this.ball.x-u,k=this.ball.y-m,w=A*A+k*k;if(w<this.ball.radius*this.ball.radius){const S=Math.sqrt(w),T=this.ball.radius-S;if(S>0){const E=A/S*T,K=k/S*T;this.ball.x+=E,this.ball.y+=K}const L=this.ball.vx-n.vx,v=this.ball.vy-n.vy,I=.5;this.ball.vx=n.vx+-L*I,this.ball.vy=n.vy+-v*I,R.playSound("BODY_HIT_1")}}}}const s=this.ball;(s.x-s.radius<Tt||s.x+s.radius>St)&&s.y<tt&&(s.vx*=-.85,s.x=s.x<b/2?Tt+s.radius:St-s.radius,this.particleSystem.emit("dust",s.x,s.y,8)),s.y-s.radius<0&&(s.y=s.radius,s.vy*=-.85,this.particleSystem.emit("dust",s.x,s.y,8)),s.y+s.radius>M&&(s.y=M-s.radius,s.vy*=-.85,s.applyGroundFriction(),s.rotationSpeed*=.8,Math.abs(s.vy)>20&&this.particleSystem.emit("dust",s.x,s.y,12,{color:"#A0522D"}));for(const n of t){const h=n===this.player1?this.player2:this.player1;if(n.isKicking&&!h.isTumbling&&!h.isBeingPushedBack){const a=r(n);if(a){const c=h.getHeadCircle(),d=a.x-c.x,g=a.y-c.y,y=d*d+g*g,p=c.radius+5,u=p*p;if(y<u){console.log(`Player ${n===this.player1?1:2} kicked Player ${h===this.player1?1:2} in the head! Pushback!`);const m=qt;h.vx=m*n.facingDirection,h.vy=-200,h.isJumping=!0,h.onOtherPlayerHead=!1,h.onLeftCrossbar=!1,h.onRightCrossbar=!1,h.isBeingPushedBack=!0,h.pushbackTimer=kt,R.playSound("BODY_HIT_1"),n.isKicking=!1}}}}for(let n=this.activeRockets.length-1;n>=0;n--){const h=this.activeRockets[n];if(!h.isActive)continue;const a=h.getRect();let c=!1;for(const g of t){if(g===h.owner)continue;const y=g.getBodyRect(),p=g.getHeadCircle();if(this.checkRectCollision(a,y)){console.log(`Rocket hit Player ${g===this.player1?1:2} body`),c=!0;break}if(!c&&this.checkCircleRectCollision(p,a)){console.log(`Rocket hit Player ${g===this.player1?1:2} head`),c=!0;break}}const d={x:this.ball.x,y:this.ball.y,radius:this.ball.radius};!c&&this.checkCircleRectCollision(d,a)&&(console.log("Rocket hit Ball"),c=!0),c&&(this.createExplosion(h.lastPos.x,h.lastPos.y),h.isActive=!1)}for(let n=this.activeArrows.length-1;n>=0;n--){const h=this.activeArrows[n];if(!h.isActive||h.state===Kt.STUCK)continue;let a=!1;const c=h.getTipPosition();for(const d of t){if(h.owner===d)continue;const g=d.getHeadCircle(),y=d.getBodyRect();let p=!1;const u=c.x-g.x,m=c.y-g.y;if(u*u+m*m<g.radius*g.radius?(console.log(`Arrow hit Player ${d===this.player1?1:2} head (Tip Check)`),p=!0):c.x>=y.x&&c.x<=y.x+y.width&&c.y>=y.y&&c.y<=y.y+y.height&&(console.log(`Arrow hit Player ${d===this.player1?1:2} body (Tip Check)`),p=!0),p){h.stick(d,c.x,c.y),d.startItching();const A=Math.atan2(c.y-d.y,c.x-d.x);d.vx+=Math.cos(A)*Mt,d.vy+=Math.sin(A)*Mt*.5-100,R.playSound("BODY_HIT_1"),a=!0;break}}if(!a){const d=c.x-this.ball.x,g=c.y-this.ball.y;if(d*d+g*g<this.ball.radius*this.ball.radius){const y=h.vx,p=h.vy;console.log(`[GM] Arrow hit Ball. Stored Velocity: (${y.toFixed(1)}, ${p.toFixed(1)}) (Tip Check)`);const u=1,m=y*u,A=p*u;console.log(`[GM] Calculated Force to Apply: (${m.toFixed(1)}, ${A.toFixed(1)})`),console.log("[GM] Calling ball.applyForce..."),this.ball.applyForce(m,A),console.log("[GM] Returned from ball.applyForce."),R.playSound("BODY_HIT_1"),console.log("[GM] Calling arrow.stick..."),h.stick(this.ball,c.x,c.y),console.log("[GM] Returned from arrow.stick."),a=!0}}!a&&h.y>=M-h.thickness/2&&(console.log("Arrow hit Ground (End Pos Check)"),h.stick("ground",h.x,M-h.thickness/2),a=!0)}for(const n of t){if(!n.isSword||!n.isSwingingSword)continue;const h=n.getSwordCollisionShape();if(!h)continue;const a=n===this.player1?this.player2:this.player1;if(!a.isTumbling&&!a.isBeingPushedBack){const d=a.getHeadCircle(),g=a.getBodyRect();let y=!1;if(this.checkLineCircleCollision(h.p1,h.p2,d))console.log(`Sword hit Player ${a===this.player1?1:2} head!`),y=!0;else{const p=g.x+g.width/2,u=g.y+g.height/2,m=Math.max(g.width,g.height)/1.8,A={x:p,y:u,radius:m};this.checkLineCircleCollision(h.p1,h.p2,A)&&(console.log(`Sword hit Player ${a===this.player1?1:2} body!`),y=!0)}if(y){const p=Math.sign(a.x-n.x)||1,u=-300;a.vx=p*hi,a.vy=u,a.isBeingPushedBack=!0,a.pushbackTimer=kt,a.isJumping=!0,a.onOtherPlayerHead=!1,a.onLeftCrossbar=!1,a.onRightCrossbar=!1,a.startTumble(),R.playSound("SWORD_HIT")}}const c={x:this.ball.x,y:this.ball.y,radius:this.ball.radius};if(console.log(`[Sword Check] Sword: p1=(${h.p1.x.toFixed(1)},${h.p1.y.toFixed(1)}), p2=(${h.p2.x.toFixed(1)},${h.p2.y.toFixed(1)}) | Ball: cx=${c.x.toFixed(1)}, cy=${c.y.toFixed(1)}, r=${c.radius.toFixed(1)}`),this.checkLineCircleCollision(h.p1,h.p2,c)){const d=Math.atan2(h.p2.y-h.p1.y,h.p2.x-h.p1.x),g=ni,y=Math.cos(d)*g,p=Math.sin(d)*g;this.ball.applyForce(y,p),R.playSound("SWORD_HIT_BALL")}}}checkRectCollision(t,i){return t.x<i.x+i.width&&t.x+t.width>i.x&&t.y<i.y+i.height&&t.y+t.height>i.y}checkFeetOnHeadCollision(t,i){const r=i.getHeadCircle(),l=t.x,e=t.y,s=r.y-r.radius,n=r.y,h=r.x-r.radius,a=r.x+r.radius;return l>=h&&l<=a&&e>=s&&e<=n+5&&t.vy>=0}checkCircleRectCollision(t,i){const r=Math.max(i.x,Math.min(t.x,i.x+i.width)),l=Math.max(i.y,Math.min(t.y,i.y+i.height)),e=t.x-r,s=t.y-l;return e*e+s*s<t.radius*t.radius}checkLineCircleCollision(t,i,r){const l=(i.x-t.x)*(i.x-t.x)+(i.y-t.y)*(i.y-t.y);if(l===0){const d=r.x-t.x,g=r.y-t.y;return d*d+g*g<=r.radius*r.radius}let e=((r.x-t.x)*(i.x-t.x)+(r.y-t.y)*(i.y-t.y))/l;e=Math.max(0,Math.min(1,e));const s=t.x+e*(i.x-t.x),n=t.y+e*(i.y-t.y),h=r.x-s,a=r.y-n;return h*h+a*a<=r.radius*r.radius}applyPowerup(t,i){switch(console.log(`Applying powerup ${i} to player ${t===this.player1?1:2}...`),i){case x.SPEED_BOOST:t.activateSpeedBoost();break;case x.BIG_PLAYER:t.activateBigPlayer();break;case x.SUPER_JUMP:t.activateSuperJump();break;case x.BALL_FREEZE:console.log("Calling ball.freeze()"),this.ball.freeze(zt);break;case x.ROCKET_LAUNCHER:{const e=t.hasRocketLauncher;e?t.rocketAmmo+=3:(t.hasRocketLauncher=!0,t.rocketAmmo=3),console.log(`Player ${t===this.player1?1:2} ${e?"added":"picked up"} Rocket Launcher (Ammo: ${t.rocketAmmo})`);break}case x.BOW:t.hasRocketLauncher&&(t.hasRocketLauncher=!1,t.rocketAmmo=0),t.isSword&&(t.isSword=!1);const r=t.hasBow;t.hasBow=!0,r?t.arrowAmmo+=3:t.arrowAmmo=3,t.aimAngle=0,console.log(`Player ${t===this.player1?1:2} ${r?"added arrows to":"picked up"} Bow (Ammo: ${t.arrowAmmo})`);break;case x.SWORD:t.hasRocketLauncher&&(t.hasRocketLauncher=!1,t.rocketAmmo=0),t.hasBow&&(t.hasBow=!1,t.arrowAmmo=0),t.isSword=!0,console.log(`Player ${t===this.player1?1:2} picked up Sword`);break;case x.GOAL_ENLARGE:t===this.player1?(this.isPlayer2GoalEnlarged=!0,this.player2GoalEnlargeTimer=Pt,console.log("Player 2 goal enlarged!")):(this.isPlayer1GoalEnlarged=!0,this.player1GoalEnlargeTimer=Pt,console.log("Player 1 goal enlarged!"));break;default:console.warn(`Unhandled powerup type: ${i}`)}}update(t){switch(this.inputHandler.update(),this.isPlayer1GoalEnlarged&&this.player1GoalEnlargeTimer>0&&(this.player1GoalEnlargeTimer-=t,this.player1GoalEnlargeTimer<=0&&(this.isPlayer1GoalEnlarged=!1,console.log("Player 1 goal back to normal size."))),this.isPlayer2GoalEnlarged&&this.player2GoalEnlargeTimer>0&&(this.player2GoalEnlargeTimer-=t,this.player2GoalEnlargeTimer<=0&&(this.isPlayer2GoalEnlarged=!1,console.log("Player 2 goal back to normal size."))),this.currentState===O.MATCH_OVER&&this.matchOverTimer<=0&&!this.isMatchOverListenerActive&&(console.log("Match Over timer ended. Waiting for Enter to restart..."),this.addMatchOverRestartListener()),this.currentState){case O.WELCOME:(this.inputHandler.isKeyPressed(q.JUMP)||this.inputHandler.isKeyPressed(q.KICK)||this.inputHandler.isKeyPressed(Z.JUMP)||this.inputHandler.isKeyPressed(Z.KICK))&&this.startNewMatch();break;case O.PLAYING:const r=performance.now()/1e3*si*Math.PI*2,l=Math.sin(r)*oi;this.player1.hasBow&&!this.player1.isKicking&&!this.player1.isStunned&&!this.player1.isTumbling?this.player1.aimAngle=-l:this.player1.hasBow||(this.player1.aimAngle=0),this.player2.hasBow&&!this.player2.isKicking&&!this.player2.isStunned&&!this.player2.isTumbling?this.player2.aimAngle=-l:this.player2.hasBow||(this.player2.aimAngle=0);let e=this.player1.playerSpeed*this.player1.speedMultiplier;if(this.player1.isBeingPushedBack||(this.inputHandler.isKeyPressed(q.LEFT)?(this.player1.vx=-e,this.player1.facingDirection=-1):this.inputHandler.isKeyPressed(q.RIGHT)?(this.player1.vx=e,this.player1.facingDirection=1):this.player1.vx=0),this.inputHandler.wasKeyJustPressed(q.JUMP)&&this.player1.jump(),this.inputHandler.wasKeyJustPressed(q.KICK)){const n=performance.now(),h=n-this.player1LastKickTime;if(this.player1LastKickTime>0&&h<xt)console.log("Player 1 Bicycle Kick!"),this.player1.isKicking=!1,this.player1.kickTimer=0,this.player1.startBicycleKick(),this.player1LastKickTime=0;else{let a=!1;if(this.player1.isSword&&(this.player1.startSwordSwing(),a=!0),!a&&this.player1.hasRocketLauncher&&!this.player1.isItching){const c=this.player1.fireRocket(this.particleSystem);c&&this.activeRockets.push(c),a=!0}if(!a&&this.player1.hasBow&&!this.player1.isItching){if(this.player1.arrowAmmo>0){const c=wt,d=-this.player1.aimAngle,g=this.player1.facingDirection===1?d:Math.PI-d,y=Math.cos(g)*c,p=-Math.sin(g)*c,u=this.player1.x,m=this.player1.y-this.player1.legLength-this.player1.torsoLength*.5,A=new Ot(u,m,y,p,this.player1,this.particleSystem);this.activeArrows.push(A),this.player1.arrowAmmo--,this.player1.arrowAmmo<=0&&(this.player1.hasBow=!1),R.playSound("KICK_1")}else console.log("Player 1 out of arrows!");a=!0}a||this.player1.startKick(),this.player1LastKickTime=n}}let s=this.player2.playerSpeed*this.player2.speedMultiplier;if(this.player2.isBeingPushedBack||(this.inputHandler.isKeyPressed(Z.LEFT)?(this.player2.vx=-s,this.player2.facingDirection=-1):this.inputHandler.isKeyPressed(Z.RIGHT)?(this.player2.vx=s,this.player2.facingDirection=1):this.player2.vx=0),this.inputHandler.wasKeyJustPressed(Z.JUMP)&&this.player2.jump(),this.inputHandler.wasKeyJustPressed(Z.KICK)){const n=performance.now(),h=n-this.player2LastKickTime;if(this.player2LastKickTime>0&&h<xt)console.log("Player 2 Bicycle Kick!"),this.player2.isKicking=!1,this.player2.kickTimer=0,this.player2.startBicycleKick(),this.player2LastKickTime=0;else{let a=!1;if(this.player2.isSword&&(this.player2.startSwordSwing(),a=!0),!a&&this.player2.hasRocketLauncher&&!this.player2.isItching){const c=this.player2.fireRocket(this.particleSystem);c&&this.activeRockets.push(c),a=!0}if(!a&&this.player2.hasBow&&!this.player2.isItching){if(this.player2.arrowAmmo>0){const c=wt,d=-this.player2.aimAngle,g=this.player2.facingDirection===1?d:Math.PI-d,y=Math.cos(g)*c,p=-Math.sin(g)*c,u=this.player2.x,m=this.player2.y-this.player2.legLength-this.player2.torsoLength*.5,A=new Ot(u,m,y,p,this.player2,this.particleSystem);this.activeArrows.push(A),this.player2.arrowAmmo--,this.player2.arrowAmmo<=0&&(this.player2.hasBow=!1),R.playSound("KICK_1")}else console.log("Player 2 out of arrows!");a=!0}a||this.player2.startKick(),this.player2LastKickTime=n}}this.inputHandler.wasKeyJustPressed("1")&&this.spawnSpecificPowerup(x.ROCKET_LAUNCHER,b/2,50),this.inputHandler.wasKeyJustPressed("2")&&(this.player1.isItching=!this.player1.isItching,console.log(`DEBUG: Toggled Player 1 itching: ${this.player1.isItching}`)),this.inputHandler.wasKeyJustPressed("3")&&(this.spawnSpecificPowerup(x.BOW,b/2,50),console.log("DEBUG: Spawned Bow Powerup")),this.inputHandler.wasKeyJustPressed("4")&&(this.player1.isSword=!this.player1.isSword,this.player1.isSword&&(this.player1.hasBow=!1,this.player1.hasRocketLauncher=!1),console.log(`DEBUG: Toggled Player 1 Sword: ${this.player1.isSword}`)),this.player1.isJumping&&!this.player1.hasJumpedThisPress&&(this.particleSystem.emit("jump",this.player1.x,this.player1.y,6,{scale:this.player1.sizeMultiplier}),this.player1.hasJumpedThisPress=!0),this.player2.isJumping&&!this.player2.hasJumpedThisPress&&(this.particleSystem.emit("jump",this.player2.x,this.player2.y,6,{scale:this.player2.sizeMultiplier}),this.player2.hasJumpedThisPress=!0),this.player1.update(t,M,b),this.player1.justLanded&&(this.particleSystem.emit("landingDust",this.player1.x,this.player1.y,12,{scale:this.player1.sizeMultiplier,landingVelocity:this.player1.lastLandingVy}),this.player1.justLanded=!1),this.player2.update(t,M,b),this.player2.justLanded&&(this.particleSystem.emit("landingDust",this.player2.x,this.player2.y,12,{scale:this.player2.sizeMultiplier,landingVelocity:this.player2.lastLandingVy}),this.player2.justLanded=!1),this.powerupManager.update(t);for(let n=this.activeRockets.length-1;n>=0;n--){const h=this.activeRockets[n];h.update(t),h.isActive||this.activeRockets.splice(n,1)}for(let n=this.activeArrows.length-1;n>=0;n--){const h=this.activeArrows[n];h.update(t),h.isActive||(console.log("Removing inactive arrow (OOB) from GameManager list."),this.activeArrows.splice(n,1))}this.handleCollisions(),this.ball.update(t),this.particleSystem.update(t),this.checkGoal();break;case O.GOAL_SCORED:this.goalMessageTimer-=t,this.goalMessageTimer<=0&&(this.resetPositions(),this.currentState=O.PLAYING),this.particleSystem.update(t);break;case O.MATCH_OVER:this.matchOverTimer-=t,this.matchOverTimer<=0,this.particleSystem.update(t);break}}addMatchOverRestartListener(){this.isMatchOverListenerActive||(document.addEventListener("keydown",this.handleMatchOverKeyPress),this.isMatchOverListenerActive=!0)}removeMatchOverRestartListener(){this.isMatchOverListenerActive&&(document.removeEventListener("keydown",this.handleMatchOverKeyPress),this.isMatchOverListenerActive=!1)}render(){this.ctx.clearRect(0,0,b,G),this.ctx.fillStyle="#87CEEB",this.ctx.fillRect(0,0,b,G),this.ctx.fillStyle="#228B22",this.ctx.fillRect(0,M,b,G-M),this.drawGoals(),this.ball.draw(this.ctx),this.player1.draw(this.ctx),this.player2.draw(this.ctx),this.powerupManager.draw(this.ctx);for(const i of this.activeRockets)i.draw(this.ctx);for(const i of this.activeArrows)i.draw(this.ctx);this.particleSystem.draw(this.ctx);const t={currentState:this.currentState,player1Score:this.player1Score,player2Score:this.player2Score,p1SpeedBoostTimer:this.player1.speedBoostTimer,p1SuperJumpTimer:this.player1.superJumpTimer,p1BigPlayerTimer:this.player1.bigPlayerTimer,p1HasRocketLauncher:this.player1.hasRocketLauncher,p1RocketAmmo:this.player1.rocketAmmo,p1HasBow:this.player1.hasBow,p1ArrowAmmo:this.player1.arrowAmmo,player1GoalEnlargeTimer:this.player1GoalEnlargeTimer,p2SpeedBoostTimer:this.player2.speedBoostTimer,p2SuperJumpTimer:this.player2.superJumpTimer,p2BigPlayerTimer:this.player2.bigPlayerTimer,p2HasRocketLauncher:this.player2.hasRocketLauncher,p2RocketAmmo:this.player2.rocketAmmo,p2HasBow:this.player2.hasBow,p2ArrowAmmo:this.player2.arrowAmmo,player2GoalEnlargeTimer:this.player2GoalEnlargeTimer,ballIsFrozen:this.ball.isFrozen,ballFreezeTimer:this.ball.freezeTimer,goalMessageTimer:this.goalMessageTimer,matchOverTimer:this.matchOverTimer};if(this.uiManager.draw(t),this.currentState===O.GOAL_SCORED)this.ctx.fillStyle=yt,this.ctx.font="60px Impact",this.ctx.textAlign="center",this.ctx.fillText("GOAL!",b/2,G/3);else if(this.currentState===O.MATCH_OVER){this.ctx.fillStyle=H,this.ctx.font="50px Arial",this.ctx.textAlign="center";const i=this.player1Score>=at?"Nils":"Harry";this.ctx.fillText(`${i} Wins!`,b/2,G/2-30),this.ctx.font="30px Arial",this.ctx.fillText(`Score: ${this.player1Score} - ${this.player2Score}`,b/2,G/2+20),this.matchOverTimer<=0&&(this.ctx.font="25px Arial",this.ctx.fillStyle=yt,this.ctx.fillText("Press Enter or Kick (S / â) to Play Again",b/2,G/2+70))}}gameLoop(t){const i=(t-this.lastTime)/1e3;for(this.lastTime=t,this.accumulatedTime+=i;this.accumulatedTime>=this.timeStep;)this.update(this.timeStep),this.accumulatedTime-=this.timeStep;this.render(),requestAnimationFrame(this.gameLoop.bind(this))}start(){console.log("Starting game..."),this.lastTime=performance.now(),requestAnimationFrame(this.gameLoop.bind(this))}drawGoals(){const t=Gt;this.ctx.fillStyle=t,this.ctx.strokeStyle=B,this.ctx.lineWidth=2;const i=At,r=this.isPlayer1GoalEnlarged?N*i:N,l=this.isPlayer1GoalEnlarged?J*i:J,e=rt,s=M-l,n=this.isPlayer2GoalEnlarged?N*i:N,h=this.isPlayer2GoalEnlarged?J*i:J,a=lt-(n-N),c=M-h;this.ctx.strokeStyle="rgba(240, 240, 240, 0.8)",this.ctx.lineWidth=1;const d=10;for(let u=s;u<M;u+=d)this.ctx.beginPath(),this.ctx.moveTo(e,u),this.ctx.lineTo(e+r,u),this.ctx.stroke();for(let u=e;u<e+r;u+=d)this.ctx.beginPath(),this.ctx.moveTo(u,s),this.ctx.lineTo(u,M),this.ctx.stroke();for(let u=c;u<M;u+=d)this.ctx.beginPath(),this.ctx.moveTo(a,u),this.ctx.lineTo(a+n,u),this.ctx.stroke();for(let u=a;u<a+n;u+=d)this.ctx.beginPath(),this.ctx.moveTo(u,c),this.ctx.lineTo(u,M),this.ctx.stroke();this.ctx.fillStyle=t,this.ctx.strokeStyle=B,this.ctx.lineWidth=2;const g=s-D;this.ctx.fillRect(e,g,r,D),this.ctx.strokeRect(e,g,r,D);const y=c-D;this.ctx.fillRect(a,y,n,D),this.ctx.strokeRect(a,y,n,D),this.ctx.fillRect(e,s,D,l),this.ctx.strokeRect(e,s,D,l);const p=a+n-D;this.ctx.fillRect(p,c,D,h),this.ctx.strokeRect(p,c,D,h)}createExplosion(t,i){console.log(`Creating REAL Explosion at (${t.toFixed(0)}, ${i.toFixed(0)}) with radius ${Q}`),R.playSound("ROCKET_EXPLODE_1");const r=[this.player1,this.player2],l=Q*Q;r.forEach(h=>{const a=h.x-t,c=h.y-h.torsoLength/2-i,d=a*a+c*c;if(d<l){console.log(`Player ${h===this.player1?1:2} in blast radius!`);const g=Math.sqrt(d);let y=0;if(g>0)y=c/g;else{const p=Math.random()*Math.PI*2;y=Math.sin(p)}h.vy=ei+y*.3,h.startTumble()}});const e=this.ball.x-t,s=this.ball.y-i,n=e*e+s*s;if(n<l){console.log("Ball in blast radius!");const h=Math.sqrt(n),a=1-h/Q,c=Qt*a;let d=0,g=0;if(h>0)d=e/h,g=s/h;else{const y=Math.random()*Math.PI*2;d=Math.cos(y),g=Math.sin(y)}this.ball.applyForce(d*c,g*c-ti)}this.particleSystem.emit("explosion",t,i,50,{radius:Q})}announceScore(){let i=[],r=null,l=null,e=null;this.player1Score>this.player2Score?(r="NILS_AHEAD",l="NUM_"+this.player1Score,e="NUM_"+this.player2Score):this.player2Score>this.player1Score?(r="HARRY_AHEAD",l="NUM_"+this.player2Score,e="NUM_"+this.player1Score):(l="NUM_"+this.player1Score,e="NUM_"+this.player2Score),r&&i.push(r),l&&parseInt(l.split("_")[1])<=5&&i.push(l),e&&parseInt(e.split("_")[1])<=5&&i.push(e);let s=50;const n=h=>{if(h<i.length){const a=i[h];setTimeout(()=>{console.log(`Playing score announcement sound: ${a}`),R.playSound(a),n(h+1)},1100)}};setTimeout(()=>{n(0)},s)}}document.addEventListener("DOMContentLoaded",()=>{const P=document.getElementById("gameCanvas");if(!P){console.error("Canvas element not found!");return}P.width=b,P.height=G;const t=P.getContext("2d");if(!t){console.error("Failed to get 2D context!");return}R.loadSounds().then(()=>{}).catch(r=>{console.error("Sound loading failed:",r)}),new Ri(t).start()});
