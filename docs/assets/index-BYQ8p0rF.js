var Bt=Object.defineProperty;var Kt=(P,t,i)=>t in P?Bt(P,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):P[t]=i;var s=(P,t,i)=>Kt(P,typeof t!="symbol"?t+"":t,i);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const l of document.querySelectorAll('link[rel="modulepreload"]'))r(l);new MutationObserver(l=>{for(const e of l)if(e.type==="childList")for(const h of e.addedNodes)h.tagName==="LINK"&&h.rel==="modulepreload"&&r(h)}).observe(document,{childList:!0,subtree:!0});function i(l){const e={};return l.integrity&&(e.integrity=l.integrity),l.referrerPolicy&&(e.referrerPolicy=l.referrerPolicy),l.crossOrigin==="use-credentials"?e.credentials="include":l.crossOrigin==="anonymous"?e.credentials="omit":e.credentials="same-origin",e}function r(l){if(l.ep)return;l.ep=!0;const e=i(l);fetch(l.href,e)}})();const T=800,K=600,Ft=60,H="#FFFFFF",F="#000000",Dt="#FFFFFF",Ct="#FFFF00",st=980,ut=240,ft=-450,et=600,lt=-450,Ht=.98,pt=.9,R=K-50,$t=1.5,Yt=10,Nt=1.4,Gt=10,Ut=1.5,Wt=12,Jt=5,Xt=15,U=80,gt=150,W=10,Y=R-gt,z=0,j=T-U,mt=z,Pt=j+U;var E=(P=>(P.WELCOME="WELCOME",P.PLAYING="PLAYING",P.GOAL_SCORED="GOAL_SCORED",P.MATCH_OVER="MATCH_OVER",P.GAME_OVER="GAME_OVER",P.TROPHY="TROPHY",P))(E||{});const Q={JUMP:"w",KICK:"s",LEFT:"a",RIGHT:"d"},tt={JUMP:"ArrowUp",KICK:"ArrowDown",LEFT:"ArrowLeft",RIGHT:"ArrowRight"},zt={SOUNDS:{KICK_1:"sounds/kick_ball1.mp3",KICK_2:"sounds/kick_ball2.mp3",KICK_3:"sounds/kick_ball3.mp3",JUMP_1:"sounds/jump1.mp3",LAND_1:"sounds/land1.mp3",LAND_2:"sounds/land2.mp3",WALL_HIT_1:"sounds/wall_hit1.mp3",PLAYER_BUMP_1:"sounds/player_bump1.mp3",HEADBUTT_1:"sounds/headbutt1.mp3",BODY_HIT_1:"sounds/body_hit1.mp3",SWORD_HIT:"sounds/sword_hit.mp3",SWORD_HIT_BALL:"sounds/sword_hit.mp3",CROSSBAR_HIT:"sounds/crossbar_hit.mp3",BALL_BOUNCE_1:"sounds/ball_bounce1.mp3",COMBO_SPARKLE_1:"sounds/combo_sparkle1.mp3",COMBO_SPARKLE_2:"sounds/combo_sparkle2.mp3",COMBO_SPARKLE_3:"sounds/combo_sparkle3.mp3",COMBO_SPARKLE_4:"sounds/combo_sparkle4.mp3",SUPER_JACKPOT:"sounds/super_jackpot.mp3",NILS_AHEAD:"sounds/nils_ahead.mp3",HARRY_AHEAD:"sounds/harry_ahead.mp3",NILS_WINS:"sounds/nils_wins.mp3",HARRY_WINS:"sounds/harry_wins.mp3",PLAYER1_GOAL_1:"sounds/player1_goal1.mp3",PLAYER1_GOAL_2:"sounds/player1_goal2.mp3",PLAYER1_GOAL_3:"sounds/player1_goal3.mp3",PLAYER2_GOAL_1:"sounds/player2_goal1.mp3",PLAYER2_GOAL_2:"sounds/player2_goal2.mp3",PLAYER2_GOAL_3:"sounds/player2_goal3.mp3",NUM_0:"sounds/0.mp3",NUM_1:"sounds/1.mp3",NUM_2:"sounds/2.mp3",NUM_3:"sounds/3.mp3",NUM_4:"sounds/4.mp3",NUM_5:"sounds/5.mp3"}},ot=Math.PI/2,Vt=600,jt=.2,qt=450,it=80,Zt=800,Qt=100,ti=1.5,ii=-400,At=600,St=400,si=.3,ei=Math.PI/3,kt=600,oi=800,hi=6*Math.PI;class ni{constructor(){s(this,"keys",new Set);s(this,"justPressedKeys",new Set);s(this,"previouslyPressedKeys",new Set);s(this,"justReleasedKeys",new Set);s(this,"previouslyReleasedKeys",new Set);window.addEventListener("keydown",t=>{const i=t.key.toLowerCase();this.keys.has(i)||this.justPressedKeys.add(i),this.keys.add(i)}),window.addEventListener("keyup",t=>{const i=t.key.toLowerCase();this.keys.delete(i),this.justReleasedKeys.add(i)})}update(){this.previouslyPressedKeys=new Set(this.justPressedKeys),this.justPressedKeys.clear(),this.previouslyReleasedKeys=new Set(this.justReleasedKeys),this.justReleasedKeys.clear()}isKeyPressed(t){return this.keys.has(t.toLowerCase())}wasKeyJustPressed(t){return this.previouslyPressedKeys.has(t.toLowerCase())}wasKeyJustReleased(t){return this.previouslyReleasedKeys.has(t.toLowerCase())}}class ai{constructor(){s(this,"audioContext");s(this,"soundBuffers",{});s(this,"soundsLoaded",!1);s(this,"loadingPromise",null);s(this,"activeLoops",new Map);s(this,"soundFiles",{KICK_1:"sounds/kick1.wav",KICK_2:"sounds/kick2.wav",KICK_3:"sounds/kick3.wav",JUMP_1:"sounds/jump1.wav",LAND_1:"sounds/land1.wav",LAND_2:"sounds/land2.wav",GOAL_1:"sounds/goal1.wav"});try{this.audioContext=new(window.AudioContext||window.webkitAudioContext)}catch(t){console.error("Web Audio API is not supported in this browser.",t),this.audioContext=null}}async loadSounds(){if(!this.audioContext)return console.warn("AudioContext not available, skipping sound loading."),this.soundsLoaded=!0,Promise.resolve();if(this.loadingPromise)return this.loadingPromise;if(this.soundsLoaded)return Promise.resolve();const t=zt.SOUNDS,i=[];return this.loadingPromise=new Promise(async(r,l)=>{for(const e in t)if(Object.prototype.hasOwnProperty.call(t,e)){const h=t[e];i.push(this.loadSound(e,h))}try{await Promise.all(i),this.soundsLoaded=!0,this.loadingPromise=null,r()}catch(e){console.error("Error loading one or more sounds:",e),this.loadingPromise=null,l(e)}}),this.loadingPromise}async loadSound(t,i){if(!this.audioContext)return Promise.resolve();try{const r=await fetch(i);if(!r.ok)throw new Error(`HTTP error! status: ${r.status} for ${i}`);const l=await r.arrayBuffer(),e=await this.audioContext.decodeAudioData(l);this.soundBuffers[t]=e}catch(r){console.error(`Failed to load sound: ${t} from ${i}`,r),this.soundBuffers[t]=null}}playSound(t,i=1,r=!1){var e;if(!this.audioContext||!this.soundsLoaded)return;const l=this.soundBuffers[t];if(!l){console.warn(`Sound buffer not found for key: ${t}`);return}try{const h=this.audioContext.createBufferSource();h.buffer=l;const a=this.audioContext.createGain();if(a.gain.setValueAtTime(i,this.audioContext.currentTime),h.connect(a),a.connect(this.audioContext.destination),h.loop=r,h.start(0),r){if(this.activeLoops.has(t))try{(e=this.activeLoops.get(t))==null||e.stop()}catch{}this.activeLoops.set(t,h),h.onended=()=>{this.activeLoops.get(t)===h&&this.activeLoops.delete(t)}}}catch(h){console.error(`Error playing sound ${t}:`,h)}}areSoundsLoaded(){return this.soundsLoaded}stopSound(t){if(this.activeLoops.has(t)){const i=this.activeLoops.get(t);try{i==null||i.stop(),console.log(`Stopped looped sound: ${t}`)}catch{}this.activeLoops.delete(t)}}}const x=new ai;class ri{constructor(t,i,r,l,e,h){s(this,"x");s(this,"y");s(this,"vx");s(this,"vy");s(this,"owner");s(this,"isActive",!0);s(this,"width",20);s(this,"height",8);s(this,"angle",0);s(this,"lastPos");s(this,"particleSystem");s(this,"smokeEmitTimer",0);s(this,"smokeEmitInterval",.03);this.x=t,this.y=i,this.vx=r,this.vy=l,this.owner=e,this.angle=Math.atan2(l,r),this.lastPos={x:t,y:i},this.particleSystem=h,console.log(`Rocket created by Player ${e.teamColor==="#DCDCDC"?1:2} at (${t.toFixed(0)}, ${i.toFixed(0)}) with velocity (${r.toFixed(0)}, ${l.toFixed(0)})`)}update(t){if(!this.isActive)return!1;if(this.lastPos={x:this.x,y:this.y},this.x+=this.vx*t,this.y+=this.vy*t,this.angle=Math.atan2(this.vy,this.vx),this.smokeEmitTimer+=t,this.smokeEmitTimer>=this.smokeEmitInterval){this.smokeEmitTimer-=this.smokeEmitInterval;const l=Math.sqrt(this.vx*this.vx+this.vy*this.vy),e=this.x-Math.cos(this.angle)*(this.width/2+2),h=this.y-Math.sin(this.angle)*(this.width/2+2);this.particleSystem.emit("rocket_smoke",e,h,1,{vx:this.vx,vy:this.vy,baseSpeed:l})}let i=!1,r=null;return this.y>R-this.height/2&&(this.y=R-this.height/2,i=!0,r="ground"),!i&&(this.x<-this.width||this.x>T+this.width||this.y<-this.height)?(this.isActive=!1,!1):i?(this.isActive=!1,console.log(`Explosion triggered by ${r} at (${this.lastPos.x.toFixed(0)}, ${this.lastPos.y.toFixed(0)})`),!0):!1}getRect(){const t=this.x-this.width/2,i=this.y-this.height/2;return{x:t,y:i,width:this.width,height:this.height}}draw(t){this.isActive&&(t.save(),t.translate(this.x,this.y),t.rotate(this.angle),t.fillStyle="#ff4500",t.fillRect(-this.width/2,-this.height/2,this.width,this.height),t.strokeStyle=F,t.lineWidth=1,t.strokeRect(-this.width/2,-this.height/2,this.width,this.height),t.fillStyle="yellow",t.beginPath(),t.moveTo(-this.width/2-5,0),t.lineTo(-this.width/2,-this.height/3),t.lineTo(-this.width/2,this.height/3),t.closePath(),t.fill(),t.restore())}}function C(P,t,i){return{x:P.x+t*Math.cos(i),y:P.y-t*Math.sin(i)}}const li=.0625*60,ct=Math.PI/7,Tt=Math.PI/6,f=-Math.PI/2,ht=Math.PI/2.5,wt=Math.PI/1.5,nt=Math.PI*.6,at=-Math.PI*.15,Mt=.45,ci=.15,di=.7,bt=14,gi=8,vt=9,Lt=25,yi=800,ui=8,fi=150,yt=50,pi=550,mi=pi-fi,Pi=0,Ai=yi-yt;function _(P,t,i){return P*(1-i)+t*i}function Si(P){return P*P}class rt{constructor(t,i,r,l,e,h,a,n,o){s(this,"x");s(this,"y");s(this,"vx");s(this,"vy");s(this,"baseY");s(this,"isJumping");s(this,"hasJumpedThisPress",!1);s(this,"isKicking");s(this,"isBicycleKicking",!1);s(this,"bicycleKickTimer",0);s(this,"kickTimer");s(this,"kickDuration",Mt);s(this,"walkCycleTimer");s(this,"facingDirection",1);s(this,"onOtherPlayerHead",!1);s(this,"onLeftCrossbar");s(this,"onRightCrossbar");s(this,"justLanded",!1);s(this,"lastLandingVy",0);s(this,"isStunned");s(this,"stunTimer");s(this,"isTumbling");s(this,"tumbleTimer");s(this,"rotationAngle");s(this,"rotationVelocity");s(this,"minKickDistSq",1/0);s(this,"kickImpactForceX",0);s(this,"kickImpactForceY",0);s(this,"isBeingPushedBack",!1);s(this,"pushbackTimer",0);s(this,"teamColor");s(this,"teamAccent");s(this,"eyeColor");s(this,"baseHeadRadius",8);s(this,"baseTorsoLength",36);s(this,"baseLimbWidth",10);s(this,"baseArmLength",24);s(this,"baseLegLength",32);s(this,"headRadius");s(this,"torsoLength");s(this,"limbWidth");s(this,"armLength");s(this,"legLength");s(this,"leftThighAngle",f);s(this,"rightThighAngle",f);s(this,"leftShinAngle",0);s(this,"rightShinAngle",0);s(this,"leftArmAngle",f);s(this,"rightArmAngle",f);s(this,"activePowerups",new Map);s(this,"isFlying",!1);s(this,"isBig",!1);s(this,"isShrunk",!1);s(this,"isEnormousHead",!1);s(this,"isControlsReversed",!1);s(this,"isSword",!1);s(this,"swordAngle",0);s(this,"isSwingingSword",!1);s(this,"swordSwingTimer",0);s(this,"isItching",!1);s(this,"itchingTimer",0);s(this,"itchDuration",10);s(this,"isAiming",!1);s(this,"aimAngle",0);s(this,"drawPower",0);s(this,"hasBow",!1);s(this,"arrowAmmo",0);s(this,"jumpPower");s(this,"playerSpeed");s(this,"gravity");s(this,"speedMultiplier",1);s(this,"jumpMultiplier",1);s(this,"sizeMultiplier",1);s(this,"speedBoostTimer",0);s(this,"superJumpTimer",0);s(this,"bigPlayerTimer",0);s(this,"hasRocketLauncher",!1);s(this,"rocketAmmo",0);s(this,"swordSwingDuration",.6);s(this,"swordSwingAngleMax",Math.PI*1.5);s(this,"swordLengthMultiplier",3);this.x=t,this.y=i,this.baseY=i,this.vx=0,this.vy=0,this.isJumping=!1,this.isKicking=!1,this.isBicycleKicking=!1,this.bicycleKickTimer=0,this.kickTimer=0,this.walkCycleTimer=0,this.facingDirection=r,this.hasJumpedThisPress=!1,this.justLanded=!1,this.lastLandingVy=0,this.onLeftCrossbar=!1,this.onRightCrossbar=!1,this.isStunned=!1,this.stunTimer=0,this.isTumbling=!1,this.tumbleTimer=0,this.rotationAngle=0,this.rotationVelocity=0,this.isAiming=!1,this.aimAngle=0,this.drawPower=0,this.hasBow=!1,this.teamColor=l,this.teamAccent=e,this.eyeColor=h,this.headRadius=this.baseHeadRadius,this.torsoLength=this.baseTorsoLength,this.limbWidth=this.baseLimbWidth,this.armLength=this.baseArmLength,this.legLength=this.baseLegLength,this.gravity=a,this.jumpPower=n,this.playerSpeed=o,this.kickDuration=Mt,this.updateSizeAttributes()}_getRelativeLimbPositions(){let t=this.leftThighAngle,i=this.rightThighAngle,r=this.leftShinAngle,l=this.rightShinAngle,e=this.leftArmAngle,h=this.rightArmAngle;isNaN(t)&&(t=f),isNaN(i)&&(i=f),isNaN(r)&&(r=0),isNaN(l)&&(l=0),isNaN(e)&&(e=f),isNaN(h)&&(h=f);let a=this.isItching,n="normal",o="normal";if(a){const J=Date.now()/1e3*4,N=(Math.sin(J*Math.PI)+1)/2,B=N<.5?4*N*N*N:1-Math.pow(-2*N+2,3)/2,G={leftThigh:Math.PI*.3,leftShin:Math.PI*.4,leftArm:Math.PI*.6,rightThigh:-Math.PI*.2,rightShin:-Math.PI*.1,rightArm:-Math.PI*.3},X={leftThigh:-Math.PI*.1,leftShin:-Math.PI*.2,leftArm:-Math.PI*.4,rightThigh:Math.PI*.4,rightShin:Math.PI*.5,rightArm:Math.PI*.7};t=ot+_(G.leftThigh,X.leftThigh,B),r=_(G.leftShin,X.leftShin,B),e=ot+_(G.leftArm,X.leftArm,B),i=ot+_(G.rightThigh,X.rightThigh,B),l=_(G.rightShin,X.rightShin,B),h=ot+_(G.rightArm,X.rightArm,B),n="frantic",o="jagged"}const c={x:0,y:-this.legLength},d={x:0,y:c.y-this.torsoLength},g={x:0,y:d.y-this.headRadius},y=this.headRadius*.2,u=this.limbWidth*.5,m={x:d.x-u,y:d.y+y},p={x:d.x+u,y:d.y+y},A=this.armLength*.5,w=this.armLength*.5,M=C(m,A,e),k=C(M,w,e),S=C(p,A,h),b=C(S,w,h),v=this.legLength*.5,I=this.legLength*.5,L=C(c,v,t),O=C(L,I,t+r),$=C(c,v,i),q=C($,I,i+l);return{drawLThighAngle:t,drawRThighAngle:i,drawLShinAngle:r,drawRShinAngle:l,drawLArmAngle:e,drawRArmAngle:h,relHipPos:c,relNeckPos:d,relHeadCenter:g,relLeftShoulderPos:m,relRightShoulderPos:p,relLeftElbowPos:M,relLeftHandPos:k,relRightElbowPos:S,relRightHandPos:b,relLeftKneePos:L,relLeftFootPos:O,relRightKneePos:$,relRightFootPos:q,isDrawingItching:a,eyeStyle:n,mouthStyle:o}}draw(t){t.save(),t.translate(this.x,this.y);const i=this._getRelativeLimbPositions();if(this.isTumbling){const n=-(this.legLength+this.torsoLength/2);t.translate(0,n),t.rotate(this.rotationAngle),t.translate(0,-n)}else if(this.isBicycleKicking){const n=-(this.legLength+this.torsoLength/2);t.translate(0,n),t.rotate(this.rotationAngle),t.translate(0,-n)}t.lineWidth=this.limbWidth,t.lineCap="round",t.strokeStyle=this.teamColor,t.beginPath(),t.moveTo(i.relHipPos.x,i.relHipPos.y),t.lineTo(i.relNeckPos.x,i.relNeckPos.y),t.stroke(),t.fillStyle=this.teamColor,t.beginPath(),t.arc(i.relHeadCenter.x,i.relHeadCenter.y,this.headRadius,0,Math.PI*2),t.fill(),t.stroke();const r=this.headRadius*.18,l=this.headRadius*.4,e=i.relHeadCenter.x,h=i.relHeadCenter.y;if(i.isDrawingItching?(t.fillStyle=this.eyeColor,t.beginPath(),t.arc(e-l*.9,h+(Math.random()-.5)*3,r*1.2,0,Math.PI*2),t.fill(),t.beginPath(),t.arc(e+l*1.1,h+(Math.random()-.5)*3,r*.8,0,Math.PI*2),t.fill()):(t.fillStyle=this.eyeColor,t.beginPath(),t.arc(e-l,h,r,0,Math.PI*2),t.fill(),t.beginPath(),t.arc(e+l,h,r,0,Math.PI*2),t.fill()),i.mouthStyle==="jagged"){t.strokeStyle=F,t.lineWidth=1,t.beginPath();const n=h+l*.8;t.moveTo(e-l*.8,n);for(let o=0;o<4;o++)t.lineTo(e-l*.8+l*1.6*(o+Math.random())/4,n+(Math.random()-.5)*8);t.lineTo(e+l*.8,n),t.stroke(),t.lineWidth=this.limbWidth}t.strokeStyle=this.teamAccent,t.beginPath(),t.moveTo(i.relLeftShoulderPos.x,i.relLeftShoulderPos.y),t.lineTo(i.relLeftElbowPos.x,i.relLeftElbowPos.y),t.lineTo(i.relLeftHandPos.x,i.relLeftHandPos.y),t.stroke(),t.beginPath(),t.moveTo(i.relRightShoulderPos.x,i.relRightShoulderPos.y),t.lineTo(i.relRightElbowPos.x,i.relRightElbowPos.y),t.lineTo(i.relRightHandPos.x,i.relRightHandPos.y),t.stroke(),t.strokeStyle=this.teamColor,t.beginPath(),t.moveTo(i.relHipPos.x,i.relHipPos.y),t.lineTo(i.relLeftKneePos.x,i.relLeftKneePos.y),t.lineTo(i.relLeftFootPos.x,i.relLeftFootPos.y),t.stroke(),t.beginPath(),t.moveTo(i.relHipPos.x,i.relHipPos.y),t.lineTo(i.relRightKneePos.x,i.relRightKneePos.y),t.lineTo(i.relRightFootPos.x,i.relRightFootPos.y),t.stroke(),t.fillStyle=this.teamAccent;const a=(n,o)=>{const c=o===1?0:Math.PI;t.save(),t.translate(n.x,n.y),t.rotate(c),t.fillRect(0,-8/2,bt,gi),t.restore()};if(a(i.relLeftFootPos,this.facingDirection),a(i.relRightFootPos,this.facingDirection),this.hasRocketLauncher){t.save();const n=this.armLength*1.1,o=this.limbWidth*.8,c=-(this.legLength+this.torsoLength*.3),d=this.facingDirection*(this.limbWidth*.5);t.translate(d,c);const g=this.facingDirection===1?0:-n;t.fillStyle="#808080",t.fillRect(g,-o/2,n,o),t.strokeStyle=F,t.lineWidth=1,t.strokeRect(g,-o/2,n,o);const y=this.facingDirection===1?n:-5;t.fillStyle="#505050",t.fillRect(g+y,-o/3,5,o*.66),t.restore()}if(this.hasBow){t.save();const n=this.facingDirection*(this.armLength*.6),o=-(this.legLength+this.torsoLength*.5);t.translate(n,o);const c=this.facingDirection===1?this.aimAngle:Math.PI-this.aimAngle;t.rotate(c);const d=this.armLength*2.2,g=this.limbWidth*.6,y=d*.2,u=-g*.8,m=d/2,p=u,A=-m,w=p,M=m,k=p+y,S=0;t.strokeStyle="#E0E0E0",t.lineWidth=1.5,t.lineCap="butt",t.beginPath(),t.moveTo(p,A),t.lineTo(w,M),t.stroke(),t.strokeStyle="#8B4513",t.lineWidth=g,t.lineCap="round",t.beginPath(),t.moveTo(p,A),t.quadraticCurveTo(k,S,w,M),t.stroke(),t.strokeStyle="red",t.lineWidth=1,t.beginPath(),t.moveTo(0,0),t.lineTo(50,0),t.stroke(),t.restore()}if(this.isSword){t.save(),t.translate(i.relRightHandPos.x,i.relRightHandPos.y);const o=(this.facingDirection===1?Math.PI*2/3:Math.PI/3)+this.swordAngle;t.rotate(o);const c=this.armLength*this.swordLengthMultiplier,d=c*.15,g=c-d,y=this.limbWidth*.8;t.fillStyle="#8B4513",t.fillRect(0,-y/2,d,y),t.fillStyle="#C0C0C0",t.fillRect(d,-y/2*.7,g,y*.7),t.strokeStyle=F,t.lineWidth=1,t.strokeRect(0,-y/2,d,y),t.strokeRect(d,-y/2*.7,g,y*.7),t.restore()}t.restore()}update(t,i,r){this.onOtherPlayerHead=!1,this.onLeftCrossbar=!1,this.onRightCrossbar=!1,this.y<i&&!this.onLeftCrossbar&&!this.onRightCrossbar&&(this.vy+=this.gravity*t);const l=this.isJumping,e=this.vy;this.y+=this.vy*t,this.x+=this.vx*t;let h=!1;const a=mi-ui;if(this.vy>=0){const n={x:Pi,y:a,width:yt};if(this.x>=n.x&&this.x<=n.x+n.width&&this.y>=n.y&&this.y<=n.y+10&&(this.y=n.y,this.vy=0,this.isJumping=!1,this.onLeftCrossbar=!0,h=!0,l&&e>100&&x.playSound("LAND_1")),!h){const o={x:Ai,y:a,width:yt};this.x>=o.x&&this.x<=o.x+o.width&&this.y>=o.y&&this.y<=o.y+10&&(this.y=o.y,this.vy=0,this.isJumping=!1,this.onRightCrossbar=!0,h=!0,l&&e>100&&x.playSound("LAND_1"))}}if(this.isSwingingSword){this.swordSwingTimer+=t;const n=Math.min(this.swordSwingTimer/this.swordSwingDuration,1),o=0,c=-this.swordSwingAngleMax*(this.facingDirection===1?1:-1);this.swordAngle=_(o,c,n),this.swordSwingTimer>=this.swordSwingDuration&&(this.isSwingingSword=!1,this.swordSwingTimer=0)}else this.swordAngle=_(this.swordAngle,0,.15),Math.abs(this.swordAngle)<.01&&(this.swordAngle=0);if(!this.isSwingingSword&&this.isKicking){this.kickTimer,this.kickTimer+=t;const c=this.kickTimer/this.kickDuration;if(c<.2){const d=Si(c/.2);this.facingDirection===1?(this.rightThighAngle=f+d*-ht,this.rightShinAngle=-nt):(this.leftThighAngle=f+d*ht,this.leftShinAngle=nt)}else if(c<1){const d=(c-.2)/.8;if(this.facingDirection===1)if(this.rightThighAngle=f+_(-ht,wt,d),d<.5){const g=d/.5;this.rightShinAngle=_(-nt,-at,g)}else this.rightShinAngle=-at;else if(this.leftThighAngle=f+_(ht,-wt,d),d<.5){const g=d/.5;this.leftShinAngle=_(nt,at,g)}else this.leftShinAngle=at}this.kickTimer>=this.kickDuration&&(this.kickTimer=0,this.isKicking=!1)}else if(this.isBicycleKicking){const o=[{time:0,angles:{nkThigh:f-.2*Math.PI,nkShin:.3*Math.PI,kThigh:f-.1*Math.PI,kShin:.2*Math.PI,lArm:f+.2*Math.PI,rArm:f-.2*Math.PI,rotationMag:0}},{time:.2,angles:{nkThigh:f-.7*Math.PI,nkShin:.8*Math.PI,kThigh:f+.3*Math.PI,kShin:.6*Math.PI,lArm:f+.6*Math.PI,rArm:f-.7*Math.PI,rotationMag:.4*Math.PI}},{time:.5,angles:{nkThigh:f-.9*Math.PI,nkShin:.8*Math.PI,kThigh:f-1.5*Math.PI,kShin:0*Math.PI,lArm:f-.8*Math.PI,rArm:f-.8*Math.PI,rotationMag:1*Math.PI}},{time:.75,angles:{nkThigh:f-.8*Math.PI,nkShin:.9*Math.PI,kThigh:f-.6*Math.PI,kShin:.7*Math.PI,lArm:f-.5*Math.PI,rArm:f+.5*Math.PI,rotationMag:1.6*Math.PI}},{time:1,angles:{nkThigh:f-.4*Math.PI,nkShin:.5*Math.PI,kThigh:f-.4*Math.PI,kShin:.5*Math.PI,lArm:f,rArm:f,rotationMag:2*Math.PI}}];this.bicycleKickTimer+=t;const c=Math.min(this.bicycleKickTimer/1,1);let d=o[0],g=o[1];for(let L=0;L<o.length-1;L++)if(c>=o[L].time&&c<o[L+1].time){d=o[L],g=o[L+1];break}const y=d.angles,u=g.angles,m=g.time-d.time,p=m>0?(c-d.time)/m:1,A=_(y.nkThigh,u.nkThigh,p),w=_(y.kThigh,u.kThigh,p),M=_(y.nkShin,u.nkShin,p),k=_(y.kShin,u.kShin,p),S=_(y.lArm,u.lArm,p),b=_(y.rArm,u.rArm,p),v=_(y.rotationMag,u.rotationMag,p),I=this.facingDirection!==1;I?(this.rightThighAngle=w,this.rightShinAngle=k,this.leftThighAngle=A,this.leftShinAngle=M):(this.leftThighAngle=w,this.leftShinAngle=k,this.rightThighAngle=A,this.rightShinAngle=M),this.leftArmAngle=S,this.rightArmAngle=b,this.rotationAngle=I?v:-v,c>=1&&(this.isBicycleKicking=!1,this.bicycleKickTimer=0,this.rotationAngle=0)}else if(!this.isSwingingSword){const n=this.y>=i||this.onLeftCrossbar||this.onRightCrossbar;if(this.isJumping&&!n){const o=f+Math.PI*.2,c=f-Math.PI*.2,d=-Math.PI*.2,g=Lt*t;this.leftThighAngle+=(o-this.leftThighAngle)*g,this.rightThighAngle+=(c-this.rightThighAngle)*g,this.leftShinAngle+=(d-this.leftShinAngle)*g,this.rightShinAngle+=(d-this.rightShinAngle)*g}else if(n&&this.vx!==0){this.walkCycleTimer+=t*li;const o=Math.sin(this.walkCycleTimer*Math.PI*2)*ct;this.leftThighAngle=f+o,this.rightThighAngle=f-o,this.leftShinAngle=o*-.5,this.rightShinAngle=-o*-.5,this.leftArmAngle=f-o*(Tt/ct),this.rightArmAngle=f+o*(Tt/ct)}else{const o=Lt*t;this.leftThighAngle+=(f-this.leftThighAngle)*o,this.rightThighAngle+=(f-this.rightThighAngle)*o,this.leftShinAngle+=(0-this.leftShinAngle)*o,this.rightShinAngle+=(0-this.rightShinAngle)*o,this.leftArmAngle+=(f-this.leftArmAngle)*o,this.rightArmAngle+=(f-this.rightArmAngle)*o}}if(this.x<0&&(this.x=0),this.x>r&&(this.x=r),!h)if(this.y>=i){const o=this.vy;this.y=i,this.vy=0,l&&(this.lastLandingVy=o,this.isJumping=!1,this.hasJumpedThisPress=!1,this.justLanded=!0,o>200&&x.playSound("LAND_2"))}else this.justLanded=!1;this.isTumbling&&(this.tumbleTimer-=t,this.rotationAngle+=this.rotationVelocity*t,this.tumbleTimer<=0&&(this.isTumbling=!1,this.tumbleTimer=0,this.rotationAngle=0,this.rotationVelocity=0,this.leftThighAngle=f,this.rightThighAngle=f,this.leftShinAngle=0,this.rightShinAngle=0,this.leftArmAngle=f,this.rightArmAngle=f)),this.isBeingPushedBack&&(this.pushbackTimer-=t,this.pushbackTimer<=0&&(this.isBeingPushedBack=!1,this.pushbackTimer=0)),this.speedBoostTimer>0&&(this.speedBoostTimer-=t,this.speedBoostTimer<=0&&this.deactivateSpeedBoost()),this.superJumpTimer>0&&(this.superJumpTimer-=t,this.superJumpTimer<=0&&this.deactivateSuperJump()),this.bigPlayerTimer>0&&(this.bigPlayerTimer-=t,this.bigPlayerTimer<=0&&this.deactivateBigPlayer()),this.isItching&&(this.itchingTimer-=t,this.itchingTimer<=0&&(this.isItching=!1,console.log(`Player ${this.teamColor} stopped itching`)))}startKick(){!this.isKicking&&!this.isStunned&&!this.isTumbling&&!this.isItching&&(this.isKicking=!0,this.kickTimer=0,this.minKickDistSq=1/0,this.kickImpactForceX=0,this.kickImpactForceY=0)}startBicycleKick(){const t=!this.isKicking&&!this.isStunned&&!this.isTumbling&&!this.isItching&&!this.isBicycleKicking;if(t||console.warn(`[Player.startBicycleKick] BLOCKED! States: isKicking=${this.isKicking}, isStunned=${this.isStunned}, isTumbling=${this.isTumbling}, isItching=${this.isItching}, isBicycleKicking=${this.isBicycleKicking}`),t){console.log(`[Player.startBicycleKick] Starting bicycle kick for player ${this.teamColor}`),this.isBicycleKicking=!0,this.bicycleKickTimer=0,this.rotationAngle=0;const i={nkThigh:f-.2*Math.PI,nkShin:.3*Math.PI,kThigh:f-.1*Math.PI,kShin:.2*Math.PI,lArm:f+.2*Math.PI,rArm:f-.2*Math.PI};this.facingDirection!==1?(this.rightThighAngle=i.kThigh,this.rightShinAngle=i.kShin,this.leftThighAngle=i.nkThigh,this.leftShinAngle=i.nkShin,this.rightArmAngle=i.rArm,this.leftArmAngle=i.lArm):(this.leftThighAngle=i.kThigh,this.leftShinAngle=i.kShin,this.rightThighAngle=i.nkThigh,this.rightShinAngle=i.nkShin,this.leftArmAngle=i.lArm,this.rightArmAngle=i.rArm),this.minKickDistSq=1/0,this.kickImpactForceX=0,this.kickImpactForceY=0,x.playSound("KICK_1")}}jump(){let t=!this.isJumping&&!this.isKicking&&!this.isStunned&&!this.isTumbling;if((this.onOtherPlayerHead||this.onLeftCrossbar||this.onRightCrossbar)&&(t=!this.isKicking&&!this.isStunned&&!this.isTumbling),t){const i=this.jumpPower*this.jumpMultiplier;this.vy=i,this.isJumping=!0,this.hasJumpedThisPress=!0,this.onOtherPlayerHead=!1,this.onLeftCrossbar=!1,this.onRightCrossbar=!1,x.playSound("JUMP_1")}}startSwordSwing(){this.isSword&&!this.isSwingingSword&&!this.isKicking&&!this.isStunned&&!this.isTumbling&&!this.isItching&&(this.isSwingingSword=!0,this.swordSwingTimer=0,this.swordAngle=0,console.log("Player started sword swing!"))}getHeadCircle(){const t={x:this.x,y:this.y-this.legLength-this.torsoLength},i={x:t.x,y:t.y-this.headRadius};return{x:i.x,y:i.y,radius:this.headRadius}}getBodyRect(){const t=this.y-this.legLength,i=this.legLength+this.torsoLength,r=this.limbWidth*2;return{x:this.x-r/2,y:t-this.torsoLength,width:r,height:i}}startTumble(){!this.isTumbling&&!this.isStunned&&(this.isTumbling=!0,this.tumbleTimer=ti,this.rotationVelocity=(Math.random()-.5)*hi,this.rotationAngle=0,this.isJumping=!1,this.onOtherPlayerHead=!1,this.onLeftCrossbar=!1,this.onRightCrossbar=!1,this.isKicking=!1,this.kickTimer=0)}getFootPosition(t){const i=t?this.rightThighAngle:this.leftThighAngle,r=t?this.rightShinAngle:this.leftShinAngle,l=this.legLength*.5,e=this.legLength*.5,h={x:this.x,y:this.y-this.legLength},a=C(h,l,i);return C(a,e,i+r)}getKickImpactPoint(){if(!this.isKicking)return null;const t=this.kickTimer/this.kickDuration;if(t<ci||t>di)return null;const i=this.facingDirection===1,r={x:this.x,y:this.y-this.legLength},l=i?this.rightThighAngle:this.leftThighAngle,e=i?this.rightShinAngle:this.leftShinAngle,h=this.legLength*.5,a=this.legLength*.5,n=C(r,h,l);return C(n,a,l+e)}getBicycleKickImpactPoint(){if(!this.isBicycleKicking)return null;const t=1,i=[{time:0,angles:{nkThigh:f-.2*Math.PI,nkShin:.3*Math.PI,kThigh:f-.1*Math.PI,kShin:.2*Math.PI,lArm:f+.2*Math.PI,rArm:f-.2*Math.PI,rotationMag:0}},{time:.2,angles:{nkThigh:f-.7*Math.PI,nkShin:.8*Math.PI,kThigh:f+.3*Math.PI,kShin:.6*Math.PI,lArm:f+.6*Math.PI,rArm:f-.7*Math.PI,rotationMag:.4*Math.PI}},{time:.5,angles:{nkThigh:f-.9*Math.PI,nkShin:.8*Math.PI,kThigh:f-1.5*Math.PI,kShin:0*Math.PI,lArm:f-.8*Math.PI,rArm:f-.8*Math.PI,rotationMag:1*Math.PI}},{time:.75,angles:{nkThigh:f-.8*Math.PI,nkShin:.9*Math.PI,kThigh:f-.6*Math.PI,kShin:.7*Math.PI,lArm:f-.5*Math.PI,rArm:f+.5*Math.PI,rotationMag:1.6*Math.PI}},{time:1,angles:{nkThigh:f-.4*Math.PI,nkShin:.5*Math.PI,kThigh:f-.4*Math.PI,kShin:.5*Math.PI,lArm:f,rArm:f,rotationMag:2*Math.PI}}],r=Math.min(this.bicycleKickTimer/t,1);let l=i[0],e=i[1];for(let B=0;B<i.length-1;B++)if(r>=i[B].time&&r<i[B+1].time){l=i[B],e=i[B+1];break}const h=l.angles,a=e.angles,n=e.time-l.time,o=n>0?(r-l.time)/n:1,c=_(h.kThigh,a.kThigh,o),d=_(h.kShin,a.kShin,o);_(h.nkThigh,a.nkThigh,o),_(h.nkShin,a.nkShin,o);const g=this.facingDirection!==1,y=c,u=d,m=this.legLength*.5,p=this.legLength*.5,A={x:0,y:-this.legLength},w=C(A,m,y),M=C(w,p,y+u),k=0,S=-(this.legLength+this.torsoLength/2),b=M.x-k,v=M.y-S,I=Math.cos(this.rotationAngle),L=Math.sin(this.rotationAngle),O=b*I-v*L,$=b*L+v*I,q=O+k,V=$+S,J=this.x+q,N=this.y+V;return console.log(`[BicycleKickImpact] Timer: ${this.bicycleKickTimer.toFixed(2)} Prog: ${r.toFixed(2)} Rot: ${(this.rotationAngle*180/Math.PI).toFixed(1)}° RelFoot: (${M.x.toFixed(1)}, ${M.y.toFixed(1)}) AbsFoot: (${J.toFixed(1)}, ${N.toFixed(1)})`),{x:J,y:N}}getFootHitboxes(){const t=[],i={x:this.x,y:this.y-this.legLength},r=this.legLength*.5,l=this.legLength*.5,e=bt*.5,h=C(i,r,this.leftThighAngle),a=C(h,l,this.leftThighAngle+this.leftShinAngle),n=this.leftThighAngle+this.leftShinAngle,o=C(a,e,n);t.push({x:o.x,y:o.y,radius:vt});const c=C(i,r,this.rightThighAngle),d=C(c,l,this.rightThighAngle+this.rightShinAngle),g=this.rightThighAngle+this.rightShinAngle,y=C(d,e,g);return t.push({x:y.x,y:y.y,radius:vt}),t}getBowCenterPosition(){const t=this.facingDirection*(this.armLength*.6),i=-this.legLength-this.torsoLength*.5,r=this.x+t,l=this.y+i;return{x:r,y:l}}getSwordCollisionShape(){if(!this.isSword||!this.isSwingingSword)return null;const t=this._getRelativeLimbPositions(),i={x:this.x+t.relRightHandPos.x,y:this.y+t.relRightHandPos.y},r=this.armLength*this.swordLengthMultiplier,l=r*.15,h=(this.facingDirection===1?Math.PI*2/3:Math.PI/3)+this.swordAngle,a=l*.5,n=C(i,a,h),o=C(i,r,h);return{p1:n,p2:o}}activateSpeedBoost(){this.speedMultiplier=$t,this.speedBoostTimer=Yt,console.log("Speed Boost Activated!")}deactivateSpeedBoost(){this.speedMultiplier=1,console.log("Speed Boost Deactivated.")}activateSuperJump(){this.jumpMultiplier=Nt,this.superJumpTimer=Gt,console.log("Super Jump Activated!")}deactivateSuperJump(){this.jumpMultiplier=1,console.log("Super Jump Deactivated.")}activateBigPlayer(){this.sizeMultiplier=Ut,this.bigPlayerTimer=Wt,this.updateSizeAttributes(),console.log("Big Player Activated!")}deactivateBigPlayer(){this.sizeMultiplier=1,this.updateSizeAttributes(),console.log("Big Player Deactivated.")}fireRocket(t){if(!this.hasRocketLauncher||this.rocketAmmo<=0||this.isStunned||this.isTumbling)return null;this.rocketAmmo--,console.log(`Player ${this.facingDirection===1?1:2} fired rocket! Ammo left: ${this.rocketAmmo}`);const i=this.armLength*1.1;this.limbWidth*.8;const r=-this.legLength-this.torsoLength*.3,l=this.facingDirection*(this.limbWidth*.5),e=this.facingDirection===1?i+5:-5,h=this.x+l,a=this.y+r,n=h+this.facingDirection*e+this.facingDirection*5,o=a,c=this.facingDirection*qt,d=0,g=new ri(n,o,c,d,this,t);return x.playSound("ROCKET_FIRE_1"),this.rocketAmmo<=0&&(this.hasRocketLauncher=!1,console.log(`Player ${this.facingDirection===1?1:2} ran out of rockets.`)),g}updateSizeAttributes(){this.headRadius=this.baseHeadRadius*this.sizeMultiplier,this.torsoLength=this.baseTorsoLength*this.sizeMultiplier,this.armLength=this.baseArmLength*this.sizeMultiplier,this.legLength=this.baseLegLength*this.sizeMultiplier}startItching(){this.isItching||(console.log(`Player ${this.teamColor} started itching!`),this.isItching=!0,this.itchingTimer=this.itchDuration,this.isKicking=!1,this.isTumbling=!1,this.isBeingPushedBack=!1)}updateAim(t,i){const r=t-this.x,l=i-this.y;this.aimAngle=Math.atan2(-l,r)}}class ki{constructor(t,i){s(this,"x");s(this,"y");s(this,"vx");s(this,"vy");s(this,"radius");s(this,"color");s(this,"rotation",0);s(this,"rotationSpeed",0);s(this,"isFrozen",!1);s(this,"freezeTimer",0);this.x=t,this.y=i,this.vx=0,this.vy=0,this.radius=Xt,this.color=H}update(t){if(console.log(`[Ball] Update START: vx=${this.vx.toFixed(1)}, vy=${this.vy.toFixed(1)}`),this.isFrozen&&this.freezeTimer&&this.freezeTimer>0){this.freezeTimer-=t,this.freezeTimer<=0&&(this.isFrozen=!1,console.log("Ball Unfrozen!"));return}const i=this.vy,r=this.vx;let l=!1;this.vy+=st*t;const e=Ht;this.vx*=e,this.vy*=e,this.x+=this.vx*t,this.y+=this.vy*t,this.rotation+=this.vx/this.radius*t,this.rotation+=this.rotationSpeed*t,this.y+this.radius>R&&(this.y=R-this.radius,i>50?(this.vy*=-.85,this.vx*=.9,l||(x.playSound("BALL_BOUNCE_1"),l=!0)):this.vy=0,this.vx*=pt),this.x-this.radius<0&&(this.y<=Y||this.y>=R)?(this.x=this.radius,r<-50?(this.vx*=-.85,l||(x.playSound("WALL_HIT_1"),l=!0)):this.vx=0):this.x+this.radius>T&&(this.y<=Y||this.y>=R)&&(this.x=T-this.radius,r>50?(this.vx*=-.85,l||(x.playSound("WALL_HIT_1"),l=!0)):this.vx=0);const h=[{x:z,y:Y-W,width:U,height:W},{x:j,y:Y-W,width:U,height:W}];for(const a of h)if(this.checkCircleRectCollision(this,a)){console.log("Crossbar Collision!");const n=.8,o=Math.max(a.x,Math.min(this.x,a.x+a.width)),c=Math.max(a.y,Math.min(this.y,a.y+a.height)),d=this.x-o,g=this.y-c,y=Math.sqrt(d*d+g*g)||1,u=this.radius-y;if(u>0){const m=d/y*(u+.1),p=g/y*(u+.1);this.x+=m,this.y+=p}Math.abs(d)>Math.abs(g)?(this.vx=-this.vx*n,this.vy*=.95):(g<0?(this.vy=-Math.abs(this.vy*n),this.vy>-80&&(this.vy-=80)):(this.vy=-Math.abs(this.vy*n),this.vy>-80&&(this.vy-=80),this.x+=Math.sign(this.x-(a.x+a.width/2))*1),this.vx*=.95),l||(x.playSound("CROSSBAR_HIT"),l=!0);break}}checkCircleRectCollision(t,i){const r=Math.max(i.x,Math.min(t.x,i.x+i.width)),l=Math.max(i.y,Math.min(t.y,i.y+i.height)),e=t.x-r,h=t.y-l;return e*e+h*h<t.radius*t.radius}draw(t){t.save(),t.translate(this.x,this.y),t.rotate(this.rotation),t.beginPath(),t.arc(0,0,this.radius,0,Math.PI*2),t.fillStyle=H,t.fill(),t.strokeStyle=F,t.lineWidth=1,t.stroke(),t.closePath(),t.fillStyle=F;const i=6,r=Math.PI*2/i,l=this.radius*.4,e=this.radius*.6;for(let h=0;h<i;h++){const a=h*r,n=Math.cos(a)*e,o=Math.sin(a)*e;t.beginPath();for(let c=0;c<5;c++){const d=a+c*(Math.PI*2)/5+Math.PI/5,g=n+Math.cos(d)*l,y=o+Math.sin(d)*l;c===0?t.moveTo(g,y):t.lineTo(g,y)}t.closePath(),t.fill()}this.isFrozen&&(t.beginPath(),t.arc(0,0,this.radius,0,Math.PI*2),t.fillStyle="rgba(173, 216, 230, 0.6)",t.fill(),t.closePath()),t.restore()}applyForce(t,i){this.vx+=t,this.vy+=i}applyKick(t,i){this.vx=t,this.vy=i}freeze(t){this.isFrozen=!0,this.freezeTimer=t,this.vx=0,this.vy=0,console.log(`Ball Frozen for ${t}s!`)}applyGroundFriction(){this.vx*=pt}}class Ti{constructor(t){s(this,"ctx");this.ctx=t}draw(t){switch(t.currentState){case E.WELCOME:this.drawWelcomeScreen();break;case E.PLAYING:this.drawScoreboard(t.player1Score,t.player2Score),this.drawPlayerStatusText(t);break;case E.GOAL_SCORED:this.drawScoreboard(t.player1Score,t.player2Score),this.drawGoalMessage();break;case E.MATCH_OVER:this.drawScoreboard(t.player1Score,t.player2Score),this.drawMatchOverMessage(t.player1Score,t.player2Score);break;default:this.drawScoreboard(t.player1Score,t.player2Score);break}this.drawGlobalStatusText(t)}drawWelcomeScreen(){this.ctx.fillStyle=H,this.ctx.font="40px Arial",this.ctx.textAlign="center",this.ctx.fillText("Awesome Ball 2!",T/2,K/2-50),this.ctx.font="24px Arial",this.ctx.fillText("Press Kick or Jump to Start",T/2,K/2)}drawScoreboard(t,i){const r=`${t} - ${i}`,l=32;this.ctx.font=`bold ${l}px Arial, sans-serif`,this.ctx.textAlign="center",this.ctx.textBaseline="top",this.ctx.strokeStyle=F,this.ctx.lineWidth=3,this.ctx.strokeText(r,T/2,10),this.ctx.fillStyle=H,this.ctx.fillText(r,T/2,10)}drawPlayerStatusText(t){this.ctx.font="bold 14px Arial",this.ctx.fillStyle=H,this.ctx.textAlign="center";const r=T*.25;let l=50;t.p1SpeedBoostTimer&&t.p1SpeedBoostTimer>0&&(this.ctx.fillText(`SPEED UP! ${t.p1SpeedBoostTimer.toFixed(1)}s`,r,l),l+=16),t.p1SuperJumpTimer&&t.p1SuperJumpTimer>0&&(this.ctx.fillText(`HIGH JUMP! ${t.p1SuperJumpTimer.toFixed(1)}s`,r,l),l+=16),t.p1BigPlayerTimer&&t.p1BigPlayerTimer>0&&(this.ctx.fillText(`BIG! ${t.p1BigPlayerTimer.toFixed(1)}s`,r,l),l+=16),t.p1HasRocketLauncher&&t.p1RocketAmmo!==void 0&&t.p1RocketAmmo>0&&(this.ctx.fillStyle="#FF4500",this.ctx.fillText(`ROCKETS: ${t.p1RocketAmmo}`,r,l),this.ctx.fillStyle=H,l+=16),t.p1HasBow&&t.p1ArrowAmmo!==void 0&&t.p1ArrowAmmo>0&&(this.ctx.fillStyle="#90EE90",this.ctx.fillText(`ARROWS: ${t.p1ArrowAmmo}`,r,l),this.ctx.fillStyle=H,l+=16);const e=T*.75;let h=50;t.p2SpeedBoostTimer&&t.p2SpeedBoostTimer>0&&(this.ctx.fillText(`SPEED UP! ${t.p2SpeedBoostTimer.toFixed(1)}s`,e,h),h+=16),t.p2SuperJumpTimer&&t.p2SuperJumpTimer>0&&(this.ctx.fillText(`HIGH JUMP! ${t.p2SuperJumpTimer.toFixed(1)}s`,e,h),h+=16),t.p2BigPlayerTimer&&t.p2BigPlayerTimer>0&&(this.ctx.fillText(`BIG! ${t.p2BigPlayerTimer.toFixed(1)}s`,e,h),h+=16),t.p2HasRocketLauncher&&t.p2RocketAmmo!==void 0&&t.p2RocketAmmo>0&&(this.ctx.fillStyle="#FF4500",this.ctx.fillText(`ROCKETS: ${t.p2RocketAmmo}`,e,h),this.ctx.fillStyle=H,h+=16),t.p2HasBow&&t.p2ArrowAmmo!==void 0&&t.p2ArrowAmmo>0&&(this.ctx.fillStyle="#90EE90",this.ctx.fillText(`ARROWS: ${t.p2ArrowAmmo}`,e,h),this.ctx.fillStyle=H,h+=16)}drawGlobalStatusText(t){if(t.ballIsFrozen&&t.ballFreezeTimer&&t.ballFreezeTimer>0){const i=`BALL FROZEN: ${t.ballFreezeTimer.toFixed(1)}s`;this.ctx.font="bold 18px Arial",this.ctx.fillStyle="rgba(173, 216, 230, 0.9)",this.ctx.textAlign="center",this.ctx.fillText(i,T/2,K-30)}}drawGoalMessage(){this.ctx.fillStyle=Ct,this.ctx.font="60px Impact",this.ctx.textAlign="center",this.ctx.fillText("GOAL!",T/2,K/3)}drawMatchOverMessage(t,i){const r=t>=wi?"Player 1":"Player 2";this.ctx.fillStyle=H,this.ctx.font="50px Arial",this.ctx.textAlign="center",this.ctx.fillText(`${r} Wins Match!`,T/2,K/2-30),this.ctx.font="30px Arial",this.ctx.fillText(`Score: ${t} - ${i}`,T/2,K/2+20)}}const wi=5;var D=(P=>(P.SPEED_BOOST="SPEED_BOOST",P.BIG_PLAYER="BIG_PLAYER",P.SUPER_JUMP="SUPER_JUMP",P.BALL_FREEZE="BALL_FREEZE",P.ROCKET_LAUNCHER="ROCKET_LAUNCHER",P.BOW="BOW",P))(D||{});class Et{constructor(t,i,r){s(this,"x");s(this,"y");s(this,"vx");s(this,"vy");s(this,"type");s(this,"width",30);s(this,"height",30);s(this,"isActive",!0);s(this,"hasParachute",!0);s(this,"driftSpeed",30);s(this,"descendSpeed",80);s(this,"swayTimer",0);s(this,"swayMagnitude",8);s(this,"swayFrequency",2);s(this,"currentSwayOffset",0);this.x=t,this.y=i,this.type=r,this.vy=this.descendSpeed,this.vx=(Math.random()<.5?-1:1)*this.driftSpeed}update(t){this.isActive&&(this.y<R-this.height?(this.x+=this.vx*t,this.y+=this.vy*t,(this.x<0||this.x+this.width>T)&&(this.vx*=-1,this.x=Math.max(0,Math.min(this.x,T-this.width))),this.hasParachute?(this.swayTimer+=t,this.currentSwayOffset=Math.sin(this.swayTimer*this.swayFrequency*2*Math.PI)*this.swayMagnitude):this.currentSwayOffset=0,this.hasParachute&&this.y>R-this.height*3&&(this.hasParachute=!1,this.vy=150,this.currentSwayOffset=0)):(this.y=R-this.height,this.vx=0,this.vy=0,this.hasParachute=!1),this.y>K&&(this.isActive=!1))}draw(t){if(!this.isActive)return;const r=this.x+this.currentSwayOffset,l=this.y,e=this.width,h=this.height;if(this.hasParachute){const a=e*2,n=h*1.5,o=r+e/2-a/2,c=l-n-h*.2;t.fillStyle=H,t.strokeStyle=F,t.lineWidth=1,t.beginPath(),t.arc(o+a/2,c+n,a/2,Math.PI,0),t.closePath(),t.fill(),t.stroke(),t.beginPath(),t.moveTo(o,c+n),t.lineTo(r,l),t.moveTo(o+a,c+n),t.lineTo(r+e,l),t.stroke()}switch(t.save(),t.translate(r+e/2,l+h/2),t.fillStyle=H,t.strokeStyle=F,t.lineWidth=1,t.fillRect(-e/2,-h/2,e,h),t.strokeRect(-e/2,-h/2,e,h),t.lineWidth=2,t.strokeStyle=F,this.type){case"SPEED_BOOST":t.fillStyle="#FFFF00",t.beginPath(),t.moveTo(-e*.1,-h*.4),t.lineTo(e*.3,0),t.lineTo(e*.1,h*.4),t.lineTo(-e*.3,0),t.closePath(),t.fill(),t.stroke();break;case"BIG_PLAYER":t.fillStyle="#FF0000",t.beginPath(),t.moveTo(0,-h*.3),t.lineTo(e*.3,0),t.lineTo(e*.1,0),t.lineTo(e*.1,h*.3),t.lineTo(-e*.1,h*.3),t.lineTo(-e*.1,0),t.lineTo(-e*.3,0),t.closePath(),t.fill(),t.stroke();break;case"SUPER_JUMP":t.fillStyle="#00FF00",t.beginPath(),t.moveTo(-e*.3,h*.3),t.quadraticCurveTo(0,-h*.1,e*.3,h*.3),t.moveTo(-e*.3,h*.1),t.quadraticCurveTo(0,-h*.3,e*.3,h*.1),t.stroke();break;case"BALL_FREEZE":t.fillStyle="#00FFFF",t.beginPath();for(let a=0;a<6;a++){const n=Math.PI/3*a;t.moveTo(0,0),t.lineTo(Math.cos(n)*e*.4,Math.sin(n)*h*.4)}t.stroke(),t.beginPath(),t.arc(0,0,e*.15,0,Math.PI*2),t.fill();break;case"ROCKET_LAUNCHER":t.fillStyle="#808080",t.fillRect(-e*.1,-h*.4,e*.2,h*.8),t.beginPath(),t.moveTo(-e*.1,-h*.4),t.lineTo(e*.1,-h*.4),t.lineTo(0,-h*.6),t.closePath(),t.fill(),t.stroke(),t.fillRect(-e*.2,h*.2,e*.4,h*.1);break;case"BOW":t.fillStyle="#8B4513",t.strokeStyle=F,t.lineWidth=2,t.beginPath(),t.arc(0,0,e*.35,Math.PI*.6,Math.PI*1.4),t.stroke(),t.beginPath(),t.moveTo(0,-h*.35),t.lineTo(0,h*.35),t.stroke();break;default:t.fillStyle="purple",t.fillRect(-e/2,-h/2,e,h),t.strokeStyle=H,t.strokeRect(-e/2,-h/2,e,h)}t.restore()}getRect(){return{x:this.x,y:this.y,width:this.width,height:this.height}}}class Mi{constructor(){s(this,"activePowerups",[]);s(this,"spawnTimer",0);s(this,"minSpawnTime",15);s(this,"maxSpawnTime",45);s(this,"nextSpawnTime",0);this.resetSpawnTimer()}resetSpawnTimer(){this.nextSpawnTime=Math.random()*(this.maxSpawnTime-this.minSpawnTime)+this.minSpawnTime,this.spawnTimer=0}spawnPowerup(){const t=[D.SPEED_BOOST,D.BIG_PLAYER,D.SUPER_JUMP,D.BALL_FREEZE,D.ROCKET_LAUNCHER,D.BOW],i=Math.floor(Math.random()*t.length),r=t[i],l=Math.random()*(T-40)+20,e=-50,h=new Et(l,e,r);this.activePowerups.push(h),this.resetSpawnTimer()}update(t){this.spawnTimer+=t,this.spawnTimer>=this.nextSpawnTime&&this.spawnPowerup();for(let i=this.activePowerups.length-1;i>=0;i--){const r=this.activePowerups[i];r.update(t),r.isActive||this.activePowerups.splice(i,1)}}draw(t){for(const i of this.activePowerups)i.draw(t)}checkCollisions(t){const i=t.getBodyRect();for(let r=this.activePowerups.length-1;r>=0;r--){const l=this.activePowerups[r];if(!l.isActive)continue;const e=l.getRect();if(i.x<e.x+e.width&&i.x+i.width>e.x&&i.y<e.y+e.height&&i.y+i.height>e.y){const h=l.type;return l.isActive=!1,this.activePowerups.splice(r,1),h}}return null}addPowerup(t){this.activePowerups.push(t)}}const Rt=.97;class Z{constructor(t,i,r,l,e,h,a=3,n=.5,o="circle"){s(this,"x");s(this,"y");s(this,"vx");s(this,"vy");s(this,"lifespan");s(this,"initialLifespan");s(this,"color");s(this,"radius");s(this,"initialRadius");s(this,"alpha",1);s(this,"gravityEffect");s(this,"isActive",!0);s(this,"particleType","circle");this.x=t,this.y=i,this.vx=r,this.vy=l,this.lifespan=e,this.initialLifespan=e,this.color=h,this.radius=a,this.initialRadius=a,this.gravityEffect=n,this.particleType=o}update(t){if(this.isActive)if(this.vy+=st*this.gravityEffect*t,this.x+=this.vx*t,this.y+=this.vy*t,this.vx*=Rt,this.vy*=Rt,this.lifespan-=t,this.lifespan<=0)this.alpha=0,this.isActive=!1;else{const i=Math.max(0,this.lifespan/this.initialLifespan);this.particleType==="smoke"?(this.alpha=i,this.radius=this.initialRadius*(.8+.2*i)):this.particleType==="spark"?(this.alpha=i*i,this.radius=this.initialRadius*this.alpha):(this.alpha=i,this.radius=this.initialRadius*i)}}draw(t){!this.isActive||this.alpha<=0||this.radius<=.1||(t.globalAlpha=this.alpha,t.fillStyle=this.color,t.shadowBlur,t.shadowColor,t.beginPath(),t.arc(this.x,this.y,Math.max(.5,this.radius),0,Math.PI*2),t.fill(),t.globalAlpha=1)}}class bi{constructor(){s(this,"particles",[])}addParticle(t){this.particles.push(t)}emit(t,i,r,l=10,e={}){const h=e.scale||1;switch(t){case"dust":const a=e.count!==void 0?e.count:8;for(let m=0;m<a;m++){const p=Math.random()*Math.PI*2,A=Math.random()*35+10,w=Math.cos(p)*A,M=Math.sin(p)*A*.6-3,k=Math.random()*.7+.4;let S=Math.random()*1.6+1.2;S*=h;const b=e.color||"rgba(139, 69, 19, 0.65)",v=.02;this.addParticle(new Z(i,r,w,M,k,b,S,v,"smoke"))}break;case"landingDust":const n=e.count!==void 0?e.count:12;for(let m=0;m<n;m++){const p=Math.random()*Math.PI*2,A=Math.random()*40+15,w=Math.cos(p)*A,M=Math.sin(p)*A*.5-5,k=Math.random()*.8+.5;let S=Math.random()*3.4+2.4;const b=1+Math.min(2,Math.abs(e.landingVelocity||0)/500);S*=h*b;const v="rgba(255, 255, 255, 0.6)",I=.03;this.addParticle(new Z(i,r,w,M,k,v,S,I,"smoke"))}break;case"goal":const o=e.count!==void 0?e.count:50;for(let m=0;m<o;m++){const p=Math.random()*Math.PI*2,A=Math.random()*90+30,w=Math.cos(p)*A,M=Math.sin(p)*A,k=Math.random()*.5+.3;let S=Math.random()*1.8+1.2;S*=h;const b=["#FFD700","#FFA500","#FF4500"],v=b[Math.floor(Math.random()*b.length)],I=.1;this.addParticle(new Z(i,r,w,M,k,v,S,I,"spark"))}break;case"jump":const c=e.count!==void 0?e.count:10;for(let m=0;m<c;m++){const p=Math.random()*Math.PI*.8+Math.PI*1.1,A=Math.random()*30+8,w=Math.cos(p)*A,M=Math.sin(p)*A*.7,k=Math.random()*.6+.3;let S=Math.random()*1.7+1.2;S*=h;const b="rgba(255, 255, 255, 0.7)",v=.01;this.addParticle(new Z(i,r,w,M,k,b,S,v,"smoke"))}break;case"kick":for(let m=0;m<l;m++){const p=Math.random()*Math.PI*2,A=Math.random()*60+20,w=Math.cos(p)*A*(e.kickDirection||1),M=Math.sin(p)*A-15,k=Math.random()*.35+.25;let S=Math.random()*1.4+1.1;S*=h;const b="#FFFF00",v=.1;this.addParticle(new Z(i,r,w,M,k,b,S,v,"spark"))}break;case"explosion":const d=e.count!==void 0?e.count:50,g=e.radius||50;for(let m=0;m<d;m++){const p=Math.random()*Math.PI*2,A=Math.random()*(g*2.5)+g*.5,w=Math.cos(p)*A,M=Math.sin(p)*A,k=Math.random()*.6+.3;let S=Math.random()*3+2;S*=h;const b=["#FFA500","#FF4500","#FFD700","#FFFFFF","#808080"],v=b[Math.floor(Math.random()*b.length)],I=.05,L=Math.random()<.7?"spark":"smoke";this.addParticle(new Z(i,r,w,M,k,v,S,I,L))}break;case"rocket_smoke":const y=e.count!==void 0?e.count:1,u=e.baseSpeed||50;for(let m=0;m<y;m++){const p=(e.vx||0)*-.02,A=(e.vy||0)*-.02,w=Math.PI/4,k=Math.atan2(e.vy||0,e.vx||0)+Math.PI+(Math.random()*w-w/2),S=u*(Math.random()*.2+.1),b=Math.cos(k)*S,v=Math.sin(k)*S,I=Math.random()*.5+.3;let L=Math.random()*1.5+1;L*=h;const O=`rgba(150, 150, 150, ${Math.random()*.3+.4})`,$=.01;this.addParticle(new Z(i+p,r+A,b,v,I,O,L,$,"smoke"))}break}}update(t){for(let i=this.particles.length-1;i>=0;i--)this.particles[i].update(t),this.particles[i].isActive||this.particles.splice(i,1)}draw(t){for(const i of this.particles)i.draw(t)}clear(){this.particles=[]}}var Ot=(P=>(P.FLYING="FLYING",P.STUCK="STUCK",P))(Ot||{});function xt(P,t,i){return{x:P.x+t*Math.cos(i),y:P.y-t*Math.sin(i)}}class It{constructor(t,i,r,l,e,h){s(this,"x");s(this,"y");s(this,"vx");s(this,"vy");s(this,"owner");s(this,"isActive",!0);s(this,"state","FLYING");s(this,"width",30);s(this,"thickness",2);s(this,"angle",0);s(this,"stuckToObject",null);s(this,"stuckOffsetX",0);s(this,"stuckOffsetY",0);s(this,"lastPos");s(this,"particleSystem");s(this,"length",30);s(this,"headSize",6);this.x=t,this.y=i,this.vx=r,this.vy=l,this.owner=e,this.angle=Math.atan2(l,r),this.lastPos={x:t,y:i},this.particleSystem=h}update(t){return this.isActive&&(this.lastPos={x:this.x,y:this.y},this.state==="FLYING"?(this.vy+=st*t,this.x+=this.vx*t,this.y+=this.vy*t,this.angle=Math.atan2(this.vy,this.vx),(this.x<-this.width*2||this.x>T+this.width*2||this.y>K+100||this.y<-this.width*2)&&(console.log("Arrow went way out of bounds, deactivating."),this.isActive=!1)):this.state==="STUCK"&&this.stuckToObject&&typeof this.stuckToObject=="object"&&"x"in this.stuckToObject&&"y"in this.stuckToObject&&(this.x=this.stuckToObject.x+this.stuckOffsetX,this.y=this.stuckToObject.y+this.stuckOffsetY,this.stuckToObject instanceof rt)),!1}stick(t,i,r){var l;if(this.state==="FLYING")if(this.state="STUCK",this.stuckToObject=t,this.x=i,this.y=r,this.angle=Math.atan2(this.vy,this.vx),this.vx=0,this.vy=0,t&&typeof t=="object"&&"x"in t&&"y"in t){this.stuckOffsetX=i-t.x,this.stuckOffsetY=r-t.y;let e=((l=t.constructor)==null?void 0:l.name)||"object";t instanceof rt&&(e="Player"),console.log(`Arrow Stuck to ${e} at relative offset (${this.stuckOffsetX.toFixed(1)}, ${this.stuckOffsetY.toFixed(1)})`)}else console.log(`Arrow Stuck to ${t} at (${i.toFixed(1)}, ${r.toFixed(1)})`)}getTipPosition(){return xt({x:this.x,y:this.y},this.width*.5,this.angle)}getBasePosition(){return xt({x:this.x,y:this.y},-this.width*.5,this.angle)}draw(t){this.isActive&&(t.save(),t.translate(this.x,this.y),t.rotate(this.angle),t.strokeStyle=this.owner.teamColor,t.lineWidth=this.thickness,t.beginPath(),t.moveTo(-this.width/2,0),t.lineTo(this.width/2,0),t.stroke(),t.fillStyle=F,t.beginPath(),t.moveTo(this.width/2,0),t.lineTo(this.width/2-6,-3),t.lineTo(this.width/2-6,3),t.closePath(),t.fill(),t.lineWidth=1,t.strokeStyle="#A0522D",t.beginPath(),t.moveTo(-this.width/2,0),t.lineTo(-this.width/2-5,-4),t.moveTo(-this.width/2,0),t.lineTo(-this.width/2-5,4),t.moveTo(-this.width/2-2,0),t.lineTo(-this.width/2-7,-4),t.moveTo(-this.width/2-2,0),t.lineTo(-this.width/2-7,4),t.stroke(),t.restore())}getCollisionShape(){const t=this.length/2,i=this.x-Math.cos(this.angle)*t,r=this.y-Math.sin(this.angle)*t,l=this.x+Math.cos(this.angle)*t,e=this.y+Math.sin(this.angle)*t;return{p1:{x:i,y:r},p2:{x:l,y:e},radius:this.thickness/2}}getLastPosition(){return this.lastPos}}const dt=5,vi=1.5,_t=400;class Li{constructor(t){s(this,"ctx");s(this,"inputHandler");s(this,"uiManager");s(this,"particleSystem");s(this,"lastTime",0);s(this,"accumulatedTime",0);s(this,"timeStep",1/Ft);s(this,"player1");s(this,"player2");s(this,"ball");s(this,"player1Score",0);s(this,"player2Score",0);s(this,"currentState",E.WELCOME);s(this,"goalMessageTimer",0);s(this,"matchOverTimer",0);s(this,"powerupManager");s(this,"activeRockets",[]);s(this,"activeArrows",[]);s(this,"player1LastKickTime",0);s(this,"player2LastKickTime",0);this.ctx=t,this.inputHandler=new ni,this.uiManager=new Ti(t),this.powerupManager=new Mi,this.particleSystem=new bi,this.player1=new rt(T*.25,R,1,"#DCDCDC","#1E1E1E",F,st,ft,ut),this.player2=new rt(T*.75,R,-1,"#009246","#CE2B37",F,st,ft,ut),this.ball=new ki(T/2,R-100)}spawnSpecificPowerup(t,i,r){const l=new Et(i,r,t);this.powerupManager.addPowerup(l)}resetPositions(){this.ball.x=T/2,this.ball.y=R-100,this.ball.vx=0,this.ball.vy=0,this.player1.x=T*.25,this.player1.y=R,this.player1.vx=0,this.player1.vy=0,this.player1.facingDirection=1,this.player1.isKicking=!1,this.player1.isJumping=!1,this.player1.isTumbling=!1,this.player2.x=T*.75,this.player2.y=R,this.player2.vx=0,this.player2.vy=0,this.player2.facingDirection=-1,this.player2.isKicking=!1,this.player2.isJumping=!1,this.player2.isTumbling=!1,this.particleSystem.clear()}startNewMatch(){this.player1Score=0,this.player2Score=0,this.resetPositions(),this.currentState=E.PLAYING,this.particleSystem.clear()}checkGoal(){if(this.currentState===E.PLAYING&&this.ball.y>Y&&this.ball.y<R){let t=!1,i=null;this.ball.x-this.ball.radius<z?(console.log("GOAL P2!"),this.player2Score++,t=!0,i=2):this.ball.x+this.ball.radius>j+U&&(console.log("GOAL P1!"),this.player1Score++,t=!0,i=1),t&&(i===1?x.playSound("PLAYER1_GOAL_1"):i===2&&x.playSound("PLAYER2_GOAL_1"),this.particleSystem.emit("goal",this.ball.x,this.ball.y,50),this.currentState=E.GOAL_SCORED,this.goalMessageTimer=vi,(this.player1Score>=dt||this.player2Score>=dt)&&(this.currentState=E.MATCH_OVER,this.matchOverTimer=3))}}handleCollisions(){if(this.currentState!==E.PLAYING)return;const t=[this.player1,this.player2];let i=!1;const r=a=>{if(typeof a.getKickImpactPoint=="function")return a.getKickImpactPoint();if(!a.isKicking)return null;const n=a.legLength||30,o=n*.8,c=a.y-n*.5;return{x:a.x+a.facingDirection*o,y:c}};for(const a of t){const n=this.powerupManager.checkCollisions(a);n&&this.applyPowerup(a,n)}const l=this.player1.getBodyRect(),e=this.player2.getBodyRect();if(this.checkRectCollision(l,e)){const a=l.x+l.width/2-(e.x+e.width/2),n=l.width/2+e.width/2-Math.abs(a);if(n>0){const o=n/2,c=Math.sign(a)||1;this.player1.x+=o*c,this.player2.x-=o*c;const d=.3,g=this.player1.vx,y=this.player2.vx;this.player1.vx=-g*d+y*d*.5,this.player2.vx=-y*d+g*d*.5,console.log("Player-Player Body Collision"),x.playSound("PLAYER_BUMP_1")}}if(this.checkFeetOnHeadCollision(this.player1,this.player2)){const a=this.player2.getHeadCircle();this.player1.y=a.y-a.radius,this.player1.vy=0,this.player1.isJumping=!1,this.player1.onOtherPlayerHead=!0}else this.player1.onOtherPlayerHead=!1;if(this.checkFeetOnHeadCollision(this.player2,this.player1)){const a=this.player1.getHeadCircle();this.player2.y=a.y-a.radius,this.player2.vy=0,this.player2.isJumping=!1,this.player2.onOtherPlayerHead=!0}else this.player2.onOtherPlayerHead=!1;for(const a of t){if(a.isBicycleKicking&&!i){const u=a.getBicycleKickImpactPoint();if(u){const m=this.ball.x-u.x,p=this.ball.y-u.y,A=m*m+p*p,w=this.ball.radius+60,M=w*w;if(console.log(`[Bicycle Kick] Check: dist=${Math.sqrt(A).toFixed(1)}, radius=${Math.sqrt(M).toFixed(1)}`),A<M){console.log(`BICYCLE KICK CONNECT! Player: ${a===this.player1?1:2}, KickPoint: (${u.x.toFixed(1)}, ${u.y.toFixed(1)}), Ball: (${this.ball.x.toFixed(1)}, ${this.ball.y.toFixed(1)})`),x.playSound("KICK_1"),console.log("Applying Bicycle Kick force (Direction-Based)!");const S=et*2.5*1.5,b=-(a.legLength+a.torsoLength/2),v=a.x,I=a.y+b;let L=u.x-v,O=u.y-I;const $=Math.sqrt(L*L+O*O);$>0?(L/=$,O/=$):(L=a.facingDirection,O=-.5);const q=L*S,V=O*S;this.ball.applyKick(q,V),this.particleSystem.emit("kick",u.x,u.y,15,{kickDirection:a.facingDirection,isBicycle:!0}),i=!0;continue}}}if(a.isKicking&&!i){const u=a.getKickImpactPoint();if(u){const m=this.ball.x-u.x,p=this.ball.y-u.y,A=m*m+p*p,w=this.ball.radius+30,M=w*w;if(A<M){console.log(`Kick Connect! Player: ${a===this.player1?1:2}, KickPoint: (${u.x.toFixed(1)}, ${u.y.toFixed(1)}), Ball: (${this.ball.x.toFixed(1)}, ${this.ball.y.toFixed(1)}), DistSq: ${A.toFixed(1)}, RadiusSq: ${M.toFixed(1)}`),x.playSound("KICK_1");let k=0,S=0;if(a.isBicycleKicking){console.log("Applying Bicycle Kick force!");const V=2,J=1.5;k=a.facingDirection*et*V*.7,S=lt*V*J}else{const J=a.vx*.4,N=a.vy*.4,B=a.facingDirection*et*1.5;let G=lt*1.5;const X=R-this.ball.radius*2;this.ball.y<X&&(G*=.2,console.log(`Volley kick! Ball Y: ${this.ball.y.toFixed(0)}, Threshold: ${X.toFixed(0)}. Reduced base VY to ${G.toFixed(0)}`)),k=B+J,S=G+N,console.log(`Standard Kick Details: Base=(${B.toFixed(0)}, ${G.toFixed(0)}), Momentum=(${J.toFixed(0)}, ${N.toFixed(0)}), Final=(${k.toFixed(0)}, ${S.toFixed(0)})`)}const b=Math.atan2(S,k),v=Math.sqrt(k*k+S*S),I=Math.PI/18,L=(Math.random()*2-1)*I,O=b+L,$=Math.cos(O)*v,q=Math.sin(O)*v;console.log(`Kick Randomness: OrigAngle=${b.toFixed(2)}, Offset=${L.toFixed(2)}, FinalAngle=${O.toFixed(2)}`),this.ball.applyKick($,q),this.particleSystem.emit("kick",u.x,u.y,a.isBicycleKicking?15:8,{kickDirection:a.facingDirection,isBicycle:a.isBicycleKicking}),i=!0;continue}}}const n=a.getHeadCircle(),o=this.ball.x-n.x,c=this.ball.y-n.y,d=o*o+c*c,g=n.radius+this.ball.radius+5,y=g*g;if(d<y&&!a.isKicking){console.log("Headbutt Connect!");const u=et*a.facingDirection*.6,m=lt*1.5,p=a.vx*.3,A=a.vy*.3;this.ball.vx=u+p,this.ball.vy=m+A,i=!0,x.playSound("HEADBUTT_1")}if(!i){const u=a.getBodyRect();if(this.checkCircleRectCollision(this.ball,u)){const m=Math.max(u.x,Math.min(this.ball.x,u.x+u.width)),p=Math.max(u.y,Math.min(this.ball.y,u.y+u.height)),A=this.ball.x-m,w=this.ball.y-p,M=A*A+w*w;if(M<this.ball.radius*this.ball.radius){const k=Math.sqrt(M),S=this.ball.radius-k;if(k>0){const L=A/k*S,O=w/k*S;this.ball.x+=L,this.ball.y+=O}const b=this.ball.vx-a.vx,v=this.ball.vy-a.vy,I=.5;this.ball.vx=a.vx+-b*I,this.ball.vy=a.vy+-v*I,x.playSound("BODY_HIT_1")}}}}const h=this.ball;(h.x-h.radius<mt||h.x+h.radius>Pt)&&h.y<Y&&(h.vx*=-.85,h.x=h.x<T/2?mt+h.radius:Pt-h.radius,this.particleSystem.emit("dust",h.x,h.y,8)),h.y-h.radius<0&&(h.y=h.radius,h.vy*=-.85,this.particleSystem.emit("dust",h.x,h.y,8)),h.y+h.radius>R&&(h.y=R-h.radius,h.vy*=-.85,h.applyGroundFriction(),h.rotationSpeed*=.8,Math.abs(h.vy)>20&&this.particleSystem.emit("dust",h.x,h.y,12,{color:"#A0522D"}));for(const a of t){const n=a===this.player1?this.player2:this.player1;if(a.isKicking&&!n.isTumbling&&!n.isBeingPushedBack){const o=r(a);if(o){const c=n.getHeadCircle(),d=o.x-c.x,g=o.y-c.y,y=d*d+g*g,u=c.radius+5,m=u*u;if(y<m){console.log(`Player ${a===this.player1?1:2} kicked Player ${n===this.player1?1:2} in the head! Pushback!`);const p=Vt;n.vx=p*a.facingDirection,n.vy=-200,n.isJumping=!0,n.onOtherPlayerHead=!1,n.onLeftCrossbar=!1,n.onRightCrossbar=!1,n.isBeingPushedBack=!0,n.pushbackTimer=jt,x.playSound("BODY_HIT_1"),a.isKicking=!1}}}}for(let a=this.activeRockets.length-1;a>=0;a--){const n=this.activeRockets[a];if(!n.isActive)continue;const o=n.getRect();let c=!1;for(const g of t){if(g===n.owner)continue;const y=g.getBodyRect(),u=g.getHeadCircle();if(this.checkRectCollision(o,y)){console.log(`Rocket hit Player ${g===this.player1?1:2} body`),c=!0;break}if(!c&&this.checkCircleRectCollision(u,o)){console.log(`Rocket hit Player ${g===this.player1?1:2} head`),c=!0;break}}const d={x:this.ball.x,y:this.ball.y,radius:this.ball.radius};!c&&this.checkCircleRectCollision(d,o)&&(console.log("Rocket hit Ball"),c=!0),c&&(this.createExplosion(n.lastPos.x,n.lastPos.y),n.isActive=!1)}for(let a=this.activeArrows.length-1;a>=0;a--){const n=this.activeArrows[a];if(!n.isActive||n.state===Ot.STUCK)continue;let o=!1;const c=n.getTipPosition();for(const d of t){if(n.owner===d)continue;const g=d.getHeadCircle(),y=d.getBodyRect();let u=!1;const m=c.x-g.x,p=c.y-g.y;if(m*m+p*p<g.radius*g.radius?(console.log(`Arrow hit Player ${d===this.player1?1:2} head (Tip Check)`),u=!0):c.x>=y.x&&c.x<=y.x+y.width&&c.y>=y.y&&c.y<=y.y+y.height&&(console.log(`Arrow hit Player ${d===this.player1?1:2} body (Tip Check)`),u=!0),u){n.stick(d,c.x,c.y),d.startItching();const A=Math.atan2(c.y-d.y,c.x-d.x);d.vx+=Math.cos(A)*St,d.vy+=Math.sin(A)*St*.5-100,x.playSound("BODY_HIT_1"),o=!0;break}}if(!o){const d=c.x-this.ball.x,g=c.y-this.ball.y;if(d*d+g*g<this.ball.radius*this.ball.radius){const y=n.vx,u=n.vy;console.log(`[GM] Arrow hit Ball. Stored Velocity: (${y.toFixed(1)}, ${u.toFixed(1)}) (Tip Check)`);const m=1,p=y*m,A=u*m;console.log(`[GM] Calculated Force to Apply: (${p.toFixed(1)}, ${A.toFixed(1)})`),console.log("[GM] Calling ball.applyForce..."),this.ball.applyForce(p,A),console.log("[GM] Returned from ball.applyForce."),x.playSound("BODY_HIT_1"),console.log("[GM] Calling arrow.stick..."),n.stick(this.ball,c.x,c.y),console.log("[GM] Returned from arrow.stick."),o=!0}}!o&&n.y>=R-n.thickness/2&&(console.log("Arrow hit Ground (End Pos Check)"),n.stick("ground",n.x,R-n.thickness/2),o=!0)}for(const a of t){if(!a.isSword||!a.isSwingingSword)continue;const n=a.getSwordCollisionShape();if(!n)continue;const o=a===this.player1?this.player2:this.player1;if(!o.isTumbling&&!o.isBeingPushedBack){const d=o.getHeadCircle(),g=o.getBodyRect();let y=!1;if(this.checkLineCircleCollision(n.p1,n.p2,d))console.log(`Sword hit Player ${o===this.player1?1:2} head!`),y=!0;else{const u=g.x+g.width/2,m=g.y+g.height/2,p=Math.max(g.width,g.height)/1.8,A={x:u,y:m,radius:p};this.checkLineCircleCollision(n.p1,n.p2,A)&&(console.log(`Sword hit Player ${o===this.player1?1:2} body!`),y=!0)}if(y){const u=Math.atan2(o.y-a.y,o.x-a.x);o.vx=Math.cos(u)*kt,o.vy=Math.sin(u)*kt-150,o.startTumble(),x.playSound("SWORD_HIT_PLAYER")}}const c={x:this.ball.x,y:this.ball.y,radius:this.ball.radius};if(console.log(`[Sword Check] Sword: p1=(${n.p1.x.toFixed(1)},${n.p1.y.toFixed(1)}), p2=(${n.p2.x.toFixed(1)},${n.p2.y.toFixed(1)}) | Ball: cx=${c.x.toFixed(1)}, cy=${c.y.toFixed(1)}, r=${c.radius.toFixed(1)}`),this.checkLineCircleCollision(n.p1,n.p2,c)){const d=Math.atan2(n.p2.y-n.p1.y,n.p2.x-n.p1.x),g=oi,y=Math.cos(d)*g,u=Math.sin(d)*g;this.ball.applyForce(y,u),x.playSound("SWORD_HIT_BALL")}}}checkRectCollision(t,i){return t.x<i.x+i.width&&t.x+t.width>i.x&&t.y<i.y+i.height&&t.y+t.height>i.y}checkFeetOnHeadCollision(t,i){const r=i.getHeadCircle(),l=t.x,e=t.y,h=r.y-r.radius,a=r.y,n=r.x-r.radius,o=r.x+r.radius;return l>=n&&l<=o&&e>=h&&e<=a+5&&t.vy>=0}checkCircleRectCollision(t,i){const r=Math.max(i.x,Math.min(t.x,i.x+i.width)),l=Math.max(i.y,Math.min(t.y,i.y+i.height)),e=t.x-r,h=t.y-l;return e*e+h*h<t.radius*t.radius}checkLineCircleCollision(t,i,r){const l=(i.x-t.x)*(i.x-t.x)+(i.y-t.y)*(i.y-t.y);if(l===0){const d=r.x-t.x,g=r.y-t.y;return d*d+g*g<=r.radius*r.radius}let e=((r.x-t.x)*(i.x-t.x)+(r.y-t.y)*(i.y-t.y))/l;e=Math.max(0,Math.min(1,e));const h=t.x+e*(i.x-t.x),a=t.y+e*(i.y-t.y),n=r.x-h,o=r.y-a;return n*n+o*o<=r.radius*r.radius}applyPowerup(t,i){switch(console.log(`Applying powerup ${i} to player ${t===this.player1?1:2}...`),i){case D.SPEED_BOOST:t.activateSpeedBoost();break;case D.BIG_PLAYER:t.activateBigPlayer();break;case D.SUPER_JUMP:t.activateSuperJump();break;case D.BALL_FREEZE:console.log("Calling ball.freeze()"),this.ball.freeze(Jt);break;case D.ROCKET_LAUNCHER:{const e=t.hasRocketLauncher;e?t.rocketAmmo+=3:(t.hasRocketLauncher=!0,t.rocketAmmo=3),console.log(`Player ${t===this.player1?1:2} ${e?"added":"picked up"} Rocket Launcher (Ammo: ${t.rocketAmmo})`);break}case D.BOW:t.hasRocketLauncher&&(t.hasRocketLauncher=!1,t.rocketAmmo=0);const r=t.hasBow;t.hasBow=!0,r?t.arrowAmmo+=3:t.arrowAmmo=3,t.aimAngle=0,console.log(`Player ${t===this.player1?1:2} ${r?"added arrows to":"picked up"} Bow (Ammo: ${t.arrowAmmo})`);break;default:console.warn(`Unhandled powerup type: ${i}`)}}update(t){switch(this.inputHandler.update(),this.currentState){case E.WELCOME:(this.inputHandler.isKeyPressed(Q.JUMP)||this.inputHandler.isKeyPressed(Q.KICK)||this.inputHandler.isKeyPressed(tt.JUMP)||this.inputHandler.isKeyPressed(tt.KICK))&&this.startNewMatch();break;case E.PLAYING:const r=performance.now()/1e3*si*Math.PI*2,l=Math.sin(r)*ei;this.player1.hasBow&&!this.player1.isKicking&&!this.player1.isStunned&&!this.player1.isTumbling?this.player1.aimAngle=-l:this.player1.hasBow||(this.player1.aimAngle=0),this.player2.hasBow&&!this.player2.isKicking&&!this.player2.isStunned&&!this.player2.isTumbling?this.player2.aimAngle=-l:this.player2.hasBow||(this.player2.aimAngle=0);let e=this.player1.playerSpeed*this.player1.speedMultiplier;if(this.player1.isBeingPushedBack||(this.inputHandler.isKeyPressed(Q.LEFT)?(this.player1.vx=-e,this.player1.facingDirection=-1):this.inputHandler.isKeyPressed(Q.RIGHT)?(this.player1.vx=e,this.player1.facingDirection=1):this.player1.vx=0),this.inputHandler.wasKeyJustPressed(Q.JUMP)&&this.player1.jump(),this.inputHandler.wasKeyJustPressed(Q.KICK)){const a=performance.now(),n=a-this.player1LastKickTime;if(this.player1LastKickTime>0&&n<_t)console.log("Player 1 Bicycle Kick!"),this.player1.isKicking=!1,this.player1.kickTimer=0,this.player1.startBicycleKick(),this.player1LastKickTime=0;else{if(this.player1.startKick(),this.player1.isSword&&this.player1.startSwordSwing(),this.player1.hasRocketLauncher&&!this.player1.isItching){const o=this.player1.fireRocket(this.particleSystem);o&&this.activeRockets.push(o)}if(this.player1.hasBow&&!this.player1.isItching)if(this.player1.arrowAmmo>0){const o=At,c=-this.player1.aimAngle,d=this.player1.facingDirection===1?c:Math.PI-c,g=Math.cos(d)*o,y=-Math.sin(d)*o,u=this.player1.x,m=this.player1.y-this.player1.legLength-this.player1.torsoLength*.5,p=new It(u,m,g,y,this.player1,this.particleSystem);this.activeArrows.push(p),this.player1.arrowAmmo--,this.player1.arrowAmmo<=0&&(this.player1.hasBow=!1,console.log("Player 1 ran out of arrows, bow removed.")),x.playSound("KICK_1")}else console.log("Player 1 out of arrows!");this.player1LastKickTime=a}}let h=this.player2.playerSpeed*this.player2.speedMultiplier;if(this.player2.isBeingPushedBack||(this.inputHandler.isKeyPressed(tt.LEFT)?(this.player2.vx=-h,this.player2.facingDirection=-1):this.inputHandler.isKeyPressed(tt.RIGHT)?(this.player2.vx=h,this.player2.facingDirection=1):this.player2.vx=0),this.inputHandler.wasKeyJustPressed(tt.JUMP)&&this.player2.jump(),this.inputHandler.wasKeyJustPressed(tt.KICK)){const a=performance.now(),n=a-this.player2LastKickTime;if(this.player2LastKickTime>0&&n<_t)console.log("Player 2 Bicycle Kick!"),this.player2.isKicking=!1,this.player2.kickTimer=0,this.player2.startBicycleKick(),this.player2LastKickTime=0;else{if(this.player2.startKick(),this.player2.isSword&&this.player2.startSwordSwing(),this.player2.hasRocketLauncher&&!this.player2.isItching){const o=this.player2.fireRocket(this.particleSystem);o&&this.activeRockets.push(o)}if(this.player2.hasBow&&!this.player2.isItching)if(this.player2.arrowAmmo>0){const o=At,c=-this.player2.aimAngle,d=this.player2.facingDirection===1?c:Math.PI-c,g=Math.cos(d)*o,y=-Math.sin(d)*o,u=this.player2.x,m=this.player2.y-this.player2.legLength-this.player2.torsoLength*.5,p=new It(u,m,g,y,this.player2,this.particleSystem);this.activeArrows.push(p),this.player2.arrowAmmo--,this.player2.arrowAmmo<=0&&(this.player2.hasBow=!1,console.log("Player 2 ran out of arrows, bow removed.")),x.playSound("KICK_1")}else console.log("Player 2 out of arrows!");this.player2LastKickTime=a}}this.inputHandler.wasKeyJustPressed("1")&&this.spawnSpecificPowerup(D.ROCKET_LAUNCHER,T/2,50),this.inputHandler.wasKeyJustPressed("2")&&(this.player1.isItching=!this.player1.isItching,console.log(`DEBUG: Toggled Player 1 itching: ${this.player1.isItching}`)),this.inputHandler.wasKeyJustPressed("3")&&(this.spawnSpecificPowerup(D.BOW,T/2,50),console.log("DEBUG: Spawned Bow Powerup")),this.inputHandler.wasKeyJustPressed("4")&&(this.player1.isSword=!this.player1.isSword,this.player1.isSword&&(this.player1.hasBow=!1,this.player1.hasRocketLauncher=!1),console.log(`DEBUG: Toggled Player 1 Sword: ${this.player1.isSword}`)),this.player1.isJumping&&!this.player1.hasJumpedThisPress&&(this.particleSystem.emit("jump",this.player1.x,this.player1.y,6,{scale:this.player1.sizeMultiplier}),this.player1.hasJumpedThisPress=!0),this.player2.isJumping&&!this.player2.hasJumpedThisPress&&(this.particleSystem.emit("jump",this.player2.x,this.player2.y,6,{scale:this.player2.sizeMultiplier}),this.player2.hasJumpedThisPress=!0),this.player1.update(t,R,T),this.player1.justLanded&&(this.particleSystem.emit("landingDust",this.player1.x,this.player1.y,12,{scale:this.player1.sizeMultiplier,landingVelocity:this.player1.lastLandingVy}),this.player1.justLanded=!1),this.player2.update(t,R,T),this.player2.justLanded&&(this.particleSystem.emit("landingDust",this.player2.x,this.player2.y,12,{scale:this.player2.sizeMultiplier,landingVelocity:this.player2.lastLandingVy}),this.player2.justLanded=!1),this.powerupManager.update(t);for(let a=this.activeRockets.length-1;a>=0;a--){const n=this.activeRockets[a];n.update(t),n.isActive||this.activeRockets.splice(a,1)}for(let a=this.activeArrows.length-1;a>=0;a--){const n=this.activeArrows[a];n.update(t),n.isActive||(console.log("Removing inactive arrow (OOB) from GameManager list."),this.activeArrows.splice(a,1))}this.handleCollisions(),this.ball.update(t),this.particleSystem.update(t),this.checkGoal();break;case E.GOAL_SCORED:this.goalMessageTimer-=t,this.goalMessageTimer<=0&&(this.resetPositions(),this.currentState=E.PLAYING);break;case E.MATCH_OVER:this.matchOverTimer-=t,this.matchOverTimer<=0&&(console.log("Match Over! Starting new match."),this.startNewMatch());break}}render(){this.ctx.clearRect(0,0,T,K),this.ctx.fillStyle="#87CEEB",this.ctx.fillRect(0,0,T,K),this.ctx.fillStyle="#228B22",this.ctx.fillRect(0,R,T,K-R),this.drawGoals(),this.ball.draw(this.ctx),this.player1.draw(this.ctx),this.player2.draw(this.ctx),this.powerupManager.draw(this.ctx);for(const i of this.activeRockets)i.draw(this.ctx);for(const i of this.activeArrows)i.draw(this.ctx);this.particleSystem.draw(this.ctx);const t={currentState:this.currentState,player1Score:this.player1Score,player2Score:this.player2Score,p1SpeedBoostTimer:this.player1.speedBoostTimer,p1SuperJumpTimer:this.player1.superJumpTimer,p1BigPlayerTimer:this.player1.bigPlayerTimer,p1HasRocketLauncher:this.player1.hasRocketLauncher,p1RocketAmmo:this.player1.rocketAmmo,p1HasBow:this.player1.hasBow,p1ArrowAmmo:this.player1.arrowAmmo,p2SpeedBoostTimer:this.player2.speedBoostTimer,p2SuperJumpTimer:this.player2.superJumpTimer,p2BigPlayerTimer:this.player2.bigPlayerTimer,p2HasRocketLauncher:this.player2.hasRocketLauncher,p2RocketAmmo:this.player2.rocketAmmo,p2HasBow:this.player2.hasBow,p2ArrowAmmo:this.player2.arrowAmmo,ballIsFrozen:this.ball.isFrozen,ballFreezeTimer:this.ball.freezeTimer,goalMessageTimer:this.goalMessageTimer,matchOverTimer:this.matchOverTimer};if(this.uiManager.draw(t),this.currentState===E.GOAL_SCORED&&(this.ctx.fillStyle=Ct,this.ctx.font="60px Impact",this.ctx.textAlign="center",this.ctx.fillText("GOAL!",T/2,K/3)),this.currentState===E.MATCH_OVER){this.ctx.fillStyle=H,this.ctx.font="50px Arial",this.ctx.textAlign="center";const i=this.player1Score>=dt?"Player 1":"Player 2";this.ctx.fillText(`${i} Wins Match!`,T/2,K/2-30),this.ctx.font="30px Arial",this.ctx.fillText(`Score: ${this.player1Score} - ${this.player2Score}`,T/2,K/2+20)}}gameLoop(t){const i=(t-this.lastTime)/1e3;for(this.lastTime=t,this.accumulatedTime+=i;this.accumulatedTime>=this.timeStep;)this.update(this.timeStep),this.accumulatedTime-=this.timeStep;this.render(),requestAnimationFrame(this.gameLoop.bind(this))}start(){console.log("Starting game..."),this.lastTime=performance.now(),requestAnimationFrame(this.gameLoop.bind(this))}drawGoals(){const t=Dt;this.ctx.fillStyle=t,this.ctx.strokeStyle=F,this.ctx.lineWidth=2;const i=[{x:z,y:Y-W,width:U,height:W},{x:j,y:Y-W,width:U,height:W}];this.ctx.strokeStyle="rgba(240, 240, 240, 0.8)",this.ctx.lineWidth=1;const r=10,l=Y,e=R;for(let o=l;o<e;o+=r)this.ctx.beginPath(),this.ctx.moveTo(z,o),this.ctx.lineTo(z+U,o),this.ctx.stroke();for(let o=z;o<z+U;o+=r)this.ctx.beginPath(),this.ctx.moveTo(o,l),this.ctx.lineTo(o,e),this.ctx.stroke();const h=Y,a=R;for(let o=h;o<a;o+=r)this.ctx.beginPath(),this.ctx.moveTo(j,o),this.ctx.lineTo(j+U,o),this.ctx.stroke();for(let o=j;o<j+U;o+=r)this.ctx.beginPath(),this.ctx.moveTo(o,h),this.ctx.lineTo(o,a),this.ctx.stroke();this.ctx.fillStyle=t,this.ctx.strokeStyle=F,this.ctx.lineWidth=2;for(const o of i)this.ctx.fillRect(o.x,o.y,o.width,o.height),this.ctx.strokeRect(o.x,o.y,o.width,o.height);const n=[{x:z,y:Y,width:W,height:gt},{x:T-W,y:Y,width:W,height:gt}];for(const o of n)this.ctx.fillRect(o.x,o.y,o.width,o.height),this.ctx.strokeRect(o.x,o.y,o.width,o.height)}createExplosion(t,i){console.log(`Creating REAL Explosion at (${t.toFixed(0)}, ${i.toFixed(0)}) with radius ${it}`),x.playSound("ROCKET_EXPLODE_1");const r=[this.player1,this.player2],l=it*it;r.forEach(n=>{const o=n.x-t,c=n.y-n.torsoLength/2-i,d=o*o+c*c;if(d<l){console.log(`Player ${n===this.player1?1:2} in blast radius!`);const g=Math.sqrt(d);let y=0;if(g>0)y=c/g;else{const u=Math.random()*Math.PI*2;y=Math.sin(u)}n.vy=ii+y*.3,n.startTumble()}});const e=this.ball.x-t,h=this.ball.y-i,a=e*e+h*h;if(a<l){console.log("Ball in blast radius!");const n=Math.sqrt(a),o=1-n/it,c=Zt*o;let d=0,g=0;if(n>0)d=e/n,g=h/n;else{const y=Math.random()*Math.PI*2;d=Math.cos(y),g=Math.sin(y)}this.ball.applyForce(d*c,g*c-Qt)}this.particleSystem.emit("explosion",t,i,50,{radius:it})}}document.addEventListener("DOMContentLoaded",()=>{const P=document.getElementById("gameCanvas");if(!P){console.error("Canvas element not found!");return}P.width=T,P.height=K;const t=P.getContext("2d");if(!t){console.error("Failed to get 2D context!");return}x.loadSounds().then(()=>{}).catch(r=>{console.error("Sound loading failed:",r)}),new Li(t).start()});
