var qt=Object.defineProperty;var Zt=(S,t,e)=>t in S?qt(S,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):S[t]=e;var o=(S,t,e)=>Zt(S,typeof t!="symbol"?t+"":t,e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))n(a);new MutationObserver(a=>{for(const s of a)if(s.type==="childList")for(const i of s.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&n(i)}).observe(document,{childList:!0,subtree:!0});function e(a){const s={};return a.integrity&&(s.integrity=a.integrity),a.referrerPolicy&&(s.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?s.credentials="include":a.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function n(a){if(a.ep)return;a.ep=!0;const s=e(a);fetch(a.href,s)}})();const I=800,z=600,Qt=60,j="#FFFFFF",Y="#000000",te="#FFFFFF",wt="#FFFF00",lt=980,Rt=240,xt=-450,dt=600,Tt=-450,ee=.98,Et=.9,x=z-50,ie=1.5,se=10,oe=1.4,ne=10,ae=1.5,he=12,le=5,It=30,Pt=1.4,re=15,K=100,U=150,X=10,gt=x-U,ot=0,nt=I-K,_t=ot,Ct=nt+K;var N=(S=>(S.WELCOME="WELCOME",S.PLAYING="PLAYING",S.GOAL_SCORED="GOAL_SCORED",S.MATCH_OVER="MATCH_OVER",S.GAME_OVER="GAME_OVER",S.TROPHY="TROPHY",S))(N||{});const et={JUMP:"w",KICK:"s",LEFT:"a",RIGHT:"d"},it={JUMP:"ArrowUp",KICK:"ArrowDown",LEFT:"ArrowLeft",RIGHT:"ArrowRight"},bt={SOUNDS:{KICK_1:"sounds/kick_ball1.mp3",KICK_2:"sounds/kick_ball2.mp3",KICK_3:"sounds/kick_ball3.mp3",JUMP_1:"sounds/jump1.mp3",LAND_1:"sounds/land1.mp3",LAND_2:"sounds/land2.mp3",WALL_HIT_1:"sounds/wall_hit1.mp3",PLAYER_BUMP_1:"sounds/player_bump1.mp3",HEADBUTT_1:"sounds/headbutt1.mp3",BODY_HIT_1:"sounds/body_hit1.mp3",SWORD_HIT:"sounds/sword_hit.mp3",SWORD_HIT_BALL:"sounds/sword_hit.mp3",CROSSBAR_HIT:"sounds/crossbar_hit.mp3",BALL_BOUNCE_1:"sounds/ball_bounce1.mp3",COMBO_SPARKLE_1:"sounds/combo_sparkle1.mp3",COMBO_SPARKLE_2:"sounds/combo_sparkle2.mp3",COMBO_SPARKLE_3:"sounds/combo_sparkle3.mp3",COMBO_SPARKLE_4:"sounds/combo_sparkle4.mp3",SUPER_JACKPOT:"sounds/super_jackpot.mp3",NILS_AHEAD:"sounds/nils_ahead.mp3",HARRY_AHEAD:"sounds/harry_ahead.mp3",NILS_WINS:"sounds/nils_wins.mp3",HARRY_WINS:"sounds/harry_wins.mp3",PLAYER1_GOAL_1:"sounds/player1_goal1.mp3",PLAYER1_GOAL_2:"sounds/player1_goal2.mp3",PLAYER1_GOAL_3:"sounds/player1_goal3.mp3",PLAYER2_GOAL_1:"sounds/player2_goal1.mp3",PLAYER2_GOAL_2:"sounds/player2_goal2.mp3",PLAYER2_GOAL_3:"sounds/player2_goal3.mp3",NUM_0:"sounds/0.mp3",NUM_1:"sounds/1.mp3",NUM_2:"sounds/2.mp3",NUM_3:"sounds/3.mp3",NUM_4:"sounds/4.mp3",NUM_5:"sounds/5.mp3"},IMAGES:{POWERUPS:{SPEED_BOOST:"images/powerups/powerup_speed_boost.png",SUPER_JUMP:"images/powerups/powerup_super_jump.png",BIG_PLAYER:"images/powerups/powerup_big_player.png",BALL_FREEZE:"images/powerups/powerup_ball_freeze.png",ROCKET_LAUNCHER:"images/powerups/powerup_rocket_launcher.png",BOW:"images/powerups/powerup_bow.png",SWORD:"images/powerups/powerup_sword.png",GOAL_ENLARGE:"images/powerups/powerup_goal_enlarge.png"}}},pt=Math.PI/2,ce=600,Ot=.2,de=800,Bt=1200,st=150,ge=200,Kt=150,pe=100,ye=1.5,Ft=600,Gt=400,ue=.3,fe=Math.PI/3,me=600,Pe=800,Ae=6*Math.PI,Se=20;class Te{constructor(){o(this,"keys",new Set);o(this,"justPressedKeys",new Set);o(this,"previouslyPressedKeys",new Set);o(this,"justReleasedKeys",new Set);o(this,"previouslyReleasedKeys",new Set);window.addEventListener("keydown",t=>{const e=t.key.toLowerCase();this.keys.has(e)||this.justPressedKeys.add(e),this.keys.add(e)}),window.addEventListener("keyup",t=>{const e=t.key.toLowerCase();this.keys.delete(e),this.justReleasedKeys.add(e)})}update(){this.previouslyPressedKeys=new Set(this.justPressedKeys),this.justPressedKeys.clear(),this.previouslyReleasedKeys=new Set(this.justReleasedKeys),this.justReleasedKeys.clear()}isKeyPressed(t){return this.keys.has(t.toLowerCase())}wasKeyJustPressed(t){return this.previouslyPressedKeys.has(t.toLowerCase())}wasKeyJustReleased(t){return this.previouslyReleasedKeys.has(t.toLowerCase())}}class ke{constructor(){o(this,"audioContext");o(this,"soundBuffers",{});o(this,"soundsLoaded",!1);o(this,"loadingPromise",null);o(this,"activeLoops",new Map);o(this,"lastPlayedTimes",new Map);o(this,"debounceInterval",1e3);try{this.audioContext=new(window.AudioContext||window.webkitAudioContext)}catch(t){console.error("Web Audio API is not supported in this browser.",t),this.audioContext=null}}async loadSounds(){if(!this.audioContext)return console.warn("AudioContext not available, skipping sound loading."),this.soundsLoaded=!0,Promise.resolve();if(this.loadingPromise)return this.loadingPromise;if(this.soundsLoaded)return Promise.resolve();const t=bt.SOUNDS,e=[];return this.loadingPromise=new Promise(async(n,a)=>{console.log("Starting sound loading..."),Object.keys(t).length;for(const s in t)if(Object.prototype.hasOwnProperty.call(t,s)){const i=t[s];e.push(this.loadSound(s,i).then(()=>{}))}try{await Promise.all(e),console.log("All sounds loaded successfully!"),this.soundsLoaded=!0,this.loadingPromise=null,n()}catch(s){console.error("Error loading one or more sounds:",s),this.loadingPromise=null,a(s)}}),this.loadingPromise}async loadSound(t,e){if(!this.audioContext)return Promise.resolve();try{const n=await fetch(e);if(!n.ok)throw new Error(`HTTP error! status: ${n.status} for ${e}`);const a=await n.arrayBuffer(),s=await this.audioContext.decodeAudioData(a);this.soundBuffers[t]=s}catch(n){console.error(`Failed to load sound: ${t} from ${e}`,n),this.soundBuffers[t]=null}}playSound(t,e=1,n=!1){var r;const a=performance.now(),s=this.lastPlayedTimes.get(t);if(s&&a-s<this.debounceInterval||!this.audioContext||!this.soundsLoaded)return;const i=this.soundBuffers[t];if(!i){console.warn(`Sound buffer not found for key: ${t}`);return}try{const c=this.audioContext.createBufferSource();c.buffer=i;const d=this.audioContext.createGain();if(d.gain.setValueAtTime(e,this.audioContext.currentTime),c.connect(d),d.connect(this.audioContext.destination),c.loop=n,c.start(0),this.lastPlayedTimes.set(t,a),n){if(this.activeLoops.has(t))try{(r=this.activeLoops.get(t))==null||r.stop()}catch{}this.activeLoops.set(t,c),c.onended=()=>{this.activeLoops.get(t)===c&&this.activeLoops.delete(t)}}}catch(c){console.error(`Error playing sound ${t}:`,c)}}areSoundsLoaded(){return this.soundsLoaded}stopSound(t){if(this.activeLoops.has(t)){const e=this.activeLoops.get(t);try{e==null||e.stop(),console.log(`Stopped looped sound: ${t}`)}catch{}this.activeLoops.delete(t)}}}const _=new ke;class we{constructor(t,e,n,a,s,i){o(this,"x");o(this,"y");o(this,"vx");o(this,"vy");o(this,"owner");o(this,"isActive",!0);o(this,"width",20);o(this,"height",8);o(this,"angle",0);o(this,"lastPos");o(this,"particleSystem");o(this,"smokeEmitTimer",0);o(this,"smokeEmitInterval",.03);o(this,"exploded",!1);this.x=t,this.y=e,this.vx=n,this.vy=a,this.owner=s,this.angle=Math.atan2(a,n),this.lastPos={x:t,y:e},this.particleSystem=i,console.log(`Rocket created by Player ${s.teamColor==="#DCDCDC"?1:2} at (${t.toFixed(0)}, ${e.toFixed(0)}) with velocity (${n.toFixed(0)}, ${a.toFixed(0)})`)}update(t){if(!this.isActive)return!1;if(this.lastPos={x:this.x,y:this.y},this.x+=this.vx*t,this.y+=this.vy*t,this.angle=Math.atan2(this.vy,this.vx),this.smokeEmitTimer+=t,this.smokeEmitTimer>=this.smokeEmitInterval){this.smokeEmitTimer-=this.smokeEmitInterval;const a=Math.sqrt(this.vx*this.vx+this.vy*this.vy),s=this.x-Math.cos(this.angle)*(this.width/2+2),i=this.y-Math.sin(this.angle)*(this.width/2+2);this.particleSystem.emit("rocket_smoke",s,i,1,{vx:this.vx,vy:this.vy,baseSpeed:a})}let e=!1,n=null;return this.y>x-this.height/2&&(this.y=x-this.height/2,e=!0,n="ground"),!e&&(this.x<-this.width||this.x>I+this.width||this.y<-this.height)?(this.isActive=!1,!1):e?(this.isActive=!1,console.log(`Explosion triggered by ${n} at (${this.lastPos.x.toFixed(0)}, ${this.lastPos.y.toFixed(0)})`),!0):!1}getRect(){const t=this.x-this.width/2,e=this.y-this.height/2;return{x:t,y:e,width:this.width,height:this.height}}draw(t){this.isActive&&(t.save(),t.translate(this.x,this.y),t.rotate(this.angle),t.fillStyle="#ff4500",t.fillRect(-this.width/2,-this.height/2,this.width,this.height),t.strokeStyle=Y,t.lineWidth=1,t.strokeRect(-this.width/2,-this.height/2,this.width,this.height),t.fillStyle="yellow",t.beginPath(),t.moveTo(-this.width/2-5,0),t.lineTo(-this.width/2,-this.height/3),t.lineTo(-this.width/2,this.height/3),t.closePath(),t.fill(),t.restore())}}function G(S,t,e){return{x:S.x+t*Math.cos(e),y:S.y-t*Math.sin(e)}}const be=.0625*60,kt=Math.PI/7,Ht=Math.PI/6,u=-Math.PI/2,yt=Math.PI/2.5,Dt=Math.PI/1.5,ut=Math.PI*.6,ft=-Math.PI*.15,$t=.45,Me=.15,ve=.7,Nt=14,Le=8,Yt=9,Wt=25;function F(S,t,e){return S*(1-e)+t*e}function Re(S){return S*S}class At{constructor(t,e,n,a,s,i,r,c,d){o(this,"x");o(this,"y");o(this,"vx");o(this,"vy");o(this,"baseY");o(this,"isJumping");o(this,"hasJumpedThisPress",!1);o(this,"isKicking");o(this,"isBicycleKicking",!1);o(this,"bicycleKickTimer",0);o(this,"kickTimer");o(this,"kickDuration",$t);o(this,"walkCycleTimer");o(this,"facingDirection",1);o(this,"onOtherPlayerHead",!1);o(this,"onLeftCrossbar");o(this,"onRightCrossbar");o(this,"justLanded",!1);o(this,"lastLandingVy",0);o(this,"isStunned");o(this,"stunTimer");o(this,"isTumbling");o(this,"tumbleTimer");o(this,"rotationAngle");o(this,"rotationVelocity");o(this,"minKickDistSq",1/0);o(this,"kickImpactForceX",0);o(this,"kickImpactForceY",0);o(this,"isBeingPushedBack",!1);o(this,"pushbackTimer",0);o(this,"teamColor");o(this,"teamAccent");o(this,"eyeColor");o(this,"baseHeadRadius",8);o(this,"baseTorsoLength",36);o(this,"baseLimbWidth",10);o(this,"baseArmLength",24);o(this,"baseLegLength",32);o(this,"headRadius");o(this,"torsoLength");o(this,"limbWidth");o(this,"armLength");o(this,"legLength");o(this,"leftThighAngle",u);o(this,"rightThighAngle",u);o(this,"leftShinAngle",0);o(this,"rightShinAngle",0);o(this,"leftArmAngle",u);o(this,"rightArmAngle",u);o(this,"activePowerups",new Map);o(this,"isFlying",!1);o(this,"isBig",!1);o(this,"isShrunk",!1);o(this,"isEnormousHead",!1);o(this,"isControlsReversed",!1);o(this,"isSword",!1);o(this,"swordAngle",0);o(this,"isSwingingSword",!1);o(this,"swordSwingTimer",0);o(this,"isItching",!1);o(this,"itchingTimer",0);o(this,"itchDuration",10);o(this,"isAiming",!1);o(this,"aimAngle",0);o(this,"drawPower",0);o(this,"hasBow",!1);o(this,"arrowAmmo",0);o(this,"jumpPower");o(this,"playerSpeed");o(this,"gravity");o(this,"speedMultiplier",1);o(this,"jumpMultiplier",1);o(this,"sizeMultiplier",1);o(this,"speedBoostTimer",0);o(this,"superJumpTimer",0);o(this,"bigPlayerTimer",0);o(this,"hasRocketLauncher",!1);o(this,"rocketAmmo",0);o(this,"swordSwingDuration",.6);o(this,"swordSwingAngleMax",Math.PI*1.5);o(this,"swordLengthMultiplier",3);this.x=t,this.y=e,this.baseY=e,this.vx=0,this.vy=0,this.isJumping=!1,this.isKicking=!1,this.isBicycleKicking=!1,this.bicycleKickTimer=0,this.kickTimer=0,this.walkCycleTimer=0,this.facingDirection=n,this.hasJumpedThisPress=!1,this.justLanded=!1,this.lastLandingVy=0,this.onLeftCrossbar=!1,this.onRightCrossbar=!1,this.isStunned=!1,this.stunTimer=0,this.isTumbling=!1,this.tumbleTimer=0,this.rotationAngle=0,this.rotationVelocity=0,this.isAiming=!1,this.aimAngle=0,this.drawPower=0,this.hasBow=!1,this.teamColor=a,this.teamAccent=s,this.eyeColor=i,this.headRadius=this.baseHeadRadius,this.torsoLength=this.baseTorsoLength,this.limbWidth=this.baseLimbWidth,this.armLength=this.baseArmLength,this.legLength=this.baseLegLength,this.gravity=r,this.jumpPower=c,this.playerSpeed=d,this.kickDuration=$t,this.updateSizeAttributes()}_getRelativeLimbPositions(){let t=this.leftThighAngle,e=this.rightThighAngle,n=this.leftShinAngle,a=this.rightShinAngle,s=this.leftArmAngle,i=this.rightArmAngle;isNaN(t)&&(t=u),isNaN(e)&&(e=u),isNaN(n)&&(n=0),isNaN(a)&&(a=0),isNaN(s)&&(s=u),isNaN(i)&&(i=u);let r=this.isItching,c="normal",d="normal";if(r){const W=Date.now()/1e3*4,$=(Math.sin(W*Math.PI)+1)/2,B=$<.5?4*$*$*$:1-Math.pow(-2*$+2,3)/2,D={leftThigh:Math.PI*.3,leftShin:Math.PI*.4,leftArm:Math.PI*.6,rightThigh:-Math.PI*.2,rightShin:-Math.PI*.1,rightArm:-Math.PI*.3},J={leftThigh:-Math.PI*.1,leftShin:-Math.PI*.2,leftArm:-Math.PI*.4,rightThigh:Math.PI*.4,rightShin:Math.PI*.5,rightArm:Math.PI*.7};t=pt+F(D.leftThigh,J.leftThigh,B),n=F(D.leftShin,J.leftShin,B),s=pt+F(D.leftArm,J.leftArm,B),e=pt+F(D.rightThigh,J.rightThigh,B),a=F(D.rightShin,J.rightShin,B),i=pt+F(D.rightArm,J.rightArm,B),c="frantic",d="jagged"}const m={x:0,y:-this.legLength},P={x:0,y:m.y-this.torsoLength},A={x:0,y:P.y-this.headRadius},k=this.headRadius*.2,R=this.limbWidth*.5,f={x:P.x-R,y:P.y+k},b={x:P.x+R,y:P.y+k},v=this.armLength*.5,E=this.armLength*.5,l=G(f,v,s),h=G(l,E,s),g=G(b,v,i),p=G(g,E,i),y=this.legLength*.5,w=this.legLength*.5,M=G(m,y,t),T=G(M,w,t+n),L=G(m,y,e),C=G(L,w,e+a);return{drawLThighAngle:t,drawRThighAngle:e,drawLShinAngle:n,drawRShinAngle:a,drawLArmAngle:s,drawRArmAngle:i,relHipPos:m,relNeckPos:P,relHeadCenter:A,relLeftShoulderPos:f,relRightShoulderPos:b,relLeftElbowPos:l,relLeftHandPos:h,relRightElbowPos:g,relRightHandPos:p,relLeftKneePos:M,relLeftFootPos:T,relRightKneePos:L,relRightFootPos:C,isDrawingItching:r,eyeStyle:c,mouthStyle:d}}draw(t){t.save(),t.translate(this.x,this.y);const e=this._getRelativeLimbPositions();if(this.isTumbling){const c=-(this.legLength+this.torsoLength/2);t.translate(0,c),t.rotate(this.rotationAngle),t.translate(0,-c)}else if(this.isBicycleKicking){const c=-(this.legLength+this.torsoLength/2);t.translate(0,c),t.rotate(this.rotationAngle),t.translate(0,-c)}t.lineWidth=this.limbWidth,t.lineCap="round",t.strokeStyle=this.teamColor,t.beginPath(),t.moveTo(e.relHipPos.x,e.relHipPos.y),t.lineTo(e.relNeckPos.x,e.relNeckPos.y),t.stroke(),t.fillStyle=this.teamColor,t.beginPath(),t.arc(e.relHeadCenter.x,e.relHeadCenter.y,this.headRadius,0,Math.PI*2),t.fill(),t.stroke();const n=this.headRadius*.18,a=this.headRadius*.4,s=e.relHeadCenter.x,i=e.relHeadCenter.y;if(e.isDrawingItching?(t.fillStyle=this.eyeColor,t.beginPath(),t.arc(s-a*.9,i+(Math.random()-.5)*3,n*1.2,0,Math.PI*2),t.fill(),t.beginPath(),t.arc(s+a*1.1,i+(Math.random()-.5)*3,n*.8,0,Math.PI*2),t.fill()):(t.fillStyle=this.eyeColor,t.beginPath(),t.arc(s-a,i,n,0,Math.PI*2),t.fill(),t.beginPath(),t.arc(s+a,i,n,0,Math.PI*2),t.fill()),e.mouthStyle==="jagged"){t.strokeStyle=Y,t.lineWidth=1,t.beginPath();const c=i+a*.8;t.moveTo(s-a*.8,c);for(let d=0;d<4;d++)t.lineTo(s-a*.8+a*1.6*(d+Math.random())/4,c+(Math.random()-.5)*8);t.lineTo(s+a*.8,c),t.stroke(),t.lineWidth=this.limbWidth}t.strokeStyle=this.teamAccent,t.beginPath(),t.moveTo(e.relLeftShoulderPos.x,e.relLeftShoulderPos.y),t.lineTo(e.relLeftElbowPos.x,e.relLeftElbowPos.y),t.lineTo(e.relLeftHandPos.x,e.relLeftHandPos.y),t.stroke(),t.beginPath(),t.moveTo(e.relRightShoulderPos.x,e.relRightShoulderPos.y),t.lineTo(e.relRightElbowPos.x,e.relRightElbowPos.y),t.lineTo(e.relRightHandPos.x,e.relRightHandPos.y),t.stroke(),t.strokeStyle=this.teamColor,t.beginPath(),t.moveTo(e.relHipPos.x,e.relHipPos.y),t.lineTo(e.relLeftKneePos.x,e.relLeftKneePos.y),t.lineTo(e.relLeftFootPos.x,e.relLeftFootPos.y),t.stroke(),t.beginPath(),t.moveTo(e.relHipPos.x,e.relHipPos.y),t.lineTo(e.relRightKneePos.x,e.relRightKneePos.y),t.lineTo(e.relRightFootPos.x,e.relRightFootPos.y),t.stroke(),t.fillStyle=this.teamAccent;const r=(c,d)=>{const m=d===1?0:Math.PI;t.save(),t.translate(c.x,c.y),t.rotate(m),t.fillRect(0,-8/2,Nt,Le),t.restore()};if(r(e.relLeftFootPos,this.facingDirection),r(e.relRightFootPos,this.facingDirection),this.hasRocketLauncher){t.save();const c=this.armLength*1.1,d=this.limbWidth*.8,m=-(this.legLength+this.torsoLength*.3),P=this.facingDirection*(this.limbWidth*.5);t.translate(P,m);const A=this.facingDirection===1?0:-c;t.fillStyle="#808080",t.fillRect(A,-d/2,c,d),t.strokeStyle=Y,t.lineWidth=1,t.strokeRect(A,-d/2,c,d);const k=this.facingDirection===1?c:-5;t.fillStyle="#505050",t.fillRect(A+k,-d/3,5,d*.66),t.restore()}if(this.hasBow){t.save();const c=this.facingDirection*(this.armLength*.6),d=-(this.legLength+this.torsoLength*.5);t.translate(c,d);const m=this.facingDirection===1?this.aimAngle:Math.PI-this.aimAngle;t.rotate(m);const P=this.armLength*2.2,A=this.limbWidth*.6,k=P*.2,R=-A*.8,f=P/2,b=R,v=-f,E=b,l=f,h=b+k,g=0;t.strokeStyle="#E0E0E0",t.lineWidth=1.5,t.lineCap="butt",t.beginPath(),t.moveTo(b,v),t.lineTo(E,l),t.stroke(),t.strokeStyle="#8B4513",t.lineWidth=A,t.lineCap="round",t.beginPath(),t.moveTo(b,v),t.quadraticCurveTo(h,g,E,l),t.stroke(),t.strokeStyle="red",t.lineWidth=1,t.beginPath(),t.moveTo(0,0),t.lineTo(50,0),t.stroke(),t.restore()}if(this.isSword){t.save(),t.translate(e.relRightHandPos.x,e.relRightHandPos.y);const d=(this.facingDirection===1?Math.PI*2/3:Math.PI/3)+this.swordAngle;t.rotate(d);const m=this.armLength*this.swordLengthMultiplier,P=m*.15,A=m-P,k=this.limbWidth*.8;t.fillStyle="#8B4513",t.fillRect(0,-k/2,P,k),t.fillStyle="#C0C0C0",t.fillRect(P,-k/2*.7,A,k*.7),t.strokeStyle=Y,t.lineWidth=1,t.strokeRect(0,-k/2,P,k),t.strokeRect(P,-k/2*.7,A,k*.7),t.restore()}t.restore()}update(t,e,n,a,s){this.onOtherPlayerHead=!1,this.onLeftCrossbar=!1,this.onRightCrossbar=!1,this.y<e&&!this.onLeftCrossbar&&!this.onRightCrossbar&&(this.vy+=this.gravity*t);const i=this.isJumping,r=this.vy;this.y+=this.vy*t,this.x+=this.vx*t;const c=Pt,d=X,m=a?U*c:U,P=e-m-d,A=a?K*c:K,k=ot,R=s?U*c:U,f=e-R-d,b=s?K*c:K,v=nt-(b-K);let E=!1;if(this.vy>=0){const l={x:k,y:P,width:A};if(this.x>=l.x&&this.x<=l.x+l.width&&this.y>=l.y&&this.y<=l.y+10&&(this.y=l.y,this.vy=0,this.isJumping=!1,this.onLeftCrossbar=!0,E=!0,i&&r>100&&_.playSound("LAND_1")),!E){const h={x:v,y:f,width:b};this.x>=h.x&&this.x<=h.x+h.width&&this.y>=h.y&&this.y<=h.y+10&&(this.y=h.y,this.vy=0,this.isJumping=!1,this.onRightCrossbar=!0,E=!0,i&&r>100&&_.playSound("LAND_1"))}}if(this.isSwingingSword){this.swordSwingTimer+=t;const l=Math.min(this.swordSwingTimer/this.swordSwingDuration,1),h=0,g=-this.swordSwingAngleMax*(this.facingDirection===1?1:-1);this.swordAngle=F(h,g,l),this.swordSwingTimer>=this.swordSwingDuration&&(this.isSwingingSword=!1,this.swordSwingTimer=0)}else this.swordAngle=F(this.swordAngle,0,.15),Math.abs(this.swordAngle)<.01&&(this.swordAngle=0);if(!this.isSwingingSword&&this.isKicking){this.kickTimer,this.kickTimer+=t;const g=this.kickTimer/this.kickDuration;if(g<.2){const p=Re(g/.2);this.facingDirection===1?(this.rightThighAngle=u+p*-yt,this.rightShinAngle=-ut):(this.leftThighAngle=u+p*yt,this.leftShinAngle=ut)}else if(g<1){const p=(g-.2)/.8;if(this.facingDirection===1)if(this.rightThighAngle=u+F(-yt,Dt,p),p<.5){const y=p/.5;this.rightShinAngle=F(-ut,-ft,y)}else this.rightShinAngle=-ft;else if(this.leftThighAngle=u+F(yt,-Dt,p),p<.5){const y=p/.5;this.leftShinAngle=F(ut,ft,y)}else this.leftShinAngle=ft}this.kickTimer>=this.kickDuration&&(this.kickTimer=0,this.isKicking=!1)}else if(this.isBicycleKicking){const h=[{time:0,angles:{nkThigh:u-.2*Math.PI,nkShin:.3*Math.PI,kThigh:u-.1*Math.PI,kShin:.2*Math.PI,lArm:u+.2*Math.PI,rArm:u-.2*Math.PI,rotationMag:0}},{time:.2,angles:{nkThigh:u-.7*Math.PI,nkShin:.8*Math.PI,kThigh:u+.3*Math.PI,kShin:.6*Math.PI,lArm:u+.6*Math.PI,rArm:u-.7*Math.PI,rotationMag:.4*Math.PI}},{time:.5,angles:{nkThigh:u-.9*Math.PI,nkShin:.8*Math.PI,kThigh:u-1.5*Math.PI,kShin:0*Math.PI,lArm:u-.8*Math.PI,rArm:u-.8*Math.PI,rotationMag:1*Math.PI}},{time:.75,angles:{nkThigh:u-.8*Math.PI,nkShin:.9*Math.PI,kThigh:u-.6*Math.PI,kShin:.7*Math.PI,lArm:u-.5*Math.PI,rArm:u+.5*Math.PI,rotationMag:1.6*Math.PI}},{time:1,angles:{nkThigh:u-.4*Math.PI,nkShin:.5*Math.PI,kThigh:u-.4*Math.PI,kShin:.5*Math.PI,lArm:u,rArm:u,rotationMag:2*Math.PI}}];this.bicycleKickTimer+=t;const g=Math.min(this.bicycleKickTimer/1,1);let p=h[0],y=h[1];for(let V=0;V<h.length-1;V++)if(g>=h[V].time&&g<h[V+1].time){p=h[V],y=h[V+1];break}const w=p.angles,M=y.angles,T=y.time-p.time,L=T>0?(g-p.time)/T:1,C=F(w.nkThigh,M.nkThigh,L),O=F(w.kThigh,M.kThigh,L),W=F(w.nkShin,M.nkShin,L),$=F(w.kShin,M.kShin,L),B=F(w.lArm,M.lArm,L),D=F(w.rArm,M.rArm,L),J=F(w.rotationMag,M.rotationMag,L),Q=this.facingDirection!==1;Q?(this.rightThighAngle=O,this.rightShinAngle=$,this.leftThighAngle=C,this.leftShinAngle=W):(this.leftThighAngle=O,this.leftShinAngle=$,this.rightThighAngle=C,this.rightShinAngle=W),this.leftArmAngle=B,this.rightArmAngle=D,this.rotationAngle=Q?J:-J,g>=1&&(this.isBicycleKicking=!1,this.bicycleKickTimer=0,this.rotationAngle=0)}else if(!this.isSwingingSword){const l=this.y>=e||this.onLeftCrossbar||this.onRightCrossbar;if(this.isJumping&&!l){const h=u+Math.PI*.2,g=u-Math.PI*.2,p=-Math.PI*.2,y=Wt*t;this.leftThighAngle+=(h-this.leftThighAngle)*y,this.rightThighAngle+=(g-this.rightThighAngle)*y,this.leftShinAngle+=(p-this.leftShinAngle)*y,this.rightShinAngle+=(p-this.rightShinAngle)*y}else if(l&&this.vx!==0){this.walkCycleTimer+=t*be;const h=Math.sin(this.walkCycleTimer*Math.PI*2)*kt;this.leftThighAngle=u+h,this.rightThighAngle=u-h,this.leftShinAngle=h*-.5,this.rightShinAngle=-h*-.5,this.leftArmAngle=u-h*(Ht/kt),this.rightArmAngle=u+h*(Ht/kt)}else{const h=Wt*t;this.leftThighAngle+=(u-this.leftThighAngle)*h,this.rightThighAngle+=(u-this.rightThighAngle)*h,this.leftShinAngle+=(0-this.leftShinAngle)*h,this.rightShinAngle+=(0-this.rightShinAngle)*h,this.leftArmAngle+=(u-this.leftArmAngle)*h,this.rightArmAngle+=(u-this.rightArmAngle)*h}}if(this.x<0&&(this.x=0),this.x>n&&(this.x=n),!E)if(this.y>=e){const h=this.vy;this.y=e,this.vy=0,i&&(this.lastLandingVy=h,this.isJumping=!1,this.hasJumpedThisPress=!1,this.justLanded=!0,h>200&&_.playSound("LAND_2"))}else this.justLanded=!1;this.isTumbling&&(this.tumbleTimer-=t,this.rotationAngle+=this.rotationVelocity*t,this.tumbleTimer<=0&&(this.isTumbling=!1,this.tumbleTimer=0,this.rotationAngle=0,this.rotationVelocity=0,this.leftThighAngle=u,this.rightThighAngle=u,this.leftShinAngle=0,this.rightShinAngle=0,this.leftArmAngle=u,this.rightArmAngle=u)),this.isBeingPushedBack&&(this.pushbackTimer-=t,this.pushbackTimer<=0&&(this.isBeingPushedBack=!1,this.pushbackTimer=0)),this.speedBoostTimer>0&&(this.speedBoostTimer-=t,this.speedBoostTimer<=0&&this.deactivateSpeedBoost()),this.superJumpTimer>0&&(this.superJumpTimer-=t,this.superJumpTimer<=0&&this.deactivateSuperJump()),this.bigPlayerTimer>0&&(this.bigPlayerTimer-=t,this.bigPlayerTimer<=0&&this.deactivateBigPlayer()),this.isItching&&(this.itchingTimer-=t,this.itchingTimer<=0&&(this.isItching=!1,console.log(`Player ${this.teamColor} stopped itching`)))}startKick(){!this.isKicking&&!this.isStunned&&!this.isTumbling&&!this.isItching&&(this.isKicking=!0,this.kickTimer=0,this.minKickDistSq=1/0,this.kickImpactForceX=0,this.kickImpactForceY=0)}startBicycleKick(){const t=!this.isKicking&&!this.isStunned&&!this.isTumbling&&!this.isItching&&!this.isBicycleKicking;if(t||console.warn(`[Player.startBicycleKick] BLOCKED! States: isKicking=${this.isKicking}, isStunned=${this.isStunned}, isTumbling=${this.isTumbling}, isItching=${this.isItching}, isBicycleKicking=${this.isBicycleKicking}`),t){console.log(`[Player.startBicycleKick] Starting bicycle kick for player ${this.teamColor}`),this.isBicycleKicking=!0,this.bicycleKickTimer=0,this.rotationAngle=0;const e={nkThigh:u-.2*Math.PI,nkShin:.3*Math.PI,kThigh:u-.1*Math.PI,kShin:.2*Math.PI,lArm:u+.2*Math.PI,rArm:u-.2*Math.PI};this.facingDirection!==1?(this.rightThighAngle=e.kThigh,this.rightShinAngle=e.kShin,this.leftThighAngle=e.nkThigh,this.leftShinAngle=e.nkShin,this.rightArmAngle=e.rArm,this.leftArmAngle=e.lArm):(this.leftThighAngle=e.kThigh,this.leftShinAngle=e.kShin,this.rightThighAngle=e.nkThigh,this.rightShinAngle=e.nkShin,this.leftArmAngle=e.lArm,this.rightArmAngle=e.rArm),this.minKickDistSq=1/0,this.kickImpactForceX=0,this.kickImpactForceY=0,_.playSound("KICK_1")}}jump(){let t=!this.isJumping&&!this.isKicking&&!this.isStunned&&!this.isTumbling;if((this.onOtherPlayerHead||this.onLeftCrossbar||this.onRightCrossbar)&&(t=!this.isKicking&&!this.isStunned&&!this.isTumbling),t){const e=this.jumpPower*this.jumpMultiplier;this.vy=e,this.isJumping=!0,this.hasJumpedThisPress=!0,this.onOtherPlayerHead=!1,this.onLeftCrossbar=!1,this.onRightCrossbar=!1,_.playSound("JUMP_1")}}startSwordSwing(){this.isSword&&!this.isSwingingSword&&!this.isKicking&&!this.isStunned&&!this.isTumbling&&!this.isItching&&(this.isSwingingSword=!0,this.swordSwingTimer=0,this.swordAngle=0,console.log("Player started sword swing!"))}getHeadCircle(){const t={x:this.x,y:this.y-this.legLength-this.torsoLength},e={x:t.x,y:t.y-this.headRadius};return{x:e.x,y:e.y,radius:this.headRadius}}getBodyRect(){const t=this.y-this.legLength,e=this.legLength+this.torsoLength,n=this.limbWidth*2;return{x:this.x-n/2,y:t-this.torsoLength,width:n,height:e}}startTumble(){!this.isTumbling&&!this.isStunned&&(this.isTumbling=!0,this.tumbleTimer=ye,this.rotationVelocity=(Math.random()-.5)*Ae,this.rotationAngle=0,this.isJumping=!1,this.onOtherPlayerHead=!1,this.onLeftCrossbar=!1,this.onRightCrossbar=!1,this.isKicking=!1,this.kickTimer=0)}getFootPosition(t){const e=t?this.rightThighAngle:this.leftThighAngle,n=t?this.rightShinAngle:this.leftShinAngle,a=this.legLength*.5,s=this.legLength*.5,i={x:this.x,y:this.y-this.legLength},r=G(i,a,e);return G(r,s,e+n)}getKickImpactPoint(){if(!this.isKicking)return null;const t=this.kickTimer/this.kickDuration;if(t<Me||t>ve)return null;const e=this.facingDirection===1,n={x:this.x,y:this.y-this.legLength},a=e?this.rightThighAngle:this.leftThighAngle,s=e?this.rightShinAngle:this.leftShinAngle,i=this.legLength*.5,r=this.legLength*.5,c=G(n,i,a);return G(c,r,a+s)}getBicycleKickImpactPoint(){if(!this.isBicycleKicking)return null;const t=1,e=[{time:0,angles:{nkThigh:u-.2*Math.PI,nkShin:.3*Math.PI,kThigh:u-.1*Math.PI,kShin:.2*Math.PI,lArm:u+.2*Math.PI,rArm:u-.2*Math.PI,rotationMag:0}},{time:.2,angles:{nkThigh:u-.7*Math.PI,nkShin:.8*Math.PI,kThigh:u+.3*Math.PI,kShin:.6*Math.PI,lArm:u+.6*Math.PI,rArm:u-.7*Math.PI,rotationMag:.4*Math.PI}},{time:.5,angles:{nkThigh:u-.9*Math.PI,nkShin:.8*Math.PI,kThigh:u-1.5*Math.PI,kShin:0*Math.PI,lArm:u-.8*Math.PI,rArm:u-.8*Math.PI,rotationMag:1*Math.PI}},{time:.75,angles:{nkThigh:u-.8*Math.PI,nkShin:.9*Math.PI,kThigh:u-.6*Math.PI,kShin:.7*Math.PI,lArm:u-.5*Math.PI,rArm:u+.5*Math.PI,rotationMag:1.6*Math.PI}},{time:1,angles:{nkThigh:u-.4*Math.PI,nkShin:.5*Math.PI,kThigh:u-.4*Math.PI,kShin:.5*Math.PI,lArm:u,rArm:u,rotationMag:2*Math.PI}}],n=Math.min(this.bicycleKickTimer/t,1);let a=e[0],s=e[1];for(let B=0;B<e.length-1;B++)if(n>=e[B].time&&n<e[B+1].time){a=e[B],s=e[B+1];break}const i=a.angles,r=s.angles,c=s.time-a.time,d=c>0?(n-a.time)/c:1,m=F(i.kThigh,r.kThigh,d),P=F(i.kShin,r.kShin,d);F(i.nkThigh,r.nkThigh,d),F(i.nkShin,r.nkShin,d);const A=this.facingDirection!==1,k=m,R=P,f=this.legLength*.5,b=this.legLength*.5,v={x:0,y:-this.legLength},E=G(v,f,k),l=G(E,b,k+R),h=0,g=-(this.legLength+this.torsoLength/2),p=l.x-h,y=l.y-g,w=Math.cos(this.rotationAngle),M=Math.sin(this.rotationAngle),T=p*w-y*M,L=p*M+y*w,C=T+h,O=L+g,W=this.x+C,$=this.y+O;return console.log(`[BicycleKickImpact] Timer: ${this.bicycleKickTimer.toFixed(2)} Prog: ${n.toFixed(2)} Rot: ${(this.rotationAngle*180/Math.PI).toFixed(1)}Â° RelFoot: (${l.x.toFixed(1)}, ${l.y.toFixed(1)}) AbsFoot: (${W.toFixed(1)}, ${$.toFixed(1)})`),{x:W,y:$}}getFootHitboxes(){const t=[],e={x:this.x,y:this.y-this.legLength},n=this.legLength*.5,a=this.legLength*.5,s=Nt*.5,i=G(e,n,this.leftThighAngle),r=G(i,a,this.leftThighAngle+this.leftShinAngle),c=this.leftThighAngle+this.leftShinAngle,d=G(r,s,c);t.push({x:d.x,y:d.y,radius:Yt});const m=G(e,n,this.rightThighAngle),P=G(m,a,this.rightThighAngle+this.rightShinAngle),A=this.rightThighAngle+this.rightShinAngle,k=G(P,s,A);return t.push({x:k.x,y:k.y,radius:Yt}),t}getBowCenterPosition(){const t=this.facingDirection*(this.armLength*.6),e=-this.legLength-this.torsoLength*.5,n=this.x+t,a=this.y+e;return{x:n,y:a}}getSwordCollisionShape(){if(!this.isSword||!this.isSwingingSword)return null;const t=this._getRelativeLimbPositions(),e={x:this.x+t.relRightHandPos.x,y:this.y+t.relRightHandPos.y},n=this.armLength*this.swordLengthMultiplier,a=n*.15,i=(this.facingDirection===1?Math.PI*2/3:Math.PI/3)+this.swordAngle,r=a*.5,c=G(e,r,i),d=G(e,n,i);return{p1:c,p2:d}}activateSpeedBoost(){this.speedMultiplier=ie,this.speedBoostTimer=se,console.log("Speed Boost Activated!")}deactivateSpeedBoost(){this.speedMultiplier=1,console.log("Speed Boost Deactivated.")}activateSuperJump(){this.jumpMultiplier=oe,this.superJumpTimer=ne,console.log("Super Jump Activated!")}deactivateSuperJump(){this.jumpMultiplier=1,console.log("Super Jump Deactivated.")}activateBigPlayer(){this.sizeMultiplier=ae,this.bigPlayerTimer=he,this.updateSizeAttributes(),console.log("Big Player Activated!")}deactivateBigPlayer(){this.sizeMultiplier=1,this.updateSizeAttributes(),console.log("Big Player Deactivated.")}fireRocket(t){if(!this.hasRocketLauncher||this.rocketAmmo<=0||this.isStunned||this.isTumbling)return null;this.rocketAmmo--,console.log(`Player ${this.facingDirection===1?1:2} fired rocket! Ammo left: ${this.rocketAmmo}`);const e=-this.legLength-this.torsoLength*.3,n=this.limbWidth*2,a=this.armLength*1.1,s=this.facingDirection*(this.limbWidth*.5),i=Math.abs(s)+a,r=n/2,c=Math.max(i,r),m=this.x+this.facingDirection*(c+15),P=this.y+e,A=this.facingDirection*de,k=0,R=new we(m,P,A,k,this,t);return _.playSound("ROCKET_FIRE_1"),this.rocketAmmo<=0&&(this.hasRocketLauncher=!1,console.log(`Player ${this.facingDirection===1?1:2} ran out of rockets.`)),R}updateSizeAttributes(){this.headRadius=this.baseHeadRadius*this.sizeMultiplier,this.torsoLength=this.baseTorsoLength*this.sizeMultiplier,this.armLength=this.baseArmLength*this.sizeMultiplier,this.legLength=this.baseLegLength*this.sizeMultiplier}startItching(){this.isItching||(console.log(`Player ${this.teamColor} started itching!`),this.isItching=!0,this.itchingTimer=this.itchDuration,this.isKicking=!1,this.isTumbling=!1,this.isBeingPushedBack=!1)}updateAim(t,e){const n=t-this.x,a=e-this.y;this.aimAngle=Math.atan2(-a,n)}}class xe{constructor(t,e){o(this,"x");o(this,"y");o(this,"vx");o(this,"vy");o(this,"radius");o(this,"color");o(this,"rotation",0);o(this,"rotationSpeed",0);o(this,"isFrozen",!1);o(this,"freezeTimer",0);this.x=t,this.y=e,this.vx=0,this.vy=0,this.radius=re,this.color=j}update(t){if(this.isFrozen&&this.freezeTimer&&this.freezeTimer>0){this.freezeTimer-=t,this.freezeTimer<=0&&(this.isFrozen=!1,console.log("Ball Unfrozen!"));return}const e=this.vy,n=this.vx;let a=!1;this.vy+=lt*t;const s=ee;this.vx*=s,this.vy*=s,this.x+=this.vx*t,this.y+=this.vy*t,this.rotation+=this.vx/this.radius*t,this.rotation+=this.rotationSpeed*t,this.y+this.radius>x&&(this.y=x-this.radius,e>50?(this.vy*=-.85,this.vx*=.9,a||(_.playSound("BALL_BOUNCE_1"),a=!0)):this.vy=0,this.vx*=Et),this.x-this.radius<0&&(this.y<=gt||this.y>=x)?(this.x=this.radius,n<-50?(this.vx*=-.85,a||(_.playSound("WALL_HIT_1"),a=!0)):this.vx=0):this.x+this.radius>I&&(this.y<=gt||this.y>=x)&&(this.x=I-this.radius,n>50?(this.vx*=-.85,a||(_.playSound("WALL_HIT_1"),a=!0)):this.vx=0);const i=[{x:ot,y:gt-X,width:K,height:X},{x:nt,y:gt-X,width:K,height:X}];for(const r of i)if(this.checkCircleRectCollision(this,r)){console.log("Crossbar Collision!");const c=.8,d=Math.max(r.x,Math.min(this.x,r.x+r.width)),m=Math.max(r.y,Math.min(this.y,r.y+r.height)),P=this.x-d,A=this.y-m,k=Math.sqrt(P*P+A*A)||1,R=this.radius-k;if(R>0){const f=P/k*(R+.1),b=A/k*(R+.1);this.x+=f,this.y+=b}Math.abs(P)>Math.abs(A)?(this.vx=-this.vx*c,this.vy*=.95):(A<0?(this.vy=-Math.abs(this.vy*c),this.vy>-80&&(this.vy-=80)):(this.vy=-Math.abs(this.vy*c),this.vy>-80&&(this.vy-=80),this.x+=Math.sign(this.x-(r.x+r.width/2))*1),this.vx*=.95),a||(_.playSound("CROSSBAR_HIT"),a=!0);break}}checkCircleRectCollision(t,e){const n=Math.max(e.x,Math.min(t.x,e.x+e.width)),a=Math.max(e.y,Math.min(t.y,e.y+e.height)),s=t.x-n,i=t.y-a;return s*s+i*i<t.radius*t.radius}draw(t){t.save(),t.translate(this.x,this.y),t.rotate(this.rotation),t.beginPath(),t.arc(0,0,this.radius,0,Math.PI*2),t.fillStyle=j,t.fill(),t.strokeStyle=Y,t.lineWidth=1,t.stroke(),t.closePath(),t.fillStyle=Y;const e=6,n=Math.PI*2/e,a=this.radius*.4,s=this.radius*.6;for(let i=0;i<e;i++){const r=i*n,c=Math.cos(r)*s,d=Math.sin(r)*s;t.beginPath();for(let m=0;m<5;m++){const P=r+m*(Math.PI*2)/5+Math.PI/5,A=c+Math.cos(P)*a,k=d+Math.sin(P)*a;m===0?t.moveTo(A,k):t.lineTo(A,k)}t.closePath(),t.fill()}this.isFrozen&&(t.beginPath(),t.arc(0,0,this.radius,0,Math.PI*2),t.fillStyle="rgba(173, 216, 230, 0.6)",t.fill(),t.closePath()),t.restore()}applyForce(t,e){this.vx+=t,this.vy+=e}applyKick(t,e){this.vx=t,this.vy=e}freeze(t){this.isFrozen=!0,this.freezeTimer=t,this.vx=0,this.vy=0,console.log(`Ball Frozen for ${t}s!`)}applyGroundFriction(){this.vx*=Et}}var H=(S=>(S.SPEED_BOOST="SPEED_BOOST",S.BIG_PLAYER="BIG_PLAYER",S.SUPER_JUMP="SUPER_JUMP",S.BALL_FREEZE="BALL_FREEZE",S.ROCKET_LAUNCHER="ROCKET_LAUNCHER",S.BOW="BOW",S.SWORD="SWORD",S.GOAL_ENLARGE="GOAL_ENLARGE",S))(H||{});class jt{constructor(t,e,n){o(this,"x");o(this,"y");o(this,"vx");o(this,"vy");o(this,"type");o(this,"width",30);o(this,"height",30);o(this,"isActive",!0);o(this,"hasParachute",!0);o(this,"driftSpeed",30);o(this,"descendSpeed",80);o(this,"swayTimer",0);o(this,"swayMagnitude",8);o(this,"swayFrequency",2);o(this,"currentSwayOffset",0);this.x=t,this.y=e,this.type=n,this.vy=this.descendSpeed,this.vx=(Math.random()<.5?-1:1)*this.driftSpeed}update(t){this.isActive&&(this.y<x-this.height?(this.x+=this.vx*t,this.y+=this.vy*t,(this.x<0||this.x+this.width>I)&&(this.vx*=-1,this.x=Math.max(0,Math.min(this.x,I-this.width))),this.hasParachute?(this.swayTimer+=t,this.currentSwayOffset=Math.sin(this.swayTimer*this.swayFrequency*2*Math.PI)*this.swayMagnitude):this.currentSwayOffset=0,this.hasParachute&&this.y>x-this.height*3&&(this.hasParachute=!1,this.vy=150,this.currentSwayOffset=0)):(this.y=x-this.height,this.vx=0,this.vy=0,this.hasParachute=!1),this.y>z&&(this.isActive=!1))}draw(t){if(!this.isActive)return;const n=this.x+this.currentSwayOffset,a=this.y,s=this.width,i=this.height;if(this.hasParachute){const r=s*2,c=i*1.5,d=n+s/2-r/2,m=a-c-i*.2;t.fillStyle=j,t.strokeStyle=Y,t.lineWidth=1,t.beginPath(),t.arc(d+r/2,m+c,r/2,Math.PI,0),t.closePath(),t.fill(),t.stroke(),t.beginPath(),t.moveTo(d,m+c),t.lineTo(n,a),t.moveTo(d+r,m+c),t.lineTo(n+s,a),t.stroke()}switch(t.save(),t.translate(n+s/2,a+i/2),t.fillStyle=j,t.strokeStyle=Y,t.lineWidth=1,t.fillRect(-s/2,-i/2,s,i),t.strokeRect(-s/2,-i/2,s,i),t.lineWidth=2,t.strokeStyle=Y,this.type){case"SPEED_BOOST":t.fillStyle="#FFFF00",t.beginPath(),t.moveTo(-s*.1,-i*.4),t.lineTo(s*.3,0),t.lineTo(s*.1,i*.4),t.lineTo(-s*.3,0),t.closePath(),t.fill(),t.stroke();break;case"BIG_PLAYER":t.fillStyle="#FF0000",t.beginPath(),t.moveTo(0,-i*.3),t.lineTo(s*.3,0),t.lineTo(s*.1,0),t.lineTo(s*.1,i*.3),t.lineTo(-s*.1,i*.3),t.lineTo(-s*.1,0),t.lineTo(-s*.3,0),t.closePath(),t.fill(),t.stroke();break;case"SUPER_JUMP":t.fillStyle="#00FF00",t.beginPath(),t.moveTo(-s*.3,i*.3),t.quadraticCurveTo(0,-i*.1,s*.3,i*.3),t.moveTo(-s*.3,i*.1),t.quadraticCurveTo(0,-i*.3,s*.3,i*.1),t.stroke();break;case"BALL_FREEZE":t.fillStyle="#00FFFF",t.beginPath();for(let r=0;r<6;r++){const c=Math.PI/3*r;t.moveTo(0,0),t.lineTo(Math.cos(c)*s*.4,Math.sin(c)*i*.4)}t.stroke(),t.beginPath(),t.arc(0,0,s*.15,0,Math.PI*2),t.fill();break;case"ROCKET_LAUNCHER":t.fillStyle="#808080",t.fillRect(-s*.1,-i*.4,s*.2,i*.8),t.beginPath(),t.moveTo(-s*.1,-i*.4),t.lineTo(s*.1,-i*.4),t.lineTo(0,-i*.6),t.closePath(),t.fill(),t.stroke(),t.fillRect(-s*.2,i*.2,s*.4,i*.1);break;case"BOW":t.fillStyle="#8B4513",t.strokeStyle=Y,t.lineWidth=2,t.beginPath(),t.arc(0,0,s*.35,Math.PI*.6,Math.PI*1.4),t.stroke(),t.beginPath(),t.moveTo(0,-i*.35),t.lineTo(0,i*.35),t.stroke();break;case"SWORD":t.fillStyle="#A9A9A9",t.strokeStyle=Y,t.lineWidth=2,t.fillRect(-s*.08,i*.1,s*.16,i*.3),t.fillRect(-s*.25,i*.05,s*.5,i*.1),t.beginPath(),t.moveTo(-s*.08,i*.05),t.lineTo(s*.08,i*.05),t.lineTo(s*.08,-i*.4),t.lineTo(0,-i*.5),t.lineTo(-s*.08,-i*.4),t.closePath(),t.fill(),t.stroke();break;case"GOAL_ENLARGE":t.fillStyle="#FFA500",t.strokeStyle=Y,t.lineWidth=2,t.beginPath(),t.moveTo(0,-i*.1),t.lineTo(0,-i*.4),t.moveTo(-s*.15,-i*.3),t.lineTo(0,-i*.4),t.lineTo(s*.15,-i*.3),t.stroke(),t.beginPath(),t.moveTo(0,i*.1),t.lineTo(0,i*.4),t.moveTo(-s*.15,i*.3),t.lineTo(0,i*.4),t.lineTo(s*.15,i*.3),t.stroke(),t.beginPath(),t.moveTo(-s*.1,0),t.lineTo(-s*.4,0),t.moveTo(-s*.3,-i*.15),t.lineTo(-s*.4,0),t.lineTo(-s*.3,i*.15),t.stroke(),t.beginPath(),t.moveTo(s*.1,0),t.lineTo(s*.4,0),t.moveTo(s*.3,-i*.15),t.lineTo(s*.4,0),t.lineTo(s*.3,i*.15),t.stroke();break;default:t.fillStyle="purple",t.fillRect(-s/2,-i/2,s,i),t.strokeStyle=j,t.strokeRect(-s/2,-i/2,s,i)}t.restore()}getRect(){return{x:this.x,y:this.y,width:this.width,height:this.height}}}class Ee{constructor(){o(this,"cache",new Map);o(this,"loading",new Set)}getImage(t){if(this.cache.has(t))return this.cache.get(t);if(!this.loading.has(t)){this.loading.add(t);const e=new Image;e.onload=()=>{console.log(`Image loaded: ${t}`),this.cache.set(t,e),this.loading.delete(t)},e.onerror=()=>{console.error(`Failed to load image: ${t}`),this.loading.delete(t)},e.src=t}return null}}class Ie{constructor(t){o(this,"ctx");o(this,"imageCache");this.ctx=t,this.imageCache=new Ee}draw(t){switch(t.currentState){case N.WELCOME:this.drawWelcomeScreen();break;case N.PLAYING:this.drawScoreboard(t.player1Score,t.player2Score),this.drawPlayerStatusText(t);break;case N.GOAL_SCORED:this.drawScoreboard(t.player1Score,t.player2Score),this.drawGoalMessage();break;case N.MATCH_OVER:this.drawScoreboard(t.player1Score,t.player2Score),this.drawMatchOverMessage(t.player1Score,t.player2Score);break;default:this.drawScoreboard(t.player1Score,t.player2Score);break}this.drawGlobalStatusText(t),this.drawGoalStatusText(t),this.drawDebugInfo(t)}drawWelcomeScreen(){this.ctx.fillStyle=j,this.ctx.font="40px Arial",this.ctx.textAlign="center",this.ctx.fillText("Awesome Ball 2!",I/2,z/2-50),this.ctx.font="24px Arial",this.ctx.fillText("Press Kick or Jump to Start",I/2,z/2)}drawScoreboard(t,e){const n=`${t} - ${e}`,a=32;this.ctx.font=`bold ${a}px Arial, sans-serif`,this.ctx.textAlign="center",this.ctx.textBaseline="top",this.ctx.strokeStyle=Y,this.ctx.lineWidth=3,this.ctx.strokeText(n,I/2,10),this.ctx.fillStyle=j,this.ctx.fillText(n,I/2,10)}drawPlayerStatusText(t){this.ctx.font="bold 14px Arial",this.ctx.fillStyle=j,this.ctx.textAlign="center";const n=I*.25;let a=50;t.p1SpeedBoostTimer&&t.p1SpeedBoostTimer>0&&(this.ctx.fillText(`SPEED UP! ${t.p1SpeedBoostTimer.toFixed(1)}s`,n,a),a+=16),t.p1SuperJumpTimer&&t.p1SuperJumpTimer>0&&(this.ctx.fillText(`HIGH JUMP! ${t.p1SuperJumpTimer.toFixed(1)}s`,n,a),a+=16),t.p1BigPlayerTimer&&t.p1BigPlayerTimer>0&&(this.ctx.fillText(`BIG! ${t.p1BigPlayerTimer.toFixed(1)}s`,n,a),a+=16),t.p1HasRocketLauncher&&t.p1RocketAmmo!==void 0&&t.p1RocketAmmo>0&&(this.ctx.fillStyle="#FF4500",this.ctx.fillText(`ROCKETS: ${t.p1RocketAmmo}`,n,a),this.ctx.fillStyle=j,a+=16),t.p1HasBow&&t.p1ArrowAmmo!==void 0&&t.p1ArrowAmmo>0&&(this.ctx.fillStyle="#90EE90",this.ctx.fillText(`ARROWS: ${t.p1ArrowAmmo}`,n,a),this.ctx.fillStyle=j,a+=16);const s=I*.75;let i=50;t.p2SpeedBoostTimer&&t.p2SpeedBoostTimer>0&&(this.ctx.fillText(`SPEED UP! ${t.p2SpeedBoostTimer.toFixed(1)}s`,s,i),i+=16),t.p2SuperJumpTimer&&t.p2SuperJumpTimer>0&&(this.ctx.fillText(`HIGH JUMP! ${t.p2SuperJumpTimer.toFixed(1)}s`,s,i),i+=16),t.p2BigPlayerTimer&&t.p2BigPlayerTimer>0&&(this.ctx.fillText(`BIG! ${t.p2BigPlayerTimer.toFixed(1)}s`,s,i),i+=16),t.p2HasRocketLauncher&&t.p2RocketAmmo!==void 0&&t.p2RocketAmmo>0&&(this.ctx.fillStyle="#FF4500",this.ctx.fillText(`ROCKETS: ${t.p2RocketAmmo}`,s,i),this.ctx.fillStyle=j,i+=16),t.p2HasBow&&t.p2ArrowAmmo!==void 0&&t.p2ArrowAmmo>0&&(this.ctx.fillStyle="#90EE90",this.ctx.fillText(`ARROWS: ${t.p2ArrowAmmo}`,s,i),this.ctx.fillStyle=j,i+=16)}drawGlobalStatusText(t){if(t.ballIsFrozen&&t.ballFreezeTimer&&t.ballFreezeTimer>0){const e=`BALL FROZEN: ${t.ballFreezeTimer.toFixed(1)}s`;this.ctx.font="bold 18px Arial",this.ctx.fillStyle="rgba(173, 216, 230, 0.9)",this.ctx.textAlign="center",this.ctx.fillText(e,I/2,z-30)}}drawGoalStatusText(t){this.ctx.font="bold 16px Arial",this.ctx.fillStyle="#FFA500",this.ctx.textAlign="center";const n=50;if(t.player1GoalEnlargeTimer&&t.player1GoalEnlargeTimer>0){const a=`P1 GOAL ENLARGED: ${t.player1GoalEnlargeTimer.toFixed(1)}s`,s=I*.2;this.ctx.fillText(a,s,n)}if(t.player2GoalEnlargeTimer&&t.player2GoalEnlargeTimer>0){const a=`P2 GOAL ENLARGED: ${t.player2GoalEnlargeTimer.toFixed(1)}s`,s=I*.8;this.ctx.fillText(a,s,n)}}drawGoalMessage(){this.ctx.fillStyle=wt,this.ctx.font="60px Impact",this.ctx.textAlign="center",this.ctx.fillText("GOAL!",I/2,z/3)}drawMatchOverMessage(t,e){}drawDebugInfo(t){if(t.debugSelectedPowerupType){const e=t.debugSelectedPowerupType,n=Object.keys(H).find(a=>H[a]===e);if(n&&bt.IMAGES.POWERUPS[n]){const a=bt.IMAGES.POWERUPS[n],s=this.imageCache.getImage(a);if(s){const i=Se*1.5,r=10;this.ctx.drawImage(s,r,r,i,i);const c=12;this.ctx.font=`${c}px Arial`,this.ctx.fillStyle=j,this.ctx.textAlign="left",this.ctx.textBaseline="top";const d=`(${e})`;this.ctx.fillText(d,r+i+5,r+i/2-c/2)}else{this.ctx.font="12px Arial",this.ctx.fillStyle="#FFA500",this.ctx.textAlign="left",this.ctx.textBaseline="top";const r=`Loading ${e}...`;this.ctx.fillText(r,10,10)}}else{this.ctx.font="12px Arial",this.ctx.fillStyle="#FF0000",this.ctx.textAlign="left",this.ctx.textBaseline="top";const s=`Icon path missing for ${e}`;this.ctx.fillText(s,10,10)}}}}class _e{constructor(){o(this,"activePowerups",[]);o(this,"spawnTimer",0);o(this,"minSpawnTime",15);o(this,"maxSpawnTime",45);o(this,"nextSpawnTime",0);this.resetSpawnTimer()}resetSpawnTimer(){this.nextSpawnTime=Math.random()*(this.maxSpawnTime-this.minSpawnTime)+this.minSpawnTime,this.spawnTimer=0}spawnPowerup(){const t=[H.SPEED_BOOST,H.BIG_PLAYER,H.SUPER_JUMP,H.BALL_FREEZE,H.ROCKET_LAUNCHER,H.BOW,H.SWORD,H.GOAL_ENLARGE],e=Math.floor(Math.random()*t.length),n=t[e],a=Math.random()*(I-40)+20,s=-50,i=new jt(a,s,n);this.activePowerups.push(i),this.resetSpawnTimer()}update(t){this.spawnTimer+=t,this.spawnTimer>=this.nextSpawnTime&&this.spawnPowerup();for(let e=this.activePowerups.length-1;e>=0;e--){const n=this.activePowerups[e];n.update(t),n.isActive||this.activePowerups.splice(e,1)}}draw(t){for(const e of this.activePowerups)e.draw(t)}checkCollisions(t){const e=t.getBodyRect();for(let n=this.activePowerups.length-1;n>=0;n--){const a=this.activePowerups[n];if(!a.isActive)continue;const s=a.getRect();if(e.x<s.x+s.width&&e.x+e.width>s.x&&e.y<s.y+s.height&&e.y+e.height>s.y){const i=a.type;return a.isActive=!1,this.activePowerups.splice(n,1),i}}return null}addPowerup(t){this.activePowerups.push(t)}}const Ut=.97;class tt{constructor(t,e,n,a,s,i,r=3,c=.5,d="circle"){o(this,"x");o(this,"y");o(this,"vx");o(this,"vy");o(this,"lifespan");o(this,"initialLifespan");o(this,"color");o(this,"radius");o(this,"initialRadius");o(this,"alpha",1);o(this,"gravityEffect");o(this,"isActive",!0);o(this,"particleType","circle");this.x=t,this.y=e,this.vx=n,this.vy=a,this.lifespan=s,this.initialLifespan=s,this.color=i,this.radius=r,this.initialRadius=r,this.gravityEffect=c,this.particleType=d}update(t){if(this.isActive)if(this.vy+=lt*this.gravityEffect*t,this.x+=this.vx*t,this.y+=this.vy*t,this.vx*=Ut,this.vy*=Ut,this.lifespan-=t,this.lifespan<=0)this.alpha=0,this.isActive=!1;else{const e=Math.max(0,this.lifespan/this.initialLifespan);this.particleType==="smoke"?(this.alpha=e,this.radius=this.initialRadius*(.8+.2*e)):this.particleType==="spark"?(this.alpha=e*e,this.radius=this.initialRadius*this.alpha):(this.alpha=e,this.radius=this.initialRadius*e)}}draw(t){!this.isActive||this.alpha<=0||this.radius<=.1||(t.globalAlpha=this.alpha,t.fillStyle=this.color,t.shadowBlur,t.shadowColor,t.beginPath(),t.arc(this.x,this.y,Math.max(.5,this.radius),0,Math.PI*2),t.fill(),t.globalAlpha=1)}}class Ce{constructor(){o(this,"particles",[])}addParticle(t){this.particles.push(t)}emit(t,e,n,a=10,s={}){const i=s.scale||1;switch(t){case"dust":const r=s.count!==void 0?s.count:8;for(let f=0;f<r;f++){const b=Math.random()*Math.PI*2,v=Math.random()*35+10,E=Math.cos(b)*v,l=Math.sin(b)*v*.6-3,h=Math.random()*.7+.4;let g=Math.random()*1.6+1.2;g*=i;const p=s.color||"rgba(139, 69, 19, 0.65)",y=.02;this.addParticle(new tt(e,n,E,l,h,p,g,y,"smoke"))}break;case"landingDust":const c=s.count!==void 0?s.count:12;for(let f=0;f<c;f++){const b=Math.random()*Math.PI*2,v=Math.random()*40+15,E=Math.cos(b)*v,l=Math.sin(b)*v*.5-5,h=Math.random()*.8+.5;let g=Math.random()*3.4+2.4;const p=1+Math.min(2,Math.abs(s.landingVelocity||0)/500);g*=i*p;const y="rgba(255, 255, 255, 0.6)",w=.03;this.addParticle(new tt(e,n,E,l,h,y,g,w,"smoke"))}break;case"goal":const d=s.count!==void 0?s.count:50;for(let f=0;f<d;f++){const b=Math.random()*Math.PI*2,v=Math.random()*90+30,E=Math.cos(b)*v,l=Math.sin(b)*v,h=Math.random()*.5+.3;let g=Math.random()*1.8+1.2;g*=i;const p=["#FFD700","#FFA500","#FF4500"],y=p[Math.floor(Math.random()*p.length)],w=.1;this.addParticle(new tt(e,n,E,l,h,y,g,w,"spark"))}break;case"jump":const m=s.count!==void 0?s.count:10;for(let f=0;f<m;f++){const b=Math.random()*Math.PI*.8+Math.PI*1.1,v=Math.random()*30+8,E=Math.cos(b)*v,l=Math.sin(b)*v*.7,h=Math.random()*.6+.3;let g=Math.random()*1.7+1.2;g*=i;const p="rgba(255, 255, 255, 0.7)",y=.01;this.addParticle(new tt(e,n,E,l,h,p,g,y,"smoke"))}break;case"kick":for(let f=0;f<a;f++){const b=Math.random()*Math.PI*2,v=Math.random()*60+20,E=Math.cos(b)*v*(s.kickDirection||1),l=Math.sin(b)*v-15,h=Math.random()*.35+.25;let g=Math.random()*1.4+1.1;g*=i;const p="#FFFF00",y=.1;this.addParticle(new tt(e,n,E,l,h,p,g,y,"spark"))}break;case"explosion":const P=s.count!==void 0?s.count:50,A=s.radius||50;for(let f=0;f<P;f++){const b=Math.random()*Math.PI*2,v=Math.random()*(A*2.5)+A*.5,E=Math.cos(b)*v,l=Math.sin(b)*v,h=Math.random()*.6+.3;let g=Math.random()*3+2;g*=i;const p=["#FFA500","#FF4500","#FFD700","#FFFFFF","#808080"],y=p[Math.floor(Math.random()*p.length)],w=.05,M=Math.random()<.7?"spark":"smoke";this.addParticle(new tt(e,n,E,l,h,y,g,w,M))}break;case"rocket_smoke":const k=s.count!==void 0?s.count:1,R=s.baseSpeed||50;for(let f=0;f<k;f++){const b=(s.vx||0)*-.02,v=(s.vy||0)*-.02,E=Math.PI/4,h=Math.atan2(s.vy||0,s.vx||0)+Math.PI+(Math.random()*E-E/2),g=R*(Math.random()*.2+.1),p=Math.cos(h)*g,y=Math.sin(h)*g,w=Math.random()*.5+.3;let M=Math.random()*1.5+1;M*=i;const T=`rgba(150, 150, 150, ${Math.random()*.3+.4})`,L=.01;this.addParticle(new tt(e+b,n+v,p,y,w,T,M,L,"smoke"))}break}}update(t){for(let e=this.particles.length-1;e>=0;e--)this.particles[e].update(t),this.particles[e].isActive||this.particles.splice(e,1)}draw(t){for(const e of this.particles)e.draw(t)}clear(){this.particles=[]}}var Vt=(S=>(S.FLYING="FLYING",S.STUCK="STUCK",S))(Vt||{});function Xt(S,t,e){return{x:S.x+t*Math.cos(e),y:S.y-t*Math.sin(e)}}class Jt{constructor(t,e,n,a,s,i){o(this,"x");o(this,"y");o(this,"vx");o(this,"vy");o(this,"owner");o(this,"isActive",!0);o(this,"state","FLYING");o(this,"width",30);o(this,"thickness",2);o(this,"angle",0);o(this,"stuckToObject",null);o(this,"stuckOffsetX",0);o(this,"stuckOffsetY",0);o(this,"lastPos");o(this,"particleSystem");o(this,"length",30);o(this,"headSize",6);this.x=t,this.y=e,this.vx=n,this.vy=a,this.owner=s,this.angle=Math.atan2(a,n),this.lastPos={x:t,y:e},this.particleSystem=i}update(t){return this.isActive&&(this.lastPos={x:this.x,y:this.y},this.state==="FLYING"?(this.vy+=lt*t,this.x+=this.vx*t,this.y+=this.vy*t,this.angle=Math.atan2(this.vy,this.vx),(this.x<-this.width*2||this.x>I+this.width*2||this.y>z+100||this.y<-this.width*2)&&(console.log("Arrow went way out of bounds, deactivating."),this.isActive=!1)):this.state==="STUCK"&&this.stuckToObject&&typeof this.stuckToObject=="object"&&"x"in this.stuckToObject&&"y"in this.stuckToObject&&(this.x=this.stuckToObject.x+this.stuckOffsetX,this.y=this.stuckToObject.y+this.stuckOffsetY,this.stuckToObject instanceof At)),!1}stick(t,e,n){var a;if(this.state==="FLYING")if(this.state="STUCK",this.stuckToObject=t,this.x=e,this.y=n,this.angle=Math.atan2(this.vy,this.vx),this.vx=0,this.vy=0,t&&typeof t=="object"&&"x"in t&&"y"in t){this.stuckOffsetX=e-t.x,this.stuckOffsetY=n-t.y;let s=((a=t.constructor)==null?void 0:a.name)||"object";t instanceof At&&(s="Player"),console.log(`Arrow Stuck to ${s} at relative offset (${this.stuckOffsetX.toFixed(1)}, ${this.stuckOffsetY.toFixed(1)})`)}else console.log(`Arrow Stuck to ${t} at (${e.toFixed(1)}, ${n.toFixed(1)})`)}getTipPosition(){return Xt({x:this.x,y:this.y},this.width*.5,this.angle)}getBasePosition(){return Xt({x:this.x,y:this.y},-this.width*.5,this.angle)}draw(t){this.isActive&&(t.save(),t.translate(this.x,this.y),t.rotate(this.angle),t.strokeStyle=this.owner.teamColor,t.lineWidth=this.thickness,t.beginPath(),t.moveTo(-this.width/2,0),t.lineTo(this.width/2,0),t.stroke(),t.fillStyle=Y,t.beginPath(),t.moveTo(this.width/2,0),t.lineTo(this.width/2-6,-3),t.lineTo(this.width/2-6,3),t.closePath(),t.fill(),t.lineWidth=1,t.strokeStyle="#A0522D",t.beginPath(),t.moveTo(-this.width/2,0),t.lineTo(-this.width/2-5,-4),t.moveTo(-this.width/2,0),t.lineTo(-this.width/2-5,4),t.moveTo(-this.width/2-2,0),t.lineTo(-this.width/2-7,-4),t.moveTo(-this.width/2-2,0),t.lineTo(-this.width/2-7,4),t.stroke(),t.restore())}getCollisionShape(){const t=this.length/2,e=this.x-Math.cos(this.angle)*t,n=this.y-Math.sin(this.angle)*t,a=this.x+Math.cos(this.angle)*t,s=this.y+Math.sin(this.angle)*t;return{p1:{x:e,y:n},p2:{x:a,y:s},radius:this.thickness/2}}getLastPosition(){return this.lastPos}}const mt=5,Oe=1.5,zt=400;class Be{constructor(t){o(this,"ctx");o(this,"inputHandler");o(this,"uiManager");o(this,"particleSystem");o(this,"lastTime",0);o(this,"accumulatedTime",0);o(this,"timeStep",1/Qt);o(this,"player1");o(this,"player2");o(this,"ball");o(this,"player1Score",0);o(this,"player2Score",0);o(this,"currentState",N.WELCOME);o(this,"goalMessageTimer",0);o(this,"matchOverTimer",0);o(this,"powerupManager");o(this,"activeRockets",[]);o(this,"activeArrows",[]);o(this,"isPlayer1GoalEnlarged",!1);o(this,"player1GoalEnlargeTimer",0);o(this,"isPlayer2GoalEnlarged",!1);o(this,"player2GoalEnlargeTimer",0);o(this,"player1LastKickTime",0);o(this,"player2LastKickTime",0);o(this,"debugAvailablePowerupTypes",Object.values(H));o(this,"debugSelectedPowerupIndex",this.debugAvailablePowerupTypes.indexOf(H.GOAL_ENLARGE)>=0?this.debugAvailablePowerupTypes.indexOf(H.GOAL_ENLARGE):0);o(this,"isMatchOverListenerActive",!1);o(this,"handleMatchOverKeyPress",t=>{const e=t.key.toLowerCase();(e==="enter"||e==="s"||e==="arrowdown")&&(console.log(`Restart key pressed (${t.key}) after Match Over. Restarting game...`),this.startNewMatch(),this.removeMatchOverRestartListener())});this.ctx=t,this.inputHandler=new Te,this.uiManager=new Ie(t),this.powerupManager=new _e,this.particleSystem=new Ce,this.player1=new At(I*.25,x,1,"#DCDCDC","#1E1E1E",Y,lt,xt,Rt),this.player2=new At(I*.75,x,-1,"#009246","#CE2B37",Y,lt,xt,Rt),this.ball=new xe(I/2,x-100)}spawnSpecificPowerup(t,e,n){const a=new jt(e,n,t);this.powerupManager.addPowerup(a)}resetPositions(){this.ball.x=I/2,this.ball.y=x-100,this.ball.vx=0,this.ball.vy=0,this.player1.x=I*.25,this.player1.y=x,this.player1.vx=0,this.player1.vy=0,this.player1.facingDirection=1,this.player1.isKicking=!1,this.player1.isJumping=!1,this.player1.isTumbling=!1,this.player1.isStunned=!1,this.player1.stunTimer=0,this.player1.isBeingPushedBack=!1,this.player1.pushbackTimer=0,this.player1.isItching=!1,this.player1.speedMultiplier=1,this.player1.jumpMultiplier=1,this.player1.sizeMultiplier=1,this.player1.hasRocketLauncher=!1,this.player1.rocketAmmo=0,this.player1.hasBow=!1,this.player1.arrowAmmo=0,this.player1.isSword=!1,this.player2.x=I*.75,this.player2.y=x,this.player2.vx=0,this.player2.vy=0,this.player2.facingDirection=-1,this.player2.isKicking=!1,this.player2.isJumping=!1,this.player2.isTumbling=!1,this.player2.isStunned=!1,this.player2.stunTimer=0,this.player2.isBeingPushedBack=!1,this.player2.pushbackTimer=0,this.player2.isItching=!1,this.player2.speedMultiplier=1,this.player2.jumpMultiplier=1,this.player2.sizeMultiplier=1,this.player2.hasRocketLauncher=!1,this.player2.rocketAmmo=0,this.player2.hasBow=!1,this.player2.arrowAmmo=0,this.player2.isSword=!1,this.particleSystem.clear()}startNewMatch(){console.log("Executing startNewMatch..."),this.player1Score=0,this.player2Score=0,this.resetPositions(),this.activeRockets=[],this.activeArrows=[],this.powerupManager&&Array.isArray(this.powerupManager.activePowerups)?this.powerupManager.activePowerups=[]:console.warn("Could not clear powerups in PowerupManager"),this.currentState=N.PLAYING,this.particleSystem.clear(),console.log("startNewMatch finished. State set to PLAYING.")}checkGoal(){if(this.currentState!==N.PLAYING)return;const t=Pt;this.isPlayer1GoalEnlarged&&K*t;const e=this.isPlayer1GoalEnlarged?U*t:U,n=ot,a=x-e,s=n,i=this.isPlayer2GoalEnlarged?K*t:K,r=this.isPlayer2GoalEnlarged?U*t:U,c=nt-(i-K),d=x-r,m=c+i,P=this.ball.y+this.ball.radius,A=P>a&&this.ball.y-this.ball.radius<x,k=P>d&&this.ball.y-this.ball.radius<x;let R=!1,f=null;A&&this.ball.x-this.ball.radius<s?(console.log("GOAL P2! (Goal Size Adjusted)"),this.player2Score++,R=!0,f=2):k&&this.ball.x+this.ball.radius>m&&(console.log("GOAL P1! (Goal Size Adjusted)"),this.player1Score++,R=!0,f=1),R&&(f===1?_.playSound("PLAYER1_GOAL_1"):f===2&&_.playSound("PLAYER2_GOAL_1"),this.particleSystem.emit("goal",this.ball.x,this.ball.y,50),this.player1Score>=mt||this.player2Score>=mt?(this.currentState=N.MATCH_OVER,this.matchOverTimer=3,this.player1Score>=mt?_.playSound("NILS_WINS"):_.playSound("HARRY_WINS")):(this.currentState=N.GOAL_SCORED,this.goalMessageTimer=Oe,this.announceScore()))}handleCollisions(){if(this.currentState!==N.PLAYING)return;const t=[this.player1,this.player2];let e=!1;const n=l=>{if(typeof l.getKickImpactPoint=="function")return l.getKickImpactPoint();if(!l.isKicking)return null;const h=l.legLength||30,g=h*.8,p=l.y-h*.5;return{x:l.x+l.facingDirection*g,y:p}};for(const l of t){const h=this.powerupManager.checkCollisions(l);h&&this.applyPowerup(l,h)}const a=this.player1.getBodyRect(),s=this.player2.getBodyRect();if(this.checkRectCollision(a,s)){const l=a.x+a.width/2-(s.x+s.width/2),h=a.width/2+s.width/2-Math.abs(l);if(h>0){const g=h/2,p=Math.sign(l)||1;this.player1.x+=g*p,this.player2.x-=g*p;const y=.3,w=this.player1.vx,M=this.player2.vx;this.player1.vx=-w*y+M*y*.5,this.player2.vx=-M*y+w*y*.5,console.log("Player-Player Body Collision"),_.playSound("PLAYER_BUMP_1")}}if(this.checkFeetOnHeadCollision(this.player1,this.player2)){const l=this.player2.getHeadCircle();this.player1.y=l.y-l.radius,this.player1.vy=0,this.player1.isJumping=!1,this.player1.onOtherPlayerHead=!0}else this.player1.onOtherPlayerHead=!1;if(this.checkFeetOnHeadCollision(this.player2,this.player1)){const l=this.player1.getHeadCircle();this.player2.y=l.y-l.radius,this.player2.vy=0,this.player2.isJumping=!1,this.player2.onOtherPlayerHead=!0}else this.player2.onOtherPlayerHead=!1;for(const l of t){if(l.isBicycleKicking&&!e){const T=l.getBicycleKickImpactPoint();if(T){const L=this.ball.x-T.x,C=this.ball.y-T.y,O=L*L+C*C,W=this.ball.radius+60,$=W*W;if(console.log(`[Bicycle Kick] Check: dist=${Math.sqrt(O).toFixed(1)}, radius=${Math.sqrt($).toFixed(1)}`),O<$){console.log(`BICYCLE KICK CONNECT! Player: ${l===this.player1?1:2}, KickPoint: (${T.x.toFixed(1)}, ${T.y.toFixed(1)}), Ball: (${this.ball.x.toFixed(1)}, ${this.ball.y.toFixed(1)})`),_.playSound("KICK_1"),console.log("Applying Bicycle Kick force (Direction-Based)!");const D=dt*2.5*1.5,J=-(l.legLength+l.torsoLength/2),Q=l.x,V=l.y+J;let Z=T.x-Q,q=T.y-V;const at=Math.sqrt(Z*Z+q*q);at>0?(Z/=at,q/=at):(Z=l.facingDirection,q=-.5);const St=Z*D,ht=q*D;this.ball.applyKick(St,ht),this.particleSystem.emit("kick",T.x,T.y,15,{kickDirection:l.facingDirection,isBicycle:!0}),e=!0;continue}}}if(l.isKicking&&!e){const T=l.getKickImpactPoint();if(T){const L=this.ball.x-T.x,C=this.ball.y-T.y,O=L*L+C*C,W=this.ball.radius+30,$=W*W;if(O<$){console.log(`Kick Connect! Player: ${l===this.player1?1:2}, KickPoint: (${T.x.toFixed(1)}, ${T.y.toFixed(1)}), Ball: (${this.ball.x.toFixed(1)}, ${this.ball.y.toFixed(1)}), DistSq: ${O.toFixed(1)}, RadiusSq: ${$.toFixed(1)}`),_.playSound("KICK_1");let B=0,D=0;if(l.isBicycleKicking){console.log("Applying Bicycle Kick force!");const ht=2,rt=1.5;B=l.facingDirection*dt*ht*.7,D=Tt*ht*rt}else{const rt=l.vx*.4,Mt=l.vy*.4,vt=l.facingDirection*dt*1.5;let ct=Tt*1.5;const Lt=x-this.ball.radius*2;this.ball.y<Lt&&(ct*=.2,console.log(`Volley kick! Ball Y: ${this.ball.y.toFixed(0)}, Threshold: ${Lt.toFixed(0)}. Reduced base VY to ${ct.toFixed(0)}`)),B=vt+rt,D=ct+Mt,console.log(`Standard Kick Details: Base=(${vt.toFixed(0)}, ${ct.toFixed(0)}), Momentum=(${rt.toFixed(0)}, ${Mt.toFixed(0)}), Final=(${B.toFixed(0)}, ${D.toFixed(0)})`)}const J=Math.atan2(D,B),Q=Math.sqrt(B*B+D*D),V=Math.PI/18,Z=(Math.random()*2-1)*V,q=J+Z,at=Math.cos(q)*Q,St=Math.sin(q)*Q;console.log(`Kick Randomness: OrigAngle=${J.toFixed(2)}, Offset=${Z.toFixed(2)}, FinalAngle=${q.toFixed(2)}`),this.ball.applyKick(at,St),this.particleSystem.emit("kick",T.x,T.y,l.isBicycleKicking?15:8,{kickDirection:l.facingDirection,isBicycle:l.isBicycleKicking}),e=!0;continue}}}const h=l.getHeadCircle(),g=this.ball.x-h.x,p=this.ball.y-h.y,y=g*g+p*p,w=h.radius+this.ball.radius+5,M=w*w;if(y<M&&!l.isKicking){console.log("Headbutt Connect!");const T=dt*l.facingDirection*.6,L=Tt*1.5,C=l.vx*.3,O=l.vy*.3;this.ball.vx=T+C,this.ball.vy=L+O,e=!0,_.playSound("HEADBUTT_1")}if(!e){const T=l.getBodyRect();if(this.checkCircleRectCollision(this.ball,T)){const L=Math.max(T.x,Math.min(this.ball.x,T.x+T.width)),C=Math.max(T.y,Math.min(this.ball.y,T.y+T.height)),O=this.ball.x-L,W=this.ball.y-C,$=O*O+W*W;if($<this.ball.radius*this.ball.radius){const B=Math.sqrt($),D=this.ball.radius-B;if(B>0){const Z=O/B*D,q=W/B*D;this.ball.x+=Z,this.ball.y+=q}const J=this.ball.vx-l.vx,Q=this.ball.vy-l.vy,V=.5;this.ball.vx=l.vx+-J*V,this.ball.vy=l.vy+-Q*V,_.playSound("BODY_HIT_1")}}}}const i=this.ball,r=Pt,c=this.isPlayer1GoalEnlarged?U*r:U,d=x-c,m=this.isPlayer1GoalEnlarged?K*r:K,P=ot,A=d,k=this.isPlayer2GoalEnlarged?U*r:U,R=x-k,f=this.isPlayer2GoalEnlarged?K*r:K,b=nt-(f-K),v=R;i.x-i.radius<_t?i.y<d&&(i.vx*=-.85,i.x=_t+i.radius,this.particleSystem.emit("dust",i.x,i.y,8),_.playSound("WALL_HIT_1")):i.x+i.radius>Ct&&i.y<R&&(i.vx*=-.85,i.x=Ct-i.radius,this.particleSystem.emit("dust",i.x,i.y,8),_.playSound("WALL_HIT_1"));const E=X;i.x>=P&&i.x<=P+m&&i.y+i.radius>=A-E&&i.y-i.radius<=A&&i.vy>0&&(i.y=A-E-i.radius,i.vy*=-.85*.9,i.vx*=.95,console.log("Ball hit P1 Crossbar (bottom)!"),_.playSound("CROSSBAR_HIT"),this.particleSystem.emit("dust",i.x,i.y,5)),i.x>=b&&i.x<=b+f&&i.y+i.radius>=v-E&&i.y-i.radius<=v&&i.vy>0&&(i.y=v-E-i.radius,i.vy*=-.85*.9,i.vx*=.95,console.log("Ball hit P2 Crossbar (bottom)!"),_.playSound("CROSSBAR_HIT"),this.particleSystem.emit("dust",i.x,i.y,5)),i.y-i.radius<0&&(i.y=i.radius,i.vy*=-.85,this.particleSystem.emit("dust",i.x,i.y,8)),i.y+i.radius>x&&(i.y=x-i.radius,i.vy*=-.85,i.applyGroundFriction(),i.rotationSpeed*=.8,Math.abs(i.vy)>20&&this.particleSystem.emit("dust",i.x,i.y,12,{color:"#A0522D"}));for(const l of t){const h=l===this.player1?this.player2:this.player1;if(l.isKicking&&!h.isTumbling&&!h.isBeingPushedBack){const g=n(l);if(g){const p=h.getHeadCircle(),y=g.x-p.x,w=g.y-p.y,M=y*y+w*w,T=p.radius+5,L=T*T;if(M<L){console.log(`Player ${l===this.player1?1:2} kicked Player ${h===this.player1?1:2} in the head! Pushback!`);const C=ce;h.vx=C*l.facingDirection,h.vy=-200,h.isJumping=!0,h.onOtherPlayerHead=!1,h.onLeftCrossbar=!1,h.onRightCrossbar=!1,h.isBeingPushedBack=!0,h.pushbackTimer=Ot,_.playSound("BODY_HIT_1"),l.isKicking=!1}}}}for(let l=this.activeRockets.length-1;l>=0;l--){const h=this.activeRockets[l],g=h.getRect();let p=null;for(const y of t){const w=y.getBodyRect(),M=y.getHeadCircle();if(this.checkRectCollision(g,w)||this.checkCircleRectCollision(M,g)){p=y;const T=y.x-h.x,L=Math.sqrt(T*T);if(L>0){const C=T/L,O=ge;y.vx+=C*O,console.log(`Rocket direct hit on Player ${y===this.player1?1:2}. Applying pushback vx: ${(C*O).toFixed(1)}`),y.vy-=60,y.isJumping=!0}h.exploded=!0;break}}if(!h.exploded){const y={x:this.ball.x,y:this.ball.y,radius:this.ball.radius};this.checkCircleRectCollision(y,g)&&(console.log("Rocket hit ball"),h.exploded=!0)}!h.exploded&&(h.x<0||h.x>I||h.y<0||h.y>x)&&(console.log("Rocket hit terrain/wall"),h.exploded=!0),h.exploded&&(console.log(`Rocket exploded at (${h.x.toFixed(0)}, ${h.y.toFixed(0)})`),this.createExplosion(h.x,h.y,p),this.activeRockets.splice(l,1),_.playSound("EXPLOSION_1"))}for(let l=this.activeArrows.length-1;l>=0;l--){const h=this.activeArrows[l];if(!h.isActive||h.state===Vt.STUCK)continue;let g=!1;const p=h.getTipPosition();for(const y of t){if(h.owner===y)continue;const w=y.getHeadCircle(),M=y.getBodyRect();let T=!1;const L=p.x-w.x,C=p.y-w.y;if(L*L+C*C<w.radius*w.radius?(console.log(`Arrow hit Player ${y===this.player1?1:2} head (Tip Check)`),T=!0):p.x>=M.x&&p.x<=M.x+M.width&&p.y>=M.y&&p.y<=M.y+M.height&&(console.log(`Arrow hit Player ${y===this.player1?1:2} body (Tip Check)`),T=!0),T){h.stick(y,p.x,p.y),y.startItching();const O=Math.atan2(p.y-y.y,p.x-y.x);y.vx+=Math.cos(O)*Gt,y.vy+=Math.sin(O)*Gt*.5-100,_.playSound("BODY_HIT_1"),g=!0;break}}if(!g){const y=p.x-this.ball.x,w=p.y-this.ball.y;if(y*y+w*w<this.ball.radius*this.ball.radius){const M=h.vx,T=h.vy;console.log(`[GM] Arrow hit Ball. Stored Velocity: (${M.toFixed(1)}, ${T.toFixed(1)}) (Tip Check)`);const L=1,C=M*L,O=T*L;console.log(`[GM] Calculated Force to Apply: (${C.toFixed(1)}, ${O.toFixed(1)})`),console.log("[GM] Calling ball.applyForce..."),this.ball.applyForce(C,O),console.log("[GM] Returned from ball.applyForce."),_.playSound("BODY_HIT_1"),console.log("[GM] Calling arrow.stick..."),h.stick(this.ball,p.x,p.y),console.log("[GM] Returned from arrow.stick."),g=!0}}!g&&h.y>=x-h.thickness/2&&(console.log("Arrow hit Ground (End Pos Check)"),h.stick("ground",h.x,x-h.thickness/2),g=!0)}for(const l of t){if(!l.isSword||!l.isSwingingSword)continue;const h=l.getSwordCollisionShape();if(!h)continue;const g=l===this.player1?this.player2:this.player1;if(!g.isTumbling&&!g.isBeingPushedBack){const y=g.getHeadCircle(),w=g.getBodyRect();let M=!1;if(this.checkLineCircleCollision(h.p1,h.p2,y))console.log(`Sword hit Player ${g===this.player1?1:2} head!`),M=!0;else{const T=w.x+w.width/2,L=w.y+w.height/2,C=Math.max(w.width,w.height)/1.8,O={x:T,y:L,radius:C};this.checkLineCircleCollision(h.p1,h.p2,O)&&(console.log(`Sword hit Player ${g===this.player1?1:2} body!`),M=!0)}if(M){const T=Math.sign(g.x-l.x)||1,L=-300;g.vx=T*me,g.vy=L,g.isBeingPushedBack=!0,g.pushbackTimer=Ot,g.isJumping=!0,g.onOtherPlayerHead=!1,g.onLeftCrossbar=!1,g.onRightCrossbar=!1,g.startTumble(),_.playSound("SWORD_HIT")}}const p={x:this.ball.x,y:this.ball.y,radius:this.ball.radius};if(console.log(`[Sword Check] Sword: p1=(${h.p1.x.toFixed(1)},${h.p1.y.toFixed(1)}), p2=(${h.p2.x.toFixed(1)},${h.p2.y.toFixed(1)}) | Ball: cx=${p.x.toFixed(1)}, cy=${p.y.toFixed(1)}, r=${p.radius.toFixed(1)}`),this.checkLineCircleCollision(h.p1,h.p2,p)){const y=Math.atan2(h.p2.y-h.p1.y,h.p2.x-h.p1.x),w=Pe,M=Math.cos(y)*w,T=Math.sin(y)*w;this.ball.applyForce(M,T),_.playSound("SWORD_HIT_BALL")}}}checkRectCollision(t,e){return t.x<e.x+e.width&&t.x+t.width>e.x&&t.y<e.y+e.height&&t.y+t.height>e.y}checkFeetOnHeadCollision(t,e){const n=e.getHeadCircle(),a=t.x,s=t.y,i=n.y-n.radius,r=n.y,c=n.x-n.radius,d=n.x+n.radius;return a>=c&&a<=d&&s>=i&&s<=r+5&&t.vy>=0}checkCircleRectCollision(t,e){const n=Math.max(e.x,Math.min(t.x,e.x+e.width)),a=Math.max(e.y,Math.min(t.y,e.y+e.height)),s=t.x-n,i=t.y-a;return s*s+i*i<t.radius*t.radius}checkLineCircleCollision(t,e,n){const a=(e.x-t.x)*(e.x-t.x)+(e.y-t.y)*(e.y-t.y);if(a===0){const P=n.x-t.x,A=n.y-t.y;return P*P+A*A<=n.radius*n.radius}let s=((n.x-t.x)*(e.x-t.x)+(n.y-t.y)*(e.y-t.y))/a;s=Math.max(0,Math.min(1,s));const i=t.x+s*(e.x-t.x),r=t.y+s*(e.y-t.y),c=n.x-i,d=n.y-r;return c*c+d*d<=n.radius*n.radius}applyPowerup(t,e){switch(console.log(`Applying powerup ${e} to player ${t===this.player1?1:2}...`),e){case H.SPEED_BOOST:t.activateSpeedBoost();break;case H.BIG_PLAYER:t.activateBigPlayer();break;case H.SUPER_JUMP:t.activateSuperJump();break;case H.BALL_FREEZE:console.log("Calling ball.freeze()"),this.ball.freeze(le);break;case H.ROCKET_LAUNCHER:{const s=t.hasRocketLauncher;s?t.rocketAmmo+=3:(t.hasRocketLauncher=!0,t.rocketAmmo=3),console.log(`Player ${t===this.player1?1:2} ${s?"added":"picked up"} Rocket Launcher (Ammo: ${t.rocketAmmo})`);break}case H.BOW:t.hasRocketLauncher&&(t.hasRocketLauncher=!1,t.rocketAmmo=0),t.isSword&&(t.isSword=!1);const n=t.hasBow;t.hasBow=!0,n?t.arrowAmmo+=3:t.arrowAmmo=3,t.aimAngle=0,console.log(`Player ${t===this.player1?1:2} ${n?"added arrows to":"picked up"} Bow (Ammo: ${t.arrowAmmo})`);break;case H.SWORD:t.hasRocketLauncher&&(t.hasRocketLauncher=!1,t.rocketAmmo=0),t.hasBow&&(t.hasBow=!1,t.arrowAmmo=0),t.isSword=!0,console.log(`Player ${t===this.player1?1:2} picked up Sword`);break;case H.GOAL_ENLARGE:t===this.player1?(this.isPlayer2GoalEnlarged=!0,this.player2GoalEnlargeTimer=It,console.log("Player 2 goal enlarged!")):(this.isPlayer1GoalEnlarged=!0,this.player1GoalEnlargeTimer=It,console.log("Player 1 goal enlarged!"));break;default:console.warn(`Unhandled powerup type: ${e}`)}}update(t){switch(this.inputHandler.update(),this.isPlayer1GoalEnlarged&&this.player1GoalEnlargeTimer>0&&(this.player1GoalEnlargeTimer-=t,this.player1GoalEnlargeTimer<=0&&(this.isPlayer1GoalEnlarged=!1,console.log("Player 1 goal back to normal size."))),this.isPlayer2GoalEnlarged&&this.player2GoalEnlargeTimer>0&&(this.player2GoalEnlargeTimer-=t,this.player2GoalEnlargeTimer<=0&&(this.isPlayer2GoalEnlarged=!1,console.log("Player 2 goal back to normal size."))),this.currentState===N.MATCH_OVER&&this.matchOverTimer<=0&&!this.isMatchOverListenerActive&&(console.log("Match Over timer ended. Waiting for Enter to restart..."),this.addMatchOverRestartListener()),this.currentState){case N.WELCOME:(this.inputHandler.isKeyPressed(et.JUMP)||this.inputHandler.isKeyPressed(et.KICK)||this.inputHandler.isKeyPressed(it.JUMP)||this.inputHandler.isKeyPressed(it.KICK))&&this.startNewMatch();break;case N.PLAYING:const n=performance.now()/1e3*ue*Math.PI*2,a=Math.sin(n)*fe;this.player1.hasBow&&!this.player1.isKicking&&!this.player1.isStunned&&!this.player1.isTumbling?this.player1.aimAngle=-a:this.player1.hasBow||(this.player1.aimAngle=0),this.player2.hasBow&&!this.player2.isKicking&&!this.player2.isStunned&&!this.player2.isTumbling?this.player2.aimAngle=-a:this.player2.hasBow||(this.player2.aimAngle=0);let s=this.player1.playerSpeed*this.player1.speedMultiplier;if(this.player1.isBeingPushedBack||(this.inputHandler.isKeyPressed(et.LEFT)?(this.player1.vx=-s,this.player1.facingDirection=-1):this.inputHandler.isKeyPressed(et.RIGHT)?(this.player1.vx=s,this.player1.facingDirection=1):this.player1.vx=0),this.inputHandler.wasKeyJustPressed(et.JUMP)&&this.player1.jump(),this.inputHandler.wasKeyJustPressed(et.KICK)){const r=performance.now(),c=r-this.player1LastKickTime;if(this.player1LastKickTime>0&&c<zt)console.log("Player 1 Bicycle Kick!"),this.player1.isKicking=!1,this.player1.kickTimer=0,this.player1.startBicycleKick(),this.player1LastKickTime=0;else{let d=!1;if(this.player1.isSword&&(this.player1.startSwordSwing(),d=!0),!d&&this.player1.hasRocketLauncher&&!this.player1.isItching){const m=this.player1.fireRocket(this.particleSystem);m&&this.activeRockets.push(m),d=!0}if(!d&&this.player1.hasBow&&!this.player1.isItching){if(this.player1.arrowAmmo>0){const m=Ft,P=-this.player1.aimAngle,A=this.player1.facingDirection===1?P:Math.PI-P,k=Math.cos(A)*m,R=-Math.sin(A)*m,f=this.player1.x,b=this.player1.y-this.player1.legLength-this.player1.torsoLength*.5,v=new Jt(f,b,k,R,this.player1,this.particleSystem);this.activeArrows.push(v),this.player1.arrowAmmo--,this.player1.arrowAmmo<=0&&(this.player1.hasBow=!1),_.playSound("KICK_1")}else console.log("Player 1 out of arrows!");d=!0}d||this.player1.startKick(),this.player1LastKickTime=r}}let i=this.player2.playerSpeed*this.player2.speedMultiplier;if(this.player2.isBeingPushedBack||(this.inputHandler.isKeyPressed(it.LEFT)?(this.player2.vx=-i,this.player2.facingDirection=-1):this.inputHandler.isKeyPressed(it.RIGHT)?(this.player2.vx=i,this.player2.facingDirection=1):this.player2.vx=0),this.inputHandler.wasKeyJustPressed(it.JUMP)&&this.player2.jump(),this.inputHandler.wasKeyJustPressed(it.KICK)){const r=performance.now(),c=r-this.player2LastKickTime;if(this.player2LastKickTime>0&&c<zt)console.log("Player 2 Bicycle Kick!"),this.player2.isKicking=!1,this.player2.kickTimer=0,this.player2.startBicycleKick(),this.player2LastKickTime=0;else{let d=!1;if(this.player2.isSword&&(this.player2.startSwordSwing(),d=!0),!d&&this.player2.hasRocketLauncher&&!this.player2.isItching){const m=this.player2.fireRocket(this.particleSystem);m&&this.activeRockets.push(m),d=!0}if(!d&&this.player2.hasBow&&!this.player2.isItching){if(this.player2.arrowAmmo>0){const m=Ft,P=-this.player2.aimAngle,A=this.player2.facingDirection===1?P:Math.PI-P,k=Math.cos(A)*m,R=-Math.sin(A)*m,f=this.player2.x,b=this.player2.y-this.player2.legLength-this.player2.torsoLength*.5,v=new Jt(f,b,k,R,this.player2,this.particleSystem);this.activeArrows.push(v),this.player2.arrowAmmo--,this.player2.arrowAmmo<=0&&(this.player2.hasBow=!1),_.playSound("KICK_1")}else console.log("Player 2 out of arrows!");d=!0}d||this.player2.startKick(),this.player2LastKickTime=r}}if(this.inputHandler.wasKeyJustPressed("1")){this.debugSelectedPowerupIndex=(this.debugSelectedPowerupIndex+1)%this.debugAvailablePowerupTypes.length;const r=this.debugAvailablePowerupTypes[this.debugSelectedPowerupIndex];console.log(`DEBUG: Selected power-up type: ${r}`)}if(this.inputHandler.wasKeyJustPressed("2")){const r=this.debugAvailablePowerupTypes[this.debugSelectedPowerupIndex],c=Math.random()*(I-40)+20;this.spawnSpecificPowerup(r,c,-50),console.log(`DEBUG: Spawned ${r} via key press.`)}this.player1.isJumping&&!this.player1.hasJumpedThisPress&&(this.particleSystem.emit("jump",this.player1.x,this.player1.y,6,{scale:this.player1.sizeMultiplier}),this.player1.hasJumpedThisPress=!0),this.player2.isJumping&&!this.player2.hasJumpedThisPress&&(this.particleSystem.emit("jump",this.player2.x,this.player2.y,6,{scale:this.player2.sizeMultiplier}),this.player2.hasJumpedThisPress=!0),this.player1.update(t,x,I,this.isPlayer1GoalEnlarged,this.isPlayer2GoalEnlarged),this.player1.justLanded&&(this.particleSystem.emit("landingDust",this.player1.x,this.player1.y,12,{scale:this.player1.sizeMultiplier,landingVelocity:this.player1.lastLandingVy}),this.player1.justLanded=!1),this.player2.update(t,x,I,this.isPlayer1GoalEnlarged,this.isPlayer2GoalEnlarged),this.player2.justLanded&&(this.particleSystem.emit("landingDust",this.player2.x,this.player2.y,12,{scale:this.player2.sizeMultiplier,landingVelocity:this.player2.lastLandingVy}),this.player2.justLanded=!1),this.powerupManager.update(t);for(let r=this.activeRockets.length-1;r>=0;r--){const c=this.activeRockets[r];c.update(t),c.isActive||this.activeRockets.splice(r,1)}for(let r=this.activeArrows.length-1;r>=0;r--){const c=this.activeArrows[r];c.update(t),c.isActive||(console.log("Removing inactive arrow (OOB) from GameManager list."),this.activeArrows.splice(r,1))}this.handleCollisions(),this.ball.update(t),this.particleSystem.update(t),this.checkGoal();break;case N.GOAL_SCORED:this.goalMessageTimer-=t,this.goalMessageTimer<=0&&(this.resetPositions(),this.currentState=N.PLAYING),this.particleSystem.update(t);break;case N.MATCH_OVER:this.matchOverTimer-=t,this.matchOverTimer<=0,this.particleSystem.update(t);break}}addMatchOverRestartListener(){this.isMatchOverListenerActive||(document.addEventListener("keydown",this.handleMatchOverKeyPress),this.isMatchOverListenerActive=!0)}removeMatchOverRestartListener(){this.isMatchOverListenerActive&&(document.removeEventListener("keydown",this.handleMatchOverKeyPress),this.isMatchOverListenerActive=!1)}render(){this.ctx.clearRect(0,0,I,z),this.ctx.fillStyle="#87CEEB",this.ctx.fillRect(0,0,I,z),this.ctx.fillStyle="#228B22",this.ctx.fillRect(0,x,I,z-x),this.drawGoals(),this.ball.draw(this.ctx),this.player1.draw(this.ctx),this.player2.draw(this.ctx),this.powerupManager.draw(this.ctx);for(const e of this.activeRockets)e.draw(this.ctx);for(const e of this.activeArrows)e.draw(this.ctx);this.particleSystem.draw(this.ctx);const t={currentState:this.currentState,player1Score:this.player1Score,player2Score:this.player2Score,p1SpeedBoostTimer:this.player1.speedBoostTimer,p1SuperJumpTimer:this.player1.superJumpTimer,p1BigPlayerTimer:this.player1.bigPlayerTimer,p1HasRocketLauncher:this.player1.hasRocketLauncher,p1RocketAmmo:this.player1.rocketAmmo,p1HasBow:this.player1.hasBow,p1ArrowAmmo:this.player1.arrowAmmo,player1GoalEnlargeTimer:this.player1GoalEnlargeTimer,p2SpeedBoostTimer:this.player2.speedBoostTimer,p2SuperJumpTimer:this.player2.superJumpTimer,p2BigPlayerTimer:this.player2.bigPlayerTimer,p2HasRocketLauncher:this.player2.hasRocketLauncher,p2RocketAmmo:this.player2.rocketAmmo,p2HasBow:this.player2.hasBow,p2ArrowAmmo:this.player2.arrowAmmo,player2GoalEnlargeTimer:this.player2GoalEnlargeTimer,ballIsFrozen:this.ball.isFrozen,ballFreezeTimer:this.ball.freezeTimer,goalMessageTimer:this.goalMessageTimer,matchOverTimer:this.matchOverTimer,debugSelectedPowerupType:this.debugAvailablePowerupTypes[this.debugSelectedPowerupIndex]};if(this.uiManager.draw(t),this.currentState===N.GOAL_SCORED)this.ctx.fillStyle=wt,this.ctx.font="60px Impact",this.ctx.textAlign="center",this.ctx.fillText("GOAL!",I/2,z/3);else if(this.currentState===N.MATCH_OVER){this.ctx.fillStyle=j,this.ctx.font="50px Arial",this.ctx.textAlign="center";const e=this.player1Score>=mt?"Nils":"Harry";this.ctx.fillText(`${e} Wins!`,I/2,z/2-30),this.ctx.font="30px Arial",this.ctx.fillText(`Score: ${this.player1Score} - ${this.player2Score}`,I/2,z/2+20),this.matchOverTimer<=0&&(this.ctx.font="25px Arial",this.ctx.fillStyle=wt,this.ctx.fillText("Press Enter or Kick (S / â) to Play Again",I/2,z/2+70))}}gameLoop(t){const e=(t-this.lastTime)/1e3;for(this.lastTime=t,this.accumulatedTime+=e;this.accumulatedTime>=this.timeStep;)this.update(this.timeStep),this.accumulatedTime-=this.timeStep;this.render(),requestAnimationFrame(this.gameLoop.bind(this))}start(){console.log("Starting game..."),this.lastTime=performance.now(),requestAnimationFrame(this.gameLoop.bind(this))}drawGoals(){const t=te;this.ctx.fillStyle=t,this.ctx.strokeStyle=Y,this.ctx.lineWidth=2;const e=Pt,n=this.isPlayer1GoalEnlarged?K*e:K,a=this.isPlayer1GoalEnlarged?U*e:U,s=ot,i=x-a,r=this.isPlayer2GoalEnlarged?K*e:K,c=this.isPlayer2GoalEnlarged?U*e:U,d=nt-(r-K),m=x-c;this.ctx.strokeStyle="rgba(240, 240, 240, 0.8)",this.ctx.lineWidth=1;const P=10;for(let f=i;f<x;f+=P)this.ctx.beginPath(),this.ctx.moveTo(s,f),this.ctx.lineTo(s+n,f),this.ctx.stroke();for(let f=s;f<s+n;f+=P)this.ctx.beginPath(),this.ctx.moveTo(f,i),this.ctx.lineTo(f,x),this.ctx.stroke();for(let f=m;f<x;f+=P)this.ctx.beginPath(),this.ctx.moveTo(d,f),this.ctx.lineTo(d+r,f),this.ctx.stroke();for(let f=d;f<d+r;f+=P)this.ctx.beginPath(),this.ctx.moveTo(f,m),this.ctx.lineTo(f,x),this.ctx.stroke();this.ctx.fillStyle=t,this.ctx.strokeStyle=Y,this.ctx.lineWidth=2;const A=i-X;this.ctx.fillRect(s,A,n,X),this.ctx.strokeRect(s,A,n,X);const k=m-X;this.ctx.fillRect(d,k,r,X),this.ctx.strokeRect(d,k,r,X),this.ctx.fillRect(s,i,X,a),this.ctx.strokeRect(s,i,X,a);const R=d+r-X;this.ctx.fillRect(R,m,X,c),this.ctx.strokeRect(R,m,X,c)}createExplosion(t,e,n){console.log(`Creating REAL Explosion at (${t.toFixed(0)}, ${e.toFixed(0)}) with radius ${st}`),_.playSound("ROCKET_EXPLODE_1");const a=[this.player1,this.player2],s=st*st;a.forEach(d=>{const m=d===n,P=d.x-t,A=d.y-d.torsoLength/2-e,k=P*P+A*A;if(k<s){console.log(`Player ${d===this.player1?1:2} in blast radius!`);const R=Math.sqrt(k),f=1-R/st,b=Bt*f;let v=0,E=0;if(R>0)v=P/R,E=A/R;else{const l=Math.random()*Math.PI*2;v=Math.cos(l),E=Math.sin(l)}d.vx+=v*b,d.vy+=E*b*.3-Kt,console.log(`  Player ${d===this.player1?1:2} (DirectHit: ${m}) Applying blast force: vx+=${(v*b).toFixed(1)}, vy+=${(E*b*.3-Kt).toFixed(1)}`),d.startTumble()}});const i=this.ball.x-t,r=this.ball.y-e,c=i*i+r*r;if(c<s){console.log("Ball in blast radius!");const d=Math.sqrt(c),m=1-d/st,P=Bt*m;let A=0,k=0;if(d>0)A=i/d,k=r/d;else{const R=Math.random()*Math.PI*2;A=Math.cos(R),k=Math.sin(R)}this.ball.applyForce(A*P,k*P-pe)}this.particleSystem.emit("explosion",t,e,50,{radius:st})}announceScore(){let e=[],n=null,a=null,s=null;this.player1Score>this.player2Score?(n="NILS_AHEAD",a="NUM_"+this.player1Score,s="NUM_"+this.player2Score):this.player2Score>this.player1Score?(n="HARRY_AHEAD",a="NUM_"+this.player2Score,s="NUM_"+this.player1Score):(a="NUM_"+this.player1Score,s="NUM_"+this.player2Score),n&&e.push(n),a&&parseInt(a.split("_")[1])<=5&&e.push(a),s&&parseInt(s.split("_")[1])<=5&&e.push(s);let i=50;const r=c=>{if(c<e.length){const d=e[c];setTimeout(()=>{console.log(`Playing score announcement sound: ${d}`),_.playSound(d),r(c+1)},1100)}};setTimeout(()=>{r(0)},i)}}document.addEventListener("DOMContentLoaded",()=>{const S=document.getElementById("gameCanvas");if(!S){console.error("Canvas element not found!");return}S.width=I,S.height=z;const t=S.getContext("2d");if(!t){console.error("Failed to get 2D context!");return}_.loadSounds().then(()=>{}).catch(n=>{console.error("Sound loading failed:",n)}),new Be(t).start()});
