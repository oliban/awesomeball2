var Bt=Object.defineProperty;var Kt=(P,t,i)=>t in P?Bt(P,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):P[t]=i;var o=(P,t,i)=>Kt(P,typeof t!="symbol"?t+"":t,i);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const l of document.querySelectorAll('link[rel="modulepreload"]'))r(l);new MutationObserver(l=>{for(const e of l)if(e.type==="childList")for(const n of e.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&r(n)}).observe(document,{childList:!0,subtree:!0});function i(l){const e={};return l.integrity&&(e.integrity=l.integrity),l.referrerPolicy&&(e.referrerPolicy=l.referrerPolicy),l.crossOrigin==="use-credentials"?e.credentials="include":l.crossOrigin==="anonymous"?e.credentials="omit":e.credentials="same-origin",e}function r(l){if(l.ep)return;l.ep=!0;const e=i(l);fetch(l.href,e)}})();const T=800,D=600,Ft=60,H="#FFFFFF",K="#000000",Dt="#FFFFFF",gt="#FFFF00",et=980,pt=240,ft=-450,st=600,ct=-450,Ht=.98,mt=.9,I=D-50,$t=1.5,Nt=10,Yt=1.4,Gt=10,Ut=1.5,Wt=12,Jt=5,Xt=15,U=80,yt=150,W=10,N=I-yt,z=0,j=T-U,Pt=z,St=j+U;var E=(P=>(P.WELCOME="WELCOME",P.PLAYING="PLAYING",P.GOAL_SCORED="GOAL_SCORED",P.MATCH_OVER="MATCH_OVER",P.GAME_OVER="GAME_OVER",P.TROPHY="TROPHY",P))(E||{});const Q={JUMP:"w",KICK:"s",LEFT:"a",RIGHT:"d"},tt={JUMP:"ArrowUp",KICK:"ArrowDown",LEFT:"ArrowLeft",RIGHT:"ArrowRight"},zt={SOUNDS:{KICK_1:"sounds/kick_ball1.mp3",KICK_2:"sounds/kick_ball2.mp3",KICK_3:"sounds/kick_ball3.mp3",JUMP_1:"sounds/jump1.mp3",LAND_1:"sounds/land1.mp3",LAND_2:"sounds/land2.mp3",WALL_HIT_1:"sounds/wall_hit1.mp3",PLAYER_BUMP_1:"sounds/player_bump1.mp3",HEADBUTT_1:"sounds/headbutt1.mp3",BODY_HIT_1:"sounds/body_hit1.mp3",SWORD_HIT:"sounds/sword_hit.mp3",SWORD_HIT_BALL:"sounds/sword_hit.mp3",CROSSBAR_HIT:"sounds/crossbar_hit.mp3",BALL_BOUNCE_1:"sounds/ball_bounce1.mp3",COMBO_SPARKLE_1:"sounds/combo_sparkle1.mp3",COMBO_SPARKLE_2:"sounds/combo_sparkle2.mp3",COMBO_SPARKLE_3:"sounds/combo_sparkle3.mp3",COMBO_SPARKLE_4:"sounds/combo_sparkle4.mp3",SUPER_JACKPOT:"sounds/super_jackpot.mp3",NILS_AHEAD:"sounds/nils_ahead.mp3",HARRY_AHEAD:"sounds/harry_ahead.mp3",NILS_WINS:"sounds/nils_wins.mp3",HARRY_WINS:"sounds/harry_wins.mp3",PLAYER1_GOAL_1:"sounds/player1_goal1.mp3",PLAYER1_GOAL_2:"sounds/player1_goal2.mp3",PLAYER1_GOAL_3:"sounds/player1_goal3.mp3",PLAYER2_GOAL_1:"sounds/player2_goal1.mp3",PLAYER2_GOAL_2:"sounds/player2_goal2.mp3",PLAYER2_GOAL_3:"sounds/player2_goal3.mp3",NUM_0:"sounds/0.mp3",NUM_1:"sounds/1.mp3",NUM_2:"sounds/2.mp3",NUM_3:"sounds/3.mp3",NUM_4:"sounds/4.mp3",NUM_5:"sounds/5.mp3"}},ot=Math.PI/2,Vt=600,At=.2,jt=450,it=80,qt=800,Zt=100,Qt=1.5,ti=-400,kt=600,Tt=400,ii=.3,ei=Math.PI/3,si=600,oi=800,hi=6*Math.PI;class ni{constructor(){o(this,"keys",new Set);o(this,"justPressedKeys",new Set);o(this,"previouslyPressedKeys",new Set);o(this,"justReleasedKeys",new Set);o(this,"previouslyReleasedKeys",new Set);window.addEventListener("keydown",t=>{const i=t.key.toLowerCase();this.keys.has(i)||this.justPressedKeys.add(i),this.keys.add(i)}),window.addEventListener("keyup",t=>{const i=t.key.toLowerCase();this.keys.delete(i),this.justReleasedKeys.add(i)})}update(){this.previouslyPressedKeys=new Set(this.justPressedKeys),this.justPressedKeys.clear(),this.previouslyReleasedKeys=new Set(this.justReleasedKeys),this.justReleasedKeys.clear()}isKeyPressed(t){return this.keys.has(t.toLowerCase())}wasKeyJustPressed(t){return this.previouslyPressedKeys.has(t.toLowerCase())}wasKeyJustReleased(t){return this.previouslyReleasedKeys.has(t.toLowerCase())}}class ai{constructor(){o(this,"audioContext");o(this,"soundBuffers",{});o(this,"soundsLoaded",!1);o(this,"loadingPromise",null);o(this,"activeLoops",new Map);o(this,"lastPlayedTimes",new Map);o(this,"debounceInterval",1e3);try{this.audioContext=new(window.AudioContext||window.webkitAudioContext)}catch(t){console.error("Web Audio API is not supported in this browser.",t),this.audioContext=null}}async loadSounds(){if(!this.audioContext)return console.warn("AudioContext not available, skipping sound loading."),this.soundsLoaded=!0,Promise.resolve();if(this.loadingPromise)return this.loadingPromise;if(this.soundsLoaded)return Promise.resolve();const t=zt.SOUNDS,i=[];return this.loadingPromise=new Promise(async(r,l)=>{console.log("Starting sound loading..."),Object.keys(t).length;for(const e in t)if(Object.prototype.hasOwnProperty.call(t,e)){const n=t[e];i.push(this.loadSound(e,n).then(()=>{}))}try{await Promise.all(i),console.log("All sounds loaded successfully!"),this.soundsLoaded=!0,this.loadingPromise=null,r()}catch(e){console.error("Error loading one or more sounds:",e),this.loadingPromise=null,l(e)}}),this.loadingPromise}async loadSound(t,i){if(!this.audioContext)return Promise.resolve();try{const r=await fetch(i);if(!r.ok)throw new Error(`HTTP error! status: ${r.status} for ${i}`);const l=await r.arrayBuffer(),e=await this.audioContext.decodeAudioData(l);this.soundBuffers[t]=e}catch(r){console.error(`Failed to load sound: ${t} from ${i}`,r),this.soundBuffers[t]=null}}playSound(t,i=1,r=!1){var a;const l=performance.now(),e=this.lastPlayedTimes.get(t);if(e&&l-e<this.debounceInterval||!this.audioContext||!this.soundsLoaded)return;const n=this.soundBuffers[t];if(!n){console.warn(`Sound buffer not found for key: ${t}`);return}try{const h=this.audioContext.createBufferSource();h.buffer=n;const s=this.audioContext.createGain();if(s.gain.setValueAtTime(i,this.audioContext.currentTime),h.connect(s),s.connect(this.audioContext.destination),h.loop=r,h.start(0),this.lastPlayedTimes.set(t,l),r){if(this.activeLoops.has(t))try{(a=this.activeLoops.get(t))==null||a.stop()}catch{}this.activeLoops.set(t,h),h.onended=()=>{this.activeLoops.get(t)===h&&this.activeLoops.delete(t)}}}catch(h){console.error(`Error playing sound ${t}:`,h)}}areSoundsLoaded(){return this.soundsLoaded}stopSound(t){if(this.activeLoops.has(t)){const i=this.activeLoops.get(t);try{i==null||i.stop(),console.log(`Stopped looped sound: ${t}`)}catch{}this.activeLoops.delete(t)}}}const L=new ai;class ri{constructor(t,i,r,l,e,n){o(this,"x");o(this,"y");o(this,"vx");o(this,"vy");o(this,"owner");o(this,"isActive",!0);o(this,"width",20);o(this,"height",8);o(this,"angle",0);o(this,"lastPos");o(this,"particleSystem");o(this,"smokeEmitTimer",0);o(this,"smokeEmitInterval",.03);this.x=t,this.y=i,this.vx=r,this.vy=l,this.owner=e,this.angle=Math.atan2(l,r),this.lastPos={x:t,y:i},this.particleSystem=n,console.log(`Rocket created by Player ${e.teamColor==="#DCDCDC"?1:2} at (${t.toFixed(0)}, ${i.toFixed(0)}) with velocity (${r.toFixed(0)}, ${l.toFixed(0)})`)}update(t){if(!this.isActive)return!1;if(this.lastPos={x:this.x,y:this.y},this.x+=this.vx*t,this.y+=this.vy*t,this.angle=Math.atan2(this.vy,this.vx),this.smokeEmitTimer+=t,this.smokeEmitTimer>=this.smokeEmitInterval){this.smokeEmitTimer-=this.smokeEmitInterval;const l=Math.sqrt(this.vx*this.vx+this.vy*this.vy),e=this.x-Math.cos(this.angle)*(this.width/2+2),n=this.y-Math.sin(this.angle)*(this.width/2+2);this.particleSystem.emit("rocket_smoke",e,n,1,{vx:this.vx,vy:this.vy,baseSpeed:l})}let i=!1,r=null;return this.y>I-this.height/2&&(this.y=I-this.height/2,i=!0,r="ground"),!i&&(this.x<-this.width||this.x>T+this.width||this.y<-this.height)?(this.isActive=!1,!1):i?(this.isActive=!1,console.log(`Explosion triggered by ${r} at (${this.lastPos.x.toFixed(0)}, ${this.lastPos.y.toFixed(0)})`),!0):!1}getRect(){const t=this.x-this.width/2,i=this.y-this.height/2;return{x:t,y:i,width:this.width,height:this.height}}draw(t){this.isActive&&(t.save(),t.translate(this.x,this.y),t.rotate(this.angle),t.fillStyle="#ff4500",t.fillRect(-this.width/2,-this.height/2,this.width,this.height),t.strokeStyle=K,t.lineWidth=1,t.strokeRect(-this.width/2,-this.height/2,this.width,this.height),t.fillStyle="yellow",t.beginPath(),t.moveTo(-this.width/2-5,0),t.lineTo(-this.width/2,-this.height/3),t.lineTo(-this.width/2,this.height/3),t.closePath(),t.fill(),t.restore())}}function C(P,t,i){return{x:P.x+t*Math.cos(i),y:P.y-t*Math.sin(i)}}const li=.0625*60,dt=Math.PI/7,wt=Math.PI/6,p=-Math.PI/2,ht=Math.PI/2.5,Mt=Math.PI/1.5,nt=Math.PI*.6,at=-Math.PI*.15,bt=.45,ci=.15,di=.7,vt=14,gi=8,Lt=9,Rt=25,yi=800,ui=8,pi=150,ut=50,fi=550,mi=fi-pi,Pi=0,Si=yi-ut;function _(P,t,i){return P*(1-i)+t*i}function Ai(P){return P*P}class lt{constructor(t,i,r,l,e,n,a,h,s){o(this,"x");o(this,"y");o(this,"vx");o(this,"vy");o(this,"baseY");o(this,"isJumping");o(this,"hasJumpedThisPress",!1);o(this,"isKicking");o(this,"isBicycleKicking",!1);o(this,"bicycleKickTimer",0);o(this,"kickTimer");o(this,"kickDuration",bt);o(this,"walkCycleTimer");o(this,"facingDirection",1);o(this,"onOtherPlayerHead",!1);o(this,"onLeftCrossbar");o(this,"onRightCrossbar");o(this,"justLanded",!1);o(this,"lastLandingVy",0);o(this,"isStunned");o(this,"stunTimer");o(this,"isTumbling");o(this,"tumbleTimer");o(this,"rotationAngle");o(this,"rotationVelocity");o(this,"minKickDistSq",1/0);o(this,"kickImpactForceX",0);o(this,"kickImpactForceY",0);o(this,"isBeingPushedBack",!1);o(this,"pushbackTimer",0);o(this,"teamColor");o(this,"teamAccent");o(this,"eyeColor");o(this,"baseHeadRadius",8);o(this,"baseTorsoLength",36);o(this,"baseLimbWidth",10);o(this,"baseArmLength",24);o(this,"baseLegLength",32);o(this,"headRadius");o(this,"torsoLength");o(this,"limbWidth");o(this,"armLength");o(this,"legLength");o(this,"leftThighAngle",p);o(this,"rightThighAngle",p);o(this,"leftShinAngle",0);o(this,"rightShinAngle",0);o(this,"leftArmAngle",p);o(this,"rightArmAngle",p);o(this,"activePowerups",new Map);o(this,"isFlying",!1);o(this,"isBig",!1);o(this,"isShrunk",!1);o(this,"isEnormousHead",!1);o(this,"isControlsReversed",!1);o(this,"isSword",!1);o(this,"swordAngle",0);o(this,"isSwingingSword",!1);o(this,"swordSwingTimer",0);o(this,"isItching",!1);o(this,"itchingTimer",0);o(this,"itchDuration",10);o(this,"isAiming",!1);o(this,"aimAngle",0);o(this,"drawPower",0);o(this,"hasBow",!1);o(this,"arrowAmmo",0);o(this,"jumpPower");o(this,"playerSpeed");o(this,"gravity");o(this,"speedMultiplier",1);o(this,"jumpMultiplier",1);o(this,"sizeMultiplier",1);o(this,"speedBoostTimer",0);o(this,"superJumpTimer",0);o(this,"bigPlayerTimer",0);o(this,"hasRocketLauncher",!1);o(this,"rocketAmmo",0);o(this,"swordSwingDuration",.6);o(this,"swordSwingAngleMax",Math.PI*1.5);o(this,"swordLengthMultiplier",3);this.x=t,this.y=i,this.baseY=i,this.vx=0,this.vy=0,this.isJumping=!1,this.isKicking=!1,this.isBicycleKicking=!1,this.bicycleKickTimer=0,this.kickTimer=0,this.walkCycleTimer=0,this.facingDirection=r,this.hasJumpedThisPress=!1,this.justLanded=!1,this.lastLandingVy=0,this.onLeftCrossbar=!1,this.onRightCrossbar=!1,this.isStunned=!1,this.stunTimer=0,this.isTumbling=!1,this.tumbleTimer=0,this.rotationAngle=0,this.rotationVelocity=0,this.isAiming=!1,this.aimAngle=0,this.drawPower=0,this.hasBow=!1,this.teamColor=l,this.teamAccent=e,this.eyeColor=n,this.headRadius=this.baseHeadRadius,this.torsoLength=this.baseTorsoLength,this.limbWidth=this.baseLimbWidth,this.armLength=this.baseArmLength,this.legLength=this.baseLegLength,this.gravity=a,this.jumpPower=h,this.playerSpeed=s,this.kickDuration=bt,this.updateSizeAttributes()}_getRelativeLimbPositions(){let t=this.leftThighAngle,i=this.rightThighAngle,r=this.leftShinAngle,l=this.rightShinAngle,e=this.leftArmAngle,n=this.rightArmAngle;isNaN(t)&&(t=p),isNaN(i)&&(i=p),isNaN(r)&&(r=0),isNaN(l)&&(l=0),isNaN(e)&&(e=p),isNaN(n)&&(n=p);let a=this.isItching,h="normal",s="normal";if(a){const J=Date.now()/1e3*4,Y=(Math.sin(J*Math.PI)+1)/2,F=Y<.5?4*Y*Y*Y:1-Math.pow(-2*Y+2,3)/2,G={leftThigh:Math.PI*.3,leftShin:Math.PI*.4,leftArm:Math.PI*.6,rightThigh:-Math.PI*.2,rightShin:-Math.PI*.1,rightArm:-Math.PI*.3},X={leftThigh:-Math.PI*.1,leftShin:-Math.PI*.2,leftArm:-Math.PI*.4,rightThigh:Math.PI*.4,rightShin:Math.PI*.5,rightArm:Math.PI*.7};t=ot+_(G.leftThigh,X.leftThigh,F),r=_(G.leftShin,X.leftShin,F),e=ot+_(G.leftArm,X.leftArm,F),i=ot+_(G.rightThigh,X.rightThigh,F),l=_(G.rightShin,X.rightShin,F),n=ot+_(G.rightArm,X.rightArm,F),h="frantic",s="jagged"}const c={x:0,y:-this.legLength},d={x:0,y:c.y-this.torsoLength},g={x:0,y:d.y-this.headRadius},y=this.headRadius*.2,u=this.limbWidth*.5,m={x:d.x-u,y:d.y+y},f={x:d.x+u,y:d.y+y},S=this.armLength*.5,w=this.armLength*.5,M=C(m,S,e),k=C(M,w,e),A=C(f,S,n),b=C(A,w,n),v=this.legLength*.5,x=this.legLength*.5,R=C(c,v,t),O=C(R,x,t+r),$=C(c,v,i),q=C($,x,i+l);return{drawLThighAngle:t,drawRThighAngle:i,drawLShinAngle:r,drawRShinAngle:l,drawLArmAngle:e,drawRArmAngle:n,relHipPos:c,relNeckPos:d,relHeadCenter:g,relLeftShoulderPos:m,relRightShoulderPos:f,relLeftElbowPos:M,relLeftHandPos:k,relRightElbowPos:A,relRightHandPos:b,relLeftKneePos:R,relLeftFootPos:O,relRightKneePos:$,relRightFootPos:q,isDrawingItching:a,eyeStyle:h,mouthStyle:s}}draw(t){t.save(),t.translate(this.x,this.y);const i=this._getRelativeLimbPositions();if(this.isTumbling){const h=-(this.legLength+this.torsoLength/2);t.translate(0,h),t.rotate(this.rotationAngle),t.translate(0,-h)}else if(this.isBicycleKicking){const h=-(this.legLength+this.torsoLength/2);t.translate(0,h),t.rotate(this.rotationAngle),t.translate(0,-h)}t.lineWidth=this.limbWidth,t.lineCap="round",t.strokeStyle=this.teamColor,t.beginPath(),t.moveTo(i.relHipPos.x,i.relHipPos.y),t.lineTo(i.relNeckPos.x,i.relNeckPos.y),t.stroke(),t.fillStyle=this.teamColor,t.beginPath(),t.arc(i.relHeadCenter.x,i.relHeadCenter.y,this.headRadius,0,Math.PI*2),t.fill(),t.stroke();const r=this.headRadius*.18,l=this.headRadius*.4,e=i.relHeadCenter.x,n=i.relHeadCenter.y;if(i.isDrawingItching?(t.fillStyle=this.eyeColor,t.beginPath(),t.arc(e-l*.9,n+(Math.random()-.5)*3,r*1.2,0,Math.PI*2),t.fill(),t.beginPath(),t.arc(e+l*1.1,n+(Math.random()-.5)*3,r*.8,0,Math.PI*2),t.fill()):(t.fillStyle=this.eyeColor,t.beginPath(),t.arc(e-l,n,r,0,Math.PI*2),t.fill(),t.beginPath(),t.arc(e+l,n,r,0,Math.PI*2),t.fill()),i.mouthStyle==="jagged"){t.strokeStyle=K,t.lineWidth=1,t.beginPath();const h=n+l*.8;t.moveTo(e-l*.8,h);for(let s=0;s<4;s++)t.lineTo(e-l*.8+l*1.6*(s+Math.random())/4,h+(Math.random()-.5)*8);t.lineTo(e+l*.8,h),t.stroke(),t.lineWidth=this.limbWidth}t.strokeStyle=this.teamAccent,t.beginPath(),t.moveTo(i.relLeftShoulderPos.x,i.relLeftShoulderPos.y),t.lineTo(i.relLeftElbowPos.x,i.relLeftElbowPos.y),t.lineTo(i.relLeftHandPos.x,i.relLeftHandPos.y),t.stroke(),t.beginPath(),t.moveTo(i.relRightShoulderPos.x,i.relRightShoulderPos.y),t.lineTo(i.relRightElbowPos.x,i.relRightElbowPos.y),t.lineTo(i.relRightHandPos.x,i.relRightHandPos.y),t.stroke(),t.strokeStyle=this.teamColor,t.beginPath(),t.moveTo(i.relHipPos.x,i.relHipPos.y),t.lineTo(i.relLeftKneePos.x,i.relLeftKneePos.y),t.lineTo(i.relLeftFootPos.x,i.relLeftFootPos.y),t.stroke(),t.beginPath(),t.moveTo(i.relHipPos.x,i.relHipPos.y),t.lineTo(i.relRightKneePos.x,i.relRightKneePos.y),t.lineTo(i.relRightFootPos.x,i.relRightFootPos.y),t.stroke(),t.fillStyle=this.teamAccent;const a=(h,s)=>{const c=s===1?0:Math.PI;t.save(),t.translate(h.x,h.y),t.rotate(c),t.fillRect(0,-8/2,vt,gi),t.restore()};if(a(i.relLeftFootPos,this.facingDirection),a(i.relRightFootPos,this.facingDirection),this.hasRocketLauncher){t.save();const h=this.armLength*1.1,s=this.limbWidth*.8,c=-(this.legLength+this.torsoLength*.3),d=this.facingDirection*(this.limbWidth*.5);t.translate(d,c);const g=this.facingDirection===1?0:-h;t.fillStyle="#808080",t.fillRect(g,-s/2,h,s),t.strokeStyle=K,t.lineWidth=1,t.strokeRect(g,-s/2,h,s);const y=this.facingDirection===1?h:-5;t.fillStyle="#505050",t.fillRect(g+y,-s/3,5,s*.66),t.restore()}if(this.hasBow){t.save();const h=this.facingDirection*(this.armLength*.6),s=-(this.legLength+this.torsoLength*.5);t.translate(h,s);const c=this.facingDirection===1?this.aimAngle:Math.PI-this.aimAngle;t.rotate(c);const d=this.armLength*2.2,g=this.limbWidth*.6,y=d*.2,u=-g*.8,m=d/2,f=u,S=-m,w=f,M=m,k=f+y,A=0;t.strokeStyle="#E0E0E0",t.lineWidth=1.5,t.lineCap="butt",t.beginPath(),t.moveTo(f,S),t.lineTo(w,M),t.stroke(),t.strokeStyle="#8B4513",t.lineWidth=g,t.lineCap="round",t.beginPath(),t.moveTo(f,S),t.quadraticCurveTo(k,A,w,M),t.stroke(),t.strokeStyle="red",t.lineWidth=1,t.beginPath(),t.moveTo(0,0),t.lineTo(50,0),t.stroke(),t.restore()}if(this.isSword){t.save(),t.translate(i.relRightHandPos.x,i.relRightHandPos.y);const s=(this.facingDirection===1?Math.PI*2/3:Math.PI/3)+this.swordAngle;t.rotate(s);const c=this.armLength*this.swordLengthMultiplier,d=c*.15,g=c-d,y=this.limbWidth*.8;t.fillStyle="#8B4513",t.fillRect(0,-y/2,d,y),t.fillStyle="#C0C0C0",t.fillRect(d,-y/2*.7,g,y*.7),t.strokeStyle=K,t.lineWidth=1,t.strokeRect(0,-y/2,d,y),t.strokeRect(d,-y/2*.7,g,y*.7),t.restore()}t.restore()}update(t,i,r){this.onOtherPlayerHead=!1,this.onLeftCrossbar=!1,this.onRightCrossbar=!1,this.y<i&&!this.onLeftCrossbar&&!this.onRightCrossbar&&(this.vy+=this.gravity*t);const l=this.isJumping,e=this.vy;this.y+=this.vy*t,this.x+=this.vx*t;let n=!1;const a=mi-ui;if(this.vy>=0){const h={x:Pi,y:a,width:ut};if(this.x>=h.x&&this.x<=h.x+h.width&&this.y>=h.y&&this.y<=h.y+10&&(this.y=h.y,this.vy=0,this.isJumping=!1,this.onLeftCrossbar=!0,n=!0,l&&e>100&&L.playSound("LAND_1")),!n){const s={x:Si,y:a,width:ut};this.x>=s.x&&this.x<=s.x+s.width&&this.y>=s.y&&this.y<=s.y+10&&(this.y=s.y,this.vy=0,this.isJumping=!1,this.onRightCrossbar=!0,n=!0,l&&e>100&&L.playSound("LAND_1"))}}if(this.isSwingingSword){this.swordSwingTimer+=t;const h=Math.min(this.swordSwingTimer/this.swordSwingDuration,1),s=0,c=-this.swordSwingAngleMax*(this.facingDirection===1?1:-1);this.swordAngle=_(s,c,h),this.swordSwingTimer>=this.swordSwingDuration&&(this.isSwingingSword=!1,this.swordSwingTimer=0)}else this.swordAngle=_(this.swordAngle,0,.15),Math.abs(this.swordAngle)<.01&&(this.swordAngle=0);if(!this.isSwingingSword&&this.isKicking){this.kickTimer,this.kickTimer+=t;const c=this.kickTimer/this.kickDuration;if(c<.2){const d=Ai(c/.2);this.facingDirection===1?(this.rightThighAngle=p+d*-ht,this.rightShinAngle=-nt):(this.leftThighAngle=p+d*ht,this.leftShinAngle=nt)}else if(c<1){const d=(c-.2)/.8;if(this.facingDirection===1)if(this.rightThighAngle=p+_(-ht,Mt,d),d<.5){const g=d/.5;this.rightShinAngle=_(-nt,-at,g)}else this.rightShinAngle=-at;else if(this.leftThighAngle=p+_(ht,-Mt,d),d<.5){const g=d/.5;this.leftShinAngle=_(nt,at,g)}else this.leftShinAngle=at}this.kickTimer>=this.kickDuration&&(this.kickTimer=0,this.isKicking=!1)}else if(this.isBicycleKicking){const s=[{time:0,angles:{nkThigh:p-.2*Math.PI,nkShin:.3*Math.PI,kThigh:p-.1*Math.PI,kShin:.2*Math.PI,lArm:p+.2*Math.PI,rArm:p-.2*Math.PI,rotationMag:0}},{time:.2,angles:{nkThigh:p-.7*Math.PI,nkShin:.8*Math.PI,kThigh:p+.3*Math.PI,kShin:.6*Math.PI,lArm:p+.6*Math.PI,rArm:p-.7*Math.PI,rotationMag:.4*Math.PI}},{time:.5,angles:{nkThigh:p-.9*Math.PI,nkShin:.8*Math.PI,kThigh:p-1.5*Math.PI,kShin:0*Math.PI,lArm:p-.8*Math.PI,rArm:p-.8*Math.PI,rotationMag:1*Math.PI}},{time:.75,angles:{nkThigh:p-.8*Math.PI,nkShin:.9*Math.PI,kThigh:p-.6*Math.PI,kShin:.7*Math.PI,lArm:p-.5*Math.PI,rArm:p+.5*Math.PI,rotationMag:1.6*Math.PI}},{time:1,angles:{nkThigh:p-.4*Math.PI,nkShin:.5*Math.PI,kThigh:p-.4*Math.PI,kShin:.5*Math.PI,lArm:p,rArm:p,rotationMag:2*Math.PI}}];this.bicycleKickTimer+=t;const c=Math.min(this.bicycleKickTimer/1,1);let d=s[0],g=s[1];for(let R=0;R<s.length-1;R++)if(c>=s[R].time&&c<s[R+1].time){d=s[R],g=s[R+1];break}const y=d.angles,u=g.angles,m=g.time-d.time,f=m>0?(c-d.time)/m:1,S=_(y.nkThigh,u.nkThigh,f),w=_(y.kThigh,u.kThigh,f),M=_(y.nkShin,u.nkShin,f),k=_(y.kShin,u.kShin,f),A=_(y.lArm,u.lArm,f),b=_(y.rArm,u.rArm,f),v=_(y.rotationMag,u.rotationMag,f),x=this.facingDirection!==1;x?(this.rightThighAngle=w,this.rightShinAngle=k,this.leftThighAngle=S,this.leftShinAngle=M):(this.leftThighAngle=w,this.leftShinAngle=k,this.rightThighAngle=S,this.rightShinAngle=M),this.leftArmAngle=A,this.rightArmAngle=b,this.rotationAngle=x?v:-v,c>=1&&(this.isBicycleKicking=!1,this.bicycleKickTimer=0,this.rotationAngle=0)}else if(!this.isSwingingSword){const h=this.y>=i||this.onLeftCrossbar||this.onRightCrossbar;if(this.isJumping&&!h){const s=p+Math.PI*.2,c=p-Math.PI*.2,d=-Math.PI*.2,g=Rt*t;this.leftThighAngle+=(s-this.leftThighAngle)*g,this.rightThighAngle+=(c-this.rightThighAngle)*g,this.leftShinAngle+=(d-this.leftShinAngle)*g,this.rightShinAngle+=(d-this.rightShinAngle)*g}else if(h&&this.vx!==0){this.walkCycleTimer+=t*li;const s=Math.sin(this.walkCycleTimer*Math.PI*2)*dt;this.leftThighAngle=p+s,this.rightThighAngle=p-s,this.leftShinAngle=s*-.5,this.rightShinAngle=-s*-.5,this.leftArmAngle=p-s*(wt/dt),this.rightArmAngle=p+s*(wt/dt)}else{const s=Rt*t;this.leftThighAngle+=(p-this.leftThighAngle)*s,this.rightThighAngle+=(p-this.rightThighAngle)*s,this.leftShinAngle+=(0-this.leftShinAngle)*s,this.rightShinAngle+=(0-this.rightShinAngle)*s,this.leftArmAngle+=(p-this.leftArmAngle)*s,this.rightArmAngle+=(p-this.rightArmAngle)*s}}if(this.x<0&&(this.x=0),this.x>r&&(this.x=r),!n)if(this.y>=i){const s=this.vy;this.y=i,this.vy=0,l&&(this.lastLandingVy=s,this.isJumping=!1,this.hasJumpedThisPress=!1,this.justLanded=!0,s>200&&L.playSound("LAND_2"))}else this.justLanded=!1;this.isTumbling&&(this.tumbleTimer-=t,this.rotationAngle+=this.rotationVelocity*t,this.tumbleTimer<=0&&(this.isTumbling=!1,this.tumbleTimer=0,this.rotationAngle=0,this.rotationVelocity=0,this.leftThighAngle=p,this.rightThighAngle=p,this.leftShinAngle=0,this.rightShinAngle=0,this.leftArmAngle=p,this.rightArmAngle=p)),this.isBeingPushedBack&&(this.pushbackTimer-=t,this.pushbackTimer<=0&&(this.isBeingPushedBack=!1,this.pushbackTimer=0)),this.speedBoostTimer>0&&(this.speedBoostTimer-=t,this.speedBoostTimer<=0&&this.deactivateSpeedBoost()),this.superJumpTimer>0&&(this.superJumpTimer-=t,this.superJumpTimer<=0&&this.deactivateSuperJump()),this.bigPlayerTimer>0&&(this.bigPlayerTimer-=t,this.bigPlayerTimer<=0&&this.deactivateBigPlayer()),this.isItching&&(this.itchingTimer-=t,this.itchingTimer<=0&&(this.isItching=!1,console.log(`Player ${this.teamColor} stopped itching`)))}startKick(){!this.isKicking&&!this.isStunned&&!this.isTumbling&&!this.isItching&&(this.isKicking=!0,this.kickTimer=0,this.minKickDistSq=1/0,this.kickImpactForceX=0,this.kickImpactForceY=0)}startBicycleKick(){const t=!this.isKicking&&!this.isStunned&&!this.isTumbling&&!this.isItching&&!this.isBicycleKicking;if(t||console.warn(`[Player.startBicycleKick] BLOCKED! States: isKicking=${this.isKicking}, isStunned=${this.isStunned}, isTumbling=${this.isTumbling}, isItching=${this.isItching}, isBicycleKicking=${this.isBicycleKicking}`),t){console.log(`[Player.startBicycleKick] Starting bicycle kick for player ${this.teamColor}`),this.isBicycleKicking=!0,this.bicycleKickTimer=0,this.rotationAngle=0;const i={nkThigh:p-.2*Math.PI,nkShin:.3*Math.PI,kThigh:p-.1*Math.PI,kShin:.2*Math.PI,lArm:p+.2*Math.PI,rArm:p-.2*Math.PI};this.facingDirection!==1?(this.rightThighAngle=i.kThigh,this.rightShinAngle=i.kShin,this.leftThighAngle=i.nkThigh,this.leftShinAngle=i.nkShin,this.rightArmAngle=i.rArm,this.leftArmAngle=i.lArm):(this.leftThighAngle=i.kThigh,this.leftShinAngle=i.kShin,this.rightThighAngle=i.nkThigh,this.rightShinAngle=i.nkShin,this.leftArmAngle=i.lArm,this.rightArmAngle=i.rArm),this.minKickDistSq=1/0,this.kickImpactForceX=0,this.kickImpactForceY=0,L.playSound("KICK_1")}}jump(){let t=!this.isJumping&&!this.isKicking&&!this.isStunned&&!this.isTumbling;if((this.onOtherPlayerHead||this.onLeftCrossbar||this.onRightCrossbar)&&(t=!this.isKicking&&!this.isStunned&&!this.isTumbling),t){const i=this.jumpPower*this.jumpMultiplier;this.vy=i,this.isJumping=!0,this.hasJumpedThisPress=!0,this.onOtherPlayerHead=!1,this.onLeftCrossbar=!1,this.onRightCrossbar=!1,L.playSound("JUMP_1")}}startSwordSwing(){this.isSword&&!this.isSwingingSword&&!this.isKicking&&!this.isStunned&&!this.isTumbling&&!this.isItching&&(this.isSwingingSword=!0,this.swordSwingTimer=0,this.swordAngle=0,console.log("Player started sword swing!"))}getHeadCircle(){const t={x:this.x,y:this.y-this.legLength-this.torsoLength},i={x:t.x,y:t.y-this.headRadius};return{x:i.x,y:i.y,radius:this.headRadius}}getBodyRect(){const t=this.y-this.legLength,i=this.legLength+this.torsoLength,r=this.limbWidth*2;return{x:this.x-r/2,y:t-this.torsoLength,width:r,height:i}}startTumble(){!this.isTumbling&&!this.isStunned&&(this.isTumbling=!0,this.tumbleTimer=Qt,this.rotationVelocity=(Math.random()-.5)*hi,this.rotationAngle=0,this.isJumping=!1,this.onOtherPlayerHead=!1,this.onLeftCrossbar=!1,this.onRightCrossbar=!1,this.isKicking=!1,this.kickTimer=0)}getFootPosition(t){const i=t?this.rightThighAngle:this.leftThighAngle,r=t?this.rightShinAngle:this.leftShinAngle,l=this.legLength*.5,e=this.legLength*.5,n={x:this.x,y:this.y-this.legLength},a=C(n,l,i);return C(a,e,i+r)}getKickImpactPoint(){if(!this.isKicking)return null;const t=this.kickTimer/this.kickDuration;if(t<ci||t>di)return null;const i=this.facingDirection===1,r={x:this.x,y:this.y-this.legLength},l=i?this.rightThighAngle:this.leftThighAngle,e=i?this.rightShinAngle:this.leftShinAngle,n=this.legLength*.5,a=this.legLength*.5,h=C(r,n,l);return C(h,a,l+e)}getBicycleKickImpactPoint(){if(!this.isBicycleKicking)return null;const t=1,i=[{time:0,angles:{nkThigh:p-.2*Math.PI,nkShin:.3*Math.PI,kThigh:p-.1*Math.PI,kShin:.2*Math.PI,lArm:p+.2*Math.PI,rArm:p-.2*Math.PI,rotationMag:0}},{time:.2,angles:{nkThigh:p-.7*Math.PI,nkShin:.8*Math.PI,kThigh:p+.3*Math.PI,kShin:.6*Math.PI,lArm:p+.6*Math.PI,rArm:p-.7*Math.PI,rotationMag:.4*Math.PI}},{time:.5,angles:{nkThigh:p-.9*Math.PI,nkShin:.8*Math.PI,kThigh:p-1.5*Math.PI,kShin:0*Math.PI,lArm:p-.8*Math.PI,rArm:p-.8*Math.PI,rotationMag:1*Math.PI}},{time:.75,angles:{nkThigh:p-.8*Math.PI,nkShin:.9*Math.PI,kThigh:p-.6*Math.PI,kShin:.7*Math.PI,lArm:p-.5*Math.PI,rArm:p+.5*Math.PI,rotationMag:1.6*Math.PI}},{time:1,angles:{nkThigh:p-.4*Math.PI,nkShin:.5*Math.PI,kThigh:p-.4*Math.PI,kShin:.5*Math.PI,lArm:p,rArm:p,rotationMag:2*Math.PI}}],r=Math.min(this.bicycleKickTimer/t,1);let l=i[0],e=i[1];for(let F=0;F<i.length-1;F++)if(r>=i[F].time&&r<i[F+1].time){l=i[F],e=i[F+1];break}const n=l.angles,a=e.angles,h=e.time-l.time,s=h>0?(r-l.time)/h:1,c=_(n.kThigh,a.kThigh,s),d=_(n.kShin,a.kShin,s);_(n.nkThigh,a.nkThigh,s),_(n.nkShin,a.nkShin,s);const g=this.facingDirection!==1,y=c,u=d,m=this.legLength*.5,f=this.legLength*.5,S={x:0,y:-this.legLength},w=C(S,m,y),M=C(w,f,y+u),k=0,A=-(this.legLength+this.torsoLength/2),b=M.x-k,v=M.y-A,x=Math.cos(this.rotationAngle),R=Math.sin(this.rotationAngle),O=b*x-v*R,$=b*R+v*x,q=O+k,V=$+A,J=this.x+q,Y=this.y+V;return console.log(`[BicycleKickImpact] Timer: ${this.bicycleKickTimer.toFixed(2)} Prog: ${r.toFixed(2)} Rot: ${(this.rotationAngle*180/Math.PI).toFixed(1)}° RelFoot: (${M.x.toFixed(1)}, ${M.y.toFixed(1)}) AbsFoot: (${J.toFixed(1)}, ${Y.toFixed(1)})`),{x:J,y:Y}}getFootHitboxes(){const t=[],i={x:this.x,y:this.y-this.legLength},r=this.legLength*.5,l=this.legLength*.5,e=vt*.5,n=C(i,r,this.leftThighAngle),a=C(n,l,this.leftThighAngle+this.leftShinAngle),h=this.leftThighAngle+this.leftShinAngle,s=C(a,e,h);t.push({x:s.x,y:s.y,radius:Lt});const c=C(i,r,this.rightThighAngle),d=C(c,l,this.rightThighAngle+this.rightShinAngle),g=this.rightThighAngle+this.rightShinAngle,y=C(d,e,g);return t.push({x:y.x,y:y.y,radius:Lt}),t}getBowCenterPosition(){const t=this.facingDirection*(this.armLength*.6),i=-this.legLength-this.torsoLength*.5,r=this.x+t,l=this.y+i;return{x:r,y:l}}getSwordCollisionShape(){if(!this.isSword||!this.isSwingingSword)return null;const t=this._getRelativeLimbPositions(),i={x:this.x+t.relRightHandPos.x,y:this.y+t.relRightHandPos.y},r=this.armLength*this.swordLengthMultiplier,l=r*.15,n=(this.facingDirection===1?Math.PI*2/3:Math.PI/3)+this.swordAngle,a=l*.5,h=C(i,a,n),s=C(i,r,n);return{p1:h,p2:s}}activateSpeedBoost(){this.speedMultiplier=$t,this.speedBoostTimer=Nt,console.log("Speed Boost Activated!")}deactivateSpeedBoost(){this.speedMultiplier=1,console.log("Speed Boost Deactivated.")}activateSuperJump(){this.jumpMultiplier=Yt,this.superJumpTimer=Gt,console.log("Super Jump Activated!")}deactivateSuperJump(){this.jumpMultiplier=1,console.log("Super Jump Deactivated.")}activateBigPlayer(){this.sizeMultiplier=Ut,this.bigPlayerTimer=Wt,this.updateSizeAttributes(),console.log("Big Player Activated!")}deactivateBigPlayer(){this.sizeMultiplier=1,this.updateSizeAttributes(),console.log("Big Player Deactivated.")}fireRocket(t){if(!this.hasRocketLauncher||this.rocketAmmo<=0||this.isStunned||this.isTumbling)return null;this.rocketAmmo--,console.log(`Player ${this.facingDirection===1?1:2} fired rocket! Ammo left: ${this.rocketAmmo}`);const i=this.armLength*1.1;this.limbWidth*.8;const r=-this.legLength-this.torsoLength*.3,l=this.facingDirection*(this.limbWidth*.5),e=this.facingDirection===1?i+5:-5,n=this.x+l,a=this.y+r,h=n+this.facingDirection*e+this.facingDirection*5,s=a,c=this.facingDirection*jt,d=0,g=new ri(h,s,c,d,this,t);return L.playSound("ROCKET_FIRE_1"),this.rocketAmmo<=0&&(this.hasRocketLauncher=!1,console.log(`Player ${this.facingDirection===1?1:2} ran out of rockets.`)),g}updateSizeAttributes(){this.headRadius=this.baseHeadRadius*this.sizeMultiplier,this.torsoLength=this.baseTorsoLength*this.sizeMultiplier,this.armLength=this.baseArmLength*this.sizeMultiplier,this.legLength=this.baseLegLength*this.sizeMultiplier}startItching(){this.isItching||(console.log(`Player ${this.teamColor} started itching!`),this.isItching=!0,this.itchingTimer=this.itchDuration,this.isKicking=!1,this.isTumbling=!1,this.isBeingPushedBack=!1)}updateAim(t,i){const r=t-this.x,l=i-this.y;this.aimAngle=Math.atan2(-l,r)}}class ki{constructor(t,i){o(this,"x");o(this,"y");o(this,"vx");o(this,"vy");o(this,"radius");o(this,"color");o(this,"rotation",0);o(this,"rotationSpeed",0);o(this,"isFrozen",!1);o(this,"freezeTimer",0);this.x=t,this.y=i,this.vx=0,this.vy=0,this.radius=Xt,this.color=H}update(t){if(this.isFrozen&&this.freezeTimer&&this.freezeTimer>0){this.freezeTimer-=t,this.freezeTimer<=0&&(this.isFrozen=!1,console.log("Ball Unfrozen!"));return}const i=this.vy,r=this.vx;let l=!1;this.vy+=et*t;const e=Ht;this.vx*=e,this.vy*=e,this.x+=this.vx*t,this.y+=this.vy*t,this.rotation+=this.vx/this.radius*t,this.rotation+=this.rotationSpeed*t,this.y+this.radius>I&&(this.y=I-this.radius,i>50?(this.vy*=-.85,this.vx*=.9,l||(L.playSound("BALL_BOUNCE_1"),l=!0)):this.vy=0,this.vx*=mt),this.x-this.radius<0&&(this.y<=N||this.y>=I)?(this.x=this.radius,r<-50?(this.vx*=-.85,l||(L.playSound("WALL_HIT_1"),l=!0)):this.vx=0):this.x+this.radius>T&&(this.y<=N||this.y>=I)&&(this.x=T-this.radius,r>50?(this.vx*=-.85,l||(L.playSound("WALL_HIT_1"),l=!0)):this.vx=0);const n=[{x:z,y:N-W,width:U,height:W},{x:j,y:N-W,width:U,height:W}];for(const a of n)if(this.checkCircleRectCollision(this,a)){console.log("Crossbar Collision!");const h=.8,s=Math.max(a.x,Math.min(this.x,a.x+a.width)),c=Math.max(a.y,Math.min(this.y,a.y+a.height)),d=this.x-s,g=this.y-c,y=Math.sqrt(d*d+g*g)||1,u=this.radius-y;if(u>0){const m=d/y*(u+.1),f=g/y*(u+.1);this.x+=m,this.y+=f}Math.abs(d)>Math.abs(g)?(this.vx=-this.vx*h,this.vy*=.95):(g<0?(this.vy=-Math.abs(this.vy*h),this.vy>-80&&(this.vy-=80)):(this.vy=-Math.abs(this.vy*h),this.vy>-80&&(this.vy-=80),this.x+=Math.sign(this.x-(a.x+a.width/2))*1),this.vx*=.95),l||(L.playSound("CROSSBAR_HIT"),l=!0);break}}checkCircleRectCollision(t,i){const r=Math.max(i.x,Math.min(t.x,i.x+i.width)),l=Math.max(i.y,Math.min(t.y,i.y+i.height)),e=t.x-r,n=t.y-l;return e*e+n*n<t.radius*t.radius}draw(t){t.save(),t.translate(this.x,this.y),t.rotate(this.rotation),t.beginPath(),t.arc(0,0,this.radius,0,Math.PI*2),t.fillStyle=H,t.fill(),t.strokeStyle=K,t.lineWidth=1,t.stroke(),t.closePath(),t.fillStyle=K;const i=6,r=Math.PI*2/i,l=this.radius*.4,e=this.radius*.6;for(let n=0;n<i;n++){const a=n*r,h=Math.cos(a)*e,s=Math.sin(a)*e;t.beginPath();for(let c=0;c<5;c++){const d=a+c*(Math.PI*2)/5+Math.PI/5,g=h+Math.cos(d)*l,y=s+Math.sin(d)*l;c===0?t.moveTo(g,y):t.lineTo(g,y)}t.closePath(),t.fill()}this.isFrozen&&(t.beginPath(),t.arc(0,0,this.radius,0,Math.PI*2),t.fillStyle="rgba(173, 216, 230, 0.6)",t.fill(),t.closePath()),t.restore()}applyForce(t,i){this.vx+=t,this.vy+=i}applyKick(t,i){this.vx=t,this.vy=i}freeze(t){this.isFrozen=!0,this.freezeTimer=t,this.vx=0,this.vy=0,console.log(`Ball Frozen for ${t}s!`)}applyGroundFriction(){this.vx*=mt}}class Ti{constructor(t){o(this,"ctx");this.ctx=t}draw(t){switch(t.currentState){case E.WELCOME:this.drawWelcomeScreen();break;case E.PLAYING:this.drawScoreboard(t.player1Score,t.player2Score),this.drawPlayerStatusText(t);break;case E.GOAL_SCORED:this.drawScoreboard(t.player1Score,t.player2Score),this.drawGoalMessage();break;case E.MATCH_OVER:this.drawScoreboard(t.player1Score,t.player2Score),this.drawMatchOverMessage(t.player1Score,t.player2Score);break;default:this.drawScoreboard(t.player1Score,t.player2Score);break}this.drawGlobalStatusText(t)}drawWelcomeScreen(){this.ctx.fillStyle=H,this.ctx.font="40px Arial",this.ctx.textAlign="center",this.ctx.fillText("Awesome Ball 2!",T/2,D/2-50),this.ctx.font="24px Arial",this.ctx.fillText("Press Kick or Jump to Start",T/2,D/2)}drawScoreboard(t,i){const r=`${t} - ${i}`,l=32;this.ctx.font=`bold ${l}px Arial, sans-serif`,this.ctx.textAlign="center",this.ctx.textBaseline="top",this.ctx.strokeStyle=K,this.ctx.lineWidth=3,this.ctx.strokeText(r,T/2,10),this.ctx.fillStyle=H,this.ctx.fillText(r,T/2,10)}drawPlayerStatusText(t){this.ctx.font="bold 14px Arial",this.ctx.fillStyle=H,this.ctx.textAlign="center";const r=T*.25;let l=50;t.p1SpeedBoostTimer&&t.p1SpeedBoostTimer>0&&(this.ctx.fillText(`SPEED UP! ${t.p1SpeedBoostTimer.toFixed(1)}s`,r,l),l+=16),t.p1SuperJumpTimer&&t.p1SuperJumpTimer>0&&(this.ctx.fillText(`HIGH JUMP! ${t.p1SuperJumpTimer.toFixed(1)}s`,r,l),l+=16),t.p1BigPlayerTimer&&t.p1BigPlayerTimer>0&&(this.ctx.fillText(`BIG! ${t.p1BigPlayerTimer.toFixed(1)}s`,r,l),l+=16),t.p1HasRocketLauncher&&t.p1RocketAmmo!==void 0&&t.p1RocketAmmo>0&&(this.ctx.fillStyle="#FF4500",this.ctx.fillText(`ROCKETS: ${t.p1RocketAmmo}`,r,l),this.ctx.fillStyle=H,l+=16),t.p1HasBow&&t.p1ArrowAmmo!==void 0&&t.p1ArrowAmmo>0&&(this.ctx.fillStyle="#90EE90",this.ctx.fillText(`ARROWS: ${t.p1ArrowAmmo}`,r,l),this.ctx.fillStyle=H,l+=16);const e=T*.75;let n=50;t.p2SpeedBoostTimer&&t.p2SpeedBoostTimer>0&&(this.ctx.fillText(`SPEED UP! ${t.p2SpeedBoostTimer.toFixed(1)}s`,e,n),n+=16),t.p2SuperJumpTimer&&t.p2SuperJumpTimer>0&&(this.ctx.fillText(`HIGH JUMP! ${t.p2SuperJumpTimer.toFixed(1)}s`,e,n),n+=16),t.p2BigPlayerTimer&&t.p2BigPlayerTimer>0&&(this.ctx.fillText(`BIG! ${t.p2BigPlayerTimer.toFixed(1)}s`,e,n),n+=16),t.p2HasRocketLauncher&&t.p2RocketAmmo!==void 0&&t.p2RocketAmmo>0&&(this.ctx.fillStyle="#FF4500",this.ctx.fillText(`ROCKETS: ${t.p2RocketAmmo}`,e,n),this.ctx.fillStyle=H,n+=16),t.p2HasBow&&t.p2ArrowAmmo!==void 0&&t.p2ArrowAmmo>0&&(this.ctx.fillStyle="#90EE90",this.ctx.fillText(`ARROWS: ${t.p2ArrowAmmo}`,e,n),this.ctx.fillStyle=H,n+=16)}drawGlobalStatusText(t){if(t.ballIsFrozen&&t.ballFreezeTimer&&t.ballFreezeTimer>0){const i=`BALL FROZEN: ${t.ballFreezeTimer.toFixed(1)}s`;this.ctx.font="bold 18px Arial",this.ctx.fillStyle="rgba(173, 216, 230, 0.9)",this.ctx.textAlign="center",this.ctx.fillText(i,T/2,D-30)}}drawGoalMessage(){this.ctx.fillStyle=gt,this.ctx.font="60px Impact",this.ctx.textAlign="center",this.ctx.fillText("GOAL!",T/2,D/3)}drawMatchOverMessage(t,i){}}var B=(P=>(P.SPEED_BOOST="SPEED_BOOST",P.BIG_PLAYER="BIG_PLAYER",P.SUPER_JUMP="SUPER_JUMP",P.BALL_FREEZE="BALL_FREEZE",P.ROCKET_LAUNCHER="ROCKET_LAUNCHER",P.BOW="BOW",P.SWORD="SWORD",P))(B||{});class Et{constructor(t,i,r){o(this,"x");o(this,"y");o(this,"vx");o(this,"vy");o(this,"type");o(this,"width",30);o(this,"height",30);o(this,"isActive",!0);o(this,"hasParachute",!0);o(this,"driftSpeed",30);o(this,"descendSpeed",80);o(this,"swayTimer",0);o(this,"swayMagnitude",8);o(this,"swayFrequency",2);o(this,"currentSwayOffset",0);this.x=t,this.y=i,this.type=r,this.vy=this.descendSpeed,this.vx=(Math.random()<.5?-1:1)*this.driftSpeed}update(t){this.isActive&&(this.y<I-this.height?(this.x+=this.vx*t,this.y+=this.vy*t,(this.x<0||this.x+this.width>T)&&(this.vx*=-1,this.x=Math.max(0,Math.min(this.x,T-this.width))),this.hasParachute?(this.swayTimer+=t,this.currentSwayOffset=Math.sin(this.swayTimer*this.swayFrequency*2*Math.PI)*this.swayMagnitude):this.currentSwayOffset=0,this.hasParachute&&this.y>I-this.height*3&&(this.hasParachute=!1,this.vy=150,this.currentSwayOffset=0)):(this.y=I-this.height,this.vx=0,this.vy=0,this.hasParachute=!1),this.y>D&&(this.isActive=!1))}draw(t){if(!this.isActive)return;const r=this.x+this.currentSwayOffset,l=this.y,e=this.width,n=this.height;if(this.hasParachute){const a=e*2,h=n*1.5,s=r+e/2-a/2,c=l-h-n*.2;t.fillStyle=H,t.strokeStyle=K,t.lineWidth=1,t.beginPath(),t.arc(s+a/2,c+h,a/2,Math.PI,0),t.closePath(),t.fill(),t.stroke(),t.beginPath(),t.moveTo(s,c+h),t.lineTo(r,l),t.moveTo(s+a,c+h),t.lineTo(r+e,l),t.stroke()}switch(t.save(),t.translate(r+e/2,l+n/2),t.fillStyle=H,t.strokeStyle=K,t.lineWidth=1,t.fillRect(-e/2,-n/2,e,n),t.strokeRect(-e/2,-n/2,e,n),t.lineWidth=2,t.strokeStyle=K,this.type){case"SPEED_BOOST":t.fillStyle="#FFFF00",t.beginPath(),t.moveTo(-e*.1,-n*.4),t.lineTo(e*.3,0),t.lineTo(e*.1,n*.4),t.lineTo(-e*.3,0),t.closePath(),t.fill(),t.stroke();break;case"BIG_PLAYER":t.fillStyle="#FF0000",t.beginPath(),t.moveTo(0,-n*.3),t.lineTo(e*.3,0),t.lineTo(e*.1,0),t.lineTo(e*.1,n*.3),t.lineTo(-e*.1,n*.3),t.lineTo(-e*.1,0),t.lineTo(-e*.3,0),t.closePath(),t.fill(),t.stroke();break;case"SUPER_JUMP":t.fillStyle="#00FF00",t.beginPath(),t.moveTo(-e*.3,n*.3),t.quadraticCurveTo(0,-n*.1,e*.3,n*.3),t.moveTo(-e*.3,n*.1),t.quadraticCurveTo(0,-n*.3,e*.3,n*.1),t.stroke();break;case"BALL_FREEZE":t.fillStyle="#00FFFF",t.beginPath();for(let a=0;a<6;a++){const h=Math.PI/3*a;t.moveTo(0,0),t.lineTo(Math.cos(h)*e*.4,Math.sin(h)*n*.4)}t.stroke(),t.beginPath(),t.arc(0,0,e*.15,0,Math.PI*2),t.fill();break;case"ROCKET_LAUNCHER":t.fillStyle="#808080",t.fillRect(-e*.1,-n*.4,e*.2,n*.8),t.beginPath(),t.moveTo(-e*.1,-n*.4),t.lineTo(e*.1,-n*.4),t.lineTo(0,-n*.6),t.closePath(),t.fill(),t.stroke(),t.fillRect(-e*.2,n*.2,e*.4,n*.1);break;case"BOW":t.fillStyle="#8B4513",t.strokeStyle=K,t.lineWidth=2,t.beginPath(),t.arc(0,0,e*.35,Math.PI*.6,Math.PI*1.4),t.stroke(),t.beginPath(),t.moveTo(0,-n*.35),t.lineTo(0,n*.35),t.stroke();break;case"SWORD":t.fillStyle="#A9A9A9",t.strokeStyle=K,t.lineWidth=2,t.fillRect(-e*.08,n*.1,e*.16,n*.3),t.fillRect(-e*.25,n*.05,e*.5,n*.1),t.beginPath(),t.moveTo(-e*.08,n*.05),t.lineTo(e*.08,n*.05),t.lineTo(e*.08,-n*.4),t.lineTo(0,-n*.5),t.lineTo(-e*.08,-n*.4),t.closePath(),t.fill(),t.stroke();break;default:t.fillStyle="purple",t.fillRect(-e/2,-n/2,e,n),t.strokeStyle=H,t.strokeRect(-e/2,-n/2,e,n)}t.restore()}getRect(){return{x:this.x,y:this.y,width:this.width,height:this.height}}}class wi{constructor(){o(this,"activePowerups",[]);o(this,"spawnTimer",0);o(this,"minSpawnTime",15);o(this,"maxSpawnTime",45);o(this,"nextSpawnTime",0);this.resetSpawnTimer()}resetSpawnTimer(){this.nextSpawnTime=Math.random()*(this.maxSpawnTime-this.minSpawnTime)+this.minSpawnTime,this.spawnTimer=0}spawnPowerup(){const t=[B.SPEED_BOOST,B.BIG_PLAYER,B.SUPER_JUMP,B.BALL_FREEZE,B.ROCKET_LAUNCHER,B.BOW,B.SWORD],i=Math.floor(Math.random()*t.length),r=t[i],l=Math.random()*(T-40)+20,e=-50,n=new Et(l,e,r);this.activePowerups.push(n),this.resetSpawnTimer()}update(t){this.spawnTimer+=t,this.spawnTimer>=this.nextSpawnTime&&this.spawnPowerup();for(let i=this.activePowerups.length-1;i>=0;i--){const r=this.activePowerups[i];r.update(t),r.isActive||this.activePowerups.splice(i,1)}}draw(t){for(const i of this.activePowerups)i.draw(t)}checkCollisions(t){const i=t.getBodyRect();for(let r=this.activePowerups.length-1;r>=0;r--){const l=this.activePowerups[r];if(!l.isActive)continue;const e=l.getRect();if(i.x<e.x+e.width&&i.x+i.width>e.x&&i.y<e.y+e.height&&i.y+i.height>e.y){const n=l.type;return l.isActive=!1,this.activePowerups.splice(r,1),n}}return null}addPowerup(t){this.activePowerups.push(t)}}const It=.97;class Z{constructor(t,i,r,l,e,n,a=3,h=.5,s="circle"){o(this,"x");o(this,"y");o(this,"vx");o(this,"vy");o(this,"lifespan");o(this,"initialLifespan");o(this,"color");o(this,"radius");o(this,"initialRadius");o(this,"alpha",1);o(this,"gravityEffect");o(this,"isActive",!0);o(this,"particleType","circle");this.x=t,this.y=i,this.vx=r,this.vy=l,this.lifespan=e,this.initialLifespan=e,this.color=n,this.radius=a,this.initialRadius=a,this.gravityEffect=h,this.particleType=s}update(t){if(this.isActive)if(this.vy+=et*this.gravityEffect*t,this.x+=this.vx*t,this.y+=this.vy*t,this.vx*=It,this.vy*=It,this.lifespan-=t,this.lifespan<=0)this.alpha=0,this.isActive=!1;else{const i=Math.max(0,this.lifespan/this.initialLifespan);this.particleType==="smoke"?(this.alpha=i,this.radius=this.initialRadius*(.8+.2*i)):this.particleType==="spark"?(this.alpha=i*i,this.radius=this.initialRadius*this.alpha):(this.alpha=i,this.radius=this.initialRadius*i)}}draw(t){!this.isActive||this.alpha<=0||this.radius<=.1||(t.globalAlpha=this.alpha,t.fillStyle=this.color,t.shadowBlur,t.shadowColor,t.beginPath(),t.arc(this.x,this.y,Math.max(.5,this.radius),0,Math.PI*2),t.fill(),t.globalAlpha=1)}}class Mi{constructor(){o(this,"particles",[])}addParticle(t){this.particles.push(t)}emit(t,i,r,l=10,e={}){const n=e.scale||1;switch(t){case"dust":const a=e.count!==void 0?e.count:8;for(let m=0;m<a;m++){const f=Math.random()*Math.PI*2,S=Math.random()*35+10,w=Math.cos(f)*S,M=Math.sin(f)*S*.6-3,k=Math.random()*.7+.4;let A=Math.random()*1.6+1.2;A*=n;const b=e.color||"rgba(139, 69, 19, 0.65)",v=.02;this.addParticle(new Z(i,r,w,M,k,b,A,v,"smoke"))}break;case"landingDust":const h=e.count!==void 0?e.count:12;for(let m=0;m<h;m++){const f=Math.random()*Math.PI*2,S=Math.random()*40+15,w=Math.cos(f)*S,M=Math.sin(f)*S*.5-5,k=Math.random()*.8+.5;let A=Math.random()*3.4+2.4;const b=1+Math.min(2,Math.abs(e.landingVelocity||0)/500);A*=n*b;const v="rgba(255, 255, 255, 0.6)",x=.03;this.addParticle(new Z(i,r,w,M,k,v,A,x,"smoke"))}break;case"goal":const s=e.count!==void 0?e.count:50;for(let m=0;m<s;m++){const f=Math.random()*Math.PI*2,S=Math.random()*90+30,w=Math.cos(f)*S,M=Math.sin(f)*S,k=Math.random()*.5+.3;let A=Math.random()*1.8+1.2;A*=n;const b=["#FFD700","#FFA500","#FF4500"],v=b[Math.floor(Math.random()*b.length)],x=.1;this.addParticle(new Z(i,r,w,M,k,v,A,x,"spark"))}break;case"jump":const c=e.count!==void 0?e.count:10;for(let m=0;m<c;m++){const f=Math.random()*Math.PI*.8+Math.PI*1.1,S=Math.random()*30+8,w=Math.cos(f)*S,M=Math.sin(f)*S*.7,k=Math.random()*.6+.3;let A=Math.random()*1.7+1.2;A*=n;const b="rgba(255, 255, 255, 0.7)",v=.01;this.addParticle(new Z(i,r,w,M,k,b,A,v,"smoke"))}break;case"kick":for(let m=0;m<l;m++){const f=Math.random()*Math.PI*2,S=Math.random()*60+20,w=Math.cos(f)*S*(e.kickDirection||1),M=Math.sin(f)*S-15,k=Math.random()*.35+.25;let A=Math.random()*1.4+1.1;A*=n;const b="#FFFF00",v=.1;this.addParticle(new Z(i,r,w,M,k,b,A,v,"spark"))}break;case"explosion":const d=e.count!==void 0?e.count:50,g=e.radius||50;for(let m=0;m<d;m++){const f=Math.random()*Math.PI*2,S=Math.random()*(g*2.5)+g*.5,w=Math.cos(f)*S,M=Math.sin(f)*S,k=Math.random()*.6+.3;let A=Math.random()*3+2;A*=n;const b=["#FFA500","#FF4500","#FFD700","#FFFFFF","#808080"],v=b[Math.floor(Math.random()*b.length)],x=.05,R=Math.random()<.7?"spark":"smoke";this.addParticle(new Z(i,r,w,M,k,v,A,x,R))}break;case"rocket_smoke":const y=e.count!==void 0?e.count:1,u=e.baseSpeed||50;for(let m=0;m<y;m++){const f=(e.vx||0)*-.02,S=(e.vy||0)*-.02,w=Math.PI/4,k=Math.atan2(e.vy||0,e.vx||0)+Math.PI+(Math.random()*w-w/2),A=u*(Math.random()*.2+.1),b=Math.cos(k)*A,v=Math.sin(k)*A,x=Math.random()*.5+.3;let R=Math.random()*1.5+1;R*=n;const O=`rgba(150, 150, 150, ${Math.random()*.3+.4})`,$=.01;this.addParticle(new Z(i+f,r+S,b,v,x,O,R,$,"smoke"))}break}}update(t){for(let i=this.particles.length-1;i>=0;i--)this.particles[i].update(t),this.particles[i].isActive||this.particles.splice(i,1)}draw(t){for(const i of this.particles)i.draw(t)}clear(){this.particles=[]}}var Ot=(P=>(P.FLYING="FLYING",P.STUCK="STUCK",P))(Ot||{});function xt(P,t,i){return{x:P.x+t*Math.cos(i),y:P.y-t*Math.sin(i)}}class _t{constructor(t,i,r,l,e,n){o(this,"x");o(this,"y");o(this,"vx");o(this,"vy");o(this,"owner");o(this,"isActive",!0);o(this,"state","FLYING");o(this,"width",30);o(this,"thickness",2);o(this,"angle",0);o(this,"stuckToObject",null);o(this,"stuckOffsetX",0);o(this,"stuckOffsetY",0);o(this,"lastPos");o(this,"particleSystem");o(this,"length",30);o(this,"headSize",6);this.x=t,this.y=i,this.vx=r,this.vy=l,this.owner=e,this.angle=Math.atan2(l,r),this.lastPos={x:t,y:i},this.particleSystem=n}update(t){return this.isActive&&(this.lastPos={x:this.x,y:this.y},this.state==="FLYING"?(this.vy+=et*t,this.x+=this.vx*t,this.y+=this.vy*t,this.angle=Math.atan2(this.vy,this.vx),(this.x<-this.width*2||this.x>T+this.width*2||this.y>D+100||this.y<-this.width*2)&&(console.log("Arrow went way out of bounds, deactivating."),this.isActive=!1)):this.state==="STUCK"&&this.stuckToObject&&typeof this.stuckToObject=="object"&&"x"in this.stuckToObject&&"y"in this.stuckToObject&&(this.x=this.stuckToObject.x+this.stuckOffsetX,this.y=this.stuckToObject.y+this.stuckOffsetY,this.stuckToObject instanceof lt)),!1}stick(t,i,r){var l;if(this.state==="FLYING")if(this.state="STUCK",this.stuckToObject=t,this.x=i,this.y=r,this.angle=Math.atan2(this.vy,this.vx),this.vx=0,this.vy=0,t&&typeof t=="object"&&"x"in t&&"y"in t){this.stuckOffsetX=i-t.x,this.stuckOffsetY=r-t.y;let e=((l=t.constructor)==null?void 0:l.name)||"object";t instanceof lt&&(e="Player"),console.log(`Arrow Stuck to ${e} at relative offset (${this.stuckOffsetX.toFixed(1)}, ${this.stuckOffsetY.toFixed(1)})`)}else console.log(`Arrow Stuck to ${t} at (${i.toFixed(1)}, ${r.toFixed(1)})`)}getTipPosition(){return xt({x:this.x,y:this.y},this.width*.5,this.angle)}getBasePosition(){return xt({x:this.x,y:this.y},-this.width*.5,this.angle)}draw(t){this.isActive&&(t.save(),t.translate(this.x,this.y),t.rotate(this.angle),t.strokeStyle=this.owner.teamColor,t.lineWidth=this.thickness,t.beginPath(),t.moveTo(-this.width/2,0),t.lineTo(this.width/2,0),t.stroke(),t.fillStyle=K,t.beginPath(),t.moveTo(this.width/2,0),t.lineTo(this.width/2-6,-3),t.lineTo(this.width/2-6,3),t.closePath(),t.fill(),t.lineWidth=1,t.strokeStyle="#A0522D",t.beginPath(),t.moveTo(-this.width/2,0),t.lineTo(-this.width/2-5,-4),t.moveTo(-this.width/2,0),t.lineTo(-this.width/2-5,4),t.moveTo(-this.width/2-2,0),t.lineTo(-this.width/2-7,-4),t.moveTo(-this.width/2-2,0),t.lineTo(-this.width/2-7,4),t.stroke(),t.restore())}getCollisionShape(){const t=this.length/2,i=this.x-Math.cos(this.angle)*t,r=this.y-Math.sin(this.angle)*t,l=this.x+Math.cos(this.angle)*t,e=this.y+Math.sin(this.angle)*t;return{p1:{x:i,y:r},p2:{x:l,y:e},radius:this.thickness/2}}getLastPosition(){return this.lastPos}}const rt=5,bi=1.5,Ct=400;class vi{constructor(t){o(this,"ctx");o(this,"inputHandler");o(this,"uiManager");o(this,"particleSystem");o(this,"lastTime",0);o(this,"accumulatedTime",0);o(this,"timeStep",1/Ft);o(this,"player1");o(this,"player2");o(this,"ball");o(this,"player1Score",0);o(this,"player2Score",0);o(this,"currentState",E.WELCOME);o(this,"goalMessageTimer",0);o(this,"matchOverTimer",0);o(this,"powerupManager");o(this,"activeRockets",[]);o(this,"activeArrows",[]);o(this,"player1LastKickTime",0);o(this,"player2LastKickTime",0);o(this,"isMatchOverListenerActive",!1);o(this,"handleMatchOverKeyPress",t=>{const i=t.key.toLowerCase();(i==="enter"||i==="s"||i==="arrowdown")&&(console.log(`Restart key pressed (${t.key}) after Match Over. Restarting game...`),this.startNewMatch(),this.removeMatchOverRestartListener())});this.ctx=t,this.inputHandler=new ni,this.uiManager=new Ti(t),this.powerupManager=new wi,this.particleSystem=new Mi,this.player1=new lt(T*.25,I,1,"#DCDCDC","#1E1E1E",K,et,ft,pt),this.player2=new lt(T*.75,I,-1,"#009246","#CE2B37",K,et,ft,pt),this.ball=new ki(T/2,I-100)}spawnSpecificPowerup(t,i,r){const l=new Et(i,r,t);this.powerupManager.addPowerup(l)}resetPositions(){this.ball.x=T/2,this.ball.y=I-100,this.ball.vx=0,this.ball.vy=0,this.player1.x=T*.25,this.player1.y=I,this.player1.vx=0,this.player1.vy=0,this.player1.facingDirection=1,this.player1.isKicking=!1,this.player1.isJumping=!1,this.player1.isTumbling=!1,this.player1.isStunned=!1,this.player1.stunTimer=0,this.player1.isBeingPushedBack=!1,this.player1.pushbackTimer=0,this.player1.isItching=!1,this.player1.speedMultiplier=1,this.player1.jumpMultiplier=1,this.player1.sizeMultiplier=1,this.player1.hasRocketLauncher=!1,this.player1.rocketAmmo=0,this.player1.hasBow=!1,this.player1.arrowAmmo=0,this.player1.isSword=!1,this.player2.x=T*.75,this.player2.y=I,this.player2.vx=0,this.player2.vy=0,this.player2.facingDirection=-1,this.player2.isKicking=!1,this.player2.isJumping=!1,this.player2.isTumbling=!1,this.player2.isStunned=!1,this.player2.stunTimer=0,this.player2.isBeingPushedBack=!1,this.player2.pushbackTimer=0,this.player2.isItching=!1,this.player2.speedMultiplier=1,this.player2.jumpMultiplier=1,this.player2.sizeMultiplier=1,this.player2.hasRocketLauncher=!1,this.player2.rocketAmmo=0,this.player2.hasBow=!1,this.player2.arrowAmmo=0,this.player2.isSword=!1,this.particleSystem.clear()}startNewMatch(){console.log("Executing startNewMatch..."),this.player1Score=0,this.player2Score=0,this.resetPositions(),this.activeRockets=[],this.activeArrows=[],this.powerupManager&&Array.isArray(this.powerupManager.activePowerups)?this.powerupManager.activePowerups=[]:console.warn("Could not clear powerups in PowerupManager"),this.currentState=E.PLAYING,this.particleSystem.clear(),console.log("startNewMatch finished. State set to PLAYING.")}checkGoal(){if(this.currentState===E.PLAYING&&this.ball.y>N&&this.ball.y<I){let t=!1,i=null;this.ball.x-this.ball.radius<z?(console.log("GOAL P2!"),this.player2Score++,t=!0,i=2):this.ball.x+this.ball.radius>j+U&&(console.log("GOAL P1!"),this.player1Score++,t=!0,i=1),t&&(i===1?L.playSound("PLAYER1_GOAL_1"):i===2&&L.playSound("PLAYER2_GOAL_1"),this.particleSystem.emit("goal",this.ball.x,this.ball.y,50),this.player1Score>=rt||this.player2Score>=rt?(this.currentState=E.MATCH_OVER,this.matchOverTimer=3,this.player1Score>=rt?L.playSound("NILS_WINS"):L.playSound("HARRY_WINS")):(this.currentState=E.GOAL_SCORED,this.goalMessageTimer=bi,this.announceScore()))}}handleCollisions(){if(this.currentState!==E.PLAYING)return;const t=[this.player1,this.player2];let i=!1;const r=a=>{if(typeof a.getKickImpactPoint=="function")return a.getKickImpactPoint();if(!a.isKicking)return null;const h=a.legLength||30,s=h*.8,c=a.y-h*.5;return{x:a.x+a.facingDirection*s,y:c}};for(const a of t){const h=this.powerupManager.checkCollisions(a);h&&this.applyPowerup(a,h)}const l=this.player1.getBodyRect(),e=this.player2.getBodyRect();if(this.checkRectCollision(l,e)){const a=l.x+l.width/2-(e.x+e.width/2),h=l.width/2+e.width/2-Math.abs(a);if(h>0){const s=h/2,c=Math.sign(a)||1;this.player1.x+=s*c,this.player2.x-=s*c;const d=.3,g=this.player1.vx,y=this.player2.vx;this.player1.vx=-g*d+y*d*.5,this.player2.vx=-y*d+g*d*.5,console.log("Player-Player Body Collision"),L.playSound("PLAYER_BUMP_1")}}if(this.checkFeetOnHeadCollision(this.player1,this.player2)){const a=this.player2.getHeadCircle();this.player1.y=a.y-a.radius,this.player1.vy=0,this.player1.isJumping=!1,this.player1.onOtherPlayerHead=!0}else this.player1.onOtherPlayerHead=!1;if(this.checkFeetOnHeadCollision(this.player2,this.player1)){const a=this.player1.getHeadCircle();this.player2.y=a.y-a.radius,this.player2.vy=0,this.player2.isJumping=!1,this.player2.onOtherPlayerHead=!0}else this.player2.onOtherPlayerHead=!1;for(const a of t){if(a.isBicycleKicking&&!i){const u=a.getBicycleKickImpactPoint();if(u){const m=this.ball.x-u.x,f=this.ball.y-u.y,S=m*m+f*f,w=this.ball.radius+60,M=w*w;if(console.log(`[Bicycle Kick] Check: dist=${Math.sqrt(S).toFixed(1)}, radius=${Math.sqrt(M).toFixed(1)}`),S<M){console.log(`BICYCLE KICK CONNECT! Player: ${a===this.player1?1:2}, KickPoint: (${u.x.toFixed(1)}, ${u.y.toFixed(1)}), Ball: (${this.ball.x.toFixed(1)}, ${this.ball.y.toFixed(1)})`),L.playSound("KICK_1"),console.log("Applying Bicycle Kick force (Direction-Based)!");const A=st*2.5*1.5,b=-(a.legLength+a.torsoLength/2),v=a.x,x=a.y+b;let R=u.x-v,O=u.y-x;const $=Math.sqrt(R*R+O*O);$>0?(R/=$,O/=$):(R=a.facingDirection,O=-.5);const q=R*A,V=O*A;this.ball.applyKick(q,V),this.particleSystem.emit("kick",u.x,u.y,15,{kickDirection:a.facingDirection,isBicycle:!0}),i=!0;continue}}}if(a.isKicking&&!i){const u=a.getKickImpactPoint();if(u){const m=this.ball.x-u.x,f=this.ball.y-u.y,S=m*m+f*f,w=this.ball.radius+30,M=w*w;if(S<M){console.log(`Kick Connect! Player: ${a===this.player1?1:2}, KickPoint: (${u.x.toFixed(1)}, ${u.y.toFixed(1)}), Ball: (${this.ball.x.toFixed(1)}, ${this.ball.y.toFixed(1)}), DistSq: ${S.toFixed(1)}, RadiusSq: ${M.toFixed(1)}`),L.playSound("KICK_1");let k=0,A=0;if(a.isBicycleKicking){console.log("Applying Bicycle Kick force!");const V=2,J=1.5;k=a.facingDirection*st*V*.7,A=ct*V*J}else{const J=a.vx*.4,Y=a.vy*.4,F=a.facingDirection*st*1.5;let G=ct*1.5;const X=I-this.ball.radius*2;this.ball.y<X&&(G*=.2,console.log(`Volley kick! Ball Y: ${this.ball.y.toFixed(0)}, Threshold: ${X.toFixed(0)}. Reduced base VY to ${G.toFixed(0)}`)),k=F+J,A=G+Y,console.log(`Standard Kick Details: Base=(${F.toFixed(0)}, ${G.toFixed(0)}), Momentum=(${J.toFixed(0)}, ${Y.toFixed(0)}), Final=(${k.toFixed(0)}, ${A.toFixed(0)})`)}const b=Math.atan2(A,k),v=Math.sqrt(k*k+A*A),x=Math.PI/18,R=(Math.random()*2-1)*x,O=b+R,$=Math.cos(O)*v,q=Math.sin(O)*v;console.log(`Kick Randomness: OrigAngle=${b.toFixed(2)}, Offset=${R.toFixed(2)}, FinalAngle=${O.toFixed(2)}`),this.ball.applyKick($,q),this.particleSystem.emit("kick",u.x,u.y,a.isBicycleKicking?15:8,{kickDirection:a.facingDirection,isBicycle:a.isBicycleKicking}),i=!0;continue}}}const h=a.getHeadCircle(),s=this.ball.x-h.x,c=this.ball.y-h.y,d=s*s+c*c,g=h.radius+this.ball.radius+5,y=g*g;if(d<y&&!a.isKicking){console.log("Headbutt Connect!");const u=st*a.facingDirection*.6,m=ct*1.5,f=a.vx*.3,S=a.vy*.3;this.ball.vx=u+f,this.ball.vy=m+S,i=!0,L.playSound("HEADBUTT_1")}if(!i){const u=a.getBodyRect();if(this.checkCircleRectCollision(this.ball,u)){const m=Math.max(u.x,Math.min(this.ball.x,u.x+u.width)),f=Math.max(u.y,Math.min(this.ball.y,u.y+u.height)),S=this.ball.x-m,w=this.ball.y-f,M=S*S+w*w;if(M<this.ball.radius*this.ball.radius){const k=Math.sqrt(M),A=this.ball.radius-k;if(k>0){const R=S/k*A,O=w/k*A;this.ball.x+=R,this.ball.y+=O}const b=this.ball.vx-a.vx,v=this.ball.vy-a.vy,x=.5;this.ball.vx=a.vx+-b*x,this.ball.vy=a.vy+-v*x,L.playSound("BODY_HIT_1")}}}}const n=this.ball;(n.x-n.radius<Pt||n.x+n.radius>St)&&n.y<N&&(n.vx*=-.85,n.x=n.x<T/2?Pt+n.radius:St-n.radius,this.particleSystem.emit("dust",n.x,n.y,8)),n.y-n.radius<0&&(n.y=n.radius,n.vy*=-.85,this.particleSystem.emit("dust",n.x,n.y,8)),n.y+n.radius>I&&(n.y=I-n.radius,n.vy*=-.85,n.applyGroundFriction(),n.rotationSpeed*=.8,Math.abs(n.vy)>20&&this.particleSystem.emit("dust",n.x,n.y,12,{color:"#A0522D"}));for(const a of t){const h=a===this.player1?this.player2:this.player1;if(a.isKicking&&!h.isTumbling&&!h.isBeingPushedBack){const s=r(a);if(s){const c=h.getHeadCircle(),d=s.x-c.x,g=s.y-c.y,y=d*d+g*g,u=c.radius+5,m=u*u;if(y<m){console.log(`Player ${a===this.player1?1:2} kicked Player ${h===this.player1?1:2} in the head! Pushback!`);const f=Vt;h.vx=f*a.facingDirection,h.vy=-200,h.isJumping=!0,h.onOtherPlayerHead=!1,h.onLeftCrossbar=!1,h.onRightCrossbar=!1,h.isBeingPushedBack=!0,h.pushbackTimer=At,L.playSound("BODY_HIT_1"),a.isKicking=!1}}}}for(let a=this.activeRockets.length-1;a>=0;a--){const h=this.activeRockets[a];if(!h.isActive)continue;const s=h.getRect();let c=!1;for(const g of t){if(g===h.owner)continue;const y=g.getBodyRect(),u=g.getHeadCircle();if(this.checkRectCollision(s,y)){console.log(`Rocket hit Player ${g===this.player1?1:2} body`),c=!0;break}if(!c&&this.checkCircleRectCollision(u,s)){console.log(`Rocket hit Player ${g===this.player1?1:2} head`),c=!0;break}}const d={x:this.ball.x,y:this.ball.y,radius:this.ball.radius};!c&&this.checkCircleRectCollision(d,s)&&(console.log("Rocket hit Ball"),c=!0),c&&(this.createExplosion(h.lastPos.x,h.lastPos.y),h.isActive=!1)}for(let a=this.activeArrows.length-1;a>=0;a--){const h=this.activeArrows[a];if(!h.isActive||h.state===Ot.STUCK)continue;let s=!1;const c=h.getTipPosition();for(const d of t){if(h.owner===d)continue;const g=d.getHeadCircle(),y=d.getBodyRect();let u=!1;const m=c.x-g.x,f=c.y-g.y;if(m*m+f*f<g.radius*g.radius?(console.log(`Arrow hit Player ${d===this.player1?1:2} head (Tip Check)`),u=!0):c.x>=y.x&&c.x<=y.x+y.width&&c.y>=y.y&&c.y<=y.y+y.height&&(console.log(`Arrow hit Player ${d===this.player1?1:2} body (Tip Check)`),u=!0),u){h.stick(d,c.x,c.y),d.startItching();const S=Math.atan2(c.y-d.y,c.x-d.x);d.vx+=Math.cos(S)*Tt,d.vy+=Math.sin(S)*Tt*.5-100,L.playSound("BODY_HIT_1"),s=!0;break}}if(!s){const d=c.x-this.ball.x,g=c.y-this.ball.y;if(d*d+g*g<this.ball.radius*this.ball.radius){const y=h.vx,u=h.vy;console.log(`[GM] Arrow hit Ball. Stored Velocity: (${y.toFixed(1)}, ${u.toFixed(1)}) (Tip Check)`);const m=1,f=y*m,S=u*m;console.log(`[GM] Calculated Force to Apply: (${f.toFixed(1)}, ${S.toFixed(1)})`),console.log("[GM] Calling ball.applyForce..."),this.ball.applyForce(f,S),console.log("[GM] Returned from ball.applyForce."),L.playSound("BODY_HIT_1"),console.log("[GM] Calling arrow.stick..."),h.stick(this.ball,c.x,c.y),console.log("[GM] Returned from arrow.stick."),s=!0}}!s&&h.y>=I-h.thickness/2&&(console.log("Arrow hit Ground (End Pos Check)"),h.stick("ground",h.x,I-h.thickness/2),s=!0)}for(const a of t){if(!a.isSword||!a.isSwingingSword)continue;const h=a.getSwordCollisionShape();if(!h)continue;const s=a===this.player1?this.player2:this.player1;if(!s.isTumbling&&!s.isBeingPushedBack){const d=s.getHeadCircle(),g=s.getBodyRect();let y=!1;if(this.checkLineCircleCollision(h.p1,h.p2,d))console.log(`Sword hit Player ${s===this.player1?1:2} head!`),y=!0;else{const u=g.x+g.width/2,m=g.y+g.height/2,f=Math.max(g.width,g.height)/1.8,S={x:u,y:m,radius:f};this.checkLineCircleCollision(h.p1,h.p2,S)&&(console.log(`Sword hit Player ${s===this.player1?1:2} body!`),y=!0)}if(y){const u=Math.sign(s.x-a.x)||1,m=-300;s.vx=u*si,s.vy=m,s.isBeingPushedBack=!0,s.pushbackTimer=At,s.isJumping=!0,s.onOtherPlayerHead=!1,s.onLeftCrossbar=!1,s.onRightCrossbar=!1,s.startTumble(),L.playSound("SWORD_HIT")}}const c={x:this.ball.x,y:this.ball.y,radius:this.ball.radius};if(console.log(`[Sword Check] Sword: p1=(${h.p1.x.toFixed(1)},${h.p1.y.toFixed(1)}), p2=(${h.p2.x.toFixed(1)},${h.p2.y.toFixed(1)}) | Ball: cx=${c.x.toFixed(1)}, cy=${c.y.toFixed(1)}, r=${c.radius.toFixed(1)}`),this.checkLineCircleCollision(h.p1,h.p2,c)){const d=Math.atan2(h.p2.y-h.p1.y,h.p2.x-h.p1.x),g=oi,y=Math.cos(d)*g,u=Math.sin(d)*g;this.ball.applyForce(y,u),L.playSound("SWORD_HIT_BALL")}}}checkRectCollision(t,i){return t.x<i.x+i.width&&t.x+t.width>i.x&&t.y<i.y+i.height&&t.y+t.height>i.y}checkFeetOnHeadCollision(t,i){const r=i.getHeadCircle(),l=t.x,e=t.y,n=r.y-r.radius,a=r.y,h=r.x-r.radius,s=r.x+r.radius;return l>=h&&l<=s&&e>=n&&e<=a+5&&t.vy>=0}checkCircleRectCollision(t,i){const r=Math.max(i.x,Math.min(t.x,i.x+i.width)),l=Math.max(i.y,Math.min(t.y,i.y+i.height)),e=t.x-r,n=t.y-l;return e*e+n*n<t.radius*t.radius}checkLineCircleCollision(t,i,r){const l=(i.x-t.x)*(i.x-t.x)+(i.y-t.y)*(i.y-t.y);if(l===0){const d=r.x-t.x,g=r.y-t.y;return d*d+g*g<=r.radius*r.radius}let e=((r.x-t.x)*(i.x-t.x)+(r.y-t.y)*(i.y-t.y))/l;e=Math.max(0,Math.min(1,e));const n=t.x+e*(i.x-t.x),a=t.y+e*(i.y-t.y),h=r.x-n,s=r.y-a;return h*h+s*s<=r.radius*r.radius}applyPowerup(t,i){switch(console.log(`Applying powerup ${i} to player ${t===this.player1?1:2}...`),i){case B.SPEED_BOOST:t.activateSpeedBoost();break;case B.BIG_PLAYER:t.activateBigPlayer();break;case B.SUPER_JUMP:t.activateSuperJump();break;case B.BALL_FREEZE:console.log("Calling ball.freeze()"),this.ball.freeze(Jt);break;case B.ROCKET_LAUNCHER:{const e=t.hasRocketLauncher;e?t.rocketAmmo+=3:(t.hasRocketLauncher=!0,t.rocketAmmo=3),console.log(`Player ${t===this.player1?1:2} ${e?"added":"picked up"} Rocket Launcher (Ammo: ${t.rocketAmmo})`);break}case B.BOW:t.hasRocketLauncher&&(t.hasRocketLauncher=!1,t.rocketAmmo=0),t.isSword&&(t.isSword=!1);const r=t.hasBow;t.hasBow=!0,r?t.arrowAmmo+=3:t.arrowAmmo=3,t.aimAngle=0,console.log(`Player ${t===this.player1?1:2} ${r?"added arrows to":"picked up"} Bow (Ammo: ${t.arrowAmmo})`);break;case B.SWORD:t.hasRocketLauncher&&(t.hasRocketLauncher=!1,t.rocketAmmo=0),t.hasBow&&(t.hasBow=!1,t.arrowAmmo=0),t.isSword=!0,console.log(`Player ${t===this.player1?1:2} picked up Sword`);break;default:console.warn(`Unhandled powerup type: ${i}`)}}update(t){switch(this.inputHandler.update(),this.currentState===E.MATCH_OVER&&this.matchOverTimer<=0&&!this.isMatchOverListenerActive&&(console.log("Match Over timer ended. Waiting for Enter to restart..."),this.addMatchOverRestartListener()),this.currentState){case E.WELCOME:(this.inputHandler.isKeyPressed(Q.JUMP)||this.inputHandler.isKeyPressed(Q.KICK)||this.inputHandler.isKeyPressed(tt.JUMP)||this.inputHandler.isKeyPressed(tt.KICK))&&this.startNewMatch();break;case E.PLAYING:const r=performance.now()/1e3*ii*Math.PI*2,l=Math.sin(r)*ei;this.player1.hasBow&&!this.player1.isKicking&&!this.player1.isStunned&&!this.player1.isTumbling?this.player1.aimAngle=-l:this.player1.hasBow||(this.player1.aimAngle=0),this.player2.hasBow&&!this.player2.isKicking&&!this.player2.isStunned&&!this.player2.isTumbling?this.player2.aimAngle=-l:this.player2.hasBow||(this.player2.aimAngle=0);let e=this.player1.playerSpeed*this.player1.speedMultiplier;if(this.player1.isBeingPushedBack||(this.inputHandler.isKeyPressed(Q.LEFT)?(this.player1.vx=-e,this.player1.facingDirection=-1):this.inputHandler.isKeyPressed(Q.RIGHT)?(this.player1.vx=e,this.player1.facingDirection=1):this.player1.vx=0),this.inputHandler.wasKeyJustPressed(Q.JUMP)&&this.player1.jump(),this.inputHandler.wasKeyJustPressed(Q.KICK)){const a=performance.now(),h=a-this.player1LastKickTime;if(this.player1LastKickTime>0&&h<Ct)console.log("Player 1 Bicycle Kick!"),this.player1.isKicking=!1,this.player1.kickTimer=0,this.player1.startBicycleKick(),this.player1LastKickTime=0;else{let s=!1;if(this.player1.isSword&&(this.player1.startSwordSwing(),s=!0),!s&&this.player1.hasRocketLauncher&&!this.player1.isItching){const c=this.player1.fireRocket(this.particleSystem);c&&this.activeRockets.push(c),s=!0}if(!s&&this.player1.hasBow&&!this.player1.isItching){if(this.player1.arrowAmmo>0){const c=kt,d=-this.player1.aimAngle,g=this.player1.facingDirection===1?d:Math.PI-d,y=Math.cos(g)*c,u=-Math.sin(g)*c,m=this.player1.x,f=this.player1.y-this.player1.legLength-this.player1.torsoLength*.5,S=new _t(m,f,y,u,this.player1,this.particleSystem);this.activeArrows.push(S),this.player1.arrowAmmo--,this.player1.arrowAmmo<=0&&(this.player1.hasBow=!1),L.playSound("KICK_1")}else console.log("Player 1 out of arrows!");s=!0}s||this.player1.startKick(),this.player1LastKickTime=a}}let n=this.player2.playerSpeed*this.player2.speedMultiplier;if(this.player2.isBeingPushedBack||(this.inputHandler.isKeyPressed(tt.LEFT)?(this.player2.vx=-n,this.player2.facingDirection=-1):this.inputHandler.isKeyPressed(tt.RIGHT)?(this.player2.vx=n,this.player2.facingDirection=1):this.player2.vx=0),this.inputHandler.wasKeyJustPressed(tt.JUMP)&&this.player2.jump(),this.inputHandler.wasKeyJustPressed(tt.KICK)){const a=performance.now(),h=a-this.player2LastKickTime;if(this.player2LastKickTime>0&&h<Ct)console.log("Player 2 Bicycle Kick!"),this.player2.isKicking=!1,this.player2.kickTimer=0,this.player2.startBicycleKick(),this.player2LastKickTime=0;else{let s=!1;if(this.player2.isSword&&(this.player2.startSwordSwing(),s=!0),!s&&this.player2.hasRocketLauncher&&!this.player2.isItching){const c=this.player2.fireRocket(this.particleSystem);c&&this.activeRockets.push(c),s=!0}if(!s&&this.player2.hasBow&&!this.player2.isItching){if(this.player2.arrowAmmo>0){const c=kt,d=-this.player2.aimAngle,g=this.player2.facingDirection===1?d:Math.PI-d,y=Math.cos(g)*c,u=-Math.sin(g)*c,m=this.player2.x,f=this.player2.y-this.player2.legLength-this.player2.torsoLength*.5,S=new _t(m,f,y,u,this.player2,this.particleSystem);this.activeArrows.push(S),this.player2.arrowAmmo--,this.player2.arrowAmmo<=0&&(this.player2.hasBow=!1),L.playSound("KICK_1")}else console.log("Player 2 out of arrows!");s=!0}s||this.player2.startKick(),this.player2LastKickTime=a}}this.inputHandler.wasKeyJustPressed("1")&&this.spawnSpecificPowerup(B.ROCKET_LAUNCHER,T/2,50),this.inputHandler.wasKeyJustPressed("2")&&(this.player1.isItching=!this.player1.isItching,console.log(`DEBUG: Toggled Player 1 itching: ${this.player1.isItching}`)),this.inputHandler.wasKeyJustPressed("3")&&(this.spawnSpecificPowerup(B.BOW,T/2,50),console.log("DEBUG: Spawned Bow Powerup")),this.inputHandler.wasKeyJustPressed("4")&&(this.player1.isSword=!this.player1.isSword,this.player1.isSword&&(this.player1.hasBow=!1,this.player1.hasRocketLauncher=!1),console.log(`DEBUG: Toggled Player 1 Sword: ${this.player1.isSword}`)),this.player1.isJumping&&!this.player1.hasJumpedThisPress&&(this.particleSystem.emit("jump",this.player1.x,this.player1.y,6,{scale:this.player1.sizeMultiplier}),this.player1.hasJumpedThisPress=!0),this.player2.isJumping&&!this.player2.hasJumpedThisPress&&(this.particleSystem.emit("jump",this.player2.x,this.player2.y,6,{scale:this.player2.sizeMultiplier}),this.player2.hasJumpedThisPress=!0),this.player1.update(t,I,T),this.player1.justLanded&&(this.particleSystem.emit("landingDust",this.player1.x,this.player1.y,12,{scale:this.player1.sizeMultiplier,landingVelocity:this.player1.lastLandingVy}),this.player1.justLanded=!1),this.player2.update(t,I,T),this.player2.justLanded&&(this.particleSystem.emit("landingDust",this.player2.x,this.player2.y,12,{scale:this.player2.sizeMultiplier,landingVelocity:this.player2.lastLandingVy}),this.player2.justLanded=!1),this.powerupManager.update(t);for(let a=this.activeRockets.length-1;a>=0;a--){const h=this.activeRockets[a];h.update(t),h.isActive||this.activeRockets.splice(a,1)}for(let a=this.activeArrows.length-1;a>=0;a--){const h=this.activeArrows[a];h.update(t),h.isActive||(console.log("Removing inactive arrow (OOB) from GameManager list."),this.activeArrows.splice(a,1))}this.handleCollisions(),this.ball.update(t),this.particleSystem.update(t),this.checkGoal();break;case E.GOAL_SCORED:this.goalMessageTimer-=t,this.goalMessageTimer<=0&&(this.resetPositions(),this.currentState=E.PLAYING),this.particleSystem.update(t);break;case E.MATCH_OVER:this.matchOverTimer-=t,this.matchOverTimer<=0,this.particleSystem.update(t);break}}addMatchOverRestartListener(){this.isMatchOverListenerActive||(document.addEventListener("keydown",this.handleMatchOverKeyPress),this.isMatchOverListenerActive=!0)}removeMatchOverRestartListener(){this.isMatchOverListenerActive&&(document.removeEventListener("keydown",this.handleMatchOverKeyPress),this.isMatchOverListenerActive=!1)}render(){this.ctx.clearRect(0,0,T,D),this.ctx.fillStyle="#87CEEB",this.ctx.fillRect(0,0,T,D),this.ctx.fillStyle="#228B22",this.ctx.fillRect(0,I,T,D-I),this.drawGoals(),this.ball.draw(this.ctx),this.player1.draw(this.ctx),this.player2.draw(this.ctx),this.powerupManager.draw(this.ctx);for(const i of this.activeRockets)i.draw(this.ctx);for(const i of this.activeArrows)i.draw(this.ctx);this.particleSystem.draw(this.ctx);const t={currentState:this.currentState,player1Score:this.player1Score,player2Score:this.player2Score,p1SpeedBoostTimer:this.player1.speedBoostTimer,p1SuperJumpTimer:this.player1.superJumpTimer,p1BigPlayerTimer:this.player1.bigPlayerTimer,p1HasRocketLauncher:this.player1.hasRocketLauncher,p1RocketAmmo:this.player1.rocketAmmo,p1HasBow:this.player1.hasBow,p1ArrowAmmo:this.player1.arrowAmmo,p2SpeedBoostTimer:this.player2.speedBoostTimer,p2SuperJumpTimer:this.player2.superJumpTimer,p2BigPlayerTimer:this.player2.bigPlayerTimer,p2HasRocketLauncher:this.player2.hasRocketLauncher,p2RocketAmmo:this.player2.rocketAmmo,p2HasBow:this.player2.hasBow,p2ArrowAmmo:this.player2.arrowAmmo,ballIsFrozen:this.ball.isFrozen,ballFreezeTimer:this.ball.freezeTimer,goalMessageTimer:this.goalMessageTimer,matchOverTimer:this.matchOverTimer};if(this.uiManager.draw(t),this.currentState===E.GOAL_SCORED)this.ctx.fillStyle=gt,this.ctx.font="60px Impact",this.ctx.textAlign="center",this.ctx.fillText("GOAL!",T/2,D/3);else if(this.currentState===E.MATCH_OVER){this.ctx.fillStyle=H,this.ctx.font="50px Arial",this.ctx.textAlign="center";const i=this.player1Score>=rt?"Nils":"Harry";this.ctx.fillText(`${i} Wins!`,T/2,D/2-30),this.ctx.font="30px Arial",this.ctx.fillText(`Score: ${this.player1Score} - ${this.player2Score}`,T/2,D/2+20),this.matchOverTimer<=0&&(this.ctx.font="25px Arial",this.ctx.fillStyle=gt,this.ctx.fillText("Press Enter or Kick (S / ↓) to Play Again",T/2,D/2+70))}}gameLoop(t){const i=(t-this.lastTime)/1e3;for(this.lastTime=t,this.accumulatedTime+=i;this.accumulatedTime>=this.timeStep;)this.update(this.timeStep),this.accumulatedTime-=this.timeStep;this.render(),requestAnimationFrame(this.gameLoop.bind(this))}start(){console.log("Starting game..."),this.lastTime=performance.now(),requestAnimationFrame(this.gameLoop.bind(this))}drawGoals(){const t=Dt;this.ctx.fillStyle=t,this.ctx.strokeStyle=K,this.ctx.lineWidth=2;const i=[{x:z,y:N-W,width:U,height:W},{x:j,y:N-W,width:U,height:W}];this.ctx.strokeStyle="rgba(240, 240, 240, 0.8)",this.ctx.lineWidth=1;const r=10,l=N,e=I;for(let s=l;s<e;s+=r)this.ctx.beginPath(),this.ctx.moveTo(z,s),this.ctx.lineTo(z+U,s),this.ctx.stroke();for(let s=z;s<z+U;s+=r)this.ctx.beginPath(),this.ctx.moveTo(s,l),this.ctx.lineTo(s,e),this.ctx.stroke();const n=N,a=I;for(let s=n;s<a;s+=r)this.ctx.beginPath(),this.ctx.moveTo(j,s),this.ctx.lineTo(j+U,s),this.ctx.stroke();for(let s=j;s<j+U;s+=r)this.ctx.beginPath(),this.ctx.moveTo(s,n),this.ctx.lineTo(s,a),this.ctx.stroke();this.ctx.fillStyle=t,this.ctx.strokeStyle=K,this.ctx.lineWidth=2;for(const s of i)this.ctx.fillRect(s.x,s.y,s.width,s.height),this.ctx.strokeRect(s.x,s.y,s.width,s.height);const h=[{x:z,y:N,width:W,height:yt},{x:T-W,y:N,width:W,height:yt}];for(const s of h)this.ctx.fillRect(s.x,s.y,s.width,s.height),this.ctx.strokeRect(s.x,s.y,s.width,s.height)}createExplosion(t,i){console.log(`Creating REAL Explosion at (${t.toFixed(0)}, ${i.toFixed(0)}) with radius ${it}`),L.playSound("ROCKET_EXPLODE_1");const r=[this.player1,this.player2],l=it*it;r.forEach(h=>{const s=h.x-t,c=h.y-h.torsoLength/2-i,d=s*s+c*c;if(d<l){console.log(`Player ${h===this.player1?1:2} in blast radius!`);const g=Math.sqrt(d);let y=0;if(g>0)y=c/g;else{const u=Math.random()*Math.PI*2;y=Math.sin(u)}h.vy=ti+y*.3,h.startTumble()}});const e=this.ball.x-t,n=this.ball.y-i,a=e*e+n*n;if(a<l){console.log("Ball in blast radius!");const h=Math.sqrt(a),s=1-h/it,c=qt*s;let d=0,g=0;if(h>0)d=e/h,g=n/h;else{const y=Math.random()*Math.PI*2;d=Math.cos(y),g=Math.sin(y)}this.ball.applyForce(d*c,g*c-Zt)}this.particleSystem.emit("explosion",t,i,50,{radius:it})}announceScore(){let i=[],r=null,l=null,e=null;this.player1Score>this.player2Score?(r="NILS_AHEAD",l="NUM_"+this.player1Score,e="NUM_"+this.player2Score):this.player2Score>this.player1Score?(r="HARRY_AHEAD",l="NUM_"+this.player2Score,e="NUM_"+this.player1Score):(l="NUM_"+this.player1Score,e="NUM_"+this.player2Score),r&&i.push(r),l&&parseInt(l.split("_")[1])<=5&&i.push(l),e&&parseInt(e.split("_")[1])<=5&&i.push(e);let n=50;const a=h=>{if(h<i.length){const s=i[h];setTimeout(()=>{console.log(`Playing score announcement sound: ${s}`),L.playSound(s),a(h+1)},1100)}};setTimeout(()=>{a(0)},n)}}document.addEventListener("DOMContentLoaded",()=>{const P=document.getElementById("gameCanvas");if(!P){console.error("Canvas element not found!");return}P.width=T,P.height=D;const t=P.getContext("2d");if(!t){console.error("Failed to get 2D context!");return}L.loadSounds().then(()=>{}).catch(r=>{console.error("Sound loading failed:",r)}),new vi(t).start()});
